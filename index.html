<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>やることリスト - v9.8 (2026-02-14)</title>

        <!--
    VERSION: 10.1
    DATE: 2026-02-14
    CHANGES:
    - ナビバーデザイン全面リニューアル（モダンボトムナビ風）
    - 設定タブ: active緑下線を廃止、プロフィールアイコンのみに
    - Instagram虹色枠: conic-gradient + アニメーション実装
    - プロフィールアバター: ストーリーズ風グロウエフェクト
    - ナビバーアクティブ状態: 緑→洗練されたインジケータに変更
    - 全体的なUI/UXポリッシュ
  -->

        <!-- ★★★ 色の切り替え: true = 色あり / false = 色なし（白） ★★★ -->
        <script>
            var USE_COLORS = false; // ← ここを true/false で切り替え
        </script>

        <style>
            * {
                box-sizing: border-box;
            }

            body,
            html {
                height: 100%;
                margin: 0;
                padding: 0;
                font-family: "Hiragino Sans", "メイリオ", Meiryo, sans-serif;
            }

            /* ナビゲーションタブ - モダンナビ */
            .nav-tabs {
                display: flex;
                background-color: #fff;
                border-bottom: 1px solid #efefef;
                padding: 0 16px;
                position: sticky;
                top: 0;
                z-index: 100;
            }

            .nav-tab {
                padding: 14px 20px;
                border: none;
                background: none;
                cursor: pointer;
                font-size: 0.9em;
                font-weight: 500;
                color: #8e8e8e;
                border-bottom: 1.5px solid transparent;
                margin-bottom: -1px;
                transition: color 0.2s ease, border-color 0.2s ease;
                letter-spacing: 0.02em;
                position: relative;
            }

            .nav-tab:hover {
                color: #555;
            }

            .nav-tab.active {
                color: #0095f6;
                font-weight: 600;
                border-bottom-color: #0095f6;
            }

            /* 設定タブ（プロフィールアイコン）- active時に下線を出さない */
            .nav-tab-settings {
                margin-left: auto;
                font-size: 1.1em;
                border-bottom: 1.5px solid transparent !important;
            }

            .nav-tab-settings.active {
                border-bottom-color: transparent !important;
            }

            .container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 1fr 1fr;
                height: calc(100vh - 50px);
                gap: 0;
            }

            .section {
                border: 1px solid #000;
                padding: 15px;
                overflow-y: auto;
                background-color: #ffffff;
            }

            /* スクロールバーを薄く */
            .section::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }

            .section::-webkit-scrollbar-track {
                background: #f5f5f5;
            }

            .section::-webkit-scrollbar-thumb {
                background: #e0e0e0;
                border-radius: 4px;
            }

            .section::-webkit-scrollbar-thumb:hover {
                background: #d0d0d0;
            }

            .header-row {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 15px;
                flex-wrap: nowrap;
                justify-content: flex-start;
            }

            .header-row h4 {
                margin: 0;
                font-size: 1.1em;
                color: #333;
                white-space: nowrap;
                flex-shrink: 0;
            }

            .simple-header h4 {
                margin: 0;
                font-size: 1.1em;
            }

            .purpose-group {
                display: flex;
                align-items: center;
                gap: 5px;
                flex: 1;
            }

            .purpose-group input {
                padding: 4px 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 0.85em;
                width: 300px;
                max-width: 300px;
            }

            .purpose-group label {
                font-weight: bold;
                white-space: nowrap;
            }

            .purpose-display {
                display: flex;
                align-items: center;
                gap: 8px;
                font-weight: bold;
                color: #333;
                white-space: normal;
                word-wrap: break-word;
                overflow-wrap: break-word;
                flex-wrap: wrap;
            }

            .purpose-display #purposeText {
                flex: 1;
                min-width: 0;
                word-wrap: break-word;
                overflow-wrap: break-word;
                font-size: 0.9em;
            }

            .edit-btn {
                padding: 4px 12px;
                background-color: #f0f0f0;
                color: #888;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.75em;
                line-height: 1.4;
                min-height: 24px;
                display: inline-flex;
                align-items: center;
                transition: all 0.2s ease;
            }

            .edit-btn:hover {
                background-color: #e0e0e0;
                color: #555;
                transform: translateY(-1px);
            }

            .edit-btn:active {
                transform: translateY(0) scale(0.97);
            }

            .simple-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 15px;
                flex-wrap: wrap;
                gap: 4px;
            }

            .simple-header h4 {
                margin: 0;
                font-size: 1.1em;
            }

            .date-display {
                font-size: 0.85em;
                color: #333;
                font-weight: 900 !important;
                margin-left: auto;
                white-space: nowrap;
            }

            /* PC: モバイル用日付は非表示 */
            .date-display-mobile {
                display: none !important;
            }

            /* 第1象限をposition:relativeに（モバイル日付の基準点） */
            #section1 {
                position: relative;
            }

            .task-input {
                padding: 5px 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 0.9em;
                margin-bottom: 8px;
            }

            /* 各象限ごとに幅を調整 */
            #input1 {
                width: 254px;
                max-width: 100%;
            }

            #input2 {
                width: 285px;
                max-width: 100%;
            }

            #input3 {
                width: 309px;
                max-width: 100%;
            }

            #input4 {
                width: 438px;
                max-width: 100%;
            }

            .task-input:focus {
                outline: none;
                border-color: #0095f6;
            }

            .task-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .task-item {
                background-color: white;
                padding: 7px 9px;
                margin-bottom: 5px;
                border-radius: 3px;
                display: flex;
                align-items: center;
                cursor: move;
                transition: all 0.2s;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                font-size: 0.88em;
                line-height: 1.4;
            }

            .task-item:hover {
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
                transform: translateY(-1px);
            }

            .task-item.dragging {
                opacity: 0.5;
                cursor: grabbing;
            }

            .task-item.drag-over-top {
                border-top: 3px solid #4caf50;
            }

            .task-item.drag-over-bottom {
                border-bottom: 3px solid #4caf50;
            }

            .task-item.selected-task {
                background-color: #ffa500 !important;
                box-shadow: 0 4px 8px rgba(255, 165, 0, 0.4) !important;
                transform: scale(1.02);
                font-weight: bold;
            }

            .section.drag-over-section {
                background-color: rgba(76, 175, 80, 0.1) !important;
                border-color: #4caf50 !important;
            }

            .task-item.completed {
                text-decoration: line-through;
                text-decoration-color: red;
                text-decoration-thickness: 2px;
            }

            .task-item.completed .task-text {
                text-decoration: line-through;
                text-decoration-color: red;
                text-decoration-thickness: 2px;
            }

            .task-text {
                flex: 1;
                word-break: break-word;
                cursor: pointer;
            }

            .delete-btn {
                color: #333;
                font-size: 1.2em;
                cursor: pointer;
                padding: 0 6px;
                line-height: 1;
            }

            .delete-btn:hover {
                color: #000;
            }

            .escape-btn {
                color: #666;
                font-size: 1em;
                cursor: pointer;
                padding: 0 6px;
                line-height: 1;
                opacity: 0.3;
            }

            .escape-btn:hover {
                color: #ff9800;
                opacity: 1;
            }

            .schedule-btn {
                color: #666;
                font-size: 1em;
                cursor: pointer;
                padding: 0 6px;
                line-height: 1;
                opacity: 0.3;
            }

            .schedule-btn:hover {
                color: #2196f3;
                opacity: 1;
            }

            .edit-task-btn {
                font-size: 1em;
                cursor: pointer;
                padding: 0 6px;
                line-height: 1;
                opacity: 0.15;
                filter: grayscale(100%);
                transition: opacity 0.2s;
            }

            .edit-task-btn:hover {
                opacity: 0.7;
            }

            .task-item:hover .edit-task-btn {
                opacity: 0.5;
            }

            .clear-all-btn {
                padding: 4px 12px;
                background-color: #f0f0f0;
                color: #888;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.75em;
                line-height: 1.4;
                min-height: 24px;
                display: inline-flex;
                align-items: center;
                transition: all 0.2s ease;
            }

            .clear-all-btn:hover {
                background-color: #ffe0e0;
                color: #ff6b6b;
                transform: translateY(-1px);
            }

            .clear-all-btn:active {
                transform: translateY(0) scale(0.97);
            }

            .header-buttons {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }

            .data-btn {
                padding: 4px 12px;
                background-color: #eef6ff;
                color: #4facfe;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.75em;
                line-height: 1.4;
                min-height: 24px;
                display: inline-flex;
                align-items: center;
                transition: all 0.2s ease;
            }

            .data-btn:hover {
                background-color: #dbeeff;
                color: #3b8bdb;
                transform: translateY(-1px);
            }

            .data-btn:active {
                transform: translateY(0) scale(0.97);
            }

            .color-toggle-btn {
                padding: 4px 12px;
                background-color: #f5f0ff;
                color: #a78bfa;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.75em;
                line-height: 1.4;
                min-height: 24px;
                display: inline-flex;
                align-items: center;
                transition: all 0.2s ease;
            }

            .color-toggle-btn:hover {
                background-color: #ede5ff;
                color: #8b5cf6;
                transform: translateY(-1px);
            }

            .color-toggle-btn:active {
                transform: translateY(0) scale(0.97);
            }

            .deep-dive-btn {
                padding: 4px 12px;
                background-color: #f0f0f0;
                color: #888;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.75em;
                margin-right: 6px;
                line-height: 1.4;
                min-height: 24px;
                display: inline-flex;
                align-items: center;
                transition: all 0.2s ease;
            }

            .deep-dive-btn:hover {
                background-color: #e0e0e0;
                color: #555;
                transform: translateY(-1px);
            }

            .deep-dive-btn:active {
                transform: translateY(0) scale(0.97);
            }

            .timer-btn {
                padding: 4px 10px;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
                font-size: 0.8em;
                font-weight: bold;
                white-space: nowrap;
                line-height: 1.5;
                min-height: 28px;
                min-width: 50px;
                display: none; /* 初期状態では非表示 */
                align-items: center;
                justify-content: center;
            }

            /* カスタム確認モーダル */
            .custom-modal {
                display: none;
                position: fixed;
                z-index: 9999;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
            }

            .custom-modal.show {
                display: flex;
                justify-content: center;
                align-items: flex-start;
                padding: 20px;
                overflow-y: auto;
            }

            /* 逃げ出したメッセージ */
            .escape-message {
                display: none;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: white;
                border: 3px solid #333;
                padding: 30px 50px;
                font-size: 1.5em;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            }

            .escape-message.show {
                display: block;
            }

            .modal-content {
                background-color: white;
                padding: 28px;
                border-radius: 16px;
                max-width: 320px;
                width: 90%;
                box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12),
                    0 2px 6px rgba(0, 0, 0, 0.04);
                text-align: center;
                max-height: calc(100vh - 40px);
                overflow-y: auto;
                margin: auto 0;
                /* スクロールバーで角丸が崩れるのを防止 */
                scrollbar-width: thin;
                scrollbar-color: rgba(0, 0, 0, 0.08) transparent;
            }

            /* WebKit系のスクロールバーを目立たなく */
            .modal-content::-webkit-scrollbar {
                width: 4px;
            }
            .modal-content::-webkit-scrollbar-track {
                background: transparent;
                margin: 16px 0;
            }
            .modal-content::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.1);
                border-radius: 4px;
            }
            .modal-content::-webkit-scrollbar-thumb:hover {
                background: rgba(0, 0, 0, 0.18);
            }

            .modal-title {
                font-size: 1.1em;
                font-weight: bold;
                margin-bottom: 15px;
                color: #333;
            }

            .modal-message {
                font-size: 0.95em;
                color: #666;
                margin-bottom: 20px;
                line-height: 1.5;
            }

            .modal-buttons {
                display: flex;
                gap: 8px;
                justify-content: center;
                flex-wrap: nowrap;
            }

            .modal-btn {
                padding: 11px 20px;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                font-size: 0.88em;
                font-weight: 600;
                min-width: 72px;
                white-space: nowrap;
                user-select: none;
                -webkit-user-select: none;
                -webkit-tap-highlight-color: transparent;
                transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1),
                    box-shadow 0.2s ease, opacity 0.15s ease,
                    background-color 0.15s ease;
                position: relative;
                letter-spacing: 0.02em;
            }

            /* hover: バネのように軽く浮く */
            .modal-btn:hover {
                transform: translateY(-1.5px);
            }

            /* active: ぷにっと押し込む感触 */
            .modal-btn:active {
                transform: translateY(0.5px) scale(0.96);
                transition: transform 0.06s ease;
            }

            /* キャンセル - 控えめで優しい */
            .modal-btn-cancel {
                background-color: #f5f5f5;
                color: #777;
                border: none;
            }

            .modal-btn-cancel:hover {
                background-color: #eee;
                color: #555;
            }

            .modal-btn-cancel:active {
                background-color: #e5e5e5;
            }

            /* 全データクリア確認用 */
            .modal-btn-confirm {
                background-color: #ff6b6b;
                color: #fff;
                box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
            }

            .modal-btn-confirm:hover {
                background-color: #ff5252;
                box-shadow: 0 4px 14px rgba(255, 82, 82, 0.35);
            }

            .modal-btn-confirm:active {
                background-color: #f44;
            }

            /* ===== 保存 - やわらかブルー、押したくなる ===== */
            .modal-btn-save {
                background: linear-gradient(180deg, #4facfe 0%, #3b8bdb 100%);
                color: #fff;
                border: none;
                box-shadow: 0 2px 6px rgba(59, 139, 219, 0.25),
                    0 1px 2px rgba(59, 139, 219, 0.15);
            }

            .modal-btn-save:hover {
                box-shadow: 0 4px 14px rgba(59, 139, 219, 0.35),
                    0 1px 3px rgba(59, 139, 219, 0.2);
                background: linear-gradient(180deg, #5ab5ff 0%, #4a9ae8 100%);
            }

            .modal-btn-save:active {
                background: linear-gradient(180deg, #3d96e6 0%, #3080cc 100%);
                box-shadow: 0 1px 3px rgba(59, 139, 219, 0.2);
            }

            /* ===== 削除 - 柔らかい赤、主張しすぎない ===== */
            .modal-btn-delete {
                background-color: transparent;
                color: #ff6b6b;
                border: none;
            }

            .modal-btn-delete:hover {
                background-color: rgba(255, 107, 107, 0.08);
                color: #ff5252;
            }

            .modal-btn-delete:active {
                background-color: rgba(255, 107, 107, 0.15);
            }

            /* ===== プライマリ（設定保存等） ===== */
            .modal-btn-primary {
                background: linear-gradient(180deg, #4facfe 0%, #3b8bdb 100%);
                color: #fff;
                border: none;
                box-shadow: 0 2px 6px rgba(59, 139, 219, 0.25),
                    0 1px 2px rgba(59, 139, 219, 0.15);
            }

            .modal-btn-primary:hover {
                box-shadow: 0 4px 14px rgba(59, 139, 219, 0.35),
                    0 1px 3px rgba(59, 139, 219, 0.2);
                background: linear-gradient(180deg, #5ab5ff 0%, #4a9ae8 100%);
            }

            .modal-btn-primary:active {
                background: linear-gradient(180deg, #3d96e6 0%, #3080cc 100%);
                box-shadow: 0 1px 3px rgba(59, 139, 219, 0.2);
            }

            /* モダンなフォーム要素 */
            .modal-content input[type="text"],
            .modal-content input[type="date"],
            .modal-content input[type="time"],
            .modal-content textarea,
            .modal-content select {
                width: 100%;
                padding: 12px 14px;
                border: 2px solid #e8e8e8;
                border-radius: 10px;
                font-size: 0.95em;
                font-family: inherit;
                background: #fafafa;
                box-sizing: border-box;
                transition: all 0.2s ease;
                outline: none;
            }

            .modal-content input[type="text"]:focus,
            .modal-content input[type="date"]:focus,
            .modal-content input[type="time"]:focus,
            .modal-content textarea:focus,
            .modal-content select:focus {
                border-color: #0095f6;
                background: white;
                box-shadow: 0 0 0 3px rgba(0, 149, 246, 0.08);
            }

            .modal-content input[type="text"]:hover,
            .modal-content input[type="date"]:hover,
            .modal-content input[type="time"]:hover,
            .modal-content textarea:hover,
            .modal-content select:hover {
                border-color: #ccc;
            }

            .modal-content label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                font-size: 0.85em;
                color: #555;
            }

            /* カスタム時間ピッカー（セレクト式） */
            .custom-time-picker {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                padding: 8px 0;
            }

            .time-select {
                appearance: none;
                -webkit-appearance: none;
                background: #fafafa;
                border: 2px solid #e8e8e8;
                border-radius: 10px;
                padding: 12px 32px 12px 16px;
                font-size: 1.2em;
                font-weight: 600;
                color: #333;
                cursor: pointer;
                outline: none;
                transition: all 0.2s ease;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 12px center;
                min-width: 80px;
                text-align: center;
            }

            .time-select:hover {
                border-color: #ccc;
                background-color: #fff;
            }

            .time-select:focus {
                border-color: #0095f6;
                background-color: #fff;
                box-shadow: 0 0 0 3px rgba(0, 149, 246, 0.08);
            }

            .time-separator {
                font-size: 1.5em;
                font-weight: 600;
                color: #333;
            }

            .time-label {
                font-size: 0.75em;
                color: #888;
                margin-top: 4px;
                text-align: center;
            }

            .time-select-wrapper {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .time-clear-btn {
                background: none;
                border: 2px solid #e8e8e8;
                border-radius: 8px;
                cursor: pointer;
                font-size: 0.9em;
                color: #999;
                padding: 10px 12px;
                transition: all 0.2s;
                margin-left: 8px;
            }

            .time-clear-btn:hover {
                color: #f44336;
                border-color: #f44336;
                background: rgba(244, 67, 54, 0.05);
            }

            .day-select-btn {
                padding: 15px;
                border: 1.5px solid #e8e8e8;
                border-radius: 10px;
                background-color: #fff;
                cursor: pointer;
                font-size: 1em;
                font-weight: bold;
                transition: all 0.2s ease;
            }

            .day-select-btn:hover {
                background-color: #eef6ff;
                border-color: #4facfe;
                color: #3b8bdb;
                transform: translateY(-1.5px);
                box-shadow: 0 3px 10px rgba(79, 172, 254, 0.15);
            }

            .day-select-btn:active {
                transform: translateY(0) scale(0.96);
            }

            @media screen and (max-width: 768px) {
                .custom-modal.show {
                    padding-top: 8vh;
                }

                /* スマホ：日付と時間を縦積み */
                .task-edit-datetime {
                    flex-direction: column !important;
                    gap: 8px !important;
                }

                /* スマホ：モーダル内のボタンサイズ調整 */
                .modal-btn {
                    padding: 10px 16px;
                    font-size: 0.85em;
                    min-width: 64px;
                }

                /* スマホ：モーダルのパディング縮小 */
                .modal-content {
                    padding: 20px 16px;
                }
            }

            @media screen and (max-width: 768px) {
                .container {
                    grid-template-columns: 1fr;
                    grid-template-rows: auto auto auto auto;
                    height: auto;
                }

                .section {
                    min-height: 300px;
                }

                /* スマホ版：ヘッダー要素を縦積み */
                .header-row {
                    flex-direction: column;
                    align-items: flex-start !important;
                    gap: 10px;
                }

                .simple-header {
                    flex-direction: column;
                    align-items: flex-start !important;
                    gap: 10px;
                }

                .simple-header > div {
                    flex-direction: column;
                    align-items: flex-start !important;
                    width: 100%;
                }

                /* 目的入力・表示をスマホ幅に */
                .purpose-group {
                    flex-direction: column;
                    align-items: flex-start !important;
                    width: 100%;
                }

                .purpose-group input {
                    width: 100% !important;
                    max-width: 100% !important;
                }

                .purpose-display {
                    flex-direction: column;
                    align-items: flex-start !important;
                    width: 100%;
                }

                /* 止める仕組みをスマホ幅に */
                #stopConditionGroup {
                    flex-direction: column;
                    align-items: flex-start !important;
                    width: 100%;
                }

                #stopConditionGroup input {
                    width: 100% !important;
                    max-width: 100% !important;
                }

                #stopConditionDisplay {
                    flex-direction: column;
                    align-items: flex-start !important;
                    width: 100%;
                }

                /* 日付表示 */
                .date-display {
                    width: 100%;
                    text-align: left;
                }

                /* スマホ縦画面：第1象限の右上に日付を固定表示 */
                .date-display-mobile {
                    display: block !important;
                    position: static;
                    width: 100%;
                    text-align: right;
                    margin: -8px 0 4px 0;
                    font-size: 0.85em;
                }

                /* スマホ：第1象限のh4を幅いっぱいに */
                #section1 .header-row h4 {
                    width: 100%;
                    font-size: 0.95em;
                }

                /* スマホ縦画面：第2象限の日付を非表示 */
                #dateDisplay {
                    display: none !important;
                }
            }

            /* 週間ビュー用CSS（バーチカル） */
            .weekly-view {
                display: none;
                width: 100%;
                height: calc(100vh - 50px);
                overflow: auto;
                padding: 20px;
                padding-top: 0;
                box-sizing: border-box;
                background-color: #f5f5f5;
            }

            .weekly-header {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 20px;
                padding: 12px 0;
                height: 48px;
                box-sizing: border-box;
                background-color: #f5f5f5;
                position: sticky;
                top: 0;
                z-index: 25;
                border-bottom: 1px solid #e0e0e0;
            }

            .weekly-header h2 {
                margin: 0;
                font-size: 1.2em;
                min-width: 150px;
                text-align: center;
            }

            .weekly-container {
                min-width: 100%;
                position: relative;
            }

            /* 週間ビューのスティッキーヘッダー */
            .weekly-container table {
                border-collapse: separate;
                border-spacing: 0;
                width: 100%;
            }

            .weekly-container thead th {
                position: sticky;
                top: 48px;
                z-index: 20;
                background-color: #f5f5f5 !important;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
                border-bottom: 2px solid #ddd !important;
            }

            /* 月間ビュー用CSS */
            .monthly-view {
                display: none;
                width: 100%;
                height: calc(100vh - 50px);
                overflow: auto;
                padding: 20px;
                box-sizing: border-box;
                background-color: #f5f5f5;
            }

            .monthly-header {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 20px;
                margin-bottom: 15px;
            }

            .monthly-header h2 {
                margin: 0;
                font-size: 1.3em;
                min-width: 150px;
                text-align: center;
            }

            .monthly-nav-btn {
                padding: 8px 16px;
                background-color: #f5f5f5;
                color: #666;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 0.9em;
                transition: all 0.2s ease;
            }

            .monthly-nav-btn:hover {
                background-color: #eee;
                color: #444;
                transform: translateY(-1px);
            }

            .monthly-nav-btn:active {
                transform: translateY(0.5px) scale(0.97);
                background-color: #e5e5e5;
            }

            .monthly-calendar {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 1px;
                background-color: #e0e0e0;
                border: 1px solid #e0e0e0;
                min-width: 100%;
            }

            .monthly-weekday-header {
                background-color: #f5f5f5;
                padding: 10px;
                text-align: center;
                font-weight: bold;
                font-size: 0.9em;
            }

            .monthly-weekday-header.saturday {
                background-color: #e3f2fd;
                color: #1976d2;
            }

            .monthly-weekday-header.sunday {
                background-color: #fff3e0;
                color: #e65100;
            }

            .monthly-day-cell {
                background-color: white;
                min-height: 80px;
                /* max-heightはリサイズハンドルで制御 */
                overflow-y: auto;
                overflow-x: hidden;
                padding: 5px;
                vertical-align: top;
                cursor: pointer;
                position: relative;
                /* スクロールバーを細く */
                scrollbar-width: thin;
                scrollbar-color: rgba(0, 0, 0, 0.08) transparent;
            }

            .monthly-day-cell::-webkit-scrollbar {
                width: 3px;
            }
            .monthly-day-cell::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.1);
                border-radius: 3px;
            }

            /* 月間ビューのリサイズハンドル */
            .monthly-resize-handle {
                grid-column: 1 / -1;
                height: 4px;
                background: transparent;
                cursor: ns-resize;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background-color 0.2s ease;
                z-index: 2;
                margin: -2px 0;
            }

            .monthly-resize-handle:hover {
                background: rgba(79, 172, 254, 0.08);
            }

            .monthly-resize-handle:active {
                background: rgba(79, 172, 254, 0.12);
            }

            /* ハンドルのグリップ（つまみ）- hover時だけ表示 */
            .monthly-resize-handle::after {
                content: "";
                width: 24px;
                height: 2px;
                background: rgba(0, 0, 0, 0);
                border-radius: 1px;
                transition: background 0.2s ease, width 0.2s ease;
            }

            .monthly-resize-handle:hover::after {
                background: rgba(0, 0, 0, 0.15);
                width: 32px;
            }

            .monthly-resize-handle:active::after {
                background: #4facfe;
                width: 40px;
            }

            .monthly-day-cell:hover {
                background-color: #fafafa;
            }

            .monthly-day-cell.other-month {
                background-color: #f9f9f9;
                color: #bbb;
            }

            .monthly-day-cell.saturday {
                background-color: #e3f2fd;
            }

            .monthly-day-cell.sunday {
                background-color: #fff3e0;
            }

            .monthly-day-cell.today {
                background-color: #fff9c4;
                box-shadow: inset 0 0 0 2px #fbc02d;
            }

            .monthly-day-number {
                font-weight: bold;
                font-size: 0.85em;
                margin-bottom: 5px;
            }

            .monthly-task-item {
                font-size: 0.75em;
                padding: 2px 4px;
                margin-bottom: 2px;
                border-radius: 2px;
                cursor: grab;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .monthly-task-item:hover {
                opacity: 0.8;
            }

            .monthly-task-item.dragging {
                opacity: 0.5;
                cursor: grabbing;
            }

            .monthly-day-cell.drag-over {
                background-color: #e8f5e9 !important;
                border: 2px dashed #4caf50;
            }

            .monthly-day-cell.holiday {
                background-color: #fff3e0;
            }

            .monthly-day-cell.holiday.saturday {
                background-color: #fff3e0;
            }

            .monthly-holiday-name {
                font-size: 0.65em;
                color: #e65100;
                margin-bottom: 2px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* ===== 年間ビュー（YEARLY PLANNER型）===== */
            .yearly-view {
                display: none;
                width: 100%;
                height: calc(100vh - 50px);
                overflow: auto;
                padding: 10px;
                box-sizing: border-box;
                background-color: #f5f5f5;
            }

            .yearly-header {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 20px;
                margin-bottom: 10px;
            }

            .yearly-header h2 {
                margin: 0;
                font-size: 1.3em;
                min-width: 100px;
                text-align: center;
            }

            .yearly-calendar {
                display: grid;
                grid-template-columns: 30px repeat(12, 1fr);
                gap: 1px;
                background-color: #bbb;
                border: 1px solid #bbb;
                font-size: 0.65em;
            }

            .yearly-header-cell {
                background-color: #e0e0e0;
                padding: 6px 2px;
                text-align: center;
                font-weight: bold;
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .yearly-day-label {
                background-color: #f0f0f0;
                padding: 4px 2px;
                text-align: center;
                font-weight: bold;
                position: sticky;
                left: 0;
                z-index: 5;
            }

            .yearly-cell {
                background-color: #fff;
                padding: 3px 2px;
                min-height: 22px;
                cursor: pointer;
                position: relative;
                text-align: center;
                transition: background-color 0.15s;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 1px;
            }

            .yearly-cell:hover {
                background-color: #e3f2fd;
            }

            .yearly-cell.empty {
                background-color: #f0f0f0;
                color: #ccc;
                cursor: default;
            }

            .yearly-cell.empty:hover {
                background-color: #f0f0f0;
            }

            .yearly-cell.today {
                background-color: #fff59d;
                font-weight: bold;
                box-shadow: inset 0 0 0 2px #ffc107;
            }

            .yearly-cell.saturday {
                background-color: #e3f2fd;
            }

            .yearly-cell.sunday {
                background-color: #fff3e0;
            }

            .yearly-cell.holiday {
                background-color: #fff3e0;
            }

            .yearly-cell.has-task {
                background-color: #c8e6c9;
            }

            .yearly-cell.has-task.saturday {
                background-color: #b2dfdb;
            }

            .yearly-cell.has-task.sunday,
            .yearly-cell.has-task.holiday {
                background-color: #ffccbc;
            }

            .yearly-cell.has-task.today {
                background-color: #aed581;
                box-shadow: inset 0 0 0 2px #8bc34a;
            }

            .yearly-weekday {
                font-size: 0.9em;
                color: #666;
            }

            .yearly-cell.saturday .yearly-weekday {
                color: #1976d2;
                font-weight: bold;
            }

            .yearly-cell.sunday .yearly-weekday,
            .yearly-cell.holiday .yearly-weekday {
                color: #e65100;
                font-weight: bold;
            }

            .yearly-task-count {
                font-size: 0.85em;
                color: #2e7d32;
                font-weight: bold;
                background-color: rgba(255, 255, 255, 0.7);
                border-radius: 50%;
                width: 14px;
                height: 14px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .weekly-container table {
                font-size: 0.9em;
            }

            .weekly-container table th,
            .weekly-container table td {
                min-width: 120px;
            }

            /* スマホ版：週間ビューはスクロール */
            @media screen and (max-width: 768px) {
                .weekly-view {
                    padding: 10px;
                }

                .weekly-header {
                    gap: 10px;
                    padding: 8px 0;
                    height: 40px;
                    font-size: 0.9em;
                }

                .weekly-header h2 {
                    font-size: 1em;
                    min-width: 120px;
                }

                /* スマホでstickyヘッダーのtop位置を再調整 */
                .weekly-container thead th {
                    top: 40px;
                    font-size: 0.7em;
                    padding: 6px 2px !important;
                }

                .weekly-container table {
                    font-size: 0.75em;
                }

                .weekly-container table th {
                    min-width: 60px;
                    padding: 8px 4px !important;
                }

                .weekly-container table td {
                    min-width: 60px;
                    padding: 6px 4px !important;
                    height: 60px !important;
                }

                /* 月間ビューのスマホ対応 */
                .monthly-view {
                    padding: 10px;
                }

                .monthly-header {
                    gap: 10px;
                    flex-wrap: wrap;
                }

                .monthly-header h2 {
                    font-size: 1.1em;
                    min-width: 120px;
                }

                .monthly-nav-btn {
                    padding: 6px 12px;
                    font-size: 0.85em;
                }

                .monthly-day-cell {
                    min-height: 70px;
                    padding: 3px;
                }

                .monthly-day-number {
                    font-size: 0.75em;
                }

                .monthly-holiday-name {
                    font-size: 0.55em;
                }

                .monthly-task-item {
                    font-size: 0.65em;
                    padding: 2px 3px;
                }

                .monthly-weekday-header {
                    padding: 6px 2px;
                    font-size: 0.8em;
                }

                /* 移動モード中のタスクハイライト */
                .monthly-task-item.moving {
                    outline: 2px solid #4caf50;
                    outline-offset: 1px;
                    animation: pulse 1s infinite;
                }

                @keyframes pulse {
                    0%,
                    100% {
                        opacity: 1;
                    }
                    50% {
                        opacity: 0.6;
                    }
                }

                /* 移動先選択中のセル */
                .monthly-day-cell.move-target {
                    background-color: #e8f5e9 !important;
                    cursor: pointer;
                }

                /* ナビタブのスマホ対応 */
                .nav-tabs {
                    padding: 0 8px;
                }

                .nav-tab {
                    padding: 12px 14px;
                    font-size: 0.85em;
                }
            }

            @media print {
                body,
                html {
                    width: 297mm;
                    margin: 0;
                    padding: 0;
                }
                /* ナビタブを印刷時に非表示 */
                .nav-tabs {
                    display: none !important;
                }
                .container {
                    grid-template-columns: 1fr 1fr;
                    grid-template-rows: 1fr 1fr;
                    height: 100vh !important; /* A4に収まるように */
                    min-height: 210mm;
                }
                .section {
                    min-height: 100mm; /* 最低限の高さを確保 */
                    page-break-inside: avoid;
                }
                .task-input {
                    border: none !important;
                }
                .purpose-group {
                    display: none !important; /* 印刷時は入力欄を非表示 */
                }
                .purpose-group label {
                    display: none !important;
                }
                .purpose-group input {
                    display: none !important;
                }
                .purpose-group button {
                    display: none !important;
                }
                /* 印刷時に目的表示を表示（ただし内容がある場合のみ） */
                #purposeDisplay:not([style*="display: none"]):not(
                        [style*="display:none"]
                    ) {
                    display: flex !important;
                    font-size: 0.75em;
                    margin-left: 10px;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    max-width: 400px;
                }
                .purpose-display #purposeText,
                #purposeDisplay #purposeText {
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }
                /* 印刷時に編集ボタンは非表示 */
                .purpose-display .edit-btn,
                #purposeDisplay .edit-btn {
                    display: none !important;
                }
                /* 印刷時にタイマーボタンを非表示 */
                .timer-btn {
                    display: none !important;
                }
                #timerBtn {
                    display: none !important;
                }
                /* 編集ボタンを印刷時に非表示 */
                .edit-btn {
                    display: none !important;
                }
                /* 点検ボタンを印刷時に非表示 */
                .deep-dive-btn {
                    display: none !important;
                }
                /* 止める仕組み：入力欄を非表示 */
                #stopConditionGroup {
                    display: none !important;
                }
                /* 止める仕組み：保存済み表示は表示（ただし内容がある場合のみ） */
                #stopConditionDisplay:not([style*="display: none"]):not(
                        [style*="display:none"]
                    ) {
                    display: flex !important;
                    font-size: 0.75em;
                    white-space: normal;
                    word-wrap: break-word;
                    flex-wrap: wrap;
                }
                #stopConditionDisplay .edit-btn {
                    display: none !important;
                }
                /* 色切替ボタンを印刷時に非表示 */
                .color-toggle-btn {
                    display: none !important;
                }
                /* 全データクリアボタンを印刷時に非表示 */
                .clear-all-btn {
                    display: none !important;
                }
                /* タスクのボタンを印刷時に非表示 */
                .edit-task-btn {
                    display: none !important;
                }
                .escape-btn {
                    display: none !important;
                }
                .schedule-btn {
                    display: none !important;
                }
                .delete-btn {
                    display: none !important;
                }
                /* スクロールバーを印刷時に非表示 */
                .section::-webkit-scrollbar {
                    display: none;
                }
            }

            /* 設定ビュー */
            .settings-view {
                padding: 30px;
                max-width: 600px;
                margin: 0 auto;
            }

            .settings-container {
                background: white;
                border-radius: 12px;
                padding: 32px;
                box-shadow: 0 1px 8px rgba(0, 0, 0, 0.06);
                border: 1px solid #efefef;
            }

            .settings-section {
                margin-bottom: 30px;
            }

            .settings-item {
                margin-bottom: 20px;
            }

            .settings-radio-group {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .settings-radio {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 14px 16px;
                border: 2px solid #e8e8e8;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .settings-radio:hover {
                border-color: #ccc;
                background: #fafafa;
            }

            .settings-radio input[type="radio"] {
                width: 20px;
                height: 20px;
                accent-color: #0095f6;
                cursor: pointer;
            }

            .settings-radio input[type="radio"]:checked + .radio-label {
                color: #0095f6;
                font-weight: bold;
            }

            .settings-radio:has(input:checked) {
                border-color: #0095f6;
                background: rgba(0, 149, 246, 0.03);
            }

            .radio-label {
                font-weight: 600;
                color: #333;
                min-width: 80px;
            }

            .radio-desc {
                font-size: 0.85em;
                color: #888;
            }

            /* プロフィール編集エリア */
            .profile-edit-area {
                display: flex;
                align-items: center;
                gap: 20px;
            }

            .profile-avatar-edit {
                position: relative;
                width: 88px;
                height: 88px;
                border-radius: 50%;
                overflow: visible;
                cursor: pointer;
                background: conic-gradient(
                    from 180deg,
                    #feda75,
                    #fa7e1e,
                    #d62976,
                    #962fbf,
                    #4f5bd5,
                    #feda75
                );
                padding: 3px;
                transition: transform 0.2s ease, box-shadow 0.3s ease;
                flex-shrink: 0;
            }

            .profile-avatar-edit:hover {
                transform: scale(1.05);
                box-shadow: 0 4px 20px rgba(214, 41, 118, 0.35);
            }

            .profile-avatar-edit img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 50%;
                border: 3px solid white;
            }

            .avatar-placeholder {
                width: calc(100% - 6px);
                height: calc(100% - 6px);
                margin: 3px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: #dbdbdb;
                color: #8e8e8e;
                font-size: 2em;
                border-radius: 50%;
            }

            .avatar-edit-overlay {
                position: absolute;
                bottom: 3px;
                left: 3px;
                right: 3px;
                background: rgba(0, 0, 0, 0.6);
                color: white;
                text-align: center;
                font-size: 0.7em;
                padding: 4px 0;
                opacity: 0;
                transition: opacity 0.2s;
                border-radius: 0 0 50% 50%;
            }

            .profile-avatar-edit:hover .avatar-edit-overlay {
                opacity: 1;
            }

            .profile-name-edit {
                flex: 1;
            }

            .avatar-remove-btn {
                margin-top: 10px;
                background: none;
                border: none;
                color: #ed4956;
                font-size: 0.85em;
                cursor: pointer;
                padding: 5px 10px;
                font-weight: 600;
            }

            .avatar-remove-btn:hover {
                opacity: 0.7;
            }

            /* ナビバーのアバター（Instagram風虹色枠 - conic-gradient） */
            .nav-avatar-wrapper {
                position: relative;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background: conic-gradient(
                    from 180deg,
                    #feda75,
                    #fa7e1e,
                    #d62976,
                    #962fbf,
                    #4f5bd5,
                    #feda75
                );
                padding: 2px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }

            .nav-avatar-wrapper:hover {
                transform: scale(1.08);
                box-shadow: 0 2px 12px rgba(214, 41, 118, 0.25);
            }

            /* 設定タブactive時：アバターにグロウエフェクト */
            .nav-tab-settings.active .nav-avatar-wrapper {
                box-shadow: 0 0 0 2px #fff, 0 2px 12px rgba(214, 41, 118, 0.35);
            }

            .nav-avatar {
                width: 26px;
                height: 26px;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid white;
                background: white;
            }

            .nav-tab-settings {
                padding: 6px 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-bottom: 2px solid transparent !important;
            }

            /* 設定アイコン（⚙️）のスタイル */
            #navAvatarPlaceholder {
                font-size: 1.2em;
                transition: transform 0.3s ease;
            }

            .nav-tab-settings:hover #navAvatarPlaceholder {
                transform: rotate(60deg);
            }

            .nav-tab-settings.active #navAvatarPlaceholder {
                transform: rotate(90deg);
            }

            @media (max-width: 600px) {
                .settings-view {
                    padding: 15px;
                }
                .settings-container {
                    padding: 20px;
                }
                .settings-radio {
                    flex-wrap: wrap;
                }
                .radio-desc {
                    width: 100%;
                    margin-left: 32px;
                    margin-top: 4px;
                }
                .profile-edit-area {
                    flex-direction: column;
                    text-align: center;
                }
                .profile-name-edit {
                    width: 100%;
                }
            }
        </style>

        <script>
            // 色の切り替えをCSSに反映
            if (typeof USE_COLORS !== "undefined" && USE_COLORS) {
                document.write(
                    "<style>.section:nth-child(1){background-color:#ffe6e6 !important;}.section:nth-child(2){background-color:#e8f5e9 !important;}.section:nth-child(3){background-color:#fffef5 !important;}.section:nth-child(4){background-color:#f0f0f0 !important;}</style>"
                );
            }
        </script>
    </head>
    <body>
        <!-- ナビゲーションタブ -->
        <div class="nav-tabs">
            <button class="nav-tab" id="navDaily" onclick="switchView('daily')">
                日次
            </button>
            <button
                class="nav-tab"
                id="navWeekly"
                onclick="switchView('weekly')"
            >
                週間
            </button>
            <button
                class="nav-tab active"
                id="navMonthly"
                onclick="switchView('monthly')"
            >
                月間
            </button>
            <button
                class="nav-tab"
                id="navYearly"
                onclick="switchView('yearly')"
            >
                年間
            </button>
            <button
                class="nav-tab nav-tab-settings"
                id="navSettings"
                onclick="switchView('settings')"
            >
                <div
                    class="nav-avatar-wrapper"
                    id="navAvatarWrapper"
                    style="display: none"
                >
                    <img id="navAvatar" src="" alt="" class="nav-avatar" />
                </div>
                <span id="navAvatarPlaceholder">⚙️</span>
            </button>
        </div>

        <div class="container">
            <!-- 左上: 緊急かつ重要 -->
            <div class="section" id="section1">
                <div class="header-row">
                    <h4>やることリスト【緊急かつ重要】</h4>
                    <!-- スマホ縦画面用：日付を第1象限に表示 -->
                    <div
                        class="date-display date-display-mobile"
                        id="dateDisplayMobile"
                    ></div>
                    <div
                        class="purpose-group"
                        id="purposeGroup"
                        style="display: none"
                    >
                        <label>目的:</label>
                        <input
                            type="text"
                            id="purposeInput"
                            placeholder="本質的な目的を一行で入力..."
                        />
                        <button class="edit-btn" onclick="confirmPurpose()">
                            仮決め
                        </button>
                    </div>
                    <div
                        class="purpose-display"
                        id="purposeDisplay"
                        style="display: none"
                    >
                        <span id="purposeText"></span>
                        <button class="edit-btn" onclick="editPurpose()">
                            編集
                        </button>
                    </div>
                    <button
                        class="timer-btn"
                        id="timerBtn"
                        onclick="handleTimerClick()"
                    ></button>
                </div>
                <input
                    type="text"
                    class="task-input"
                    id="input1"
                    placeholder="本質的で今すぐ必要な行動は？..."
                />
                <ul class="task-list" id="list1"></ul>
            </div>

            <!-- 右上: 緊急でないが重要 -->
            <div class="section" id="section2">
                <div class="simple-header">
                    <div
                        style="
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            flex: 1;
                        "
                    >
                        <h4>【緊急でないが重要】</h4>
                        <button
                            class="deep-dive-btn"
                            onclick="toggleDeepDive()"
                        >
                            点検
                        </button>

                        <!-- 止まる仕組み入力 -->
                        <div
                            id="stopConditionGroup"
                            style="display: none; align-items: center; gap: 4px"
                        >
                            <label
                                style="font-size: 0.75em; white-space: nowrap"
                                >止める仕組み:</label
                            >
                            <input
                                type="text"
                                id="stopConditionInput"
                                placeholder="例: 期限3日超過、2週間経過"
                                style="
                                    padding: 3px 6px;
                                    border: 1px solid #ccc;
                                    border-radius: 3px;
                                    font-size: 0.8em;
                                    width: 150px;
                                    max-width: 150px;
                                "
                                onkeydown="if(event.key==='Enter') saveStopCondition();"
                            />
                            <button
                                class="edit-btn"
                                onclick="saveStopCondition()"
                            >
                                仮決め
                            </button>
                        </div>

                        <!-- 止める仕組み表示 -->
                        <div
                            id="stopConditionDisplay"
                            style="
                                display: none;
                                font-size: 0.75em;
                                flex-wrap: wrap;
                                align-items: center;
                                gap: 4px;
                            "
                        >
                            <span style="white-space: nowrap"
                                >止める仕組み:</span
                            >
                            <span
                                id="stopConditionText"
                                style="
                                    font-weight: normal;
                                    word-wrap: break-word;
                                    overflow-wrap: break-word;
                                    flex: 1;
                                    min-width: 0;
                                "
                            ></span>
                            <button
                                class="edit-btn"
                                onclick="editStopCondition()"
                            >
                                編集
                            </button>
                        </div>
                    </div>
                    <div class="date-display" id="dateDisplay"></div>
                </div>
                <div
                    id="deepDiveQuestions"
                    style="
                        display: none;
                        margin-bottom: 10px;
                        font-size: 0.85em;
                        color: #333;
                        line-height: 1.6;
                    "
                >
                    <div
                        style="
                            margin-bottom: 8px;
                            font-weight: bold;
                            color: #d32f2f;
                        "
                    >
                        0. どういうことが起これば、いったん止めて点検するか？<br />
                        （2週間経過、赤字損失1万円、期限超過3日、完了率30%未満）<br />
                        ※数値化して図れ。
                    </div>
                    <div>1. これは、誰の人生に紐づく未完了か?(帰属)</div>
                    <div>2. これの正体は行動か?(真贋)</div>
                    <div>3. これと共に歩む覚悟はあるか?(覚悟)</div>
                    <div>
                        4.
                        覚悟をいつまでに（何をやるか、何時からやるか、いつまでにやるか）と行動に落とし込んだか?<br />
                        開始締め切り、終了締め切り、点検。<br />
                        明日も同じ形で継続できる形になっているか？
                    </div>
                    <div
                        style="
                            margin-top: 8px;
                            font-weight: bold;
                            color: #1976d2;
                        "
                    >
                        5. 最大の敵は、答えを出したくない自分だ。
                    </div>
                    <div
                        style="
                            margin-top: 8px;
                            font-weight: bold;
                            color: #7b1fa2;
                        "
                    >
                        6. 問いの館は崩壊し、お前は今、生まれ変わった。
                    </div>
                    <div
                        style="
                            margin-top: 8px;
                            font-weight: bold;
                            color: #388e3c;
                        "
                    >
                        7. エリクサーは具体的な行動だ！
                    </div>
                </div>
                <input
                    type="text"
                    class="task-input"
                    id="input2"
                    placeholder="本質的な計画行動は？..."
                />
                <ul class="task-list" id="list2"></ul>
            </div>

            <!-- 左下: 緊急だが重要ではない -->
            <div class="section" id="section3">
                <div class="simple-header">
                    <h4>【緊急だが重要ではない】</h4>
                    <button class="color-toggle-btn" onclick="toggleColors()">
                        色切替
                    </button>
                </div>
                <input
                    type="text"
                    class="task-input"
                    id="input3"
                    placeholder="些細だが急ぎの行動は？（人に任せる）..."
                />
                <ul class="task-list" id="list3"></ul>
            </div>

            <!-- 右下: 緊急でも重要でもない -->
            <div class="section" id="section4">
                <div class="simple-header">
                    <h4>【緊急でも重要でもない】</h4>
                    <div class="header-buttons">
                        <button class="data-btn" onclick="exportData()">
                            📤 エクスポート
                        </button>
                        <button
                            class="data-btn"
                            onclick="document.getElementById('importFile').click()"
                        >
                            📥 インポート
                        </button>
                        <input
                            type="file"
                            id="importFile"
                            accept=".json"
                            style="display: none"
                            onchange="importData(event)"
                        />
                        <button class="clear-all-btn" onclick="clearAllData()">
                            🗑️ 全クリア
                        </button>
                    </div>
                </div>
                <input
                    type="text"
                    class="task-input"
                    id="input4"
                    placeholder="些末な事はやらないと決める...視界から外す、スマホ電源切る..."
                />
                <ul class="task-list" id="list4"></ul>
            </div>
        </div>

        <!-- 逃げ出したメッセージ -->
        <div id="escapeMessage" class="escape-message">逃げ出した！</div>

        <!-- 週間タスク追加モーダル -->
        <div id="weeklyTaskModal" class="custom-modal">
            <div
                class="modal-content"
                style="max-width: 450px; max-height: 90vh; overflow-y: auto"
            >
                <h3>週間タスクに追加</h3>
                <div style="margin: 20px 0">
                    <label
                        style="
                            display: block;
                            margin-bottom: 10px;
                            font-weight: bold;
                        "
                        >曜日</label
                    >
                    <div
                        style="
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 10px;
                            margin-bottom: 20px;
                        "
                    >
                        <button class="day-select-btn" data-day="0">月</button>
                        <button class="day-select-btn" data-day="1">火</button>
                        <button class="day-select-btn" data-day="2">水</button>
                        <button class="day-select-btn" data-day="3">木</button>
                        <button class="day-select-btn" data-day="4">金</button>
                        <button class="day-select-btn" data-day="5">土</button>
                        <button class="day-select-btn" data-day="6">日</button>
                    </div>

                    <label
                        style="
                            display: block;
                            margin-bottom: 10px;
                            font-weight: bold;
                        "
                        >時間</label
                    >
                    <select
                        id="weeklyTaskTime"
                        style="
                            width: 100%;
                            padding: 12px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 1em;
                            background-color: white;
                            cursor: pointer;
                        "
                    >
                        <option value="00:00">00:00</option>
                        <option value="00:15">00:15</option>
                        <option value="00:30">00:30</option>
                        <option value="00:45">00:45</option>
                        <option value="01:00">01:00</option>
                        <option value="01:15">01:15</option>
                        <option value="01:30">01:30</option>
                        <option value="01:45">01:45</option>
                        <option value="02:00">02:00</option>
                        <option value="02:15">02:15</option>
                        <option value="02:30">02:30</option>
                        <option value="02:45">02:45</option>
                        <option value="03:00">03:00</option>
                        <option value="03:15">03:15</option>
                        <option value="03:30">03:30</option>
                        <option value="03:45">03:45</option>
                        <option value="04:00">04:00</option>
                        <option value="04:15">04:15</option>
                        <option value="04:30">04:30</option>
                        <option value="04:45">04:45</option>
                        <option value="05:00">05:00</option>
                        <option value="05:15">05:15</option>
                        <option value="05:30">05:30</option>
                        <option value="05:45">05:45</option>
                        <option value="06:00">06:00</option>
                        <option value="06:15">06:15</option>
                        <option value="06:30">06:30</option>
                        <option value="06:45">06:45</option>
                        <option value="07:00">07:00</option>
                        <option value="07:15">07:15</option>
                        <option value="07:30">07:30</option>
                        <option value="07:45">07:45</option>
                        <option value="08:00">08:00</option>
                        <option value="08:15">08:15</option>
                        <option value="08:30">08:30</option>
                        <option value="08:45">08:45</option>
                        <option value="09:00" selected>09:00</option>
                        <option value="09:15">09:15</option>
                        <option value="09:30">09:30</option>
                        <option value="09:45">09:45</option>
                        <option value="10:00">10:00</option>
                        <option value="10:15">10:15</option>
                        <option value="10:30">10:30</option>
                        <option value="10:45">10:45</option>
                        <option value="11:00">11:00</option>
                        <option value="11:15">11:15</option>
                        <option value="11:30">11:30</option>
                        <option value="11:45">11:45</option>
                        <option value="12:00">12:00</option>
                        <option value="12:15">12:15</option>
                        <option value="12:30">12:30</option>
                        <option value="12:45">12:45</option>
                        <option value="13:00">13:00</option>
                        <option value="13:15">13:15</option>
                        <option value="13:30">13:30</option>
                        <option value="13:45">13:45</option>
                        <option value="14:00">14:00</option>
                        <option value="14:15">14:15</option>
                        <option value="14:30">14:30</option>
                        <option value="14:45">14:45</option>
                        <option value="15:00">15:00</option>
                        <option value="15:15">15:15</option>
                        <option value="15:30">15:30</option>
                        <option value="15:45">15:45</option>
                        <option value="16:00">16:00</option>
                        <option value="16:15">16:15</option>
                        <option value="16:30">16:30</option>
                        <option value="16:45">16:45</option>
                        <option value="17:00">17:00</option>
                        <option value="17:15">17:15</option>
                        <option value="17:30">17:30</option>
                        <option value="17:45">17:45</option>
                        <option value="18:00">18:00</option>
                        <option value="18:15">18:15</option>
                        <option value="18:30">18:30</option>
                        <option value="18:45">18:45</option>
                        <option value="19:00">19:00</option>
                        <option value="19:15">19:15</option>
                        <option value="19:30">19:30</option>
                        <option value="19:45">19:45</option>
                        <option value="20:00">20:00</option>
                        <option value="20:15">20:15</option>
                        <option value="20:30">20:30</option>
                        <option value="20:45">20:45</option>
                        <option value="21:00">21:00</option>
                        <option value="21:15">21:15</option>
                        <option value="21:30">21:30</option>
                        <option value="21:45">21:45</option>
                        <option value="22:00">22:00</option>
                        <option value="22:15">22:15</option>
                        <option value="22:30">22:30</option>
                        <option value="22:45">22:45</option>
                        <option value="23:00">23:00</option>
                        <option value="23:15">23:15</option>
                        <option value="23:30">23:30</option>
                        <option value="23:45">23:45</option>
                    </select>
                </div>
                <div
                    style="
                        text-align: right;
                        display: flex;
                        gap: 10px;
                        justify-content: flex-end;
                    "
                >
                    <button
                        class="modal-btn modal-btn-cancel"
                        onclick="closeWeeklyTaskModal()"
                    >
                        キャンセル
                    </button>
                    <button
                        class="modal-btn modal-btn-save"
                        onclick="confirmAddToWeekly()"
                    >
                        追加
                    </button>
                </div>
            </div>
        </div>

        <!-- 週間タスク編集モーダル（再実装） -->
        <div
            id="weeklyTaskEditModal"
            class="custom-modal"
            onclick="if(event.target.id==='weeklyTaskEditModal') closeWeeklyEditModal();"
        >
            <div class="modal-content" style="max-width: 400px">
                <h3>タスク編集</h3>
                <input type="hidden" id="editTaskId" />
                <div style="margin: 15px 0">
                    <label
                        style="
                            display: block;
                            margin-bottom: 8px;
                            font-weight: bold;
                        "
                        >タスク名</label
                    >
                    <input
                        type="text"
                        id="editTaskText"
                        style="
                            width: 100%;
                            padding: 12px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 1em;
                            box-sizing: border-box;
                        "
                        onkeydown="if(event.key==='Enter') saveWeeklyEdit();"
                    />
                </div>
                <div style="margin: 15px 0">
                    <label
                        style="
                            display: block;
                            margin-bottom: 8px;
                            font-weight: bold;
                        "
                        >メモ（任意）</label
                    >
                    <textarea
                        id="editTaskMemo"
                        rows="3"
                        placeholder="詳細や持ち物など..."
                        style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 0.95em;
                            box-sizing: border-box;
                            resize: vertical;
                            font-family: inherit;
                        "
                    ></textarea>
                </div>
                <div style="margin: 15px 0">
                    <label
                        style="
                            display: block;
                            margin-bottom: 8px;
                            font-weight: bold;
                        "
                        >日付</label
                    >
                    <input
                        type="date"
                        id="editTaskDate"
                        style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 1em;
                            box-sizing: border-box;
                        "
                    />
                </div>
                <div style="margin: 15px 0">
                    <label
                        style="
                            display: block;
                            margin-bottom: 8px;
                            font-weight: bold;
                        "
                        >時間</label
                    >
                    <div class="custom-time-picker" id="weeklyEditTimePicker">
                        <div class="time-select-wrapper">
                            <select
                                class="time-select"
                                id="weeklyEditHourSelect"
                            >
                                <option value="">--</option>
                                <option value="0">00</option>
                                <option value="1">01</option>
                                <option value="2">02</option>
                                <option value="3">03</option>
                                <option value="4">04</option>
                                <option value="5">05</option>
                                <option value="6">06</option>
                                <option value="7">07</option>
                                <option value="8">08</option>
                                <option value="9">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                                <option value="15">15</option>
                                <option value="16">16</option>
                                <option value="17">17</option>
                                <option value="18">18</option>
                                <option value="19">19</option>
                                <option value="20">20</option>
                                <option value="21">21</option>
                                <option value="22">22</option>
                                <option value="23">23</option>
                            </select>
                            <div class="time-label">時</div>
                        </div>
                        <span class="time-separator">:</span>
                        <div class="time-select-wrapper">
                            <select
                                class="time-select"
                                id="weeklyEditMinuteSelect"
                            >
                                <option value="">--</option>
                                <option value="0">00</option>
                                <option value="5">05</option>
                                <option value="10">10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                                <option value="25">25</option>
                                <option value="30">30</option>
                                <option value="35">35</option>
                                <option value="40">40</option>
                                <option value="45">45</option>
                                <option value="50">50</option>
                                <option value="55">55</option>
                            </select>
                            <div class="time-label">分</div>
                        </div>
                        <button
                            type="button"
                            class="time-clear-btn"
                            onclick="clearTimeSelect('weeklyEdit')"
                            title="時間をクリア"
                        >
                            ✕
                        </button>
                    </div>
                </div>
                <div style="margin: 15px 0">
                    <label
                        style="
                            display: block;
                            margin-bottom: 8px;
                            font-weight: bold;
                        "
                        >象限</label
                    >
                    <select
                        id="editTaskSection"
                        style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 1em;
                        "
                    >
                        <option value="1">緊急かつ重要</option>
                        <option value="2">緊急でないが重要</option>
                        <option value="3">緊急だが重要ではない</option>
                        <option value="4">緊急でも重要でもない</option>
                    </select>
                </div>
                <div class="modal-buttons" style="margin-top: 20px">
                    <button
                        class="modal-btn modal-btn-cancel"
                        onclick="closeWeeklyEditModal()"
                    >
                        キャンセル
                    </button>
                    <button
                        class="modal-btn modal-btn-delete"
                        onclick="confirmDeleteFromEdit()"
                    >
                        削除
                    </button>
                    <button
                        class="modal-btn modal-btn-save"
                        onclick="saveWeeklyEdit()"
                    >
                        保存
                    </button>
                </div>
            </div>
        </div>

        <!-- 週間タスク作成モーダル -->
        <div
            id="weeklyTaskCreateModal"
            class="custom-modal"
            onclick="if(event.target.id==='weeklyTaskCreateModal') closeCreateModal();"
        >
            <div class="modal-content" style="max-width: 400px">
                <h3>タスク作成</h3>
                <div
                    id="weeklyModalDate"
                    style="
                        text-align: center;
                        color: #666;
                        margin-bottom: 15px;
                        font-size: 0.9em;
                    "
                ></div>
                <div style="margin: 15px 0">
                    <input
                        type="text"
                        id="createTaskText"
                        style="
                            width: 100%;
                            padding: 12px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 1em;
                            box-sizing: border-box;
                        "
                        placeholder="タスクを入力..."
                        onkeydown="if(event.key==='Enter') saveCreateTask();"
                    />
                </div>
                <div style="margin: 15px 0">
                    <label
                        style="
                            display: block;
                            margin-bottom: 8px;
                            font-weight: bold;
                        "
                        >メモ（任意）</label
                    >
                    <textarea
                        id="createTaskMemo"
                        rows="2"
                        placeholder="詳細や持ち物など..."
                        style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 0.95em;
                            box-sizing: border-box;
                            resize: vertical;
                            font-family: inherit;
                        "
                    ></textarea>
                </div>
                <div style="margin: 15px 0">
                    <label
                        style="
                            display: block;
                            margin-bottom: 8px;
                            font-weight: bold;
                        "
                        >時間</label
                    >
                    <select
                        id="createTaskTime"
                        style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 1em;
                        "
                    >
                        <!-- JavaScriptで動的に生成 -->
                    </select>
                </div>
                <div style="margin: 15px 0">
                    <label
                        style="
                            display: block;
                            margin-bottom: 8px;
                            font-weight: bold;
                        "
                        >象限</label
                    >
                    <select
                        id="createTaskSection"
                        style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 1em;
                        "
                    >
                        <option value="1">緊急かつ重要</option>
                        <option value="2" selected>緊急でないが重要</option>
                        <option value="3">緊急だが重要ではない</option>
                        <option value="4">緊急でも重要でもない</option>
                    </select>
                </div>
                <div class="modal-buttons" style="margin-top: 20px">
                    <button
                        class="modal-btn modal-btn-cancel"
                        onclick="closeCreateModal()"
                    >
                        キャンセル
                    </button>
                    <button
                        class="modal-btn modal-btn-save"
                        onclick="saveCreateTask()"
                    >
                        作成
                    </button>
                </div>
            </div>
        </div>

        <!-- 週間ビュー -->
        <div id="weeklyView" class="weekly-view">
            <div class="weekly-header">
                <button class="monthly-nav-btn" onclick="changeWeek(-1)">
                    ◀ 先週
                </button>
                <h2 id="weeklyTitle"></h2>
                <button class="monthly-nav-btn" onclick="changeWeek(1)">
                    来週 ▶
                </button>
            </div>
            <div class="weekly-container" id="weeklyContainer">
                <!-- JavaScriptで動的に生成 -->
            </div>
        </div>

        <!-- 月間ビュー -->
        <div id="monthlyView" class="monthly-view">
            <div class="monthly-header" style="position: relative">
                <span
                    id="seasonalArt"
                    style="
                        display: none;
                        position: absolute;
                        left: 8px;
                        top: -5px;
                        font-size: 2.2em;
                        line-height: 1;
                        filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.1));
                    "
                ></span>
                <button class="monthly-nav-btn" onclick="changeMonth(-1)">
                    ◀ 先月
                </button>
                <h2 id="monthlyTitle"></h2>
                <button class="monthly-nav-btn" onclick="changeMonth(1)">
                    来月 ▶
                </button>
            </div>
            <div
                style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin-bottom: 8px;
                    justify-content: flex-end;
                "
            >
                <span style="font-size: 0.75em; color: #999">↔ 幅</span>
                <input
                    type="range"
                    id="monthlyWidthSlider"
                    min="100"
                    max="300"
                    value="100"
                    style="width: 100px; accent-color: #4facfe; cursor: pointer"
                    oninput="adjustMonthlyWidth(this.value)"
                />
                <button
                    onclick="resetMonthlyWidth()"
                    style="
                        font-size: 0.7em;
                        color: #999;
                        background: none;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        padding: 2px 6px;
                        cursor: pointer;
                    "
                >
                    リセット
                </button>
            </div>
            <div id="monthlyCalendar" class="monthly-calendar">
                <!-- JavaScriptで動的に生成 -->
            </div>

            <!-- シンプルモード：スタンプバー -->
            <div
                id="stampBar"
                style="
                    display: none;
                    position: sticky;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    background: #fff;
                    border-top: 2px solid #eee;
                    padding: 8px 10px;
                    z-index: 30;
                    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.08);
                "
            >
                <div
                    style="
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        overflow-x: auto;
                        padding-bottom: 4px;
                        -webkit-overflow-scrolling: touch;
                    "
                >
                    <div
                        id="stampButtons"
                        style="display: flex; gap: 6px; flex-shrink: 0"
                    ></div>
                    <div
                        style="
                            display: flex;
                            gap: 6px;
                            flex-shrink: 0;
                            margin-left: 8px;
                            padding-left: 8px;
                            border-left: 2px solid #eee;
                        "
                    >
                        <button
                            onclick="selectMemoType('work')"
                            id="memoWorkBtn"
                            style="
                                padding: 6px 10px;
                                border-radius: 16px;
                                border: 2px solid #78909c;
                                background: #fff;
                                font-size: 0.8em;
                                cursor: pointer;
                                white-space: nowrap;
                                transition: all 0.2s;
                            "
                        >
                            ■ 仕事メモ
                        </button>
                        <button
                            onclick="selectMemoType('private')"
                            id="memoPrivateBtn"
                            style="
                                padding: 6px 10px;
                                border-radius: 16px;
                                border: 2px solid #ffa726;
                                background: #fff;
                                font-size: 0.8em;
                                cursor: pointer;
                                white-space: nowrap;
                                transition: all 0.2s;
                            "
                        >
                            ★ プライベート
                        </button>
                        <button
                            onclick="clearStampSelection()"
                            id="stampClearBtn"
                            style="
                                padding: 6px 10px;
                                border-radius: 16px;
                                border: 2px solid #e0e0e0;
                                background: #f5f5f5;
                                font-size: 0.8em;
                                cursor: pointer;
                                white-space: nowrap;
                            "
                        >
                            ✕ 解除
                        </button>
                    </div>
                </div>
                <div
                    id="stampSelectionInfo"
                    style="
                        text-align: center;
                        font-size: 0.75em;
                        color: #999;
                        margin-top: 4px;
                    "
                >
                    スタンプを選んで、カレンダーの日付をタップ
                </div>
            </div>
        </div>

        <!-- 年間ビュー（YEARLY PLANNER型） -->
        <div id="yearlyView" class="yearly-view" style="display: none">
            <div class="yearly-header">
                <button class="monthly-nav-btn" onclick="changeYear(-1)">
                    ◀ 去年
                </button>
                <h2 id="yearlyTitle"></h2>
                <button class="monthly-nav-btn" onclick="changeYear(1)">
                    来年 ▶
                </button>
            </div>
            <div id="yearlyCalendar" class="yearly-calendar">
                <!-- JavaScriptで動的に生成 -->
            </div>
        </div>

        <!-- 設定ビュー -->
        <div id="settingsView" class="settings-view" style="display: none">
            <div class="settings-container">
                <h2
                    style="
                        margin: 0 0 30px 0;
                        color: #262626;
                        font-size: 1.4em;
                        font-weight: 700;
                        letter-spacing: -0.01em;
                    "
                >
                    設定
                </h2>

                <!-- プロフィールセクション -->
                <div class="settings-section">
                    <h3
                        style="
                            margin: 0 0 20px 0;
                            color: #262626;
                            font-size: 1.05em;
                            font-weight: 600;
                            border-bottom: 1px solid #efefef;
                            padding-bottom: 12px;
                        "
                    >
                        プロフィール
                    </h3>
                    <div class="settings-item">
                        <div class="profile-edit-area">
                            <div
                                class="profile-avatar-edit"
                                onclick="document.getElementById('avatarInput').click()"
                            >
                                <img
                                    id="profileAvatarPreview"
                                    src=""
                                    alt="avatar"
                                    style="display: none"
                                />
                                <div
                                    id="profileAvatarPlaceholder"
                                    class="avatar-placeholder"
                                >
                                    📷
                                </div>
                                <div class="avatar-edit-overlay">変更</div>
                            </div>
                            <input
                                type="file"
                                id="avatarInput"
                                accept="image/*"
                                style="display: none"
                                onchange="handleAvatarChange(event)"
                            />
                            <div class="profile-name-edit">
                                <label
                                    style="
                                        display: block;
                                        margin-bottom: 8px;
                                        font-weight: 600;
                                        color: #262626;
                                        font-size: 0.9em;
                                    "
                                    >表示名</label
                                >
                                <input
                                    type="text"
                                    id="profileNameInput"
                                    placeholder="あなたの名前..."
                                    maxlength="20"
                                    style="
                                        width: 100%;
                                        padding: 12px;
                                        border: 2px solid #e8e8e8;
                                        border-radius: 10px;
                                        font-size: 1em;
                                        box-sizing: border-box;
                                    "
                                />
                            </div>
                        </div>
                        <button
                            class="avatar-remove-btn"
                            id="avatarRemoveBtn"
                            onclick="removeAvatar()"
                            style="display: none"
                        >
                            アイコンを削除
                        </button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3
                        style="
                            margin: 0 0 15px 0;
                            color: #262626;
                            font-size: 1.05em;
                            font-weight: 600;
                            border-bottom: 1px solid #efefef;
                            padding-bottom: 12px;
                        "
                    >
                        初期表示
                    </h3>
                    <div class="settings-item">
                        <label
                            style="
                                display: block;
                                margin-bottom: 8px;
                                font-weight: 600;
                                color: #262626;
                                font-size: 0.9em;
                            "
                            >アプリ起動時のビュー</label
                        >
                        <p
                            style="
                                margin: 0 0 12px 0;
                                font-size: 0.85em;
                                color: #8e8e8e;
                            "
                        >
                            アプリを開いたときに最初に表示するビューを選択します
                        </p>
                        <div class="settings-radio-group" id="initialViewGroup">
                            <label class="settings-radio">
                                <input
                                    type="radio"
                                    name="initialView"
                                    value="daily"
                                />
                                <span class="radio-label">📅 日次</span>
                                <span class="radio-desc"
                                    >今日のタスクに集中</span
                                >
                            </label>
                            <label class="settings-radio">
                                <input
                                    type="radio"
                                    name="initialView"
                                    value="weekly"
                                />
                                <span class="radio-label">📊 週間</span>
                                <span class="radio-desc"
                                    >1週間のスケジュールを確認</span
                                >
                            </label>
                            <label class="settings-radio">
                                <input
                                    type="radio"
                                    name="initialView"
                                    value="monthly"
                                    checked
                                />
                                <span class="radio-label">🗓️ 月間</span>
                                <span class="radio-desc"
                                    >月全体を俯瞰して把握</span
                                >
                            </label>
                            <label class="settings-radio">
                                <input
                                    type="radio"
                                    name="initialView"
                                    value="yearly"
                                />
                                <span class="radio-label">📆 年間</span>
                                <span class="radio-desc">年間計画を確認</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 月間表示モード -->
                <div
                    style="
                        margin-top: 24px;
                        border-top: 1px solid #efefef;
                        padding-top: 18px;
                    "
                >
                    <h3
                        style="
                            margin: 0 0 15px 0;
                            color: #262626;
                            font-size: 1.05em;
                            font-weight: 600;
                            border-bottom: 1px solid #efefef;
                            padding-bottom: 12px;
                        "
                    >
                        月間ビュー
                    </h3>
                    <div>
                        <label
                            style="
                                display: block;
                                margin-bottom: 8px;
                                font-weight: 600;
                                color: #262626;
                                font-size: 0.9em;
                            "
                            >表示モード</label
                        >
                        <p
                            style="
                                font-size: 0.8em;
                                color: #8e8e8e;
                                margin: 0 0 10px 0;
                            "
                        >
                            セルの高さの挙動を選択します
                        </p>
                        <div class="settings-radio-group" id="monthlyModeGroup">
                            <label class="settings-radio-label">
                                <input
                                    type="radio"
                                    name="monthlyMode"
                                    value="fixed"
                                    checked
                                />
                                <span>📐 固定高さ</span>
                                <span
                                    style="
                                        font-size: 0.75em;
                                        color: #8e8e8e;
                                        margin-left: 8px;
                                    "
                                    >コンパクト表示</span
                                >
                            </label>
                            <label class="settings-radio-label">
                                <input
                                    type="radio"
                                    name="monthlyMode"
                                    value="expand"
                                />
                                <span>📖 全タスク表示</span>
                                <span
                                    style="
                                        font-size: 0.75em;
                                        color: #8e8e8e;
                                        margin-left: 8px;
                                    "
                                    >全文判読可能</span
                                >
                            </label>
                        </div>
                    </div>
                </div>

                <!-- シンプルモード -->
                <div
                    style="
                        margin-top: 24px;
                        border-top: 1px solid #efefef;
                        padding-top: 18px;
                    "
                >
                    <h3
                        style="
                            margin: 0 0 15px 0;
                            color: #262626;
                            font-size: 1.05em;
                            font-weight: 600;
                            border-bottom: 1px solid #efefef;
                            padding-bottom: 12px;
                        "
                    >
                        🩺 シンプルモード
                    </h3>
                    <p
                        style="
                            font-size: 0.8em;
                            color: #8e8e8e;
                            margin: 0 0 12px 0;
                        "
                    >
                        シフト管理に特化したシンプル画面。スタンプをタップ→日付をタップで入力。
                    </p>
                    <div
                        style="
                            display: flex;
                            align-items: center;
                            gap: 12px;
                            margin-bottom: 16px;
                        "
                    >
                        <label
                            style="
                                font-weight: 600;
                                color: #262626;
                                font-size: 0.9em;
                            "
                            >シンプルモード</label
                        >
                        <label
                            style="
                                position: relative;
                                display: inline-block;
                                width: 50px;
                                height: 26px;
                                cursor: pointer;
                            "
                        >
                            <input
                                type="checkbox"
                                id="simpleModeToggle"
                                style="opacity: 0; width: 0; height: 0"
                                onchange="toggleSimpleModePreview(this.checked)"
                            />
                            <span
                                style="
                                    position: absolute;
                                    cursor: pointer;
                                    top: 0;
                                    left: 0;
                                    right: 0;
                                    bottom: 0;
                                    background-color: #ccc;
                                    border-radius: 26px;
                                    transition: 0.3s;
                                "
                                id="simpleToggleSlider"
                            ></span>
                            <span
                                style="
                                    position: absolute;
                                    content: '';
                                    height: 20px;
                                    width: 20px;
                                    left: 3px;
                                    bottom: 3px;
                                    background-color: white;
                                    border-radius: 50%;
                                    transition: 0.3s;
                                    pointer-events: none;
                                "
                                id="simpleToggleKnob"
                            ></span>
                        </label>
                    </div>

                    <!-- スタンプ設定 -->
                    <div id="stampSettingsArea" style="display: none">
                        <label
                            style="
                                display: block;
                                margin-bottom: 8px;
                                font-weight: 600;
                                color: #262626;
                                font-size: 0.9em;
                            "
                            >スタンプ設定</label
                        >
                        <p
                            style="
                                font-size: 0.8em;
                                color: #8e8e8e;
                                margin: 0 0 10px 0;
                            "
                        >
                            最大20個。名前・色・時間帯を設定できます。
                        </p>
                        <div id="stampList" style="margin-bottom: 12px"></div>
                        <button
                            onclick="addStampSetting()"
                            style="
                                background: linear-gradient(
                                    135deg,
                                    #4facfe 0%,
                                    #00f2fe 100%
                                );
                                color: white;
                                border: none;
                                border-radius: 8px;
                                padding: 8px 16px;
                                font-size: 0.85em;
                                cursor: pointer;
                            "
                        >
                            ＋ スタンプ追加
                        </button>
                    </div>
                </div>

                <div
                    class="settings-actions"
                    style="margin-top: 30px; text-align: center"
                >
                    <button
                        class="modal-btn modal-btn-primary"
                        style="
                            padding: 14px 40px;
                            font-size: 1em;
                            border-radius: 12px;
                        "
                        onclick="saveSettings()"
                    >
                        設定を保存
                    </button>
                </div>
            </div>
        </div>

        <!-- 月間タスク追加/編集モーダル -->
        <div
            id="monthlyTaskModal"
            class="custom-modal"
            onclick="if(event.target.id==='monthlyTaskModal') closeMonthlyTaskModal();"
        >
            <div class="modal-content" style="max-width: 400px">
                <h3 id="monthlyModalTitle">タスク追加</h3>
                <input type="hidden" id="monthlyTaskId" />
                <div style="margin: 15px 0">
                    <label
                        style="
                            display: block;
                            margin-bottom: 8px;
                            font-weight: bold;
                        "
                        >タスク名</label
                    >
                    <input
                        type="text"
                        id="monthlyTaskInput"
                        placeholder="タスクを入力..."
                        style="
                            width: 100%;
                            padding: 12px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 1em;
                            box-sizing: border-box;
                        "
                        onkeydown="if(event.key==='Enter') saveMonthlyTask();"
                    />
                </div>
                <div style="margin: 15px 0">
                    <label
                        style="
                            display: block;
                            margin-bottom: 8px;
                            font-weight: bold;
                        "
                        >メモ（任意）</label
                    >
                    <textarea
                        id="monthlyTaskMemo"
                        rows="3"
                        placeholder="詳細や持ち物など..."
                        style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 0.95em;
                            box-sizing: border-box;
                            resize: vertical;
                            font-family: inherit;
                        "
                    ></textarea>
                </div>
                <div style="margin: 15px 0">
                    <label
                        style="
                            display: block;
                            margin-bottom: 8px;
                            font-weight: bold;
                        "
                        >日付</label
                    >
                    <input
                        type="date"
                        id="monthlyTaskDate"
                        style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 1em;
                            box-sizing: border-box;
                        "
                    />
                </div>
                <div style="margin: 15px 0">
                    <label
                        style="
                            display: block;
                            margin-bottom: 8px;
                            font-weight: bold;
                        "
                        >時間（任意）</label
                    >
                    <div class="custom-time-picker" id="monthlyTimePicker">
                        <div class="time-select-wrapper">
                            <select class="time-select" id="monthlyHourSelect">
                                <option value="">--</option>
                                <option value="0">00</option>
                                <option value="1">01</option>
                                <option value="2">02</option>
                                <option value="3">03</option>
                                <option value="4">04</option>
                                <option value="5">05</option>
                                <option value="6">06</option>
                                <option value="7">07</option>
                                <option value="8">08</option>
                                <option value="9">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                                <option value="15">15</option>
                                <option value="16">16</option>
                                <option value="17">17</option>
                                <option value="18">18</option>
                                <option value="19">19</option>
                                <option value="20">20</option>
                                <option value="21">21</option>
                                <option value="22">22</option>
                                <option value="23">23</option>
                            </select>
                            <div class="time-label">時</div>
                        </div>
                        <span class="time-separator">:</span>
                        <div class="time-select-wrapper">
                            <select
                                class="time-select"
                                id="monthlyMinuteSelect"
                            >
                                <option value="">--</option>
                                <option value="0">00</option>
                                <option value="5">05</option>
                                <option value="10">10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                                <option value="25">25</option>
                                <option value="30">30</option>
                                <option value="35">35</option>
                                <option value="40">40</option>
                                <option value="45">45</option>
                                <option value="50">50</option>
                                <option value="55">55</option>
                            </select>
                            <div class="time-label">分</div>
                        </div>
                        <button
                            type="button"
                            class="time-clear-btn"
                            onclick="clearTimeSelect('monthly')"
                            title="時間をクリア"
                        >
                            ✕
                        </button>
                    </div>
                    <div
                        style="font-size: 0.75em; color: #888; margin-top: 4px"
                    >
                        ※時間を設定すると週間ビューにも表示されます
                    </div>
                </div>
                <div style="margin: 15px 0">
                    <label
                        style="
                            display: block;
                            margin-bottom: 8px;
                            font-weight: bold;
                        "
                        >象限</label
                    >
                    <select
                        id="monthlyTaskSection"
                        style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 1em;
                        "
                    >
                        <option value="1">緊急かつ重要</option>
                        <option value="2">緊急でないが重要</option>
                        <option value="3">緊急だが重要ではない</option>
                        <option value="4">緊急でも重要でもない</option>
                    </select>
                </div>
                <div class="modal-buttons" style="margin-top: 20px">
                    <button
                        class="modal-btn modal-btn-cancel"
                        onclick="closeMonthlyTaskModal()"
                    >
                        キャンセル
                    </button>
                    <button
                        id="monthlyDeleteBtn"
                        class="modal-btn modal-btn-delete"
                        style="display: none"
                        onclick="deleteMonthlyTask()"
                    >
                        削除
                    </button>
                    <button
                        class="modal-btn modal-btn-save"
                        onclick="saveMonthlyTask()"
                    >
                        保存
                    </button>
                </div>
            </div>
        </div>

        <script>
            /**
             * ============================================================
             * やることリスト - GTDアプリケーション
             * ============================================================
             *
             * アーキテクチャ概要：
             *
             * 1. データ層（Single Source of Truth）
             *    - allTasks[]: 全タスクの唯一のデータソース
             *    - 各タスクは表示フラグで「どこに表示するか」を制御
             *    - データ重複を完全に排除
             *
             * 2. ビュー層（責務の分離）
             *    - 日次ビュー: getDailyTasks() でフィルター
             *    - 週間ビュー: getWeeklyTasks() でフィルター
             *    - 月次ビュー: getMonthlyTasks() でフィルター（将来）
             *    - 年次ビュー: getYearlyTasks() でフィルター（将来）
             *    - 2年/3年/4年/5年ビュー: 長期目標管理（将来）
             *
             * 3. CRUD操作
             *    - createTask(): タスク作成
             *    - updateTask(): タスク更新（全ビューに自動反映）
             *    - deleteTask(): タスク削除（全ビューから自動削除）
             *
             * 4. 双方向同期
             *    - 日次で編集 → 週間に自動反映
             *    - 週間で編集 → 日次に自動反映
             *    - 象限移動 → 色も自動変更
             *
             * 5. 象限と色の対応
             *    - 象限1（緊急かつ重要）: 赤 (#ffe6e6)
             *    - 象限2（緊急だが重要でない）: 緑 (#e8f5e9)
             *    - 象限3（重要だが緊急でない）: 黄 (#fffef5)
             *    - 象限4（緊急でも重要でもない）: グレー (#f0f0f0)
             *
             * 6. 拡張性
             *    - 新しいビュー追加: フラグ追加 + フィルター関数追加
             *    - データ構造変更不要
             *    - 既存機能に影響なし
             */

            // データ保存用
            let purpose = "";
            let purposeConfirmed = false;
            let stopCondition = "";
            let stopConditionSaved = false;

            // ローカル日付をYYYY-MM-DD形式で取得（タイムゾーン問題を回避）
            function getLocalDateStr(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, "0");
                const day = String(date.getDate()).padStart(2, "0");
                return `${year}-${month}-${day}`;
            }
            let tasks = {
                1: [],
                2: [],
                3: [],
                4: [],
            };

            // 逃げログ用
            let escapeLog = [];

            // 週間タスク用（日付ごとの時間付きタスク）
            let weeklyTasks = {};
            // 構造: { '2026-02-03': [{ text: 'タスク', time: '09:00', completed: false }, ...], ... }

            // 1分タイマー用
            let timerState = "idle"; // idle, thinking, imagine, writing, selecting, executing, complete, pomodoro, pomodoroBreak, pomodoroComplete
            let timeLeft = 60;
            let timerInterval = null;
            let selectedTaskText = null; // 選択されたタスクのテキスト
            let pomodoroCount = 0; // ポモドーロのセット数（最大12）

            // 週間タスク追加モーダル用
            let pendingScheduleTask = null; // { sectionNum, taskText }
            let selectedWeekday = null; // 0-6 (月-日)

            // 週間タスク編集用
            let editingTask = null; // { dateStr, index }
            let creatingTask = null; // { dateStr, hour }

            // 月間ビュー用
            let currentMonthDate = new Date(); // 表示中の月
            let movingTaskId = null; // スマホ用：移動中のタスクID

            // 週間ビュー用
            let currentWeekDate = new Date(); // 表示中の週の基準日

            // 年間ビュー用
            let currentYearDate = new Date(); // 表示中の年

            // 日次ビュー用
            let currentDailyDate = null; // 表示中の日（nullなら今日）

            // 日本の祝日データ（2024-2027年）
            const japaneseHolidays = {
                // 2024年
                "2024-01-01": "元日",
                "2024-01-08": "成人の日",
                "2024-02-11": "建国記念の日",
                "2024-02-12": "振替休日",
                "2024-02-23": "天皇誕生日",
                "2024-03-20": "春分の日",
                "2024-04-29": "昭和の日",
                "2024-05-03": "憲法記念日",
                "2024-05-04": "みどりの日",
                "2024-05-05": "こどもの日",
                "2024-05-06": "振替休日",
                "2024-07-15": "海の日",
                "2024-08-11": "山の日",
                "2024-08-12": "振替休日",
                "2024-09-16": "敬老の日",
                "2024-09-22": "秋分の日",
                "2024-09-23": "振替休日",
                "2024-10-14": "スポーツの日",
                "2024-11-03": "文化の日",
                "2024-11-04": "振替休日",
                "2024-11-23": "勤労感謝の日",
                // 2025年
                "2025-01-01": "元日",
                "2025-01-13": "成人の日",
                "2025-02-11": "建国記念の日",
                "2025-02-23": "天皇誕生日",
                "2025-02-24": "振替休日",
                "2025-03-20": "春分の日",
                "2025-04-29": "昭和の日",
                "2025-05-03": "憲法記念日",
                "2025-05-04": "みどりの日",
                "2025-05-05": "こどもの日",
                "2025-05-06": "振替休日",
                "2025-07-21": "海の日",
                "2025-08-11": "山の日",
                "2025-09-15": "敬老の日",
                "2025-09-23": "秋分の日",
                "2025-10-13": "スポーツの日",
                "2025-11-03": "文化の日",
                "2025-11-23": "勤労感謝の日",
                "2025-11-24": "振替休日",
                // 2026年
                "2026-01-01": "元日",
                "2026-01-12": "成人の日",
                "2026-02-11": "建国記念の日",
                "2026-02-23": "天皇誕生日",
                "2026-03-20": "春分の日",
                "2026-04-29": "昭和の日",
                "2026-05-03": "憲法記念日",
                "2026-05-04": "みどりの日",
                "2026-05-05": "こどもの日",
                "2026-05-06": "振替休日",
                "2026-07-20": "海の日",
                "2026-08-11": "山の日",
                "2026-09-21": "敬老の日",
                "2026-09-22": "国民の休日",
                "2026-09-23": "秋分の日",
                "2026-10-12": "スポーツの日",
                "2026-11-03": "文化の日",
                "2026-11-23": "勤労感謝の日",
                // 2027年
                "2027-01-01": "元日",
                "2027-01-11": "成人の日",
                "2027-02-11": "建国記念の日",
                "2027-02-23": "天皇誕生日",
                "2027-03-21": "春分の日",
                "2027-03-22": "振替休日",
                "2027-04-29": "昭和の日",
                "2027-05-03": "憲法記念日",
                "2027-05-04": "みどりの日",
                "2027-05-05": "こどもの日",
                "2027-07-19": "海の日",
                "2027-08-11": "山の日",
                "2027-09-20": "敬老の日",
                "2027-09-23": "秋分の日",
                "2027-10-11": "スポーツの日",
                "2027-11-03": "文化の日",
                "2027-11-23": "勤労感謝の日",
            };

            function getHoliday(dateStr) {
                return japaneseHolidays[dateStr] || null;
            }

            // ===== マスターデータ（Single Source of Truth） =====
            /**
             * allTasks: 全タスクの唯一のデータソース
             *
             * 設計思想：
             * - 1つのタスクは1つのオブジェクトとして管理
             * - 表示フラグで「どのビューに表示するか」を制御
             * - データ重複を完全に排除
             * - 双方向同期を自動的に実現
             *
             * メリット：
             * 1. 編集・削除が確実に全ビューに反映される
             * 2. データ不整合が発生しない
             * 3. 新しいビュー追加が容易（フラグ追加だけ）
             * 4. デバッグが容易（データが1箇所）
             *
             * ID管理：
             * - UUID v4を使用（RFC 4122準拠）
             * - 128ビットの一意識別子
             * - 衝突確率: 実質ゼロ（10^-15）
             * - 複数タブ・複数デバイスでも安全
             * - 富士通ジャパンのマイナンバーカード問題を回避
             *
             * ビュー別フラグの使い方：
             * - showInDaily: 日次ビューに表示
             * - showInWeekly: 週間バーチカルに表示
             *
             * 注意：
             * - 月間/年間ビューはdateフィールドで直接フィルタ（フラグ不要）
             */
            let allTasks = []; // 全タスクの唯一のデータソース
            let taskIdCounter = 1; // 互換性のため保持（実際はUUIDを使用）

            // 初期データ（テストデータ54件 - 大学3年生・マックバイト・彼氏あり）
            const INITIAL_DATA = [
                {
                    id: "58c3b5d3-3dab-468e-b94d-644ad8ff2b67",
                    text: "熱力学の宿題",
                    date: "2026-02-09",
                    time: "10:00",
                    section: 1,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "6db44052-8f93-481c-bd68-9d62ded414c0",
                    text: "おばあちゃん家 様子見",
                    date: "2026-02-09",
                    time: "14:00",
                    section: 1,
                    order: 1,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "965653ab-a245-461f-99a5-efe137002ab4",
                    text: "めし",
                    date: "2026-02-09",
                    time: "12:00",
                    section: 2,
                    order: 0,
                    completed: true,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "01bf2de0-1d4f-493b-a62e-ce52f255ea16",
                    text: "洗濯",
                    date: "2026-02-09",
                    time: "09:00",
                    section: 2,
                    order: 1,
                    completed: true,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "3c916322-2347-43ff-ace2-f284d0b60c1f",
                    text: "LINE返す",
                    date: "2026-02-09",
                    time: "20:00",
                    section: 3,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "5b60a61c-803c-42d1-9208-15e500884b35",
                    text: "Netflix",
                    date: "2026-02-09",
                    time: "22:00",
                    section: 4,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "54267021-2c61-43f1-b554-be7f01f41a30",
                    text: "材料力学 2限",
                    date: "2026-02-10",
                    time: "10:30",
                    section: 2,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "6b698034-60d9-4825-a2e2-86a0681a676f",
                    text: "熱力学レポート提出",
                    date: "2026-02-10",
                    time: "23:59",
                    section: 1,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "d2b7ce67-23e0-42f5-84b2-7f9126258398",
                    text: "マック 17:00-22:00",
                    date: "2026-02-10",
                    time: "17:00",
                    section: 2,
                    order: 1,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "36612121-39ac-4d7c-b0cf-6c310a6e9045",
                    text: "新人トレーニング 佐藤さん",
                    date: "2026-02-10",
                    time: "18:00",
                    section: 1,
                    order: 1,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "68e1d1ea-89e1-4552-bde9-305d3544d0f1",
                    text: "めし",
                    date: "2026-02-10",
                    time: "12:00",
                    section: 2,
                    order: 2,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "2a6a6f00-8bae-41c8-8421-499cdf0fcf7c",
                    text: "おばあちゃん病院付き添い 横浜市大",
                    date: "2026-02-11",
                    time: "10:00",
                    section: 1,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "2d5d4e32-05aa-4d42-bcc2-1111ecc31761",
                    text: "ケアマネさん電話",
                    date: "2026-02-11",
                    time: "15:00",
                    section: 1,
                    order: 1,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "8369e595-04d8-4ef5-849b-b3b8e1c28f7e",
                    text: "薬局 処方箋",
                    date: "2026-02-11",
                    time: "12:00",
                    section: 2,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "e24e5245-7517-46ca-81d8-b9d2e9ddf8ea",
                    text: "部屋掃除",
                    date: "2026-02-11",
                    time: "16:00",
                    section: 4,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "42e13b28-a103-4b20-a755-647a405a7f64",
                    text: "研究室ゼミ 発表",
                    date: "2026-02-12",
                    time: "14:00",
                    section: 1,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "35fbff5f-bd46-4579-81f7-f6a8405590ba",
                    text: "ゼミ発表スライド最終確認",
                    date: "2026-02-12",
                    time: "09:00",
                    section: 1,
                    order: 1,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "28bc4e34-dd30-4486-95bd-7a4ffd509d1c",
                    text: "マック 17:00-21:00",
                    date: "2026-02-12",
                    time: "17:00",
                    section: 2,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "b6435ad1-fb20-4a17-9a50-295d6360eb63",
                    text: "めし",
                    date: "2026-02-12",
                    time: "12:00",
                    section: 2,
                    order: 1,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "a2169fc7-43f3-4b7b-9f07-858263188232",
                    text: "バイトグループLINE確認",
                    date: "2026-02-12",
                    time: "22:00",
                    section: 3,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "65106b5a-1a3a-4552-b4f4-e45f7928764e",
                    text: "流体力学 3限",
                    date: "2026-02-13",
                    time: "13:00",
                    section: 2,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "3d883e67-e613-4da8-880e-9a2d7f2f4d23",
                    text: "友達とカラオケ まねきねこ横浜西口",
                    date: "2026-02-13",
                    time: "19:00",
                    section: 2,
                    order: 1,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "9fce656c-2605-4787-9c72-95eb7a1b8180",
                    text: "ゆうかに誕プレ渡す",
                    date: "2026-02-13",
                    time: "19:00",
                    section: 1,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "30cc43fb-6da3-4bdd-beec-d10ed873d179",
                    text: "めし",
                    date: "2026-02-13",
                    time: "12:00",
                    section: 2,
                    order: 2,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "f9061ff5-b090-4a82-b5b0-508dafe7024f",
                    text: "翔太と横浜デート",
                    date: "2026-02-14",
                    time: "11:00",
                    section: 2,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "95040bd3-e274-4732-8f67-8aa6e5990e8f",
                    text: "bills 横浜赤レンガ ランチ",
                    date: "2026-02-14",
                    time: "12:00",
                    section: 2,
                    order: 1,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "93f82bee-882b-4229-912d-3fec6f116767",
                    text: "チョコ渡す",
                    date: "2026-02-14",
                    time: "15:00",
                    section: 1,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "6808e0e0-2c91-4fc7-a7a7-2489bc403817",
                    text: "MARINE & WALK 散歩",
                    date: "2026-02-14",
                    time: "14:00",
                    section: 2,
                    order: 2,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "6cdf43d6-c0e1-47ab-a959-9bed00d9c534",
                    text: "アニヴェルセル みなとみらい ディナー予約済",
                    date: "2026-02-14",
                    time: "18:00",
                    section: 2,
                    order: 3,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "e0edd106-3c1a-4a2f-b5e4-64f909196648",
                    text: "あいみょん ライブ 横浜アリーナ",
                    date: "2026-02-15",
                    time: "17:00",
                    section: 2,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "ed802d46-1e6f-4e8e-85ab-42448c30ec94",
                    text: "AFLOAT 横浜 カット予約",
                    date: "2026-02-15",
                    time: "11:00",
                    section: 2,
                    order: 1,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "0b620f74-5f5d-43c1-a8fb-19e74ee67f63",
                    text: "ライブ前にみさきと合流",
                    date: "2026-02-15",
                    time: "15:00",
                    section: 2,
                    order: 2,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "63fd2b42-077b-4de0-baaf-39ac7548ca32",
                    text: "めし",
                    date: "2026-02-15",
                    time: "13:00",
                    section: 2,
                    order: 3,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "69dd6d27-c23a-4bf3-92d3-cf0afa32d108",
                    text: "お母さん誕生日",
                    date: "2026-02-16",
                    time: "12:00",
                    section: 1,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "43704123-24b9-4914-94c2-4a0c9e270749",
                    text: "実家帰る",
                    date: "2026-02-16",
                    time: "11:00",
                    section: 2,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "b73e666c-e5f0-476e-b8dc-d53294d18467",
                    text: "プレゼント ルミネで買う",
                    date: "2026-02-16",
                    time: "10:00",
                    section: 1,
                    order: 1,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "fd196cc7-7214-4d1a-b97c-44a3aadd48c8",
                    text: "妹の塾送り",
                    date: "2026-02-16",
                    time: "17:00",
                    section: 3,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "21f7fa53-d2d2-46a5-ad8b-ad1c86ac61b1",
                    text: "マック 10:00-15:00",
                    date: "2026-02-17",
                    time: "10:00",
                    section: 2,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "2a5f452a-811a-4cca-bccd-f6c8edf600fa",
                    text: "制御工学 4限",
                    date: "2026-02-17",
                    time: "14:30",
                    section: 2,
                    order: 1,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "ef02a42d-fbe5-4cdc-abbc-5bea28d64499",
                    text: "履修登録確認",
                    date: "2026-02-17",
                    time: "20:00",
                    section: 3,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "9d8453d3-7a58-4868-b83a-b5e0a935907f",
                    text: "店長MTG シフト調整",
                    date: "2026-02-19",
                    time: "16:00",
                    section: 1,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "2f071eb8-fe0e-4757-8eb3-3fd3bed88271",
                    text: "マック 17:00-22:00",
                    date: "2026-02-19",
                    time: "17:00",
                    section: 2,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "fcc7da9e-dfa7-4c61-92ff-9f866ac3b198",
                    text: "EXILE ライブ 東京ドーム",
                    date: "2026-02-22",
                    time: "16:00",
                    section: 2,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "7fe096fd-18e3-4b76-97fb-d45e1b47f8ee",
                    text: "友達と現地集合 14:30",
                    date: "2026-02-22",
                    time: "14:30",
                    section: 2,
                    order: 1,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "24a1969e-302d-4631-9557-5ea289c957a1",
                    text: "家賃支払日",
                    date: "2026-02-27",
                    time: "09:00",
                    section: 1,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "cefc7416-bd08-42cd-bb43-a9a93b7775b4",
                    text: "おばあちゃん 月1通院",
                    date: "2026-02-27",
                    time: "10:00",
                    section: 1,
                    order: 1,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "4726c52b-6145-40de-a6ce-7c81a4e1159a",
                    text: "ゼミ中間発表",
                    date: "2026-03-12",
                    time: "14:00",
                    section: 1,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "487ab703-72be-4fd7-ace4-cdf3251f08d7",
                    text: "翔太 誕生日",
                    date: "2026-03-21",
                    time: "18:00",
                    section: 1,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "975c669a-5d59-4ab6-b6ae-8353bd427791",
                    text: "春休み旅行 京都 計画",
                    date: "2026-03-25",
                    time: "10:00",
                    section: 2,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "1d5e68b8-87d9-40a1-8eeb-2542ff87d270",
                    text: "新学期ガイダンス",
                    date: "2026-04-01",
                    time: "10:00",
                    section: 1,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "43a651ce-eb2a-4390-b6a1-5bebf9dd7451",
                    text: "薬飲む",
                    date: "2026-02-09",
                    time: null,
                    section: 2,
                    order: 99,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: false,
                },
                {
                    id: "fe60d6cb-131f-421b-8372-304505a9eb98",
                    text: "日記書く",
                    date: "2026-02-09",
                    time: null,
                    section: 4,
                    order: 99,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: false,
                },
                {
                    id: "ddfec598-b81c-4999-9aef-aab86bda0eba",
                    text: "教科書 生協で買う",
                    date: "2026-02-10",
                    time: null,
                    section: 3,
                    order: 0,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
                {
                    id: "740c0b4a-fe72-4369-b494-a3746de1f102",
                    text: "メルカリ出品 冬服",
                    date: "2026-02-11",
                    time: null,
                    section: 4,
                    order: 1,
                    completed: false,
                    showInDaily: true,
                    showInWeekly: true,
                },
            ];
            const INITIAL_PURPOSE = "熱力学レポート提出する";
            const INITIAL_STOP_CONDITION =
                "終わるまで寝ない。ただし2時で強制終了。";

            /**
             * ID生成関数（UUID v4）
             *
             * RFC 4122準拠のUUID v4を生成
             * - 128ビットの一意識別子
             * - 衝突確率: 10^-15（実質ゼロ）
             * - 複数タブ・複数デバイスでも安全
             *
             * 形式: xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx
             * - x: 0-9, a-f のランダム値
             * - 4: バージョン番号（v4）
             * - y: 8, 9, a, b のいずれか（variant bits）
             *
             * 例: "a3bb189e-8bf9-4d32-9c51-2d3e6f8b4a7c"
             *
             * 参考：富士通ジャパンのマイナンバーカード問題（2023年）
             * - タイムスタンプベースのIDで衝突が発生
             * - UUIDなら完全に防止可能
             */
            function generateTaskId() {
                // UUID v4生成（crypto.randomUUID()が使えない環境用のフォールバック含む）
                if (typeof crypto !== "undefined" && crypto.randomUUID) {
                    // モダンブラウザ（Chrome 92+, Firefox 95+, Safari 15.4+）
                    return crypto.randomUUID();
                } else {
                    // フォールバック実装（古いブラウザ対応）
                    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
                        /[xy]/g,
                        function (c) {
                            const r = (Math.random() * 16) | 0;
                            const v = c === "x" ? r : (r & 0x3) | 0x8;
                            return v.toString(16);
                        }
                    );
                }
            }

            // タスク作成
            /**
             * タスク作成
             *
             * @param {string} text - タスクのテキスト
             * @param {string} date - 基準日（YYYY-MM-DD形式）
             *                        週間/月次/年次タスク：その日付に表示
             *                        日次タスク：作成日（参照用、日次表示には使わない）
             * @param {string|null} time - 時刻（HH:MM形式）。nullの場合は終日タスク
             * @param {number} section - 象限（1-4）
             *                           1: 緊急かつ重要（赤）
             *                           2: 緊急だが重要でない（緑）
             *                           3: 重要だが緊急でない（黄）
             *                           4: 緊急でも重要でもない（グレー）
             * @param {boolean} showInDaily - 日次ビューに表示するか
             * @param {boolean} showInWeekly - 週間ビューに表示するか
             * @returns {object} 作成されたタスク
             *
             * データ構造：
             * {
             *   id: string,           // UUID v4（例: "a3bb189e-8bf9-4d32-9c51-2d3e6f8b4a7c"）
             *   text: string,         // タスクテキスト
             *   date: string,         // 基準日（YYYY-MM-DD）
             *   time: string|null,    // 時刻（HH:MM）または null
             *   section: number,      // 象限（1-4）
             *   completed: boolean,   // 完了フラグ
             *   showInDaily: boolean,   // 日次表示フラグ
             *   showInWeekly: boolean,  // 週間表示フラグ
             *   createdAt: string,    // 作成日時（ISO 8601形式）
             *   updatedAt: string     // 更新日時（ISO 8601形式）
             * }
             *
             * 使用例：
             * - 日次タスク作成: createTask("会議", today, null, 1, true, false)
             * - 週間タスク作成: createTask("会議", "2026-02-05", "09:00", 1, false, true)
             * - 日次＋週間: createTask("会議", "2026-02-05", "09:00", 1, true, true)
             */
            function createTask(
                text,
                date,
                time,
                section,
                showInDaily = true,
                showInWeekly = false
            ) {
                // 同じ日・同じセクションの最大orderを取得
                const sameGroupTasks = allTasks.filter(
                    (t) => t.date === date && t.section === section
                );
                const maxOrder =
                    sameGroupTasks.length > 0
                        ? Math.max(...sameGroupTasks.map((t) => t.order || 0)) +
                          1
                        : 0;

                const task = {
                    id: generateTaskId(),
                    text: text,
                    memo: null, // メモフィールド（v9.7追加）
                    date: date,
                    time: time || null,
                    section: section,
                    order: maxOrder,
                    completed: false,
                    showInDaily: showInDaily,
                    showInWeekly: showInWeekly,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                };
                allTasks.push(task);
                saveAllTasks();
                return task;
            }

            // タスク更新
            function updateTask(id, updates) {
                const task = allTasks.find((t) => t.id === id);
                if (task) {
                    Object.assign(task, updates, {
                        updatedAt: new Date().toISOString(),
                    });
                    saveAllTasks();
                    return task;
                }
                return null;
            }

            // タスク削除
            // タスク削除（マスターデータから）
            function removeTaskFromMaster(id) {
                const index = allTasks.findIndex((t) => t.id === id);
                if (index !== -1) {
                    allTasks.splice(index, 1);
                    saveAllTasks();
                    return true;
                }
                return false;
            }

            /**
             * 日次タスク取得
             *
             * @param {string} date - 対象日（YYYY-MM-DD形式）
             * @returns {object} 象限別タスク配列 { 1: [...], 2: [...], 3: [...], 4: [...] }
             *
             * フィルター条件：
             * - showInDaily === true（日次表示フラグがON）
             * - かつ以下のいずれか：
             *   1. showInWeekly === false（日次専用タスク）→ 常に表示
             *   2. showInWeekly === true（両方対応タスク）→ その日だけ表示（date一致）
             *
             * ロジック説明：
             * - 日次専用タスク（showInWeekly: false）: 日付に関係なく常に日次に表示
             *   例：「メール確認」「日報書く」など日々のルーチン
             * - 週間も対応（showInWeekly: true）: その日付だけ日次に表示
             *   例：「2/5 会議」は2/5の日次にのみ表示
             *
             * 使い分け：
             * - 日次でタスク作成 → showInWeekly: false → 毎日表示
             * - 週間でタスク作成 → showInWeekly: true → その日だけ表示
             * - 📅ボタンで週間追加 → showInWeekly: true → その日だけ表示
             */
            function getDailyTasks(date) {
                const result = { 1: [], 2: [], 3: [], 4: [] };

                allTasks
                    .filter((t) => {
                        // showInDailyがfalseなら除外
                        if (!t.showInDaily) return false;

                        // 日次専用タスク（週間非対応）→ 常に表示
                        if (!t.showInWeekly) {
                            return true;
                        }

                        // 週間も対応 → その日だけ表示
                        const match = t.date === date;
                        return match;
                    })
                    .forEach((t) => {
                        if (result[t.section]) {
                            result[t.section].push(t);
                        }
                    });

                // 各象限をorder順にソート（orderがなければ0扱い）
                for (let sec = 1; sec <= 4; sec++) {
                    result[sec].sort((a, b) => (a.order || 0) - (b.order || 0));
                }

                return result;
            }

            /**
             * 週間タスク取得
             *
             * @param {string} startDate - 週の開始日（YYYY-MM-DD形式）
             * @param {string} endDate - 週の終了日（YYYY-MM-DD形式）
             * @returns {array} タスク配列
             *
             * フィルター条件：
             * - showInWeekly === true（週間表示フラグがON）
             * - time !== null（時刻が指定されている）
             * - date が startDate〜endDate の範囲内
             *
             * 注意：
             * - 週間ビューは時刻付きタスクのみ表示（バーチカル形式のため）
             * - 終日タスク（time: null）は表示されない
             */
            function getWeeklyTasks(startDate, endDate) {
                return allTasks
                    .filter(
                        (t) =>
                            t.showInWeekly &&
                            t.time &&
                            t.date >= startDate &&
                            t.date <= endDate
                    )
                    .sort((a, b) => {
                        // まず日付順
                        if (a.date !== b.date)
                            return a.date.localeCompare(b.date);
                        // 同じ日なら時間順
                        if (a.time !== b.time)
                            return a.time.localeCompare(b.time);
                        // 同じ時間ならorder順
                        return (a.order || 0) - (b.order || 0);
                    });
            }

            // マスターデータ保存
            function saveAllTasks() {
                localStorage.setItem("allTasks", JSON.stringify(allTasks));
                localStorage.setItem("taskIdCounter", taskIdCounter.toString());
            }

            // マスターデータ読み込み
            function loadAllTasks() {
                const saved = localStorage.getItem("allTasks");
                if (saved) {
                    try {
                        allTasks = JSON.parse(saved);
                        const savedCounter =
                            localStorage.getItem("taskIdCounter");
                        if (savedCounter) {
                            taskIdCounter = parseInt(savedCounter);
                        }

                        // データが空配列の場合も初期データを使用
                        if (
                            allTasks.length === 0 &&
                            INITIAL_DATA &&
                            INITIAL_DATA.length > 0
                        ) {
                            allTasks = INITIAL_DATA;
                            saveAllTasks();
                            if (INITIAL_PURPOSE) {
                                localStorage.setItem(
                                    "purpose",
                                    INITIAL_PURPOSE
                                );
                            }
                            if (INITIAL_STOP_CONDITION) {
                                localStorage.setItem(
                                    "stopCondition",
                                    INITIAL_STOP_CONDITION
                                );
                            }
                            return;
                        }

                        // orderフィールドがないタスクに初期値を付与（v9.6マイグレーション）
                        const orderMigrationDone = localStorage.getItem(
                            "orderMigrationDone_v96"
                        );
                        if (!orderMigrationDone) {
                            // 日付+セクションごとにグループ化してorderを付与
                            const groups = {};
                            allTasks.forEach((task) => {
                                const key = `${task.date}_${task.section}`;
                                if (!groups[key]) groups[key] = [];
                                groups[key].push(task);
                            });

                            let fixedCount = 0;
                            Object.values(groups).forEach((tasks) => {
                                // 時間順にソート
                                tasks.sort((a, b) =>
                                    (a.time || "99:99").localeCompare(
                                        b.time || "99:99"
                                    )
                                );
                                tasks.forEach((task, idx) => {
                                    if (task.order === undefined) {
                                        task.order = idx;
                                        fixedCount++;
                                    }
                                });
                            });

                            if (fixedCount > 0) {
                                saveAllTasks();
                            }
                            localStorage.setItem(
                                "orderMigrationDone_v96",
                                "true"
                            );
                        }

                        // データ修正：週間タスク（showInWeekly: true）でshowInDailyがfalseなら修正
                        const migrationDone = localStorage.getItem(
                            "showInDailyMigrationDone_v1"
                        );
                        if (!migrationDone) {
                            let fixedCount = 0;
                            allTasks.forEach((task) => {
                                if (
                                    task.time &&
                                    task.showInWeekly &&
                                    !task.showInDaily
                                ) {
                                    task.showInDaily = true;
                                    fixedCount++;
                                }
                            });

                            if (fixedCount > 0) {
                                saveAllTasks();
                            }

                            localStorage.setItem(
                                "showInDailyMigrationDone_v1",
                                "true"
                            );
                        }

                        // memoフィールドがないタスクに初期値を付与（v9.7マイグレーション）
                        const memoMigrationDone = localStorage.getItem(
                            "memoMigrationDone_v97"
                        );
                        if (!memoMigrationDone) {
                            let fixedCount = 0;
                            allTasks.forEach((task) => {
                                if (task.memo === undefined) {
                                    task.memo = null;
                                    fixedCount++;
                                }
                            });

                            if (fixedCount > 0) {
                                saveAllTasks();
                            }
                            localStorage.setItem(
                                "memoMigrationDone_v97",
                                "true"
                            );
                        }
                    } catch (e) {
                        console.error("Failed to load allTasks:", e);
                        allTasks = [];
                    }
                }

                // LocalStorageにデータがない、または空の場合は初期データを使用
                if (
                    allTasks.length === 0 &&
                    INITIAL_DATA &&
                    INITIAL_DATA.length > 0
                ) {
                    allTasks = INITIAL_DATA;
                    saveAllTasks();

                    if (INITIAL_PURPOSE) {
                        localStorage.setItem("purpose", INITIAL_PURPOSE);
                    }
                    if (INITIAL_STOP_CONDITION) {
                        localStorage.setItem(
                            "stopCondition",
                            INITIAL_STOP_CONDITION
                        );
                    }
                }
            }

            // 既存データを移行
            function migrateToMasterData() {
                // 既にマスターデータがあれば移行しない
                if (allTasks.length > 0) return;

                const today = getLocalDateStr(new Date());
                const migrated = [];

                // 日次データを移行
                for (let sec = 1; sec <= 4; sec++) {
                    if (tasks[sec]) {
                        tasks[sec].forEach((oldTask) => {
                            // "11:30 タスク" 形式を分解
                            const match = oldTask.text.match(
                                /^(\d{2}:\d{2})\s+(.+)$/
                            );
                            const time = match ? match[1] : null;
                            const text = match ? match[2] : oldTask.text;

                            migrated.push({
                                id: generateTaskId(),
                                text: text,
                                date: today,
                                time: time,
                                section: sec,
                                completed: oldTask.completed || false,
                                showInDaily: true,
                                showInWeekly: false,
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString(),
                            });
                        });
                    }
                }

                // 週間データを移行
                if (weeklyTasks) {
                    Object.keys(weeklyTasks).forEach((dateStr) => {
                        weeklyTasks[dateStr].forEach((oldTask) => {
                            // 既に日次で移行済みかチェック
                            const exists = migrated.some(
                                (t) =>
                                    t.date === dateStr &&
                                    t.text === oldTask.text &&
                                    t.time === oldTask.time
                            );

                            if (!exists) {
                                migrated.push({
                                    id: generateTaskId(),
                                    text: oldTask.text,
                                    date: dateStr,
                                    time: oldTask.time,
                                    section: 1, // デフォルトで象限1
                                    completed: oldTask.completed || false,
                                    showInDaily: false,
                                    showInWeekly: true,
                                    createdAt: new Date().toISOString(),
                                    updatedAt: new Date().toISOString(),
                                });
                            }
                        });
                    });
                }

                allTasks = migrated;
                saveAllTasks();
            }

            // 日付表示
            function updateDate() {
                const now = new Date();
                const weekday = ["日", "月", "火", "水", "木", "金", "土"];
                const dateStr =
                    now.toLocaleDateString("ja-JP") +
                    "（" +
                    weekday[now.getDay()] +
                    "）";
                document.getElementById("dateDisplay").textContent = dateStr;
                // スマホ用の第1象限日付も同期
                const mobileDate = document.getElementById("dateDisplayMobile");
                if (mobileDate) mobileDate.textContent = dateStr;
            }

            // 目的の確定
            function confirmPurpose() {
                const input = document.getElementById("purposeInput");
                if (input.value.trim()) {
                    purpose = input.value.trim();
                    purposeConfirmed = true;
                    document.getElementById("purposeGroup").style.display =
                        "none";
                    document.getElementById("purposeDisplay").style.display =
                        "flex";
                    document.getElementById("purposeText").textContent =
                        "目的: " + purpose;

                    // 目的をlocalStorageに保存
                    localStorage.setItem("purpose", purpose);
                    localStorage.setItem("purposeConfirmed", "true");

                    // 確定後、5秒カウントダウン → イメージ開始
                    const timerBtn = document.getElementById("timerBtn");
                    if (timerBtn) {
                        timerState = "countdown"; // カウントダウン状態に変更

                        // 先にカウントダウンの初期値を設定してから表示
                        let countdown = 5;
                        timerBtn.textContent = countdown;
                        timerBtn.style.backgroundColor = "#3b82f6";
                        timerBtn.style.fontSize = "1.5em";
                        timerBtn.style.display = "inline-flex"; // これで「5」が表示される

                        countdown--;

                        const countdownInterval = setInterval(() => {
                            if (countdown > 0) {
                                timerBtn.textContent = countdown;
                                timerBtn.style.backgroundColor = "#3b82f6";
                                countdown--;
                            } else {
                                timerBtn.textContent = "開始！";
                                timerBtn.style.backgroundColor = "#22c55e";
                                timerBtn.style.fontSize = "1em";
                                clearInterval(countdownInterval);

                                // 1秒後にイメージ開始
                                setTimeout(() => {
                                    timerBtn.style.fontSize = "0.8em";
                                    timerState = "imagine";
                                    timeLeft = 60;
                                    startTimer();
                                }, 1000);
                            }
                        }, 1000);
                    }
                }
            }

            // 目的の編集
            function editPurpose() {
                purposeConfirmed = false;
                document.getElementById("purposeGroup").style.display = "flex";
                document.getElementById("purposeDisplay").style.display =
                    "none";
                document.getElementById("purposeInput").value = purpose;
            }

            // 止まる仕組みの保存
            function saveStopCondition() {
                const input = document.getElementById("stopConditionInput");
                stopCondition = input.value.trim();

                if (stopCondition) {
                    stopConditionSaved = true;
                    document.getElementById(
                        "stopConditionGroup"
                    ).style.display = "none";
                    document.getElementById(
                        "stopConditionDisplay"
                    ).style.display = "flex";
                    document.getElementById("stopConditionText").textContent =
                        stopCondition;

                    // 止める仕組みをlocalStorageに保存
                    localStorage.setItem("stopCondition", stopCondition);
                    localStorage.setItem("stopConditionSaved", "true");
                }
            }

            // 止まる仕組みの編集
            function editStopCondition() {
                stopConditionSaved = false;
                document.getElementById("stopConditionGroup").style.display =
                    "flex";
                document.getElementById("stopConditionDisplay").style.display =
                    "none";
                document.getElementById("stopConditionInput").value =
                    stopCondition;
            }

            // 週間タスク追加モーダルを開く
            function openDaySelectModal(sectionNum, taskText) {
                const today = getLocalDateStr(new Date());
                const dailyTasks = getDailyTasks(today);
                const task = dailyTasks[sectionNum].find(
                    (t) => t.text === taskText
                );
                if (task) {
                    openDaySelectModalById(task.id);
                }
            }

            // ID版：週間追加モーダルを開く
            function openDaySelectModalById(taskId) {
                const task = allTasks.find((t) => t.id === taskId);
                if (!task) return;

                pendingScheduleTask = { taskId: taskId, taskText: task.text };
                selectedWeekday = null;

                // 曜日ボタンの選択状態をリセット
                document.querySelectorAll(".day-select-btn").forEach((btn) => {
                    btn.style.backgroundColor = "#fff";
                    btn.style.color = "#000";
                    btn.style.borderColor = "#ddd";
                });

                document
                    .getElementById("weeklyTaskModal")
                    .classList.add("show");
            }

            // 週間タスク追加モーダルを閉じる
            function closeWeeklyTaskModal() {
                document
                    .getElementById("weeklyTaskModal")
                    .classList.remove("show");
                pendingScheduleTask = null;
                selectedWeekday = null;
            }

            // 週間ビューから日次ビューに戻る
            function backToDailyView() {
                switchView("daily");
            }

            // 曜日ボタンクリック処理（ページ読み込み後に設定）
            function setupDayButtons() {
                document.querySelectorAll(".day-select-btn").forEach((btn) => {
                    btn.addEventListener("click", function () {
                        // 全ボタンの選択解除
                        document
                            .querySelectorAll(".day-select-btn")
                            .forEach((b) => {
                                b.style.backgroundColor = "#fff";
                                b.style.color = "#000";
                                b.style.borderColor = "#ddd";
                            });

                        // このボタンを選択
                        this.style.backgroundColor = "#2196F3";
                        this.style.color = "white";
                        this.style.borderColor = "#2196F3";

                        selectedWeekday = parseInt(this.dataset.day);
                    });
                });
            }

            // 週間タスクに追加確定
            function confirmAddToWeekly() {
                if (!pendingScheduleTask || selectedWeekday === null) {
                    alert("曜日を選択してください");
                    return;
                }

                const time = document.getElementById("weeklyTaskTime").value;

                // 今週の月曜日を基準に日付を計算
                const now = new Date();
                const dayOfWeek = now.getDay();
                const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                const monday = new Date(now);
                monday.setDate(now.getDate() + mondayOffset);

                // 選択された曜日の日付
                const targetDate = new Date(monday);
                targetDate.setDate(monday.getDate() + selectedWeekday);
                const dateStr = getLocalDateStr(targetDate);

                // 既存タスクにフラグを追加
                if (pendingScheduleTask.taskId) {
                    updateTask(pendingScheduleTask.taskId, {
                        date: dateStr,
                        time: time,
                        showInWeekly: true,
                    });
                } else {
                    // 新規タスクを作成（日次＋週間の両方に表示）
                    createTask(
                        pendingScheduleTask.taskText,
                        dateStr,
                        time,
                        1,
                        true,
                        true
                    );
                }

                closeWeeklyTaskModal();

                // 週間ビューが表示されていたら更新
                if (
                    document.getElementById("weeklyView").style.display ===
                    "block"
                ) {
                    renderWeeklyView();
                }

                // 日次ビューも再描画（今日または元の日付のタスクが変更された場合）
                const today = getLocalDateStr(new Date());
                for (let sec = 1; sec <= 4; sec++) {
                    renderTasks(sec);
                }
            }

            // 色をブレンドするヘルパー関数
            function blendColors(color1, color2, ratio) {
                // 簡易実装：color2を優先的に返す
                return color2;
            }

            // 週間ビューを描画（バーチカル）
            function renderWeeklyView() {
                const container = document.getElementById("weeklyContainer");
                container.innerHTML = "";

                // 表示中の週の月曜日から日曜日まで
                const baseDate = new Date(currentWeekDate);
                const dayOfWeek = baseDate.getDay();
                const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                const monday = new Date(baseDate);
                monday.setDate(baseDate.getDate() + mondayOffset);

                // ヘッダーのタイトルを更新
                const titleEl = document.getElementById("weeklyTitle");
                const sundayDate = new Date(monday);
                sundayDate.setDate(monday.getDate() + 6);
                titleEl.textContent = `${
                    monday.getMonth() + 1
                }/${monday.getDate()} 〜 ${
                    sundayDate.getMonth() + 1
                }/${sundayDate.getDate()}`;

                const weekdays = ["月", "火", "水", "木", "金", "土", "日"];

                // テーブル作成
                const table = document.createElement("table");
                table.style.width = "100%";
                table.style.borderCollapse = "separate";
                table.style.borderSpacing = "0";
                table.style.backgroundColor = "#fff";

                // ヘッダー行
                const thead = document.createElement("thead");
                const headerRow = document.createElement("tr");

                const timeHeader = document.createElement("th");
                timeHeader.textContent = "時間";
                timeHeader.style.padding = "12px 10px";
                timeHeader.style.border = "1px solid #ddd";
                timeHeader.style.backgroundColor = "#f5f5f5";
                timeHeader.style.width = "70px";
                timeHeader.style.minWidth = "70px";
                timeHeader.style.fontWeight = "bold";
                timeHeader.style.position = "sticky";
                timeHeader.style.left = "0";
                timeHeader.style.zIndex = "25";
                headerRow.appendChild(timeHeader);

                // 今日の日付
                const todayDateStr = getLocalDateStr(new Date());

                for (let i = 0; i < 7; i++) {
                    const date = new Date(monday);
                    date.setDate(monday.getDate() + i);
                    const displayDate = `${
                        date.getMonth() + 1
                    }/${date.getDate()}`;
                    const dateStr = getLocalDateStr(date);
                    const isToday = dateStr === todayDateStr;

                    const th = document.createElement("th");
                    th.textContent = `${displayDate}（${weekdays[i]}）`;
                    th.style.padding = "12px 10px";
                    th.style.border = "1px solid #ddd";
                    th.style.backgroundColor = "#f5f5f5";
                    th.style.fontWeight = "bold";
                    th.dataset.date = dateStr; // 日付を保存

                    // 土曜・日曜の色分け
                    if (i === 5) {
                        th.style.backgroundColor = "#e3f2fd";
                        th.style.color = "#1976d2";
                    }
                    if (i === 6) {
                        th.style.backgroundColor = "#fff3e0";
                        th.style.color = "#e65100";
                    }

                    // 今日のヘッダー強調（黄色系）
                    if (isToday) {
                        th.style.backgroundColor = "#fff9c4";
                        th.style.color = "#f57c00";
                        th.style.fontWeight = "bold";
                        th.style.borderBottom = "3px solid #fbc02d";
                    }

                    headerRow.appendChild(th);
                }

                thead.appendChild(headerRow);
                table.appendChild(thead);

                // 現在時刻を取得
                const currentHour = new Date().getHours();

                // 時間行（0:00-23:00）
                const tbody = document.createElement("tbody");

                for (let hour = 0; hour <= 23; hour++) {
                    const tr = document.createElement("tr");

                    // 時間帯によるゾーニング色
                    let zoneColor = "#fafafa"; // デフォルト
                    let zoneBorder = "1px solid #ddd";

                    // 6時間ごとのゾーン
                    if (hour >= 0 && hour < 6) {
                        // 深夜（0-5時）：暗め
                        zoneColor = "#f5f5f5";
                    } else if (hour >= 6 && hour < 12) {
                        // 朝（6-11時）：明るい
                        zoneColor = "#fafafa";
                    } else if (hour >= 12 && hour < 18) {
                        // 昼（12-17時）：明るい
                        zoneColor = "#fafafa";
                    } else {
                        // 夜（18-23時）：やや暗め
                        zoneColor = "#f5f5f5";
                    }

                    // 12時（正午）の上に太い区切り線
                    if (hour === 12) {
                        tr.style.borderTop = "3px solid #ff5722";
                    }

                    // 6時、18時にも薄い区切り線
                    if (hour === 6 || hour === 18) {
                        tr.style.borderTop = "2px solid #bdbdbd";
                    }

                    // 現在時刻の行をハイライト
                    const isCurrentHour = hour === currentHour;

                    // 時間セル
                    const timeCell = document.createElement("td");
                    timeCell.textContent = `${String(hour).padStart(
                        2,
                        "0"
                    )}:00`;
                    timeCell.id = `weekly-time-${hour}`;
                    timeCell.style.padding = "15px 10px";
                    timeCell.style.border = "1px solid #ddd";
                    timeCell.style.textAlign = "center";
                    timeCell.style.backgroundColor = isCurrentHour
                        ? "#fff9c4"
                        : zoneColor;
                    timeCell.style.fontWeight = "bold";
                    timeCell.style.height = "80px";
                    timeCell.style.verticalAlign = "middle";
                    timeCell.style.position = "sticky";
                    timeCell.style.left = "0";
                    timeCell.style.zIndex = "5";
                    timeCell.style.minWidth = "70px";

                    // 現在時刻は強調
                    if (isCurrentHour) {
                        timeCell.style.color = "#e65100";
                        timeCell.style.fontSize = "1.1em";
                        timeCell.style.background =
                            "linear-gradient(135deg, #fff9c4 0%, #fff176 100%)";
                        timeCell.style.borderRight = "3px solid #fbc02d";
                    }

                    tr.appendChild(timeCell);

                    // 各曜日のセル
                    for (let i = 0; i < 7; i++) {
                        const date = new Date(monday);
                        date.setDate(monday.getDate() + i);
                        const dateStr = getLocalDateStr(date);

                        const td = document.createElement("td");
                        td.style.padding = "8px";
                        td.style.border = "1px solid #ddd";
                        td.style.verticalAlign = "top";
                        td.style.height = "80px";
                        td.style.position = "relative";
                        td.style.cursor = "pointer";
                        td.dataset.date = dateStr;
                        td.dataset.hour = hour;

                        // 曜日ごとの背景色（ベース）
                        let cellBgColor = "#ffffff"; // デフォルト白
                        if (i === 1 || i === 3) {
                            // 火・木は極薄グレー
                            cellBgColor = "#fafafa";
                        } else if (i === 5) {
                            // 土曜日は薄青
                            cellBgColor = "#e3f2fd";
                        } else if (i === 6) {
                            // 日曜日は薄オレンジ
                            cellBgColor = "#fff3e0";
                        }

                        // 祝日チェック
                        const holiday = getHoliday(dateStr);
                        if (holiday) {
                            cellBgColor = "#fff3e0"; // 祝日は薄オレンジ
                        }

                        // 現在時刻の行をハイライト
                        if (isCurrentHour && dateStr === todayDateStr) {
                            cellBgColor = "#fff176"; // 今この瞬間（濃い黄色）
                            td.style.boxShadow = "inset 0 0 0 2px #fbc02d";
                            td.style.borderRadius = "4px";
                        } else if (isCurrentHour) {
                            // 現在時刻の行は全体的に薄黄色
                            cellBgColor = blendColors(
                                cellBgColor,
                                "#fffde7",
                                0.5
                            );
                        }

                        td.style.backgroundColor = cellBgColor;
                        td.dataset.bgColor = cellBgColor; // 元の色を保存

                        // クリックでタスク作成
                        td.addEventListener("click", (e) => {
                            // タスクDiv自体がクリックされた場合は何もしない
                            if (e.target !== td) return;

                            openWeeklyTaskCreateModal(dateStr, hour);
                        });

                        // ドラッグオーバー
                        td.addEventListener("dragover", (e) => {
                            e.preventDefault();
                            e.dataTransfer.dropEffect = "move";
                            td.style.backgroundColor = "#e8f5e9";
                        });

                        // ドラッグリーブ
                        td.addEventListener("dragleave", (e) => {
                            td.style.backgroundColor = td.dataset.bgColor; // 元の色に戻す
                        });

                        // ドロップ
                        td.addEventListener("drop", (e) => {
                            e.preventDefault();
                            td.style.backgroundColor = td.dataset.bgColor; // 元の色に戻す

                            const data = JSON.parse(
                                e.dataTransfer.getData("text/plain")
                            );
                            const taskId = data.taskId;
                            const newHour = hour;
                            const newTime = `${String(newHour).padStart(
                                2,
                                "0"
                            )}:00`;

                            // マスターデータを更新
                            updateTask(taskId, {
                                date: dateStr,
                                time: newTime,
                                showInWeekly: true, // 週間に移動したのでtrueに
                                showInDaily: true, // 日次にも表示
                            });

                            renderWeeklyView();

                            // 日次も再描画
                            for (let sec = 1; sec <= 4; sec++) {
                                renderTasks(sec);
                            }
                        });

                        // この時間帯のタスクを表示（マスターデータから取得）
                        const weekStart = getLocalDateStr(monday);
                        const weekEnd = new Date(monday);
                        weekEnd.setDate(monday.getDate() + 6);
                        const weekEndStr = getLocalDateStr(weekEnd);

                        const weeklyTasksForDate = allTasks.filter(
                            (t) => t.date === dateStr && t.time
                        );

                        weeklyTasksForDate.forEach((task) => {
                            const taskHour = parseInt(task.time.split(":")[0]);

                            if (taskHour === hour) {
                                // section別の色設定
                                const sectionColors = {
                                    1: { bg: "#ffe6e6", border: "#ff4444" }, // 緊急かつ重要（赤）
                                    2: { bg: "#e8f5e9", border: "#4caf50" }, // 緊急だが重要でない（緑）
                                    3: { bg: "#fffef5", border: "#ffc107" }, // 重要だが緊急でない（黄）
                                    4: { bg: "#f0f0f0", border: "#999999" }, // 緊急でも重要でもない（グレー）
                                };

                                const colors =
                                    sectionColors[task.section] ||
                                    sectionColors[1];

                                const taskDiv = document.createElement("div");
                                taskDiv.style.padding = "4px 8px";
                                taskDiv.style.marginBottom = "2px";
                                taskDiv.style.backgroundColor = task.completed
                                    ? "#e0e0e0"
                                    : colors.bg;
                                taskDiv.style.borderLeft = `3px solid ${colors.border}`;
                                taskDiv.style.borderRadius = "3px";
                                taskDiv.style.fontSize = "0.85em";
                                taskDiv.style.cursor = "grab";
                                taskDiv.style.display = "flex";
                                taskDiv.style.alignItems = "center";
                                taskDiv.style.gap = "4px";
                                taskDiv.draggable = true;
                                taskDiv.dataset.taskId = task.id;

                                // ドラッグ開始
                                taskDiv.addEventListener("dragstart", (e) => {
                                    e.dataTransfer.effectAllowed = "move";
                                    e.dataTransfer.setData(
                                        "text/plain",
                                        JSON.stringify({
                                            taskId: task.id,
                                            dateStr: dateStr,
                                            taskText: task.text,
                                            taskTime: task.time,
                                        })
                                    );
                                    taskDiv.style.opacity = "0.5";
                                });

                                // ドラッグ終了
                                taskDiv.addEventListener("dragend", (e) => {
                                    taskDiv.style.opacity = "1";
                                });

                                const timeSpan = document.createElement("span");
                                timeSpan.textContent = task.time;
                                timeSpan.style.fontWeight = "bold";
                                timeSpan.style.marginRight = "4px";

                                const textSpan = document.createElement("span");
                                textSpan.textContent = task.text;
                                textSpan.style.flex = "1";
                                if (task.completed) {
                                    textSpan.style.textDecoration =
                                        "line-through";
                                    textSpan.style.opacity = "0.6";
                                }

                                const editBtn = document.createElement("span");
                                editBtn.textContent = "✏️";
                                editBtn.title = "編集";
                                editBtn.style.cursor = "pointer";
                                editBtn.style.opacity = "0.5";
                                editBtn.style.pointerEvents = "auto";
                                editBtn.addEventListener("click", (e) => {
                                    e.stopPropagation();
                                    e.preventDefault();

                                    // promptをsetTimeoutで遅延実行（ブラウザのブロック回避）
                                    setTimeout(() => {
                                        editWeeklyTaskById(task.id);
                                    }, 10);
                                });

                                taskDiv.onclick = (e) => {
                                    // ボタン以外をクリックした時だけ完了トグル
                                    if (
                                        e.target === taskDiv ||
                                        e.target === timeSpan ||
                                        e.target === textSpan
                                    ) {
                                        updateTask(task.id, {
                                            completed: !task.completed,
                                        });
                                        renderWeeklyView();

                                        // 今日のタスクなら日次も再描画
                                        const today = getLocalDateStr(
                                            new Date()
                                        );
                                        if (task.date === today) {
                                            for (let sec = 1; sec <= 4; sec++) {
                                                renderTasks(sec);
                                            }
                                        }
                                    }
                                };

                                taskDiv.appendChild(timeSpan);
                                taskDiv.appendChild(textSpan);
                                taskDiv.appendChild(editBtn);
                                td.appendChild(taskDiv);
                            }
                        });

                        tr.appendChild(td);
                    }

                    tbody.appendChild(tr);
                }

                table.appendChild(tbody);
                container.appendChild(table);
            }

            // 週間タスクの編集（ID版）
            let editingWeeklyTaskId = null; // 編集中のタスクID

            function editWeeklyTaskById(taskId) {
                const task = allTasks.find((t) => t.id === taskId);

                if (!task) {
                    console.error("タスクが見つかりません:", taskId);
                    return;
                }

                // 編集中のタスクIDを保存
                editingWeeklyTaskId = taskId;

                // タスク名を設定
                document.getElementById("editTaskText").value = task.text;
                document.getElementById("editTaskId").value = task.id;

                // メモを設定
                document.getElementById("editTaskMemo").value = task.memo || "";

                // 日付を設定
                document.getElementById("editTaskDate").value = task.date || "";

                // 時間を設定（新しいセレクト式）
                setTimeSelect("weeklyEdit", task.time);

                // 象限を設定
                document.getElementById("editTaskSection").value =
                    task.section || 2;

                // モーダルを表示
                document
                    .getElementById("weeklyTaskEditModal")
                    .classList.add("show");

                // 入力欄にフォーカス
                setTimeout(() => {
                    document.getElementById("editTaskText").focus();
                    document.getElementById("editTaskText").select();
                }, 100);
            }

            function closeWeeklyEditModal() {
                document
                    .getElementById("weeklyTaskEditModal")
                    .classList.remove("show");
                editingWeeklyTaskId = null;
            }

            function saveWeeklyEdit() {
                if (!editingWeeklyTaskId) return;

                const newText = document
                    .getElementById("editTaskText")
                    .value.trim();
                const newMemo = document
                    .getElementById("editTaskMemo")
                    .value.trim();
                const newDate = document.getElementById("editTaskDate").value;
                const newTime = getTimeFromSelect("weeklyEdit");
                const newSection = parseInt(
                    document.getElementById("editTaskSection").value
                );

                if (!newText) {
                    alert("タスク名を入力してください");
                    return;
                }

                if (!newDate) {
                    alert("日付を入力してください");
                    return;
                }

                // 時間があれば週間に表示
                const showInWeekly = newTime ? true : false;

                updateTask(editingWeeklyTaskId, {
                    text: newText,
                    memo: newMemo || null,
                    date: newDate,
                    time: newTime,
                    section: newSection,
                    showInWeekly: showInWeekly,
                });

                closeWeeklyEditModal();
                renderWeeklyView();
                renderMonthlyView();

                // 日次も再描画
                for (let sec = 1; sec <= 4; sec++) {
                    renderTasks(sec);
                }
            }

            let deleteConfirmationShown = false;

            function confirmDeleteFromEdit() {
                if (!editingWeeklyTaskId) {
                    console.error("editingWeeklyTaskIdが未設定");
                    return;
                }

                const task = allTasks.find((t) => t.id === editingWeeklyTaskId);

                if (!task) {
                    console.error("タスクが見つかりません");
                    return;
                }

                // 削除ボタンのテキストを変更して確認
                if (!deleteConfirmationShown) {
                    // 1回目：確認を表示
                    const btn = event.target;
                    btn.textContent = "本当に削除？";
                    btn.style.backgroundColor = "#d32f2f";
                    deleteConfirmationShown = true;

                    // 3秒後に元に戻す
                    setTimeout(() => {
                        btn.textContent = "削除";
                        btn.style.backgroundColor = "#f44336";
                        deleteConfirmationShown = false;
                    }, 3000);

                    return;
                }

                // 2回目：実際に削除

                deleteTaskById(editingWeeklyTaskId);

                closeWeeklyEditModal();

                deleteConfirmationShown = false;
            }

            // 編集を保存（旧システム・デッドコード削除済み）
            // → editWeeklyTaskByIdを使用してください

            // 編集モーダルから削除（旧システム・デッドコード削除済み）
            // → editWeeklyTaskByIdを使用してください

            // ===== 月間ビュー関数 =====

            function renderMonthlyView() {
                const calendar = document.getElementById("monthlyCalendar");
                calendar.innerHTML = "";

                // 月間表示モード取得
                const monthlyMode =
                    localStorage.getItem("monthlyMode") || "fixed";

                // expandモード時はカレンダーの最小幅を拡張
                if (monthlyMode === "expand") {
                    calendar.style.minWidth = "100%";
                    calendar.style.width = "100%";
                } else {
                    calendar.style.minWidth = "100%";
                    calendar.style.width = "100%";
                }

                const year = currentMonthDate.getFullYear();
                const month = currentMonthDate.getMonth();

                // タイトル更新
                document.getElementById(
                    "monthlyTitle"
                ).textContent = `${year}年${month + 1}月`;

                // 曜日ヘッダー
                const weekdays = ["月", "火", "水", "木", "金", "土", "日"];
                weekdays.forEach((day, index) => {
                    const header = document.createElement("div");
                    header.className = "monthly-weekday-header";
                    if (index === 5) header.classList.add("saturday");
                    if (index === 6) header.classList.add("sunday");
                    header.textContent = day;
                    calendar.appendChild(header);
                });

                // 月の最初の日
                const firstDay = new Date(year, month, 1);
                // 月曜始まりに調整（0=日曜 → 6, 1=月曜 → 0, ...）
                let startDayOfWeek = firstDay.getDay();
                startDayOfWeek = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1;

                // 月の最後の日
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();

                // 前月の日数
                const prevMonthLastDay = new Date(year, month, 0);
                const daysInPrevMonth = prevMonthLastDay.getDate();

                // 今日の日付
                const today = new Date();
                const todayStr = getLocalDateStr(today);

                // 6週分（42日）表示
                let currentDate = 1;
                let nextMonthDate = 1;

                for (let i = 0; i < 42; i++) {
                    // 各週の間にリサイズハンドルを挿入
                    if (i > 0 && i % 7 === 0) {
                        const handle = document.createElement("div");
                        handle.className = "monthly-resize-handle";
                        handle.dataset.weekRow = Math.floor(i / 7);
                        handle.addEventListener("mousedown", function (e) {
                            startMonthlyResize(e);
                        });
                        handle.addEventListener(
                            "touchstart",
                            function (e) {
                                startMonthlyResizeTouchWrapper(e);
                            },
                            { passive: false }
                        );
                        calendar.appendChild(handle);
                    }

                    const cell = document.createElement("div");
                    cell.className = "monthly-day-cell";

                    let dateStr;
                    let dayNumber;
                    let isOtherMonth = false;

                    if (i < startDayOfWeek) {
                        // 前月の日
                        dayNumber = daysInPrevMonth - startDayOfWeek + i + 1;
                        const prevMonth = month === 0 ? 11 : month - 1;
                        const prevYear = month === 0 ? year - 1 : year;
                        dateStr = `${prevYear}-${String(prevMonth + 1).padStart(
                            2,
                            "0"
                        )}-${String(dayNumber).padStart(2, "0")}`;
                        isOtherMonth = true;
                    } else if (currentDate <= daysInMonth) {
                        // 当月の日
                        dayNumber = currentDate;
                        dateStr = `${year}-${String(month + 1).padStart(
                            2,
                            "0"
                        )}-${String(dayNumber).padStart(2, "0")}`;
                        currentDate++;
                    } else {
                        // 次月の日
                        dayNumber = nextMonthDate;
                        const nextMonth = month === 11 ? 0 : month + 1;
                        const nextYear = month === 11 ? year + 1 : year;
                        dateStr = `${nextYear}-${String(nextMonth + 1).padStart(
                            2,
                            "0"
                        )}-${String(dayNumber).padStart(2, "0")}`;
                        nextMonthDate++;
                        isOtherMonth = true;
                    }

                    if (isOtherMonth) {
                        cell.classList.add("other-month");
                    }

                    // 曜日による色分け（土曜・日曜）
                    const dayOfWeek = i % 7;
                    if (dayOfWeek === 5 && !isOtherMonth)
                        cell.classList.add("saturday");
                    if (dayOfWeek === 6 && !isOtherMonth)
                        cell.classList.add("sunday");

                    // 祝日チェック
                    const holiday = getHoliday(dateStr);
                    if (holiday && !isOtherMonth) {
                        cell.classList.add("holiday");
                    }

                    // 今日の強調
                    if (dateStr === todayStr) {
                        cell.classList.add("today");
                    }

                    cell.dataset.date = dateStr;

                    // 日付番号
                    const dayNum = document.createElement("div");
                    dayNum.className = "monthly-day-number";
                    dayNum.textContent = dayNumber;
                    cell.appendChild(dayNum);

                    // 祝日名を表示
                    if (holiday && !isOtherMonth) {
                        const holidayDiv = document.createElement("div");
                        holidayDiv.className = "monthly-holiday-name";
                        holidayDiv.textContent = holiday;
                        holidayDiv.title = holiday; // ツールチップ
                        cell.appendChild(holidayDiv);
                    }

                    // シンプルモード：スタンプ表示
                    const isSimple =
                        localStorage.getItem("simpleMode") === "on";
                    if (isSimple) {
                        const stampData = getStampData();
                        const memoData = getMemoData();

                        if (stampData[dateStr]) {
                            const sd = stampData[dateStr];
                            const stampLabel = document.createElement("div");
                            stampLabel.className = "stamp-label";
                            stampLabel.textContent = sd.name;
                            stampLabel.style.cssText = `
              background: ${sd.color}; color: ${sd.textColor || "#333"};
              padding: 2px 8px; border-radius: 10px; font-size: 0.75em; font-weight: 600;
              text-align: center; margin-bottom: 2px; cursor: pointer;
            `;
                            cell.appendChild(stampLabel);
                        }

                        // メモアイコン表示
                        if (memoData[dateStr]) {
                            const memoIcons = document.createElement("div");
                            memoIcons.style.cssText =
                                "display: flex; gap: 2px; justify-content: center; font-size: 0.7em;";
                            if (
                                memoData[dateStr].work &&
                                memoData[dateStr].work.length > 0
                            ) {
                                const icon = document.createElement("span");
                                icon.className = "memo-icon";
                                icon.textContent = "■";
                                icon.style.color = "#78909c";
                                icon.title = memoData[dateStr].work.join("\n");
                                memoIcons.appendChild(icon);
                            }
                            if (
                                memoData[dateStr].private &&
                                memoData[dateStr].private.length > 0
                            ) {
                                const icon = document.createElement("span");
                                icon.className = "memo-icon";
                                icon.textContent = "★";
                                icon.style.color = "#ffa726";
                                icon.title =
                                    memoData[dateStr].private.join("\n");
                                memoIcons.appendChild(icon);
                            }
                            cell.appendChild(memoIcons);
                        }
                    }

                    // この日のタスクを表示
                    const dayTasks = allTasks.filter((t) => t.date === dateStr);
                    dayTasks.forEach((task) => {
                        const taskDiv = document.createElement("div");
                        taskDiv.className = "monthly-task-item";
                        taskDiv.dataset.taskId = task.id;
                        taskDiv.draggable = true;
                        taskDiv.style.display = "flex";
                        taskDiv.style.alignItems = "center";

                        // 象限による色
                        const colors = {
                            1: { bg: "#ffe6e6", border: "#ff4444" },
                            2: { bg: "#e8f5e9", border: "#4caf50" },
                            3: { bg: "#fffef5", border: "#ffc107" },
                            4: { bg: "#f0f0f0", border: "#999999" },
                        };
                        const color = colors[task.section] || colors[4];
                        taskDiv.style.backgroundColor = color.bg;
                        taskDiv.style.borderLeft = `3px solid ${color.border}`;

                        // 完了状態
                        if (task.completed) {
                            taskDiv.style.textDecoration = "line-through";
                            taskDiv.style.opacity = "0.6";
                        }

                        // ドラッグ開始（PC用）
                        taskDiv.addEventListener("dragstart", (e) => {
                            e.stopPropagation();
                            taskDiv.classList.add("dragging");
                            e.dataTransfer.setData(
                                "text/plain",
                                JSON.stringify({
                                    taskId: task.id,
                                    source: "monthly",
                                })
                            );
                            e.dataTransfer.effectAllowed = "move";
                        });

                        // ドラッグ終了（PC用）
                        taskDiv.addEventListener("dragend", () => {
                            taskDiv.classList.remove("dragging");
                        });

                        // 長押し検出（スマホ用）
                        let longPressTimer = null;

                        taskDiv.addEventListener(
                            "touchstart",
                            (e) => {
                                longPressTimer = setTimeout(() => {
                                    e.preventDefault();
                                    // 移動モード開始
                                    startMoveMode(task.id);
                                }, 500); // 500ms長押し
                            },
                            { passive: false }
                        );

                        taskDiv.addEventListener("touchend", () => {
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                        });

                        taskDiv.addEventListener("touchmove", () => {
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                        });

                        // タスク本体クリック → 完了トグル（線で消す）
                        taskDiv.addEventListener("click", (e) => {
                            e.stopPropagation();
                            if (movingTaskId) {
                                cancelMoveMode();
                            } else if (
                                e.target === taskDiv ||
                                e.target.classList.contains("monthly-task-text")
                            ) {
                                // 完了トグル
                                toggleTaskById(task.id);
                                renderMonthlyView();
                            }
                        });

                        // タスクテキスト部分
                        const taskText = document.createElement("span");
                        taskText.className = "monthly-task-text";
                        taskText.textContent = task.time
                            ? `${task.time} ${task.text}`
                            : task.text;
                        taskText.style.flex = "1";
                        taskText.style.overflow = "hidden";
                        taskText.style.textOverflow = "ellipsis";
                        taskText.style.whiteSpace = "nowrap";
                        taskText.style.minWidth = "0"; // flexアイテムの省略に必要
                        taskDiv.appendChild(taskText);

                        // アイコンコンテナ
                        const iconContainer = document.createElement("span");
                        iconContainer.style.display = "flex";
                        iconContainer.style.gap = "2px";
                        iconContainer.style.marginLeft = "4px";
                        iconContainer.style.flexShrink = "0";

                        // 📝編集ボタン
                        const editBtn = document.createElement("span");
                        editBtn.textContent = "📝";
                        editBtn.style.cursor = "pointer";
                        editBtn.style.fontSize = "0.7em";
                        editBtn.style.opacity = task.memo ? "1" : "0.5";
                        editBtn.title = task.memo ? "メモあり - 編集" : "編集";
                        editBtn.addEventListener("click", (e) => {
                            e.stopPropagation();
                            openMonthlyTaskEditModal(task.id);
                        });
                        iconContainer.appendChild(editBtn);

                        // 📆日次へ飛ぶボタン
                        const goBtn = document.createElement("span");
                        goBtn.textContent = "📆";
                        goBtn.style.cursor = "pointer";
                        goBtn.style.fontSize = "0.7em";
                        goBtn.title = "この日の日次ビューへ";
                        goBtn.addEventListener("click", (e) => {
                            e.stopPropagation();
                            goToDailyView(task.date);
                        });
                        iconContainer.appendChild(goBtn);

                        taskDiv.appendChild(iconContainer);

                        cell.appendChild(taskDiv);
                    });

                    // ドラッグオーバー（PC用）
                    cell.addEventListener("dragover", (e) => {
                        e.preventDefault();
                        // スタンプドロップ時はcopyエフェクト
                        if (
                            e.dataTransfer.types.includes("application/stamp")
                        ) {
                            e.dataTransfer.dropEffect = "copy";
                            cell.style.outline = "3px solid #4facfe";
                            cell.style.outlineOffset = "-3px";
                            cell.style.transition = "outline 0.1s ease";
                        } else {
                            e.dataTransfer.dropEffect = "move";
                            cell.classList.add("drag-over");
                        }
                    });

                    // ドラッグリーブ（PC用）
                    cell.addEventListener("dragleave", () => {
                        cell.classList.remove("drag-over");
                        cell.style.outline = "";
                        cell.style.outlineOffset = "";
                    });

                    // ドロップ（PC用）
                    cell.addEventListener("drop", (e) => {
                        e.preventDefault();
                        cell.classList.remove("drag-over");
                        cell.style.outline = "";
                        cell.style.outlineOffset = "";

                        // スタンプのドロップを判定
                        const stampDataStr =
                            e.dataTransfer.getData("application/stamp");
                        if (stampDataStr) {
                            try {
                                const stamp = JSON.parse(stampDataStr);
                                const targetDate = cell.dataset.date;
                                const data = getStampData();
                                if (
                                    data[targetDate] &&
                                    data[targetDate].stampId === stamp.id
                                ) {
                                    delete data[targetDate]; // 同じスタンプ再ドロップで解除
                                } else {
                                    data[targetDate] = {
                                        stampId: stamp.id,
                                        name: stamp.name,
                                        color: stamp.color,
                                        textColor: stamp.textColor,
                                    };
                                }
                                saveStampData(data);
                                renderMonthlyView();
                            } catch (err) {}
                            return;
                        }

                        try {
                            const data = JSON.parse(
                                e.dataTransfer.getData("text/plain")
                            );
                            const taskId = data.taskId;
                            const newDate = cell.dataset.date;

                            // タスクの日付を更新
                            updateTask(taskId, { date: newDate });

                            // 再描画
                            renderMonthlyView();

                            // 日次も再描画
                            for (let sec = 1; sec <= 4; sec++) {
                                renderTasks(sec);
                            }
                        } catch (err) {
                            console.error("ドロップエラー:", err);
                        }
                    });

                    // セルクリック（新規タスク追加 or 移動先確定 or スタンプ貼付）
                    cell.addEventListener("click", (e) => {
                        const isSimple =
                            localStorage.getItem("simpleMode") === "on";
                        if (
                            movingTaskId &&
                            (e.target === cell ||
                                e.target === dayNum ||
                                e.target.classList.contains(
                                    "monthly-holiday-name"
                                ))
                        ) {
                            // 移動モード中：このセルに移動
                            completeMoveMode(dateStr);
                        } else if (
                            isSimple &&
                            (selectedStamp || selectedMemoType) &&
                            (e.target === cell ||
                                e.target === dayNum ||
                                e.target.classList.contains(
                                    "monthly-holiday-name"
                                ) ||
                                e.target.classList.contains("stamp-label") ||
                                e.target.classList.contains("memo-icon"))
                        ) {
                            // シンプルモード：スタンプ/メモ貼付
                            applyStampToDate(dateStr);
                        } else if (
                            e.target === cell ||
                            e.target === dayNum ||
                            e.target.classList.contains("monthly-holiday-name")
                        ) {
                            // 通常：新規タスク追加モーダルを開く
                            openMonthlyTaskAddModal(dateStr);
                        }
                    });

                    // 月間モードに応じたセルスタイル
                    if (monthlyMode === "fixed") {
                        cell.style.maxHeight = "120px";
                    } else {
                        // expandモード：制限なし、全タスク表示
                        cell.style.maxHeight = "none";
                        cell.style.overflow = "visible";
                    }

                    calendar.appendChild(cell);
                }
            }

            // ===== 月間ビュー：行リサイズ機能 =====
            let resizingRow = null;
            let resizeStartY = 0;
            let resizeStartHeights = [];

            function startMonthlyResize(e) {
                e.preventDefault();
                const weekRow = parseInt(e.target.dataset.weekRow);
                resizingRow = weekRow;
                resizeStartY = e.clientY;

                const calendar = document.getElementById("monthlyCalendar");
                const cells = calendar.querySelectorAll(".monthly-day-cell");
                const startIndex = (weekRow - 1) * 7;
                resizeStartHeights = [];
                for (let j = 0; j < 7; j++) {
                    const actualIndex = startIndex + j;
                    if (cells[actualIndex]) {
                        resizeStartHeights.push(
                            cells[actualIndex].offsetHeight
                        );
                    }
                }

                document.addEventListener("mousemove", onMonthlyResize);
                document.addEventListener("mouseup", stopMonthlyResize);
                document.body.style.cursor = "ns-resize";
                document.body.style.userSelect = "none";
            }

            function startMonthlyResizeTouchWrapper(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const weekRow = parseInt(e.target.dataset.weekRow);
                resizingRow = weekRow;
                resizeStartY = touch.clientY;

                const calendar = document.getElementById("monthlyCalendar");
                const cells = calendar.querySelectorAll(".monthly-day-cell");
                const startIndex = (weekRow - 1) * 7;
                resizeStartHeights = [];
                for (let j = 0; j < 7; j++) {
                    const actualIndex = startIndex + j;
                    if (cells[actualIndex]) {
                        resizeStartHeights.push(
                            cells[actualIndex].offsetHeight
                        );
                    }
                }

                document.addEventListener("touchmove", onMonthlyResizeTouch, {
                    passive: false,
                });
                document.addEventListener("touchend", stopMonthlyResizeTouch);
            }

            function onMonthlyResize(e) {
                if (resizingRow === null) return;
                const delta = e.clientY - resizeStartY;
                applyRowResize(delta);
            }

            function onMonthlyResizeTouch(e) {
                e.preventDefault();
                if (resizingRow === null) return;
                const delta = e.touches[0].clientY - resizeStartY;
                applyRowResize(delta);
            }

            function applyRowResize(delta) {
                const calendar = document.getElementById("monthlyCalendar");
                const cells = calendar.querySelectorAll(".monthly-day-cell");
                const startIndex = (resizingRow - 1) * 7;

                for (let j = 0; j < 7; j++) {
                    const actualIndex = startIndex + j;
                    if (
                        cells[actualIndex] &&
                        resizeStartHeights[j] !== undefined
                    ) {
                        const newHeight = Math.max(
                            50,
                            resizeStartHeights[j] + delta
                        );
                        cells[actualIndex].style.height = newHeight + "px";
                        cells[actualIndex].style.maxHeight = newHeight + "px";
                        cells[actualIndex].style.minHeight = newHeight + "px";
                    }
                }
            }

            function stopMonthlyResize() {
                resizingRow = null;
                document.removeEventListener("mousemove", onMonthlyResize);
                document.removeEventListener("mouseup", stopMonthlyResize);
                document.body.style.cursor = "";
                document.body.style.userSelect = "";
            }

            function stopMonthlyResizeTouch() {
                resizingRow = null;
                document.removeEventListener("touchmove", onMonthlyResizeTouch);
                document.removeEventListener(
                    "touchend",
                    stopMonthlyResizeTouch
                );
            }

            // 月間カレンダーの幅調整
            function adjustMonthlyWidth(percent) {
                const calendar = document.getElementById("monthlyCalendar");
                calendar.style.width = percent + "%";
                calendar.style.minWidth = percent + "%";
            }

            function resetMonthlyWidth() {
                const slider = document.getElementById("monthlyWidthSlider");
                slider.value = 100;
                adjustMonthlyWidth(100);
            }

            function changeMonth(delta) {
                cancelMoveMode();
                currentMonthDate.setMonth(currentMonthDate.getMonth() + delta);
                renderMonthlyView();
                updateSeasonalArt();
            }

            // 週を変更
            function changeWeek(delta) {
                currentWeekDate.setDate(currentWeekDate.getDate() + delta * 7);
                renderWeeklyView();
            }

            // ===== 年間ビュー関数 =====

            // 年間ビューをレンダリング
            function renderYearlyView() {
                const year = currentYearDate.getFullYear();
                const calendar = document.getElementById("yearlyCalendar");
                const title = document.getElementById("yearlyTitle");

                title.textContent = `${year}年`;

                const today = new Date();
                const todayStr = `${today.getFullYear()}-${String(
                    today.getMonth() + 1
                ).padStart(2, "0")}-${String(today.getDate()).padStart(
                    2,
                    "0"
                )}`;

                const weekdayNames = ["日", "月", "火", "水", "木", "金", "土"];

                // グリッド構築
                let html = "";

                // ヘッダー行（空白 + 1月〜12月）
                html += '<div class="yearly-header-cell"></div>';
                for (let m = 1; m <= 12; m++) {
                    html += `<div class="yearly-header-cell">${m}月</div>`;
                }

                // 31日分の行
                for (let day = 1; day <= 31; day++) {
                    // 日ラベル
                    html += `<div class="yearly-day-label">${day}</div>`;

                    // 各月のセル
                    for (let month = 1; month <= 12; month++) {
                        const dateStr = `${year}-${String(month).padStart(
                            2,
                            "0"
                        )}-${String(day).padStart(2, "0")}`;
                        const date = new Date(year, month - 1, day);

                        // その月に存在しない日（例：2月30日）
                        if (date.getMonth() !== month - 1) {
                            html += '<div class="yearly-cell empty">-</div>';
                            continue;
                        }

                        const dayOfWeek = date.getDay();
                        const weekdayName = weekdayNames[dayOfWeek];
                        const isToday = dateStr === todayStr;
                        const isHoliday = japaneseHolidays[dateStr];

                        // その日のタスク数をカウント
                        const dayTasks = allTasks.filter(
                            (t) => t.date === dateStr
                        );
                        const taskCount = dayTasks.length;

                        let cellClass = "yearly-cell";
                        if (isToday) cellClass += " today";
                        if (dayOfWeek === 0) cellClass += " sunday";
                        if (dayOfWeek === 6) cellClass += " saturday";
                        if (isHoliday) cellClass += " holiday";
                        if (taskCount > 0) cellClass += " has-task";

                        // セル内容：曜日 + タスク数
                        let cellContent = `<span class="yearly-weekday">${weekdayName}</span>`;
                        if (taskCount > 0) {
                            cellContent += `<span class="yearly-task-count">${taskCount}</span>`;
                        }

                        html += `<div class="${cellClass}" data-date="${dateStr}" onclick="onYearlyCellClick('${dateStr}')">${cellContent}</div>`;
                    }
                }

                calendar.innerHTML = html;
            }

            // 年間セルクリック時の処理
            function onYearlyCellClick(dateStr) {
                // 月間ビューに遷移してその日にフォーカス
                const [year, month, day] = dateStr.split("-").map(Number);
                currentMonthDate = new Date(year, month - 1, 1);

                // 直接月間ビューを表示（switchViewを使わず）
                currentView = "monthly";
                const dailyView = document.querySelector(".container");
                const weeklyView = document.getElementById("weeklyView");
                const monthlyView = document.getElementById("monthlyView");
                const yearlyView = document.getElementById("yearlyView");

                dailyView.style.display = "none";
                weeklyView.style.display = "none";
                monthlyView.style.display = "block";
                yearlyView.style.display = "none";

                document
                    .querySelectorAll(".nav-tab")
                    .forEach((tab) => tab.classList.remove("active"));
                document.getElementById("navMonthly").classList.add("active");

                renderMonthlyView();
                localStorage.setItem("currentView", "monthly");

                // 少し遅延してから該当日にスクロール
                setTimeout(() => {
                    const targetCell = document.querySelector(
                        `.monthly-day-cell[data-date="${dateStr}"]`
                    );
                    if (targetCell) {
                        targetCell.scrollIntoView({
                            behavior: "smooth",
                            block: "center",
                        });
                        // ハイライト効果
                        targetCell.style.boxShadow = "0 0 10px #4caf50";
                        setTimeout(() => {
                            targetCell.style.boxShadow = "";
                        }, 2000);
                    }
                }, 100);
            }

            // 年を変更
            function changeYear(delta) {
                currentYearDate.setFullYear(
                    currentYearDate.getFullYear() + delta
                );
                renderYearlyView();
            }

            // スマホ用：移動モード開始
            function startMoveMode(taskId) {
                movingTaskId = taskId;

                // 移動中のタスクをハイライト
                const taskElements =
                    document.querySelectorAll(".monthly-task-item");
                taskElements.forEach((el) => {
                    if (el.dataset.taskId === taskId) {
                        el.classList.add("moving");
                    }
                });

                // 全セルを移動先候補としてマーク
                const cells = document.querySelectorAll(".monthly-day-cell");
                cells.forEach((cell) => {
                    cell.classList.add("move-target");
                });

                // 振動フィードバック（対応デバイスのみ）
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }

            // スマホ用：移動モード完了
            function completeMoveMode(newDate) {
                if (!movingTaskId) return;

                // タスクの日付を更新
                updateTask(movingTaskId, { date: newDate });

                // 移動モード終了
                movingTaskId = null;

                // 再描画
                renderMonthlyView();
                renderWeeklyView();

                // 日次も再描画
                for (let sec = 1; sec <= 4; sec++) {
                    renderTasks(sec);
                }

                // 振動フィードバック
                if (navigator.vibrate) {
                    navigator.vibrate([30, 30, 30]);
                }
            }

            // スマホ用：移動モードキャンセル
            function cancelMoveMode() {
                if (!movingTaskId) return;

                movingTaskId = null;

                // ハイライト解除
                document
                    .querySelectorAll(".monthly-task-item.moving")
                    .forEach((el) => {
                        el.classList.remove("moving");
                    });
                document
                    .querySelectorAll(".monthly-day-cell.move-target")
                    .forEach((el) => {
                        el.classList.remove("move-target");
                    });
            }

            function formatDateForDisplay(dateStr) {
                const date = new Date(dateStr);
                const weekdays = ["日", "月", "火", "水", "木", "金", "土"];
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const weekday = weekdays[date.getDay()];
                return `${date.getFullYear()}/${month}/${day}（${weekday}）`;
            }

            function openMonthlyTaskAddModal(dateStr) {
                document.getElementById("monthlyModalTitle").textContent =
                    "タスク追加";
                document.getElementById("monthlyTaskInput").value = "";
                document.getElementById("monthlyTaskMemo").value = "";
                document.getElementById("monthlyTaskDate").value = dateStr;
                document.getElementById("monthlyTaskId").value = "";
                clearTimeSelect("monthly"); // 時間なし
                document.getElementById("monthlyTaskSection").value = "2"; // デフォルトは第2象限
                document.getElementById("monthlyDeleteBtn").style.display =
                    "none";
                document
                    .getElementById("monthlyTaskModal")
                    .classList.add("show");
                document.getElementById("monthlyTaskInput").focus();
            }

            function openMonthlyTaskEditModal(taskId) {
                const task = allTasks.find((t) => t.id === taskId);
                if (!task) return;

                document.getElementById("monthlyModalTitle").textContent =
                    "タスク編集";
                document.getElementById("monthlyTaskInput").value = task.text;
                document.getElementById("monthlyTaskMemo").value =
                    task.memo || "";
                document.getElementById("monthlyTaskDate").value = task.date;
                document.getElementById("monthlyTaskId").value = task.id;
                setTimeSelect("monthly", task.time); // 時間があれば設定
                document.getElementById("monthlyTaskSection").value =
                    task.section;
                document.getElementById("monthlyDeleteBtn").style.display =
                    "inline-block";
                document
                    .getElementById("monthlyTaskModal")
                    .classList.add("show");
                document.getElementById("monthlyTaskInput").focus();
            }

            function closeMonthlyTaskModal() {
                document
                    .getElementById("monthlyTaskModal")
                    .classList.remove("show");
            }

            function saveMonthlyTask() {
                const text = document
                    .getElementById("monthlyTaskInput")
                    .value.trim();
                const memo = document
                    .getElementById("monthlyTaskMemo")
                    .value.trim();
                const dateStr =
                    document.getElementById("monthlyTaskDate").value;
                const taskId = document.getElementById("monthlyTaskId").value;
                const time = getTimeFromSelect("monthly");
                const section = parseInt(
                    document.getElementById("monthlyTaskSection").value
                );

                if (!text) {
                    alert("タスクを入力してください");
                    return;
                }

                if (!dateStr) {
                    alert("日付を入力してください");
                    return;
                }

                // 時間があれば週間にも表示
                const showInWeekly = time ? true : false;

                if (taskId) {
                    // 編集（日付も更新）
                    updateTask(taskId, {
                        text,
                        memo: memo || null,
                        date: dateStr,
                        time,
                        section,
                        showInWeekly,
                    });
                } else {
                    // 新規作成
                    const newTask = createTask(
                        text,
                        dateStr,
                        time,
                        section,
                        true,
                        showInWeekly
                    );
                    if (memo) {
                        updateTask(newTask.id, { memo });
                    }
                }

                closeMonthlyTaskModal();
                renderMonthlyView();

                // 週間も再描画
                renderWeeklyView();

                // 日次も再描画
                for (let i = 1; i <= 4; i++) {
                    renderTasks(i);
                }
            }

            function deleteMonthlyTask() {
                const taskId = document.getElementById("monthlyTaskId").value;
                if (!taskId) return;

                if (confirm("このタスクを削除しますか？")) {
                    deleteTaskById(taskId);
                    closeMonthlyTaskModal();
                    renderMonthlyView();

                    // 日次も再描画
                    for (let i = 1; i <= 4; i++) {
                        renderTasks(i);
                    }
                }
            }

            // 週間タスク作成モーダルを開く
            function openWeeklyTaskCreateModal(dateStr, hour) {
                creatingTask = { dateStr, hour };

                // 日付表示を設定
                document.getElementById("weeklyModalDate").textContent =
                    formatDateForDisplay(dateStr);

                // タスク名をクリア
                document.getElementById("createTaskText").value = "";

                // 象限をデフォルトに
                document.getElementById("createTaskSection").value = "2";

                // 時間セレクトボックスを生成（15分刻み）
                const timeSelect = document.getElementById("createTaskTime");
                timeSelect.innerHTML = "";
                for (let h = 0; h <= 23; h++) {
                    for (let min = 0; min < 60; min += 15) {
                        const timeStr = `${String(h).padStart(2, "0")}:${String(
                            min
                        ).padStart(2, "0")}`;
                        const option = document.createElement("option");
                        option.value = timeStr;
                        option.textContent = timeStr;
                        if (h === hour && min === 0) {
                            option.selected = true;
                        }
                        timeSelect.appendChild(option);
                    }
                }

                // モーダルを表示
                document
                    .getElementById("weeklyTaskCreateModal")
                    .classList.add("show");

                // フォーカス
                setTimeout(() => {
                    document.getElementById("createTaskText").focus();
                }, 100);
            }

            // 作成モーダルを閉じる
            function closeCreateModal() {
                document
                    .getElementById("weeklyTaskCreateModal")
                    .classList.remove("show");
                document.getElementById("createTaskMemo").value = "";
                creatingTask = null;
            }

            // タスクを作成
            function saveCreateTask() {
                if (!creatingTask) return;

                const taskText = document
                    .getElementById("createTaskText")
                    .value.trim();
                const taskMemo = document
                    .getElementById("createTaskMemo")
                    .value.trim();
                const taskTime =
                    document.getElementById("createTaskTime").value;
                const taskSection = parseInt(
                    document.getElementById("createTaskSection").value
                );

                if (!taskText) {
                    alert("タスク名を入力してください");
                    return;
                }

                // 週間タスク作成時は日次にも週間にも表示
                const showInDaily = true;
                const showInWeekly = true;

                // マスターデータに追加
                const newTask = createTask(
                    taskText,
                    creatingTask.dateStr,
                    taskTime,
                    taskSection,
                    showInDaily,
                    showInWeekly
                );

                // メモがあれば設定
                if (taskMemo) {
                    updateTask(newTask.id, { memo: taskMemo });
                }

                closeCreateModal();
                renderWeeklyView();
                renderMonthlyView();

                // 日次も再描画
                for (let sec = 1; sec <= 4; sec++) {
                    renderTasks(sec);
                }
            }

            // 週間タスクの削除
            // 週間タスク削除（旧システム・デッドコード削除済み）
            // → editWeeklyTaskByIdまたはdeleteTaskByIdを使用してください

            // 週間データの保存（旧システム・デッドコード削除済み）
            // → saveAllTasks()を使用してください

            // 週間データの読み込み（旧システム・移行処理用に保持）
            function loadWeeklyData() {
                const saved = localStorage.getItem("weeklyTasks");
                if (saved) {
                    try {
                        weeklyTasks = JSON.parse(saved);
                    } catch (e) {
                        console.error("週間データの読み込みに失敗しました", e);
                    }
                }
            }

            // タイマー関連関数
            function handleTimerClick() {
                stopTimer(); // 現在のタイマーを停止

                if (timerState === "idle") {
                    // アイドル状態では何もしない（確定ボタンから開始）
                    return;
                } else if (timerState === "thinking") {
                    // 目的出し → イメージ
                    timerState = "imagine";
                    timeLeft = 60;
                    startTimer();
                } else if (timerState === "imagine") {
                    // イメージ → 書き出し
                    timerState = "writing";
                    timeLeft = 60;
                    startTimer();
                } else if (timerState === "writing") {
                    // 書き出し → 選択
                    timerState = "selecting";
                    timeLeft = 5;
                    startTimer();
                } else if (timerState === "selecting") {
                    // 選択 → 実行（一番上を自動選択）
                    autoSelectTopTask();
                    timerState = "executing";
                    timeLeft = 60;
                    startTimer();
                } else if (timerState === "executing") {
                    // 実行 → 完了（オレンジ解除）
                    selectedTaskText = null;
                    for (let i = 1; i <= 4; i++) {
                        renderTasks(i);
                    }
                    timerState = "complete";
                    updateTimerDisplay();
                } else if (timerState === "complete") {
                    // 完了 → ポモドーロ開始
                    pomodoroCount = 0;
                    timerState = "pomodoro";
                    timeLeft = 25 * 60; // 25分
                    startTimer();
                } else if (timerState === "pomodoro") {
                    // ポモドーロ実行中 → スキップして休憩へ
                    timerState = "pomodoroBreak";
                    timeLeft = 5 * 60; // 5分
                    startTimer();
                } else if (timerState === "pomodoroBreak") {
                    // 休憩中 → スキップして実行へ
                    pomodoroCount++;
                    if (pomodoroCount >= 2) {
                        timerState = "pomodoroComplete";
                        updateTimerDisplay();
                    } else {
                        timerState = "pomodoro";
                        timeLeft = 25 * 60;
                        startTimer();
                    }
                } else if (timerState === "pomodoroComplete") {
                    // ポモドーロ完了 → 完全リセット（目的入力に戻る）
                    timerState = "idle";
                    timeLeft = 60;
                    selectedTaskText = null;
                    pomodoroCount = 0;
                    purpose = "";
                    purposeConfirmed = false;

                    // 目的入力画面に戻す
                    document.getElementById("purposeGroup").style.display =
                        "flex";
                    document.getElementById("purposeDisplay").style.display =
                        "none";
                    document.getElementById("purposeInput").value = "";

                    // ハイライト解除
                    for (let i = 1; i <= 4; i++) {
                        renderTasks(i);
                    }

                    updateTimerDisplay();
                }
            }

            function startTimer() {
                updateTimerDisplay();
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) {
                        stopTimer();
                        if (timerState === "thinking") {
                            timerState = "imagine";
                            timeLeft = 60;
                            updateTimerDisplay();
                            setTimeout(() => startTimer(), 100);
                        } else if (timerState === "imagine") {
                            timerState = "writing";
                            timeLeft = 60;
                            updateTimerDisplay();
                            setTimeout(() => startTimer(), 100);
                        } else if (timerState === "writing") {
                            timerState = "selecting";
                            timeLeft = 5; // 5秒カウントダウン
                            updateTimerDisplay();
                            setTimeout(() => startTimer(), 100);
                        } else if (timerState === "selecting") {
                            // 5秒経過：一番上のタスクを自動選択
                            autoSelectTopTask();
                            timerState = "executing";
                            timeLeft = 60;
                            updateTimerDisplay();
                            setTimeout(() => startTimer(), 100);
                        } else if (timerState === "executing") {
                            // 実行終了：オレンジ解除
                            selectedTaskText = null;
                            // 全セクション再レンダリング
                            for (let i = 1; i <= 4; i++) {
                                renderTasks(i);
                            }
                            timerState = "complete";
                            updateTimerDisplay();
                        } else if (timerState === "pomodoro") {
                            // ポモドーロ25分終了 → 休憩へ
                            timerState = "pomodoroBreak";
                            timeLeft = 5 * 60; // 5分
                            updateTimerDisplay();
                            setTimeout(() => startTimer(), 100);
                        } else if (timerState === "pomodoroBreak") {
                            // 休憩5分終了 → 次のポモドーロへ
                            pomodoroCount++;
                            if (pomodoroCount >= 2) {
                                timerState = "pomodoroComplete";
                                updateTimerDisplay();
                            } else {
                                timerState = "pomodoro";
                                timeLeft = 25 * 60; // 25分
                                updateTimerDisplay();
                                setTimeout(() => startTimer(), 100);
                            }
                        }
                    }
                }, 1000);
            }

            function stopTimer() {
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
            }

            function updateTimerDisplay() {
                const btn = document.getElementById("timerBtn");
                if (!btn) return;

                let text = "";
                let color = "#3b82f6"; // デフォルト：鮮やかな青

                if (timerState === "idle") {
                    text = "";
                    color = "#3b82f6"; // 鮮やかな青 - スタート
                } else if (timerState === "countdown") {
                    // カウントダウン中は何も表示しない（confirmPurpose内で直接設定）
                    return;
                } else if (timerState === "thinking") {
                    const mins = Math.floor(timeLeft / 60);
                    const secs = timeLeft % 60;
                    text = `目の前の1分を最高密度に！ ${mins}:${secs
                        .toString()
                        .padStart(2, "0")}`;
                    if (timeLeft > 30)
                        color = "#22c55e"; // ライムグリーン - GO!
                    else if (timeLeft > 10)
                        color = "#f59e0b"; // ゴールド - 集中
                    else color = "#dc2626"; // 赤 - ラスト!
                } else if (timerState === "imagine") {
                    const mins = Math.floor(timeLeft / 60);
                    const secs = timeLeft % 60;
                    text = `イメージタイム！最高の理想を思い描く！ ${mins}:${secs
                        .toString()
                        .padStart(2, "0")}`;
                    if (timeLeft > 40) color = "#22c55e"; // 鮮やかな緑
                    else if (timeLeft > 20) color = "#4ade80"; // 優しい緑
                    else color = "#86efac"; // さらに優しい緑
                } else if (timerState === "writing") {
                    const mins = Math.floor(timeLeft / 60);
                    const secs = timeLeft % 60;
                    text = `思いつくこと全部書き出せ！吐き出せ！ ${mins}:${secs
                        .toString()
                        .padStart(2, "0")}`;
                    if (timeLeft > 30) color = "#22c55e";
                    else if (timeLeft > 10) color = "#f59e0b";
                    else color = "#dc2626";
                } else if (timerState === "selecting") {
                    text = `5秒で選べ、センターピン！ ${timeLeft}`;
                    color = "#dc2626"; // 赤 - 緊急
                } else if (timerState === "executing") {
                    const mins = Math.floor(timeLeft / 60);
                    const secs = timeLeft % 60;
                    text = `これから1分だけ、作業に没頭してみよう！ ${mins}:${secs
                        .toString()
                        .padStart(2, "0")}`;
                    if (timeLeft > 30)
                        color = "#22c55e"; // ライムグリーン - GO!
                    else if (timeLeft > 10)
                        color = "#f59e0b"; // ゴールド - 集中
                    else color = "#dc2626"; // 赤 - ラスト!
                } else if (timerState === "complete") {
                    text = "Keep Going!";
                    color = "#e0e0e0"; // グレー（確定ボタンと同じ）
                } else if (timerState === "pomodoro") {
                    const mins = Math.floor(timeLeft / 60);
                    const secs = timeLeft % 60;
                    text = `ポモドーロタイマー実行中 ${mins}:${secs
                        .toString()
                        .padStart(2, "0")} [${pomodoroCount + 1}/2]`;
                    if (timeLeft > 15 * 60) color = "#22c55e"; // 緑
                    else if (timeLeft > 5 * 60) color = "#f59e0b"; // ゴールド
                    else color = "#dc2626"; // 赤
                } else if (timerState === "pomodoroBreak") {
                    const mins = Math.floor(timeLeft / 60);
                    const secs = timeLeft % 60;
                    text = `休憩中 ${mins}:${secs
                        .toString()
                        .padStart(2, "0")} [${pomodoroCount}/2]`;
                    color = "#4ade80"; // 優しい緑
                } else if (timerState === "pomodoroComplete") {
                    text = "自分との約束を果たそう";
                    color = "#e0e0e0"; // グレー
                }

                btn.textContent = text;
                btn.style.backgroundColor = color;

                // idle状態の時はボタンを非表示
                if (timerState === "idle") {
                    btn.style.display = "none";
                } else {
                    btn.style.display = "block";
                }

                // Keep Going!とポモドーロ完了の時は文字色もグレーに
                if (
                    timerState === "complete" ||
                    timerState === "pomodoroComplete"
                ) {
                    btn.style.color = "#666";
                } else {
                    btn.style.color = "white";
                }
            }

            // タスク選択
            function selectTask(sectionNum, index) {
                const today = getLocalDateStr(new Date());
                const dailyTasks = getDailyTasks(today);
                if (dailyTasks[sectionNum] && dailyTasks[sectionNum][index]) {
                    selectTaskById(dailyTasks[sectionNum][index].id);
                }
            }

            // ID版：タスク選択
            function selectTaskById(taskId) {
                const task = allTasks.find((t) => t.id === taskId);
                if (task) {
                    selectedTaskText = task.text;
                    // 全セクションを再レンダリング
                    for (let i = 1; i <= 4; i++) {
                        renderTasks(i);
                    }
                }
            }

            // 一番上のタスクを自動選択
            function autoSelectTopTask() {
                const today = getLocalDateStr(new Date());
                const dailyTasks = getDailyTasks(today);
                if (dailyTasks[1].length > 0) {
                    selectTaskById(dailyTasks[1][0].id);
                }
            }

            // タスク追加
            function addTask(sectionNum) {
                const input = document.getElementById("input" + sectionNum);
                const text = input.value.trim();

                if (text) {
                    const today = getLocalDateStr(new Date());

                    // 日次タスクは日次のみに表示
                    const newTask = createTask(
                        text,
                        today,
                        null,
                        sectionNum,
                        true,
                        false
                    );

                    input.value = "";
                    renderTasks(sectionNum);
                }
            }

            // タスク完了トグル（ID版）
            function toggleTaskById(taskId) {
                const task = allTasks.find((t) => t.id === taskId);
                if (task) {
                    task.completed = !task.completed;
                    task.updatedAt = new Date().toISOString();
                    saveAllTasks();

                    // 日次ビュー：全象限を再描画
                    for (let sec = 1; sec <= 4; sec++) {
                        renderTasks(sec);
                    }

                    // 週間ビューが表示されていたら更新
                    if (
                        document.getElementById("weeklyView").style.display ===
                        "block"
                    ) {
                        renderWeeklyView();
                    }
                }
            }

            // タスク完了トグル（旧版・互換性のため残す）
            function toggleTask(sectionNum, index) {
                const today = getLocalDateStr(new Date());
                const dailyTasks = getDailyTasks(today);
                const task = dailyTasks[sectionNum][index];
                if (task) {
                    toggleTaskById(task.id);
                }
            }

            // タスク編集（インライン）
            function editTask(sectionNum, index, textSpan) {
                const today = getLocalDateStr(new Date());
                const dailyTasks = getDailyTasks(today);
                if (dailyTasks[sectionNum] && dailyTasks[sectionNum][index]) {
                    editTaskById(dailyTasks[sectionNum][index].id, textSpan);
                }
            }

            // ID版：タスク編集
            function editTaskById(taskId, textSpan) {
                openTaskEditModal(taskId);
            }

            // ===== カスタム時間ピッカー（セレクト式） =====

            // セレクトから時間を取得
            function getTimeFromSelect(prefix) {
                const hourSelect = document.getElementById(
                    prefix + "HourSelect"
                );
                const minuteSelect = document.getElementById(
                    prefix + "MinuteSelect"
                );

                if (!hourSelect || !minuteSelect) return null;

                const hour = hourSelect.value;
                const minute = minuteSelect.value;

                if (hour === "" || minute === "") return null;

                return `${String(hour).padStart(2, "0")}:${String(
                    minute
                ).padStart(2, "0")}`;
            }

            // セレクトに時間を設定
            function setTimeSelect(prefix, timeStr) {
                const hourSelect = document.getElementById(
                    prefix + "HourSelect"
                );
                const minuteSelect = document.getElementById(
                    prefix + "MinuteSelect"
                );

                if (!hourSelect || !minuteSelect) return;

                if (timeStr && timeStr.includes(":")) {
                    const [h, m] = timeStr.split(":").map(Number);
                    hourSelect.value = h;
                    // 分は5分刻みなので、最も近い値に丸める
                    const roundedMinute = Math.round(m / 5) * 5;
                    minuteSelect.value =
                        roundedMinute >= 60 ? 55 : roundedMinute;
                } else {
                    hourSelect.value = "";
                    minuteSelect.value = "";
                }
            }

            // 時間をクリア
            function clearTimeSelect(prefix) {
                const hourSelect = document.getElementById(
                    prefix + "HourSelect"
                );
                const minuteSelect = document.getElementById(
                    prefix + "MinuteSelect"
                );

                if (hourSelect) hourSelect.value = "";
                if (minuteSelect) minuteSelect.value = "";
            }

            // タスク編集モーダルを開く
            function openTaskEditModal(taskId) {
                const task = allTasks.find((t) => t.id === taskId);
                if (!task) return;

                document.getElementById("taskEditId").value = taskId;
                document.getElementById("taskEditText").value = task.text;
                document.getElementById("taskEditMemo").value = task.memo || "";
                document.getElementById("taskEditDate").value = task.date || "";

                // セレクトに時間を設定
                setTimeSelect("taskEdit", task.time);

                document.getElementById("taskEditModal").classList.add("show");

                // テキスト入力にフォーカス
                setTimeout(() => {
                    document.getElementById("taskEditText").focus();
                }, 100);
            }

            // タスク編集モーダルを閉じる
            function closeTaskEditModal() {
                document
                    .getElementById("taskEditModal")
                    .classList.remove("show");
            }

            // タスク編集を保存
            function saveTaskEdit() {
                const taskId = document.getElementById("taskEditId").value;
                const text = document
                    .getElementById("taskEditText")
                    .value.trim();
                const memo = document
                    .getElementById("taskEditMemo")
                    .value.trim();
                const date = document.getElementById("taskEditDate").value;
                const time = getTimeFromSelect("taskEdit");

                if (!text) {
                    alert("タスク名を入力してください");
                    return;
                }

                if (!date) {
                    alert("日付を入力してください");
                    return;
                }

                updateTask(taskId, {
                    text: text,
                    memo: memo || null,
                    date: date,
                    time: time,
                });

                closeTaskEditModal();

                // 全画面を再描画
                const dateStr = currentDailyDate || getLocalDateStr(new Date());
                for (let sec = 1; sec <= 4; sec++) {
                    renderTasks(sec, dateStr);
                }
                renderWeeklyView();
                if (
                    document.getElementById("monthlyView").style.display ===
                    "block"
                ) {
                    renderMonthlyView();
                }
            }

            // 編集モーダルから削除
            function deleteTaskFromEditModal() {
                const taskId = document.getElementById("taskEditId").value;
                const task = allTasks.find((t) => t.id === taskId);

                if (!task) return;

                if (confirm(`「${task.text}」を削除しますか？`)) {
                    removeTaskFromMaster(taskId);
                    closeTaskEditModal();

                    // 全画面を再描画
                    const dateStr =
                        currentDailyDate || getLocalDateStr(new Date());
                    for (let sec = 1; sec <= 4; sec++) {
                        renderTasks(sec, dateStr);
                    }
                    renderWeeklyView();
                    if (
                        document.getElementById("monthlyView").style.display ===
                        "block"
                    ) {
                        renderMonthlyView();
                    }
                }
            }

            // タスク削除（旧版）
            function deleteTask(sectionNum, index) {
                const today = getLocalDateStr(new Date());
                const dailyTasks = getDailyTasks(today);
                if (dailyTasks[sectionNum] && dailyTasks[sectionNum][index]) {
                    deleteTaskById(dailyTasks[sectionNum][index].id);
                }
            }

            // ID版：タスク削除
            function deleteTaskById(taskId) {
                const task = allTasks.find((t) => t.id === taskId);
                if (!task) {
                    console.error("タスクが見つかりません:", taskId);
                    return;
                }

                const index = allTasks.findIndex((t) => t.id === taskId);
                if (index !== -1) {
                    allTasks.splice(index, 1);
                    saveAllTasks();
                }

                // 日次ビュー：全象限を再描画
                for (let sec = 1; sec <= 4; sec++) {
                    renderTasks(sec);
                }

                // 週間ビューが表示されていたら更新
                if (
                    document.getElementById("weeklyView").style.display ===
                    "block"
                ) {
                    renderWeeklyView();
                }
            }

            // 旧deleteTask関数は削除済み

            // タスクから逃げる
            // ログ記録関数
            function logAction(type, taskText = "") {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth() + 1; // 0-indexed
                const day = now.getDate();
                const hours = now.getHours().toString().padStart(2, "0");
                const minutes = now.getMinutes().toString().padStart(2, "0");

                const dateStr = `${year}/${month}/${day}`;
                const timeStr = `${hours}:${minutes}`;

                const logEntry = {
                    date: `${dateStr} ${timeStr}`,
                    type: type, // 'open', 'inspect', 'escape'
                };

                if (type === "escape") {
                    logEntry.task = taskText;
                }

                escapeLog.push(logEntry);

                // LocalStorageに保存
                localStorage.setItem("escapeLog", JSON.stringify(escapeLog));
            }

            function escapeTask(sectionNum, index) {
                const today = getLocalDateStr(new Date());
                const dailyTasks = getDailyTasks(today);
                if (dailyTasks[sectionNum] && dailyTasks[sectionNum][index]) {
                    escapeTaskById(dailyTasks[sectionNum][index].id);
                }
            }

            // ID版：タスクから逃げる
            function escapeTaskById(taskId) {
                const task = allTasks.find((t) => t.id === taskId);
                if (!task) return;

                // 逃げログに記録
                logAction("escape", task.text);

                // タスクを削除
                const section = task.section;
                const index = allTasks.findIndex((t) => t.id === taskId);
                if (index !== -1) {
                    allTasks.splice(index, 1);
                    saveAllTasks();
                }
                renderTasks(section);

                // 「逃げ出した！」メッセージ表示
                showEscapeMessage();
            }

            // 逃げ出したメッセージを表示
            function showEscapeMessage() {
                const msg = document.getElementById("escapeMessage");
                msg.classList.add("show");
                setTimeout(() => {
                    msg.classList.remove("show");
                }, 1000);
            }

            // タスク表示（dateStrがnullなら今日）
            function renderTasks(sectionNum, dateStr = null) {
                const list = document.getElementById("list" + sectionNum);
                list.innerHTML = "";

                // マスターデータからタスクを取得
                const targetDate = dateStr || getLocalDateStr(new Date());
                const dailyTasks = getDailyTasks(targetDate);
                const sectionTasks = dailyTasks[sectionNum];

                sectionTasks.forEach((task, index) => {
                    const li = document.createElement("li");
                    li.className =
                        "task-item" + (task.completed ? " completed" : "");
                    li.dataset.taskId = task.id; // IDを保存

                    // 選択されたタスクにハイライト（IDで照合）
                    if (selectedTaskText && task.text === selectedTaskText) {
                        li.classList.add("selected-task");
                    }

                    li.draggable = true;
                    li.dataset.index = index;
                    li.dataset.section = sectionNum;

                    // ドラッグ開始
                    li.addEventListener("dragstart", (e) => {
                        li.classList.add("dragging");
                        e.dataTransfer.effectAllowed = "move";
                        e.dataTransfer.setData(
                            "text/plain",
                            JSON.stringify({
                                taskId: task.id, // IDを使用
                                section: sectionNum,
                                index: index,
                                task: task,
                            })
                        );
                    });

                    // ドラッグ終了
                    li.addEventListener("dragend", (e) => {
                        li.classList.remove("dragging");
                        document
                            .querySelectorAll(".task-item")
                            .forEach((item) => {
                                item.classList.remove(
                                    "drag-over-top",
                                    "drag-over-bottom"
                                );
                            });
                        document
                            .querySelectorAll(".section")
                            .forEach((section) => {
                                section.classList.remove("drag-over-section");
                            });
                    });

                    // ドラッグオーバー
                    li.addEventListener("dragover", (e) => {
                        e.preventDefault();
                        const dragging = document.querySelector(".dragging");
                        if (dragging && dragging !== li) {
                            // 全てのタスクで上半分/下半分を判定
                            const rect = li.getBoundingClientRect();
                            const midpoint = rect.top + rect.height / 2;

                            li.classList.remove(
                                "drag-over-top",
                                "drag-over-bottom"
                            );
                            if (e.clientY < midpoint) {
                                li.classList.add("drag-over-top");
                            } else {
                                li.classList.add("drag-over-bottom");
                            }
                        }
                    });

                    // ドラッグ離脱
                    li.addEventListener("dragleave", (e) => {
                        li.classList.remove(
                            "drag-over-top",
                            "drag-over-bottom"
                        );
                    });

                    // ドロップ
                    li.addEventListener("drop", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        li.classList.remove(
                            "drag-over-top",
                            "drag-over-bottom"
                        );

                        const dragging = document.querySelector(".dragging");
                        if (!dragging || dragging === li) return;

                        try {
                            const dragData = JSON.parse(
                                e.dataTransfer.getData("text/plain")
                            );
                            const taskId = dragData.taskId;
                            const fromSection = dragData.section;
                            const toSection = parseInt(li.dataset.section);
                            const dropIndex = parseInt(li.dataset.index);

                            // 上半分か下半分かを判定
                            const rect = li.getBoundingClientRect();
                            const midpoint = rect.top + rect.height / 2;
                            const insertBefore = e.clientY < midpoint;

                            // 対象セクションのタスクを取得（order順）
                            const dailyTasks = getDailyTasks(targetDate);
                            const targetTasks = dailyTasks[toSection];

                            // 新しいorderを計算
                            let newOrder;
                            if (targetTasks.length === 0) {
                                newOrder = 0;
                            } else if (insertBefore) {
                                // 上に挿入：ターゲットのorderより小さい値
                                const targetOrder =
                                    targetTasks[dropIndex]?.order || 0;
                                const prevOrder =
                                    dropIndex > 0
                                        ? targetTasks[dropIndex - 1]?.order || 0
                                        : targetOrder - 1;
                                newOrder = (prevOrder + targetOrder) / 2;
                            } else {
                                // 下に挿入：ターゲットのorderより大きい値
                                const targetOrder =
                                    targetTasks[dropIndex]?.order || 0;
                                const nextOrder =
                                    dropIndex < targetTasks.length - 1
                                        ? targetTasks[dropIndex + 1]?.order ||
                                          targetOrder + 1
                                        : targetOrder + 1;
                                newOrder = (targetOrder + nextOrder) / 2;
                            }

                            // マスターデータを更新（section と order）
                            updateTask(taskId, {
                                section: toSection,
                                order: newOrder,
                            });

                            // 画面更新（同じセクションでも再描画）
                            renderTasks(fromSection, targetDate);
                            if (toSection !== fromSection) {
                                renderTasks(toSection, targetDate);
                            }
                        } catch (err) {
                            console.error("ドロップエラー:", err);
                        }
                    });

                    const textSpan = document.createElement("span");
                    textSpan.className = "task-text";
                    // 時間があれば表示
                    const displayText = task.time
                        ? `${task.time} ${task.text}`
                        : task.text;
                    textSpan.textContent = displayText;
                    textSpan.onclick = () => {
                        if (timerState === "selecting") {
                            // 選択モード：タスクを選択
                            selectTaskById(task.id);
                        } else {
                            // 通常モード：完了トグル
                            toggleTaskById(task.id);
                        }
                    };

                    const editBtn = document.createElement("span");
                    editBtn.className = "edit-task-btn";
                    editBtn.textContent = "📝";
                    editBtn.title = task.memo
                        ? "メモあり - クリックで編集"
                        : "編集・メモ追加";
                    editBtn.style.opacity = task.memo ? "1" : "0.4";
                    editBtn.onclick = (e) => {
                        e.stopPropagation();
                        editTaskById(task.id, textSpan);
                    };

                    const escapeBtn = document.createElement("span");
                    escapeBtn.className = "escape-btn";
                    escapeBtn.textContent = "🏃";
                    escapeBtn.title = "逃げる";
                    escapeBtn.onclick = (e) => {
                        e.stopPropagation();
                        escapeTaskById(task.id);
                    };

                    const scheduleBtn = document.createElement("span");
                    scheduleBtn.className = "schedule-btn";
                    scheduleBtn.textContent = "📅";
                    scheduleBtn.title = "週間に追加";
                    scheduleBtn.onclick = (e) => {
                        e.stopPropagation();
                        openDaySelectModalById(task.id);
                    };

                    const deleteBtn = document.createElement("span");
                    deleteBtn.className = "delete-btn";
                    deleteBtn.textContent = "×";
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteTaskById(task.id);
                    };

                    li.appendChild(textSpan);
                    li.appendChild(editBtn);
                    li.appendChild(escapeBtn);
                    li.appendChild(scheduleBtn);
                    li.appendChild(deleteBtn);
                    list.appendChild(li);
                });
            }

            // 象限へのドロップを設定（初期化時に一度だけ呼ぶ）
            function setupAllSectionDrops() {
                for (let i = 1; i <= 4; i++) {
                    const section = document.getElementById("section" + i);
                    const list = document.getElementById("list" + i);

                    section.addEventListener("dragover", (e) => {
                        e.preventDefault();
                        const dragging = document.querySelector(".dragging");
                        if (dragging && dragging.dataset.section != i) {
                            section.classList.add("drag-over-section");
                        }
                    });

                    section.addEventListener("dragleave", (e) => {
                        if (!section.contains(e.relatedTarget)) {
                            section.classList.remove("drag-over-section");
                        }
                    });

                    section.addEventListener("drop", (e) => {
                        e.preventDefault();
                        section.classList.remove("drag-over-section");

                        const dragging = document.querySelector(".dragging");
                        if (dragging) {
                            try {
                                const dragData = JSON.parse(
                                    e.dataTransfer.getData("text/plain")
                                );
                                const taskId = dragData.taskId;
                                const fromSection = dragData.section;
                                const toSection = i;

                                if (fromSection !== toSection) {
                                    // 移動先セクションの最後にorderを設定
                                    const today = getLocalDateStr(new Date());
                                    const dailyTasks = getDailyTasks(today);
                                    const targetTasks = dailyTasks[toSection];
                                    const maxOrder =
                                        targetTasks.length > 0
                                            ? Math.max(
                                                  ...targetTasks.map(
                                                      (t) => t.order || 0
                                                  )
                                              ) + 1
                                            : 0;

                                    // マスターデータのsectionとorderを更新
                                    updateTask(taskId, {
                                        section: toSection,
                                        order: maxOrder,
                                    });

                                    // 両方の象限を再描画
                                    renderTasks(fromSection);
                                    renderTasks(toSection);
                                }
                            } catch (err) {
                                console.error("象限ドロップエラー:", err);
                            }
                        }
                    });
                }
            }

            // データ保存（旧システム・デッドコード削除済み）
            // → saveAllTasks()を使用してください

            // データ読み込み（旧システム・移行処理用に保持）
            function loadData() {
                const saved = localStorage.getItem("todoData");
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        purpose = data.purpose || "";
                        purposeConfirmed = data.purposeConfirmed || false;
                        stopCondition = data.stopCondition || "";
                        stopConditionSaved = data.stopConditionSaved || false;
                        tasks = data.tasks || { 1: [], 2: [], 3: [], 4: [] };

                        if (purposeConfirmed && purpose) {
                            document.getElementById(
                                "purposeGroup"
                            ).style.display = "none";
                            document.getElementById(
                                "purposeDisplay"
                            ).style.display = "flex";
                            document.getElementById("purposeText").textContent =
                                "目的: " + purpose;

                            // 目的が確定済みの場合、タイマーはidle状態のまま
                            // （青いボタン「目の前の1分を〜」を表示）
                            updateTimerDisplay();
                        }

                        // 止める仕組みは保存されていても、点検ボタンを押すまで表示しない
                        // if (stopConditionSaved && stopCondition) {
                        //   document.getElementById('stopConditionGroup').style.display = 'none';
                        //   document.getElementById('stopConditionDisplay').style.display = 'flex';
                        //   document.getElementById('stopConditionText').textContent = stopCondition;
                        // }

                        for (let i = 1; i <= 4; i++) {
                            renderTasks(i);
                        }
                    } catch (e) {
                        console.error("データの読み込みに失敗しました", e);
                    }
                }

                // 逃げログの読み込み
                const savedEscapeLog = localStorage.getItem("escapeLog");
                if (savedEscapeLog) {
                    try {
                        escapeLog = JSON.parse(savedEscapeLog);
                    } catch (e) {
                        console.error("逃げログの読み込みに失敗しました", e);
                    }
                }
            }

            // 全データクリア - モーダルを表示
            function clearAllData() {
                document.getElementById("customModal").classList.add("show");
            }

            // モーダルを閉じる
            function closeModal() {
                document.getElementById("customModal").classList.remove("show");
            }

            // データを実際に削除
            function executeDelete() {
                closeModal();

                // 旧データ構造（互換性のため保持）
                localStorage.removeItem("todoData");
                localStorage.removeItem("deepDiveState");
                localStorage.removeItem("useColors");
                localStorage.removeItem("escapeLog");

                // マスターデータ
                localStorage.removeItem("allTasks");
                localStorage.removeItem("taskIdCounter");
                localStorage.removeItem("showInDailyMigrationDone_v1");

                // 目的・止める仕組み
                localStorage.removeItem("purpose");
                localStorage.removeItem("purposeConfirmed");
                localStorage.removeItem("stopCondition");
                localStorage.removeItem("stopConditionSaved");

                // 変数をリセット
                allTasks = [];
                taskIdCounter = 1;
                purpose = "";
                purposeConfirmed = false;
                stopCondition = "";
                stopConditionSaved = false;
                tasks = { 1: [], 2: [], 3: [], 4: [] };
                escapeLog = [];

                // タイマー状態をリセット
                timerState = "idle";
                timeLeft = 60;
                selectedTaskText = null;
                pomodoroCount = 0;
                stopTimer();

                document.getElementById("purposeGroup").style.display = "flex";
                document.getElementById("purposeDisplay").style.display =
                    "none";
                document.getElementById("purposeInput").value = "";
                document.getElementById("purposeText").textContent = "";

                document.getElementById("stopConditionGroup").style.display =
                    "flex";
                document.getElementById("stopConditionDisplay").style.display =
                    "none";
                document.getElementById("stopConditionInput").value = "";
                document.getElementById("stopConditionText").textContent = "";

                // タイマー表示を更新
                updateTimerDisplay();

                // 日次ビューを再描画
                for (let i = 1; i <= 4; i++) {
                    renderTasks(i);
                }

                // 週間ビューも再描画
                renderWeeklyView();
            }

            // ===== エクスポート/インポート機能 =====

            // エクスポート：JSONファイルをダウンロード
            function exportData() {
                const exportObj = {
                    version: "9.5",
                    exportedAt: new Date().toISOString(),
                    tasks: allTasks,
                };

                const jsonStr = JSON.stringify(exportObj, null, 2);
                const blob = new Blob([jsonStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);

                const today = new Date();
                const dateStr = `${today.getFullYear()}-${String(
                    today.getMonth() + 1
                ).padStart(2, "0")}-${String(today.getDate()).padStart(
                    2,
                    "0"
                )}`;
                const filename = `yarukotolist_${dateStr}.json`;

                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert(
                    `エクスポート完了！\n${allTasks.length}件のタスクを保存しました。\n\nファイル: ${filename}`
                );
            }

            // インポート：JSONファイルを読み込み
            function importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = JSON.parse(e.target.result);

                        // バリデーション（tasksまたはallTasksキーに対応）
                        const tasksData = data.tasks || data.allTasks;
                        if (!tasksData || !Array.isArray(tasksData)) {
                            throw new Error("タスクデータが見つかりません");
                        }

                        // 各タスクのバリデーション
                        const validTasks = tasksData.filter((task) => {
                            if (!task.id || typeof task.id !== "string")
                                return false;
                            if (!task.text || typeof task.text !== "string")
                                return false;
                            if (
                                !task.section ||
                                ![1, 2, 3, 4].includes(task.section)
                            )
                                return false;
                            if (
                                !task.date ||
                                !/^\d{4}-\d{2}-\d{2}$/.test(task.date)
                            )
                                return false;
                            return true;
                        });

                        if (validTasks.length === 0) {
                            throw new Error("有効なタスクがありません");
                        }

                        // 確認ダイアログ
                        const currentCount = allTasks.length;
                        const importCount = validTasks.length;
                        const skippedCount =
                            tasksData.length - validTasks.length;

                        let message = `インポート確認\n\n`;
                        message += `現在のタスク: ${currentCount}件\n`;
                        message += `インポートするタスク: ${importCount}件\n`;
                        if (skippedCount > 0) {
                            message += `スキップ（不正データ）: ${skippedCount}件\n`;
                        }
                        message += `\n【追加】現在のデータに追加\n`;
                        message += `【置換】現在のデータを置き換え\n`;
                        message += `【キャンセル】何もしない\n\n`;
                        message += `どうしますか？（追加=OK / 置換=キャンセル後に再度インポート）`;

                        if (confirm(message)) {
                            // 追加モード：重複チェックして追加
                            const existingIds = new Set(
                                allTasks.map((t) => t.id)
                            );
                            const newTasks = validTasks.filter(
                                (t) => !existingIds.has(t.id)
                            );
                            allTasks = [...allTasks, ...newTasks];
                            saveAllTasks();

                            // purpose, stopConditionもインポート（あれば）
                            if (data.purpose) {
                                localStorage.setItem("purpose", data.purpose);
                            }
                            if (data.stopCondition) {
                                localStorage.setItem(
                                    "stopCondition",
                                    data.stopCondition
                                );
                            }

                            alert(
                                `インポート完了！\n${newTasks.length}件を追加しました。`
                            );
                            location.reload();
                        } else {
                            // 置換モード確認
                            if (
                                confirm(
                                    "現在のデータを完全に置き換えますか？\n（この操作は取り消せません）"
                                )
                            ) {
                                allTasks = validTasks;
                                saveAllTasks();

                                // purpose, stopConditionもインポート（あれば）
                                if (data.purpose) {
                                    localStorage.setItem(
                                        "purpose",
                                        data.purpose
                                    );
                                }
                                if (data.stopCondition) {
                                    localStorage.setItem(
                                        "stopCondition",
                                        data.stopCondition
                                    );
                                }

                                alert(
                                    `インポート完了！\n${validTasks.length}件に置き換えました。`
                                );
                                location.reload();
                            } else {
                                alert("インポートをキャンセルしました。");
                            }
                        }
                    } catch (err) {
                        alert(
                            `インポートエラー: ${err.message}\n\nファイルが正しいJSON形式か確認してください。`
                        );
                    }

                    // ファイル選択をリセット
                    event.target.value = "";
                };

                reader.readAsText(file);
            }

            // 色切り替え
            function toggleColors() {
                USE_COLORS = !USE_COLORS;
                applyColors();
                // 状態を保存
                localStorage.setItem("useColors", USE_COLORS);
            }

            // 逃げログの表示切り替え
            function applyColors() {
                const section1 = document.getElementById("section1");
                const section2 = document.getElementById("section2");
                const section3 = document.getElementById("section3");
                const section4 = document.getElementById("section4");

                if (USE_COLORS) {
                    section1.style.backgroundColor = "#ffe6e6";
                    section2.style.backgroundColor = "#e8f5e9";
                    section3.style.backgroundColor = "#fffef5";
                    section4.style.backgroundColor = "#f5f5f5";
                } else {
                    section1.style.backgroundColor = "white";
                    section2.style.backgroundColor = "white";
                    section3.style.backgroundColor = "white";
                    section4.style.backgroundColor = "white";
                }
            }

            // 入力欄でEnterキー押下時の処理
            for (let i = 1; i <= 4; i++) {
                const input = document.getElementById("input" + i);
                input.addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        addTask(i);
                    }
                });
            }

            // 目的入力でEnterキー
            document
                .getElementById("purposeInput")
                .addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        confirmPurpose();
                    }
                });

            // 初期化
            updateDate();

            // マスターデータをロード
            loadAllTasks();

            // 既存データをロード（移行のため）
            loadData();
            loadWeeklyData();

            // 移行実行
            migrateToMasterData();

            // 日次ビューを初期描画
            for (let i = 1; i <= 4; i++) {
                renderTasks(i);
            }

            setupAllSectionDrops();
            setupDayButtons();

            // 週間削除ボタンのイベント設定（旧システム・デッドコード削除済み）
            // editWeeklyTaskByIdがpromptで直接編集するため不要

            // ページを開いたログを記録
            logAction("open");

            // 色設定を読み込み
            const savedColorSetting = localStorage.getItem("useColors");
            if (savedColorSetting !== null) {
                USE_COLORS = savedColorSetting === "true";
                applyColors();
            }

            // タイマーボタンの初期表示
            updateTimerDisplay();

            // 深堀展開の状態管理
            // ビュー管理（どの画面を見ているか）
            let currentView = "daily"; // 'daily' | 'weekly' | 'monthly' | 'yearly' | 'settings'

            // 点検状態（日次ビュー内での表示モード）
            let inspectionMode = 0; // 0: 通常, 1: 8つの問い表示, 2: 履歴表示, 3: プレーン表示

            // 起動時の初期ビューを適用
            (function () {
                const initialView =
                    localStorage.getItem("initialView") || "monthly";
                setTimeout(() => {
                    switchView(initialView);
                }, 100);
            })();

            // ビュー切り替え関数
            function switchView(view) {
                currentView = view;

                const dailyView = document.querySelector(".container");
                const weeklyView = document.getElementById("weeklyView");
                const monthlyView = document.getElementById("monthlyView");
                const yearlyView = document.getElementById("yearlyView");
                const settingsView = document.getElementById("settingsView");

                // 全ビューを非表示
                dailyView.style.display = "none";
                weeklyView.style.display = "none";
                monthlyView.style.display = "none";
                yearlyView.style.display = "none";
                settingsView.style.display = "none";

                // タブのアクティブ状態を更新
                document
                    .querySelectorAll(".nav-tab")
                    .forEach((tab) => tab.classList.remove("active"));

                if (view === "daily") {
                    dailyView.style.display = "grid";
                    document.getElementById("navDaily").classList.add("active");
                    // 今日にリセット
                    currentDailyDate = null;
                    updateDate(); // 日付表示を今日に更新
                    for (let i = 1; i <= 4; i++) {
                        renderTasks(i);
                    }
                } else if (view === "weekly") {
                    weeklyView.style.display = "block";
                    document
                        .getElementById("navWeekly")
                        .classList.add("active");
                    currentWeekDate = new Date(); // 今週にリセット
                    renderWeeklyView();
                    // 現在時刻にスクロール（少し上にオフセット）
                    setTimeout(() => {
                        const now = new Date();
                        const currentHourEl = document.getElementById(
                            `weekly-time-${now.getHours()}`
                        );
                        if (currentHourEl) {
                            const weeklyViewEl =
                                document.getElementById("weeklyView");
                            const elTop = currentHourEl.offsetTop;
                            weeklyViewEl.scrollTop = Math.max(0, elTop - 120);
                        }
                    }, 50);
                } else if (view === "monthly") {
                    monthlyView.style.display = "block";
                    document
                        .getElementById("navMonthly")
                        .classList.add("active");
                    currentMonthDate = new Date();
                    renderMonthlyView();
                } else if (view === "yearly") {
                    yearlyView.style.display = "block";
                    document
                        .getElementById("navYearly")
                        .classList.add("active");
                    renderYearlyView();
                } else if (view === "settings") {
                    settingsView.style.display = "block";
                    document
                        .getElementById("navSettings")
                        .classList.add("active");
                    loadSettingsUI();
                }

                // 状態を保存（設定画面以外）
                if (view !== "settings") {
                    localStorage.setItem("currentView", view);
                }
            }

            // ===== 設定関連 =====

            // 設定をUIに反映
            function loadSettingsUI() {
                // 初期ビュー
                const initialView =
                    localStorage.getItem("initialView") || "monthly";
                const radios = document.querySelectorAll(
                    'input[name="initialView"]'
                );
                radios.forEach((radio) => {
                    radio.checked = radio.value === initialView;
                });

                // 月間表示モード
                const monthlyMode =
                    localStorage.getItem("monthlyMode") || "fixed";
                const monthlyRadios = document.querySelectorAll(
                    'input[name="monthlyMode"]'
                );
                monthlyRadios.forEach((radio) => {
                    radio.checked = radio.value === monthlyMode;
                });

                // シンプルモード
                const simpleMode = localStorage.getItem("simpleMode") === "on";
                const simpleToggle =
                    document.getElementById("simpleModeToggle");
                simpleToggle.checked = simpleMode;
                updateSimpleToggleUI(simpleMode);
                document.getElementById("stampSettingsArea").style.display =
                    simpleMode ? "block" : "none";
                if (simpleMode) loadStampSettingsUI();

                // プロフィール
                const savedName = localStorage.getItem("profileName") || "";
                const savedAvatar = localStorage.getItem("profileAvatar") || "";

                document.getElementById("profileNameInput").value = savedName;

                if (savedAvatar) {
                    document.getElementById("profileAvatarPreview").src =
                        savedAvatar;
                    document.getElementById(
                        "profileAvatarPreview"
                    ).style.display = "block";
                    document.getElementById(
                        "profileAvatarPlaceholder"
                    ).style.display = "none";
                    document.getElementById("avatarRemoveBtn").style.display =
                        "block";
                } else {
                    document.getElementById(
                        "profileAvatarPreview"
                    ).style.display = "none";
                    document.getElementById(
                        "profileAvatarPlaceholder"
                    ).style.display = "flex";
                    document.getElementById("avatarRemoveBtn").style.display =
                        "none";
                }
            }

            // アバター画像変更
            function handleAvatarChange(event) {
                const file = event.target.files[0];

                if (!file) {
                    return;
                }

                // ファイルサイズチェック（5MB以下に緩和）
                if (file.size > 5 * 1024 * 1024) {
                    alert("画像サイズは5MB以下にしてください");
                    return;
                }

                // タイプチェックを緩和（iOSで空になる場合がある）
                const validExtensions = [
                    ".jpg",
                    ".jpeg",
                    ".png",
                    ".gif",
                    ".webp",
                    ".heic",
                    ".heif",
                ];
                const fileName = file.name.toLowerCase();
                const hasValidExt = validExtensions.some((ext) =>
                    fileName.endsWith(ext)
                );

                if (
                    file.type &&
                    !file.type.startsWith("image/") &&
                    !hasValidExt
                ) {
                    alert("画像ファイルを選択してください");
                    return;
                }

                const reader = new FileReader();

                reader.onerror = function (err) {
                    alert("画像の読み込みに失敗しました");
                };

                reader.onload = function (e) {
                    const img = new Image();

                    img.onerror = function (err) {
                        alert(
                            "この画像形式は対応していません。\nJPGまたはPNG形式でお試しください。"
                        );
                    };

                    img.onload = function () {
                        try {
                            const canvas = document.createElement("canvas");
                            const size = 200;
                            canvas.width = size;
                            canvas.height = size;
                            const ctx = canvas.getContext("2d");

                            const minDim = Math.min(img.width, img.height);
                            const sx = (img.width - minDim) / 2;
                            const sy = (img.height - minDim) / 2;

                            ctx.drawImage(
                                img,
                                sx,
                                sy,
                                minDim,
                                minDim,
                                0,
                                0,
                                size,
                                size
                            );

                            const resizedBase64 = canvas.toDataURL(
                                "image/jpeg",
                                0.8
                            );

                            const preview = document.getElementById(
                                "profileAvatarPreview"
                            );
                            preview.src = resizedBase64;
                            preview.style.display = "block";
                            document.getElementById(
                                "profileAvatarPlaceholder"
                            ).style.display = "none";
                            document.getElementById(
                                "avatarRemoveBtn"
                            ).style.display = "block";

                            localStorage.setItem(
                                "profileAvatar",
                                resizedBase64
                            );
                            updateNavAvatar();
                        } catch (err) {
                            alert("画像の処理に失敗しました");
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            // アバター削除
            function removeAvatar() {
                document.getElementById("profileAvatarPreview").src = "";
                document.getElementById("profileAvatarPreview").style.display =
                    "none";
                document.getElementById(
                    "profileAvatarPlaceholder"
                ).style.display = "flex";
                document.getElementById("avatarRemoveBtn").style.display =
                    "none";
                document.getElementById("avatarInput").value = "";

                // 即座にlocalStorageから削除＆ナビ更新
                localStorage.removeItem("profileAvatar");
                updateNavAvatar();
            }

            // ナビバーのアバターを更新
            function updateNavAvatar() {
                const savedAvatar = localStorage.getItem("profileAvatar");
                const navAvatar = document.getElementById("navAvatar");
                const navAvatarWrapper =
                    document.getElementById("navAvatarWrapper");
                const navPlaceholder = document.getElementById(
                    "navAvatarPlaceholder"
                );

                if (savedAvatar) {
                    navAvatar.src = savedAvatar;
                    navAvatarWrapper.style.display = "flex";
                    navPlaceholder.style.display = "none";
                } else {
                    navAvatarWrapper.style.display = "none";
                    navPlaceholder.style.display = "inline";
                }
            }

            // 設定を保存
            function saveSettings() {
                // 初期ビュー
                const selectedView = document.querySelector(
                    'input[name="initialView"]:checked'
                );
                if (selectedView) {
                    localStorage.setItem("initialView", selectedView.value);
                }

                // 月間表示モード
                const selectedMonthlyMode = document.querySelector(
                    'input[name="monthlyMode"]:checked'
                );
                if (selectedMonthlyMode) {
                    localStorage.setItem(
                        "monthlyMode",
                        selectedMonthlyMode.value
                    );
                }

                // シンプルモード
                const simpleToggle =
                    document.getElementById("simpleModeToggle");
                localStorage.setItem(
                    "simpleMode",
                    simpleToggle.checked ? "on" : "off"
                );

                // スタンプ設定保存
                saveStampSettings();

                // プロフィール名
                const profileName = document
                    .getElementById("profileNameInput")
                    .value.trim();
                localStorage.setItem("profileName", profileName);

                // アバター
                const avatarPreview = document.getElementById(
                    "profileAvatarPreview"
                );
                if (
                    avatarPreview.style.display !== "none" &&
                    avatarPreview.src
                ) {
                    localStorage.setItem("profileAvatar", avatarPreview.src);
                } else {
                    localStorage.removeItem("profileAvatar");
                }

                // ナビバー更新
                updateNavAvatar();

                // シンプルモード適用
                applySimpleMode();

                // 保存完了メッセージ
                alert("設定を保存しました！");

                // シンプルモード時は月間に強制移動
                if (simpleToggle.checked) {
                    switchView("monthly");
                } else {
                    switchView(selectedView.value);
                }
            }

            // 初期ビューを取得
            function getInitialView() {
                return localStorage.getItem("initialView") || "monthly";
            }

            // 起動時にナビアバターを更新
            (function () {
                setTimeout(updateNavAvatar, 50);
            })();

            // 特定の日付の日次ビューへ遷移
            function goToDailyView(dateStr, openTaskId = null) {
                // 日付を一時保存（日次ビューで使用）
                localStorage.setItem("selectedDailyDate", dateStr);
                currentDailyDate = dateStr; // グローバル変数に保存

                // 日次ビューに切り替え
                switchView("daily");

                // 日付表示を更新
                const dateObj = new Date(dateStr + "T00:00:00");
                const weekdays = ["日", "月", "火", "水", "木", "金", "土"];
                const dateText = `${dateObj.getFullYear()}/${
                    dateObj.getMonth() + 1
                }/${dateObj.getDate()}（${weekdays[dateObj.getDay()]}）`;
                document.getElementById("dateDisplay").textContent = dateText;
                // スマホ用の第1象限日付も同期
                const mobileDate = document.getElementById("dateDisplayMobile");
                if (mobileDate) mobileDate.textContent = dateText;

                // タスクを再描画（選択した日付で）
                for (let i = 1; i <= 4; i++) {
                    renderTasks(i, dateStr);
                }

                // タスクIDが指定されていれば編集モーダルを開く
                if (openTaskId) {
                    setTimeout(() => {
                        openTaskEditModal(openTaskId);
                    }, 100);
                }
            }

            // 点検ボタン（日次ビュー内の表示モード切り替え）
            function toggleDeepDive() {
                const questionsDiv =
                    document.getElementById("deepDiveQuestions");
                const input1 = document.getElementById("input1");
                const input2 = document.getElementById("input2");
                const input3 = document.getElementById("input3");
                const input4 = document.getElementById("input4");
                const purposeInput = document.getElementById("purposeInput");
                const purposeGroup = document.getElementById("purposeGroup");
                const stopConditionGroup =
                    document.getElementById("stopConditionGroup");

                inspectionMode = (inspectionMode + 1) % 4;

                if (inspectionMode === 0) {
                    // 通常
                    questionsDiv.style.display = "none";
                    input1.placeholder = "本質的で今すぐ必要な行動は？...";
                    input2.placeholder = "本質的な計画行動は？...";
                    input3.placeholder =
                        "些細だが急ぎの行動は？（人に任せる）...";
                    input4.placeholder =
                        "些末な事はやらないと決める...視界から外す、スマホ電源切る...";
                    purposeInput.placeholder = "本質的な目的を一行で入力...";
                    document.getElementById("stopConditionInput").placeholder =
                        "例: 期限3日超過、2週間経過";
                } else if (inspectionMode === 1) {
                    // 8つの問い表示
                    questionsDiv.innerHTML = `
          <div style="margin-bottom: 8px; font-weight: bold; color: #d32f2f;">
            0. どういうことが起これば、いったん止めて点検するか？<br>
            （2週間経過、赤字損失1万円、期限超過3日、完了率30%未満）<br>
            ※数値化して図れ。
          </div>
          <div>1. これは、誰の人生に紐づく未完了か?(帰属)</div>
          <div>2. これの正体は行動か?(真贋)</div>
          <div>3. これと共に歩む覚悟はあるか?(覚悟)</div>
          <div>
            4. 覚悟をいつまでに（何をやるか、何時からやるか、いつまでにやるか）と行動に落とし込んだか?<br>
            開始締め切り、終了締め切り、点検。<br>
            明日も同じ形で継続できる形になっているか？
          </div>
          <div style="margin-top: 8px; font-weight: bold; color: #1976d2;">5. 最大の敵は、答えを出したくない自分だ。</div>
          <div style="margin-top: 8px; font-weight: bold; color: #7b1fa2;">6. 問いの館は崩壊し、お前は今、生まれ変わった。</div>
          <div style="margin-top: 8px; font-weight: bold; color: #388e3c;">7. エリクサーは具体的な行動だ！</div>
        `;
                    questionsDiv.style.display = "block";

                    // 目的と止める仕組みを表示
                    if (!purposeConfirmed) {
                        purposeGroup.style.display = "flex";
                    }
                    if (!stopConditionSaved) {
                        stopConditionGroup.style.display = "flex";
                    } else if (stopConditionSaved && stopCondition) {
                        document.getElementById(
                            "stopConditionDisplay"
                        ).style.display = "flex";
                        document.getElementById(
                            "stopConditionText"
                        ).textContent = stopCondition;
                    }

                    // 点検ログに記録
                    logAction("inspect");
                } else if (inspectionMode === 2) {
                    // 履歴表示
                    const logs = escapeLog.slice().reverse().slice(0, 20);
                    if (logs.length === 0) {
                        questionsDiv.innerHTML =
                            '<div style="color: #999; padding: 20px;">まだ履歴がありません</div>';
                    } else {
                        let html = "";
                        logs.forEach((log) => {
                            const time = log.date.split(" ")[1] || "";
                            const dateStr = log.date.split(" ")[0];
                            if (log.type === "open") {
                                html += `<div style="padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em;">${dateStr} ${time} 開く</div>`;
                            } else if (log.type === "inspect") {
                                html += `<div style="padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em;">${dateStr} ${time} 点検</div>`;
                            } else if (log.type === "escape") {
                                html += `<div style="padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em;">${dateStr} ${time} 🏃 逃げた：${log.task}</div>`;
                            }
                        });
                        questionsDiv.innerHTML = html;
                    }
                    questionsDiv.style.display = "block";
                } else if (inspectionMode === 3) {
                    // プレーン表示（印刷用）
                    questionsDiv.style.display = "none";
                    input1.placeholder = "";
                    input2.placeholder = "";
                    input3.placeholder = "";
                    input4.placeholder = "";
                    purposeInput.placeholder = "";
                    document.getElementById("stopConditionInput").placeholder =
                        "";
                }

                // 状態を保存
                localStorage.setItem("inspectionMode", inspectionMode);
            }

            // 状態の復元（ページロード時）
            const savedView = localStorage.getItem("currentView");
            // デフォルトは月間ビュー（全体を俯瞰できる）
            switchView(savedView || "monthly");

            const savedInspectionMode = localStorage.getItem("inspectionMode");
            if (savedInspectionMode !== null) {
                const targetMode = parseInt(savedInspectionMode);
                inspectionMode = (targetMode - 1 + 4) % 4;
                toggleDeepDive();
            }

            // ===== シンプルモード =====
            let selectedStamp = null; // { id, name, color, startTime, endTime }
            let selectedMemoType = null; // 'work' | 'private'

            // 季節アート（月ごとのemoji）
            const SEASONAL_ART = {
                1: "🎍",
                2: "🌸",
                3: "🌸",
                4: "🌷",
                5: "🎏",
                6: "☔",
                7: "🎆",
                8: "🌻",
                9: "🎑",
                10: "🍁",
                11: "🍂",
                12: "🎄",
            };

            // デフォルトスタンプ
            const DEFAULT_STAMPS = [
                {
                    id: "s1",
                    name: "日勤",
                    color: "#ffcdd2",
                    textColor: "#c62828",
                    startTime: "08:30",
                    endTime: "17:00",
                },
                {
                    id: "s2",
                    name: "長日勤",
                    color: "#f8bbd0",
                    textColor: "#ad1457",
                    startTime: "08:30",
                    endTime: "20:00",
                },
                {
                    id: "s3",
                    name: "入り",
                    color: "#e1bee7",
                    textColor: "#6a1b9a",
                    startTime: "16:30",
                    endTime: "01:00",
                },
                {
                    id: "s4",
                    name: "明け",
                    color: "#c5cae9",
                    textColor: "#283593",
                    startTime: "00:00",
                    endTime: "09:00",
                },
                {
                    id: "s5",
                    name: "休み",
                    color: "#b2dfdb",
                    textColor: "#00695c",
                    startTime: "",
                    endTime: "",
                },
                {
                    id: "s6",
                    name: "有給",
                    color: "#fff9c4",
                    textColor: "#f57f17",
                    startTime: "",
                    endTime: "",
                },
            ];

            function getStamps() {
                const saved = localStorage.getItem("simpleStamps");
                return saved ? JSON.parse(saved) : DEFAULT_STAMPS;
            }

            function getStampData() {
                // 日付 → スタンプ情報のマッピング
                const saved = localStorage.getItem("stampData");
                return saved ? JSON.parse(saved) : {};
            }

            function saveStampData(data) {
                localStorage.setItem("stampData", JSON.stringify(data));
            }

            function getMemoData() {
                const saved = localStorage.getItem("simpleMemos");
                return saved ? JSON.parse(saved) : {};
            }

            function saveMemoData(data) {
                localStorage.setItem("simpleMemos", JSON.stringify(data));
            }

            // スタンプ選択
            function selectStamp(stamp) {
                selectedStamp = stamp;
                selectedMemoType = null;
                updateStampBarUI();
            }

            function selectMemoType(type) {
                selectedMemoType = type;
                selectedStamp = null;
                updateStampBarUI();
            }

            function clearStampSelection() {
                selectedStamp = null;
                selectedMemoType = null;
                updateStampBarUI();
            }

            function updateStampBarUI() {
                const info = document.getElementById("stampSelectionInfo");
                const btns = document.querySelectorAll("#stampButtons button");
                btns.forEach((btn) => {
                    btn.style.transform =
                        btn.dataset.stampId ===
                        (selectedStamp ? selectedStamp.id : "")
                            ? "scale(1.1)"
                            : "scale(1)";
                    btn.style.boxShadow =
                        btn.dataset.stampId ===
                        (selectedStamp ? selectedStamp.id : "")
                            ? "0 2px 8px rgba(0,0,0,0.2)"
                            : "none";
                });
                document.getElementById("memoWorkBtn").style.background =
                    selectedMemoType === "work" ? "#78909c" : "#fff";
                document.getElementById("memoWorkBtn").style.color =
                    selectedMemoType === "work" ? "#fff" : "#78909c";
                document.getElementById("memoPrivateBtn").style.background =
                    selectedMemoType === "private" ? "#ffa726" : "#fff";
                document.getElementById("memoPrivateBtn").style.color =
                    selectedMemoType === "private" ? "#fff" : "#ffa726";

                if (selectedStamp) {
                    info.textContent = `「${selectedStamp.name}」を選択中 → 日付をタップ`;
                    info.style.color = selectedStamp.textColor || "#333";
                } else if (selectedMemoType) {
                    info.textContent =
                        selectedMemoType === "work"
                            ? "■ 仕事メモを選択中 → 日付をタップ"
                            : "★ プライベートメモを選択中 → 日付をタップ";
                    info.style.color =
                        selectedMemoType === "work" ? "#78909c" : "#ffa726";
                } else {
                    info.textContent =
                        "スタンプを選んで、カレンダーの日付をタップ";
                    info.style.color = "#999";
                }
            }

            // 日付セルにスタンプ/メモを貼る
            function applyStampToDate(dateStr) {
                if (selectedStamp) {
                    const data = getStampData();
                    if (
                        data[dateStr] &&
                        data[dateStr].stampId === selectedStamp.id
                    ) {
                        delete data[dateStr]; // 同じスタンプ再タップで解除
                    } else {
                        data[dateStr] = {
                            stampId: selectedStamp.id,
                            name: selectedStamp.name,
                            color: selectedStamp.color,
                            textColor: selectedStamp.textColor,
                        };
                    }
                    saveStampData(data);
                    renderMonthlyView();
                } else if (selectedMemoType) {
                    const memos = getMemoData();
                    const key = dateStr;
                    if (!memos[key]) memos[key] = {};
                    const memoText = prompt(
                        selectedMemoType === "work"
                            ? "■ 仕事メモを入力:"
                            : "★ プライベートメモを入力:"
                    );
                    if (memoText !== null && memoText.trim()) {
                        if (!memos[key][selectedMemoType])
                            memos[key][selectedMemoType] = [];
                        memos[key][selectedMemoType].push(memoText.trim());
                        saveMemoData(memos);
                        renderMonthlyView();
                    }
                }
            }

            // スタンプバーのボタン生成
            function renderStampBar() {
                const container = document.getElementById("stampButtons");
                if (!container) return;
                container.innerHTML = "";
                const stamps = getStamps();
                stamps.forEach((stamp) => {
                    const btn = document.createElement("button");
                    btn.dataset.stampId = stamp.id;
                    btn.textContent = stamp.name;
                    btn.draggable = true;
                    btn.style.cssText = `
          padding: 6px 14px; border-radius: 16px; border: 2px solid ${
              stamp.textColor || "#333"
          };
          background: ${stamp.color}; color: ${
                        stamp.textColor || "#333"
                    }; font-size: 0.8em;
          font-weight: 600; cursor: grab; white-space: nowrap; transition: all 0.15s;
          user-select: none; -webkit-user-select: none;
        `;
                    btn.onclick = function () {
                        selectStamp(stamp);
                    };

                    // ドラッグ開始
                    btn.addEventListener("dragstart", function (e) {
                        e.dataTransfer.effectAllowed = "copy";
                        e.dataTransfer.setData(
                            "application/stamp",
                            JSON.stringify(stamp)
                        );
                        btn.style.opacity = "0.5";
                        btn.style.cursor = "grabbing";
                        // ドラッグ中のゴースト
                        const ghost = btn.cloneNode(true);
                        ghost.style.position = "absolute";
                        ghost.style.top = "-1000px";
                        ghost.style.transform = "scale(1.2)";
                        ghost.style.boxShadow = "0 4px 12px rgba(0,0,0,0.3)";
                        document.body.appendChild(ghost);
                        e.dataTransfer.setDragImage(
                            ghost,
                            ghost.offsetWidth / 2,
                            ghost.offsetHeight / 2
                        );
                        setTimeout(() => document.body.removeChild(ghost), 0);
                    });

                    btn.addEventListener("dragend", function () {
                        btn.style.opacity = "1";
                        btn.style.cursor = "grab";
                    });

                    // タッチ対応：長押しでドラッグ開始
                    let touchDragStamp = null;
                    let touchGhost = null;
                    let touchStarted = false;

                    btn.addEventListener(
                        "touchstart",
                        function (e) {
                            touchStarted = true;
                            touchDragStamp = stamp;
                            // 長押し判定は不要（タップで選択、ドラッグで貼付の両方対応）
                        },
                        { passive: true }
                    );

                    btn.addEventListener(
                        "touchmove",
                        function (e) {
                            if (!touchDragStamp || !touchStarted) return;
                            e.preventDefault();

                            // ゴースト要素を作成・移動
                            if (!touchGhost) {
                                touchGhost = document.createElement("div");
                                touchGhost.textContent = stamp.name;
                                touchGhost.style.cssText = `
              position: fixed; z-index: 9999; padding: 8px 16px; border-radius: 16px;
              background: ${stamp.color}; color: ${
                                    stamp.textColor || "#333"
                                }; font-size: 0.9em;
              font-weight: 700; pointer-events: none; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
              transform: scale(1.15); opacity: 0.9; border: 2px solid ${
                  stamp.textColor || "#333"
              };
            `;
                                document.body.appendChild(touchGhost);
                                // スタンプを選択状態にする
                                selectStamp(stamp);
                            }

                            const touch = e.touches[0];
                            touchGhost.style.left = touch.clientX - 30 + "px";
                            touchGhost.style.top = touch.clientY - 20 + "px";

                            // ドロップ先セルをハイライト
                            const elemBelow = document.elementFromPoint(
                                touch.clientX,
                                touch.clientY
                            );
                            document
                                .querySelectorAll(".monthly-day-cell")
                                .forEach((c) => {
                                    c.style.outline = "";
                                    c.style.outlineOffset = "";
                                });
                            if (elemBelow) {
                                const cell =
                                    elemBelow.closest(".monthly-day-cell");
                                if (cell) {
                                    cell.style.outline = `3px solid ${
                                        stamp.textColor || "#4facfe"
                                    }`;
                                    cell.style.outlineOffset = "-3px";
                                }
                            }
                        },
                        { passive: false }
                    );

                    btn.addEventListener("touchend", function (e) {
                        if (touchGhost) {
                            const touch = e.changedTouches[0];
                            const elemBelow = document.elementFromPoint(
                                touch.clientX,
                                touch.clientY
                            );

                            // ハイライト解除
                            document
                                .querySelectorAll(".monthly-day-cell")
                                .forEach((c) => {
                                    c.style.outline = "";
                                    c.style.outlineOffset = "";
                                });

                            if (elemBelow) {
                                const cell =
                                    elemBelow.closest(".monthly-day-cell");
                                if (cell && cell.dataset.date) {
                                    // スタンプをドロップ
                                    const data = getStampData();
                                    if (
                                        data[cell.dataset.date] &&
                                        data[cell.dataset.date].stampId ===
                                            stamp.id
                                    ) {
                                        delete data[cell.dataset.date];
                                    } else {
                                        data[cell.dataset.date] = {
                                            stampId: stamp.id,
                                            name: stamp.name,
                                            color: stamp.color,
                                            textColor: stamp.textColor,
                                        };
                                    }
                                    saveStampData(data);
                                    renderMonthlyView();
                                    // 振動フィードバック
                                    if (navigator.vibrate)
                                        navigator.vibrate(30);
                                }
                            }

                            document.body.removeChild(touchGhost);
                            touchGhost = null;
                        }
                        touchDragStamp = null;
                        touchStarted = false;
                    });

                    container.appendChild(btn);
                });
            }

            // シンプルモードON/OFF
            function applySimpleMode() {
                const isSimple = localStorage.getItem("simpleMode") === "on";
                const navDaily = document.getElementById("navDaily");
                const navWeekly = document.getElementById("navWeekly");
                const navYearly = document.getElementById("navYearly");
                const stampBar = document.getElementById("stampBar");
                const seasonalArt = document.getElementById("seasonalArt");
                const widthSlider =
                    document.getElementById("monthlyWidthSlider");

                if (isSimple) {
                    if (navDaily) navDaily.style.display = "none";
                    if (navWeekly) navWeekly.style.display = "none";
                    if (navYearly) navYearly.style.display = "none";
                    if (stampBar) {
                        stampBar.style.display = "block";
                        renderStampBar();
                    }
                    if (seasonalArt) {
                        seasonalArt.style.display = "block";
                        updateSeasonalArt();
                    }
                    if (widthSlider)
                        widthSlider.parentElement.style.display = "none";
                } else {
                    if (navDaily) navDaily.style.display = "";
                    if (navWeekly) navWeekly.style.display = "";
                    if (navYearly) navYearly.style.display = "";
                    if (stampBar) stampBar.style.display = "none";
                    if (seasonalArt) seasonalArt.style.display = "none";
                    if (widthSlider)
                        widthSlider.parentElement.style.display = "";
                }
            }

            function updateSeasonalArt() {
                const el = document.getElementById("seasonalArt");
                if (!el) return;
                const month = currentMonthDate
                    ? currentMonthDate.getMonth() + 1
                    : new Date().getMonth() + 1;
                el.textContent = SEASONAL_ART[month] || "🗓️";
            }

            // 設定画面のトグルUI
            function toggleSimpleModePreview(checked) {
                updateSimpleToggleUI(checked);
                document.getElementById("stampSettingsArea").style.display =
                    checked ? "block" : "none";
                if (checked) loadStampSettingsUI();
            }

            function updateSimpleToggleUI(checked) {
                const slider = document.getElementById("simpleToggleSlider");
                const knob = document.getElementById("simpleToggleKnob");
                if (checked) {
                    slider.style.backgroundColor = "#4facfe";
                    knob.style.left = "27px";
                } else {
                    slider.style.backgroundColor = "#ccc";
                    knob.style.left = "3px";
                }
            }

            // スタンプ設定UI
            function loadStampSettingsUI() {
                const stamps = getStamps();
                const list = document.getElementById("stampList");
                list.innerHTML = "";
                stamps.forEach((stamp, idx) => {
                    const row = document.createElement("div");
                    row.style.cssText =
                        "display: flex; align-items: center; gap: 6px; margin-bottom: 6px; flex-wrap: wrap;";
                    row.innerHTML = `
          <input type="text" value="${
              stamp.name
          }" data-idx="${idx}" data-field="name"
            style="width: 60px; padding: 4px 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85em;"
            onchange="updateStampField(${idx}, 'name', this.value)">
          <input type="color" value="${stamp.color}" data-idx="${idx}"
            style="width: 30px; height: 28px; border: none; cursor: pointer; border-radius: 4px;"
            onchange="updateStampField(${idx}, 'color', this.value)">
          <input type="time" value="${stamp.startTime || ""}" placeholder="開始"
            style="width: 75px; padding: 3px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8em;"
            onchange="updateStampField(${idx}, 'startTime', this.value)">
          <span style="font-size: 0.8em; color: #999;">〜</span>
          <input type="time" value="${stamp.endTime || ""}" placeholder="終了"
            style="width: 75px; padding: 3px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8em;"
            onchange="updateStampField(${idx}, 'endTime', this.value)">
          <button onclick="removeStamp(${idx})" style="background: none; border: none; color: #e53935; cursor: pointer; font-size: 1.1em; padding: 2px 6px;">✕</button>
        `;
                    list.appendChild(row);
                });
            }

            function updateStampField(idx, field, value) {
                const stamps = getStamps();
                if (stamps[idx]) {
                    stamps[idx][field] = value;
                    localStorage.setItem(
                        "simpleStamps",
                        JSON.stringify(stamps)
                    );
                }
            }

            function addStampSetting() {
                const stamps = getStamps();
                if (stamps.length >= 20) {
                    alert("スタンプは最大20個です");
                    return;
                }
                stamps.push({
                    id: "s" + Date.now(),
                    name: "新規",
                    color: "#e0e0e0",
                    textColor: "#333",
                    startTime: "",
                    endTime: "",
                });
                localStorage.setItem("simpleStamps", JSON.stringify(stamps));
                loadStampSettingsUI();
            }

            function removeStamp(idx) {
                const stamps = getStamps();
                stamps.splice(idx, 1);
                localStorage.setItem("simpleStamps", JSON.stringify(stamps));
                loadStampSettingsUI();
            }

            function saveStampSettings() {
                // 設定UIから最新の値を収集
                const stamps = getStamps();
                const nameInputs = document.querySelectorAll(
                    '#stampList input[data-field="name"]'
                );
                nameInputs.forEach((input) => {
                    const idx = parseInt(input.dataset.idx);
                    if (stamps[idx]) stamps[idx].name = input.value;
                });
                localStorage.setItem("simpleStamps", JSON.stringify(stamps));
            }

            // 起動時にシンプルモード適用
            applySimpleMode();
        </script>

        <!-- タスク編集モーダル -->
        <div
            id="taskEditModal"
            class="custom-modal"
            onclick="if(event.target.id==='taskEditModal') closeTaskEditModal();"
        >
            <div
                class="modal-content"
                style="max-width: 420px; text-align: left"
            >
                <h3
                    style="
                        margin: 0 0 24px 0;
                        text-align: center;
                        font-size: 1.15em;
                        color: #333;
                        font-weight: 600;
                    "
                >
                    タスク編集
                </h3>
                <input type="hidden" id="taskEditId" />
                <div style="margin-bottom: 18px">
                    <label>タスク名</label>
                    <input type="text" id="taskEditText" />
                </div>
                <div style="margin-bottom: 18px">
                    <label>メモ（任意）</label>
                    <textarea
                        id="taskEditMemo"
                        rows="3"
                        placeholder="詳細や持ち物など..."
                    ></textarea>
                </div>
                <div
                    class="task-edit-datetime"
                    style="display: flex; gap: 12px; margin-bottom: 18px"
                >
                    <div style="flex: 1; min-width: 0">
                        <label>日付</label>
                        <input type="date" id="taskEditDate" />
                    </div>
                    <div style="flex: 1; min-width: 0">
                        <label>時間（任意）</label>
                        <input type="hidden" id="taskEditTime" />
                        <div class="custom-time-picker" id="taskEditTimePicker">
                            <div class="time-select-wrapper">
                                <select
                                    class="time-select"
                                    id="taskEditHourSelect"
                                >
                                    <option value="">--</option>
                                    <option value="0">00</option>
                                    <option value="1">01</option>
                                    <option value="2">02</option>
                                    <option value="3">03</option>
                                    <option value="4">04</option>
                                    <option value="5">05</option>
                                    <option value="6">06</option>
                                    <option value="7">07</option>
                                    <option value="8">08</option>
                                    <option value="9">09</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="13">13</option>
                                    <option value="14">14</option>
                                    <option value="15">15</option>
                                    <option value="16">16</option>
                                    <option value="17">17</option>
                                    <option value="18">18</option>
                                    <option value="19">19</option>
                                    <option value="20">20</option>
                                    <option value="21">21</option>
                                    <option value="22">22</option>
                                    <option value="23">23</option>
                                </select>
                                <div class="time-label">時</div>
                            </div>
                            <span class="time-separator">:</span>
                            <div class="time-select-wrapper">
                                <select
                                    class="time-select"
                                    id="taskEditMinuteSelect"
                                >
                                    <option value="">--</option>
                                    <option value="0">00</option>
                                    <option value="5">05</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                    <option value="25">25</option>
                                    <option value="30">30</option>
                                    <option value="35">35</option>
                                    <option value="40">40</option>
                                    <option value="45">45</option>
                                    <option value="50">50</option>
                                    <option value="55">55</option>
                                </select>
                                <div class="time-label">分</div>
                            </div>
                            <button
                                type="button"
                                class="time-clear-btn"
                                onclick="clearTimeSelect('taskEdit')"
                                title="時間をクリア"
                            >
                                ✕
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-buttons" style="margin-top: 24px">
                    <button
                        class="modal-btn modal-btn-cancel"
                        onclick="closeTaskEditModal()"
                    >
                        キャンセル
                    </button>
                    <button
                        class="modal-btn modal-btn-delete"
                        onclick="deleteTaskFromEditModal()"
                    >
                        削除
                    </button>
                    <button
                        class="modal-btn modal-btn-save"
                        onclick="saveTaskEdit()"
                    >
                        保存
                    </button>
                </div>
            </div>
        </div>

        <!-- カスタム確認モーダル -->
        <div
            id="customModal"
            class="custom-modal"
            onclick="if(event.target.id==='customModal') closeModal();"
        >
            <div class="modal-content">
                <div class="modal-title">確認</div>
                <div class="modal-message">
                    本当に全データをクリアしますか？<br />この操作は取り消せません。
                </div>
                <div class="modal-buttons">
                    <button
                        class="modal-btn modal-btn-cancel"
                        onclick="closeModal()"
                    >
                        キャンセル
                    </button>
                    <button
                        class="modal-btn modal-btn-confirm"
                        onclick="executeDelete()"
                    >
                        削除
                    </button>
                </div>
            </div>
        </div>
    </body>
</html>
