<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ - v0.10.2</title>
  
  <!-- 
    VERSION: 10.1
    DATE: 2026-02-14
    CHANGES: 
    - ãƒŠãƒ“ãƒãƒ¼ãƒ‡ã‚¶ã‚¤ãƒ³å…¨é¢ãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ï¼ˆãƒ¢ãƒ€ãƒ³ãƒœãƒˆãƒ ãƒŠãƒ“é¢¨ï¼‰
    - è¨­å®šã‚¿ãƒ–: activeç·‘ä¸‹ç·šã‚’å»ƒæ­¢ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ã«
    - Instagramè™¹è‰²æ : conic-gradient + ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…
    - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ãƒã‚¿ãƒ¼: ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚ºé¢¨ã‚°ãƒ­ã‚¦ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    - ãƒŠãƒ“ãƒãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹: ç·‘â†’æ´—ç·´ã•ã‚ŒãŸã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã«å¤‰æ›´
    - å…¨ä½“çš„ãªUI/UXãƒãƒªãƒƒã‚·ãƒ¥
  -->
  
  <!-- â˜…â˜…â˜… è‰²ã®åˆ‡ã‚Šæ›¿ãˆ: true = è‰²ã‚ã‚Š / false = è‰²ãªã—ï¼ˆç™½ï¼‰ â˜…â˜…â˜… -->
  <script>
    var USE_COLORS = false;  // â† ã“ã“ã‚’ true/false ã§åˆ‡ã‚Šæ›¿ãˆ
  </script>
  
  <style>
    * {
      box-sizing: border-box;
    }

    body, html {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Hiragino Sans', 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo, sans-serif;
    }

    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ– - ãƒ¢ãƒ€ãƒ³ãƒŠãƒ“ */
    .nav-tabs {
      display: flex;
      background-color: #fff;
      border-bottom: 1px solid #efefef;
      padding: 0 16px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav-tab {
      padding: 14px 20px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      color: #8e8e8e;
      border-bottom: 1.5px solid transparent;
      margin-bottom: -1px;
      transition: color 0.2s ease, border-color 0.2s ease;
      letter-spacing: 0.02em;
      position: relative;
    }

    .nav-tab:hover {
      color: #555;
    }

    .nav-tab.active {
      color: #0095f6;
      font-weight: 600;
      border-bottom-color: #0095f6;
    }

    /* è¨­å®šã‚¿ãƒ–ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ï¼‰- activeæ™‚ã«ä¸‹ç·šã‚’å‡ºã•ãªã„ */
    .nav-tab-settings {
      margin-left: auto;
      font-size: 1.1em;
      border-bottom: 1.5px solid transparent !important;
    }

    .nav-tab-settings.active {
      border-bottom-color: transparent !important;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      height: calc(100vh - 50px);
      gap: 0;
    }

    .section {
      border: 1px solid #000;
      padding: 15px;
      overflow-y: auto;
      background-color: #ffffff;
    }
    
    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’è–„ã */
    .section::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    .section::-webkit-scrollbar-track {
      background: #f5f5f5;
    }
    
    .section::-webkit-scrollbar-thumb {
      background: #e0e0e0;
      border-radius: 4px;
    }
    
    .section::-webkit-scrollbar-thumb:hover {
      background: #d0d0d0;
    }

    .header-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: nowrap;
      justify-content: flex-start;
    }

    .header-row h4 {
      margin: 0;
      font-size: 1.1em;
      color: #333;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .simple-header h4 {
      margin: 0;
      font-size: 1.1em;
    }

    .purpose-group {
      display: flex;
      align-items: center;
      gap: 5px;
      flex: 1;
    }

    .purpose-group input {
      padding: 4px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.85em;
      width: 300px;
      max-width: 300px;
    }

    .purpose-group label {
      font-weight: bold;
      white-space: nowrap;
    }

    .purpose-display {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
      color: #333;
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
      flex-wrap: wrap;
    }
    
    .purpose-display #purposeText {
      flex: 1;
      min-width: 0;
      word-wrap: break-word;
      overflow-wrap: break-word;
      font-size: 0.9em;
    }

    .edit-btn {
      padding: 4px 12px;
      background-color: #f0f0f0;
      color: #888;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75em;
      line-height: 1.4;
      min-height: 24px;
      display: inline-flex;
      align-items: center;
      transition: all 0.2s ease;
    }

    .edit-btn:hover {
      background-color: #e0e0e0;
      color: #555;
      transform: translateY(-1px);
    }

    .edit-btn:active {
      transform: translateY(0) scale(0.97);
    }

    .simple-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 4px;
    }

    .simple-header h4 {
      margin: 0;
      font-size: 1.1em;
    }

    .date-display {
      font-size: 0.85em;
      color: #333;
      font-weight: 900 !important;
      margin-left: auto;
      white-space: nowrap;
    }

    /* PC: ãƒ¢ãƒã‚¤ãƒ«ç”¨æ—¥ä»˜ã¯éè¡¨ç¤º */
    .date-display-mobile {
      display: none !important;
    }

    /* ç¬¬1è±¡é™ã‚’position:relativeã«ï¼ˆãƒ¢ãƒã‚¤ãƒ«æ—¥ä»˜ã®åŸºæº–ç‚¹ï¼‰ */
    #section1 {
      position: relative;
    }

    .task-input {
      padding: 5px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9em;
      margin-bottom: 8px;
    }

    /* å„è±¡é™ã”ã¨ã«å¹…ã‚’èª¿æ•´ */
    #input1 {
      width: 254px;
      max-width: 100%;
    }

    #input2 {
      width: 285px;
      max-width: 100%;
    }

    #input3 {
      width: 309px;
      max-width: 100%;
    }

    #input4 {
      width: 438px;
      max-width: 100%;
    }

    .task-input:focus {
      outline: none;
      border-color: #0095f6;
    }

    .task-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .task-item {
      background-color: white;
      padding: 7px 9px;
      margin-bottom: 5px;
      border-radius: 3px;
      display: flex;
      align-items: center;
      cursor: move;
      transition: all 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
      font-size: 0.88em;
      line-height: 1.4;
    }

    .task-item:hover {
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      transform: translateY(-1px);
    }

    .task-item.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .task-item.drag-over-top {
      border-top: 3px solid #4CAF50;
    }

    .task-item.drag-over-bottom {
      border-bottom: 3px solid #4CAF50;
    }

    .task-item.selected-task {
      background-color: #FFA500 !important;
      box-shadow: 0 4px 8px rgba(255, 165, 0, 0.4) !important;
      transform: scale(1.02);
      font-weight: bold;
    }

    .section.drag-over-section {
      background-color: rgba(76, 175, 80, 0.1) !important;
      border-color: #4CAF50 !important;
    }

    .task-item.completed {
      text-decoration: line-through;
      text-decoration-color: red;
      text-decoration-thickness: 2px;
    }
    
    .task-item.completed .task-text {
      text-decoration: line-through;
      text-decoration-color: red;
      text-decoration-thickness: 2px;
    }

    .task-text {
      flex: 1;
      word-break: break-word;
      cursor: pointer;
    }

    .delete-btn {
      color: #333;
      font-size: 1.2em;
      cursor: pointer;
      padding: 0 6px;
      line-height: 1;
    }

    .delete-btn:hover {
      color: #000;
    }

    .escape-btn {
      color: #666;
      font-size: 1em;
      cursor: pointer;
      padding: 0 6px;
      line-height: 1;
      opacity: 0.3;
    }

    .escape-btn:hover {
      color: #ff9800;
      opacity: 1;
    }

    .schedule-btn {
      color: #666;
      font-size: 1em;
      cursor: pointer;
      padding: 0 6px;
      line-height: 1;
      opacity: 0.3;
    }

    .schedule-btn:hover {
      color: #2196F3;
      opacity: 1;
    }

    .edit-task-btn {
      font-size: 1em;
      cursor: pointer;
      padding: 0 6px;
      line-height: 1;
      opacity: 0.15;
      filter: grayscale(100%);
      transition: opacity 0.2s;
    }

    .edit-task-btn:hover {
      opacity: 0.7;
    }
    
    .task-item:hover .edit-task-btn {
      opacity: 0.5;
    }

    .clear-all-btn {
      padding: 4px 12px;
      background-color: #f0f0f0;
      color: #888;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75em;
      line-height: 1.4;
      min-height: 24px;
      display: inline-flex;
      align-items: center;
      transition: all 0.2s ease;
    }

    .clear-all-btn:hover {
      background-color: #ffe0e0;
      color: #ff6b6b;
      transform: translateY(-1px);
    }

    .clear-all-btn:active {
      transform: translateY(0) scale(0.97);
    }

    .header-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .data-btn {
      padding: 4px 12px;
      background-color: #eef6ff;
      color: #4facfe;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75em;
      line-height: 1.4;
      min-height: 24px;
      display: inline-flex;
      align-items: center;
      transition: all 0.2s ease;
    }

    .data-btn:hover {
      background-color: #dbeeff;
      color: #3b8bdb;
      transform: translateY(-1px);
    }

    .data-btn:active {
      transform: translateY(0) scale(0.97);
    }

    .color-toggle-btn {
      padding: 4px 12px;
      background-color: #f5f0ff;
      color: #a78bfa;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75em;
      line-height: 1.4;
      min-height: 24px;
      display: inline-flex;
      align-items: center;
      transition: all 0.2s ease;
    }

    .color-toggle-btn:hover {
      background-color: #ede5ff;
      color: #8b5cf6;
      transform: translateY(-1px);
    }

    .color-toggle-btn:active {
      transform: translateY(0) scale(0.97);
    }

    .deep-dive-btn {
      padding: 4px 12px;
      background-color: #f0f0f0;
      color: #888;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75em;
      margin-right: 6px;
      line-height: 1.4;
      min-height: 24px;
      display: inline-flex;
      align-items: center;
      transition: all 0.2s ease;
    }

    .deep-dive-btn:hover {
      background-color: #e0e0e0;
      color: #555;
      transform: translateY(-1px);
    }

    .deep-dive-btn:active {
      transform: translateY(0) scale(0.97);
    }

    .timer-btn {
      padding: 4px 10px;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.8em;
      font-weight: bold;
      white-space: nowrap;
      line-height: 1.5;
      min-height: 28px;
      min-width: 50px;
      display: none;  /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
      align-items: center;
      justify-content: center;
    }

    /* ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
    .custom-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .custom-modal.show {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      overflow-y: auto;
    }

    /* é€ƒã’å‡ºã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .escape-message {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      border: 3px solid #333;
      padding: 30px 50px;
      font-size: 1.5em;
      font-weight: bold;
      z-index: 10000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .escape-message.show {
      display: block;
    }

    .modal-content {
      background-color: white;
      padding: 28px;
      border-radius: 16px;
      max-width: 320px;
      width: 90%;
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12), 0 2px 6px rgba(0, 0, 0, 0.04);
      text-align: center;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
      margin: auto 0;
      /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã§è§’ä¸¸ãŒå´©ã‚Œã‚‹ã®ã‚’é˜²æ­¢ */
      scrollbar-width: thin;
      scrollbar-color: rgba(0,0,0,0.08) transparent;
    }

    /* WebKitç³»ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’ç›®ç«‹ãŸãªã */
    .modal-content::-webkit-scrollbar {
      width: 4px;
    }
    .modal-content::-webkit-scrollbar-track {
      background: transparent;
      margin: 16px 0;
    }
    .modal-content::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.1);
      border-radius: 4px;
    }
    .modal-content::-webkit-scrollbar-thumb:hover {
      background: rgba(0,0,0,0.18);
    }

    .modal-title {
      font-size: 1.1em;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }

    .modal-message {
      font-size: 0.95em;
      color: #666;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .modal-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: nowrap;
    }

    .modal-btn {
      padding: 11px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.88em;
      font-weight: 600;
      min-width: 72px;
      white-space: nowrap;
      user-select: none;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1), 
                  box-shadow 0.2s ease,
                  opacity 0.15s ease,
                  background-color 0.15s ease;
      position: relative;
      letter-spacing: 0.02em;
    }

    /* hover: ãƒãƒã®ã‚ˆã†ã«è»½ãæµ®ã */
    .modal-btn:hover {
      transform: translateY(-1.5px);
    }

    /* active: ã·ã«ã£ã¨æŠ¼ã—è¾¼ã‚€æ„Ÿè§¦ */
    .modal-btn:active {
      transform: translateY(0.5px) scale(0.96);
      transition: transform 0.06s ease;
    }

    /* ã‚­ãƒ£ãƒ³ã‚»ãƒ« - æ§ãˆã‚ã§å„ªã—ã„ */
    .modal-btn-cancel {
      background-color: #f5f5f5;
      color: #777;
      border: none;
    }

    .modal-btn-cancel:hover {
      background-color: #eee;
      color: #555;
    }

    .modal-btn-cancel:active {
      background-color: #e5e5e5;
    }

    /* å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ç¢ºèªç”¨ */
    .modal-btn-confirm {
      background-color: #ff6b6b;
      color: #fff;
      box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
    }

    .modal-btn-confirm:hover {
      background-color: #ff5252;
      box-shadow: 0 4px 14px rgba(255, 82, 82, 0.35);
    }

    .modal-btn-confirm:active {
      background-color: #f44;
    }

    /* ===== ä¿å­˜ - ã‚„ã‚ã‚‰ã‹ãƒ–ãƒ«ãƒ¼ã€æŠ¼ã—ãŸããªã‚‹ ===== */
    .modal-btn-save {
      background: linear-gradient(180deg, #4facfe 0%, #3b8bdb 100%);
      color: #fff;
      border: none;
      box-shadow: 0 2px 6px rgba(59, 139, 219, 0.25),
                  0 1px 2px rgba(59, 139, 219, 0.15);
    }

    .modal-btn-save:hover {
      box-shadow: 0 4px 14px rgba(59, 139, 219, 0.35),
                  0 1px 3px rgba(59, 139, 219, 0.2);
      background: linear-gradient(180deg, #5ab5ff 0%, #4a9ae8 100%);
    }

    .modal-btn-save:active {
      background: linear-gradient(180deg, #3d96e6 0%, #3080cc 100%);
      box-shadow: 0 1px 3px rgba(59, 139, 219, 0.2);
    }

    /* ===== å‰Šé™¤ - æŸ”ã‚‰ã‹ã„èµ¤ã€ä¸»å¼µã—ã™ããªã„ ===== */
    .modal-btn-delete {
      background-color: transparent;
      color: #ff6b6b;
      border: none;
    }

    .modal-btn-delete:hover {
      background-color: rgba(255, 107, 107, 0.08);
      color: #ff5252;
    }

    .modal-btn-delete:active {
      background-color: rgba(255, 107, 107, 0.15);
    }

    /* ===== ãƒ—ãƒ©ã‚¤ãƒãƒªï¼ˆè¨­å®šä¿å­˜ç­‰ï¼‰ ===== */
    .modal-btn-primary {
      background: linear-gradient(180deg, #4facfe 0%, #3b8bdb 100%);
      color: #fff;
      border: none;
      box-shadow: 0 2px 6px rgba(59, 139, 219, 0.25),
                  0 1px 2px rgba(59, 139, 219, 0.15);
    }

    .modal-btn-primary:hover {
      box-shadow: 0 4px 14px rgba(59, 139, 219, 0.35),
                  0 1px 3px rgba(59, 139, 219, 0.2);
      background: linear-gradient(180deg, #5ab5ff 0%, #4a9ae8 100%);
    }

    .modal-btn-primary:active {
      background: linear-gradient(180deg, #3d96e6 0%, #3080cc 100%);
      box-shadow: 0 1px 3px rgba(59, 139, 219, 0.2);
    }

    /* ãƒ¢ãƒ€ãƒ³ãªãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
    .modal-content input[type="text"],
    .modal-content input[type="date"],
    .modal-content input[type="time"],
    .modal-content textarea,
    .modal-content select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e8e8e8;
      border-radius: 10px;
      font-size: 0.95em;
      font-family: inherit;
      background: #fafafa;
      box-sizing: border-box;
      transition: all 0.2s ease;
      outline: none;
    }

    .modal-content input[type="text"]:focus,
    .modal-content input[type="date"]:focus,
    .modal-content input[type="time"]:focus,
    .modal-content textarea:focus,
    .modal-content select:focus {
      border-color: #0095f6;
      background: white;
      box-shadow: 0 0 0 3px rgba(0, 149, 246, 0.08);
    }

    .modal-content input[type="text"]:hover,
    .modal-content input[type="date"]:hover,
    .modal-content input[type="time"]:hover,
    .modal-content textarea:hover,
    .modal-content select:hover {
      border-color: #ccc;
    }

    .modal-content label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 0.85em;
      color: #555;
    }

    /* ã‚«ã‚¹ã‚¿ãƒ æ™‚é–“ãƒ”ãƒƒã‚«ãƒ¼ï¼ˆã‚»ãƒ¬ã‚¯ãƒˆå¼ï¼‰ */
    .custom-time-picker {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px 0;
    }

    .time-select {
      appearance: none;
      -webkit-appearance: none;
      background: #fafafa;
      border: 2px solid #e8e8e8;
      border-radius: 10px;
      padding: 12px 32px 12px 16px;
      font-size: 1.2em;
      font-weight: 600;
      color: #333;
      cursor: pointer;
      outline: none;
      transition: all 0.2s ease;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      min-width: 80px;
      text-align: center;
    }

    .time-select:hover {
      border-color: #ccc;
      background-color: #fff;
    }

    .time-select:focus {
      border-color: #0095f6;
      background-color: #fff;
      box-shadow: 0 0 0 3px rgba(0, 149, 246, 0.08);
    }

    .time-separator {
      font-size: 1.5em;
      font-weight: 600;
      color: #333;
    }

    .time-label {
      font-size: 0.75em;
      color: #888;
      margin-top: 4px;
      text-align: center;
    }

    .time-select-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .time-clear-btn {
      background: none;
      border: 2px solid #e8e8e8;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      color: #999;
      padding: 10px 12px;
      transition: all 0.2s;
      margin-left: 8px;
    }

    .time-clear-btn:hover {
      color: #f44336;
      border-color: #f44336;
      background: rgba(244, 67, 54, 0.05);
    }

    .day-select-btn {
      padding: 15px;
      border: 1.5px solid #e8e8e8;
      border-radius: 10px;
      background-color: #fff;
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
      transition: all 0.2s ease;
    }

    .day-select-btn:hover {
      background-color: #eef6ff;
      border-color: #4facfe;
      color: #3b8bdb;
      transform: translateY(-1.5px);
      box-shadow: 0 3px 10px rgba(79, 172, 254, 0.15);
    }

    .day-select-btn:active {
      transform: translateY(0) scale(0.96);
    }

    @media screen and (max-width: 768px) {
      .custom-modal.show {
        padding-top: 8vh;
      }

      /* ã‚¹ãƒãƒ›ï¼šæ—¥ä»˜ã¨æ™‚é–“ã‚’ç¸¦ç©ã¿ */
      .task-edit-datetime {
        flex-direction: column !important;
        gap: 8px !important;
      }

      /* ã‚¹ãƒãƒ›ï¼šãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´ */
      .modal-btn {
        padding: 10px 16px;
        font-size: 0.85em;
        min-width: 64px;
      }

      /* ã‚¹ãƒãƒ›ï¼šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ç¸®å° */
      .modal-content {
        padding: 20px 16px;
      }
    }

    @media screen and (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto;
        height: auto;
      }

      .section {
        min-height: 300px;
      }

      /* ã‚¹ãƒãƒ›ç‰ˆï¼šãƒ˜ãƒƒãƒ€ãƒ¼è¦ç´ ã‚’ç¸¦ç©ã¿ */
      .header-row {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 10px;
      }

      .simple-header {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 10px;
      }

      .simple-header > div {
        flex-direction: column;
        align-items: flex-start !important;
        width: 100%;
      }

      /* ç›®çš„å…¥åŠ›ãƒ»è¡¨ç¤ºã‚’ã‚¹ãƒãƒ›å¹…ã« */
      .purpose-group {
        flex-direction: column;
        align-items: flex-start !important;
        width: 100%;
      }

      .purpose-group input {
        width: 100% !important;
        max-width: 100% !important;
      }

      .purpose-display {
        flex-direction: column;
        align-items: flex-start !important;
        width: 100%;
      }

      /* æ­¢ã‚ã‚‹ä»•çµ„ã¿ã‚’ã‚¹ãƒãƒ›å¹…ã« */
      #stopConditionGroup {
        flex-direction: column;
        align-items: flex-start !important;
        width: 100%;
      }

      #stopConditionGroup input {
        width: 100% !important;
        max-width: 100% !important;
      }

      #stopConditionDisplay {
        flex-direction: column;
        align-items: flex-start !important;
        width: 100%;
      }

      /* æ—¥ä»˜è¡¨ç¤º */
      .date-display {
        width: 100%;
        text-align: left;
      }

      /* ã‚¹ãƒãƒ›ç¸¦ç”»é¢ï¼šç¬¬1è±¡é™ã®å³ä¸Šã«æ—¥ä»˜ã‚’å›ºå®šè¡¨ç¤º */
      .date-display-mobile {
        display: block !important;
        position: static;
        width: 100%;
        text-align: right;
        margin: -8px 0 4px 0;
        font-size: 0.85em;
      }

      /* ã‚¹ãƒãƒ›ï¼šç¬¬1è±¡é™ã®h4ã‚’å¹…ã„ã£ã±ã„ã« */
      #section1 .header-row h4 {
        width: 100%;
        font-size: 0.95em;
      }

      /* ã‚¹ãƒãƒ›ç¸¦ç”»é¢ï¼šç¬¬2è±¡é™ã®æ—¥ä»˜ã‚’éè¡¨ç¤º */
      #dateDisplay {
        display: none !important;
      }
    }

    /* é€±é–“ãƒ“ãƒ¥ãƒ¼ç”¨CSSï¼ˆãƒãƒ¼ãƒã‚«ãƒ«ï¼‰ */
    .weekly-view {
      display: none;
      width: 100%;
      height: calc(100vh - 50px);
      overflow: auto;
      padding: 20px;
      padding-top: 0;
      box-sizing: border-box;
      background-color: #f5f5f5;
    }

    .weekly-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      padding: 12px 0;
      height: 48px;
      box-sizing: border-box;
      background-color: #f5f5f5;
      position: sticky;
      top: 0;
      z-index: 25;
      border-bottom: 1px solid #e0e0e0;
    }

    .weekly-header h2 {
      margin: 0;
      font-size: 1.2em;
      min-width: 150px;
      text-align: center;
    }

    .weekly-container {
      min-width: 100%;
      position: relative;
    }

    /* é€±é–“ãƒ“ãƒ¥ãƒ¼ã®ã‚¹ãƒ†ã‚£ãƒƒã‚­ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .weekly-container table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
    }

    .weekly-container thead th {
      position: sticky;
      top: 48px;
      z-index: 20;
      background-color: #f5f5f5 !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      border-bottom: 2px solid #ddd !important;
    }

    /* æœˆé–“ãƒ“ãƒ¥ãƒ¼ç”¨CSS */
    .monthly-view {
      display: none;
      width: 100%;
      height: calc(100vh - 50px);
      overflow: auto;
      padding: 20px;
      box-sizing: border-box;
      background-color: #f5f5f5;
    }

    .monthly-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 15px;
      position: relative;
      padding-left: 45px;
      padding-right: 110px;
    }

    .monthly-header h2 {
      margin: 0;
      font-size: 1.3em;
      min-width: 150px;
      text-align: center;
    }

    .monthly-nav-btn {
      padding: 8px 16px;
      background-color: #f5f5f5;
      color: #666;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s ease;
    }

    .monthly-nav-btn:hover {
      background-color: #eee;
      color: #444;
      transform: translateY(-1px);
    }

    .monthly-nav-btn:active {
      transform: translateY(0.5px) scale(0.97);
      background-color: #e5e5e5;
    }

    .monthly-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background-color: #e0e0e0;
      border: 1px solid #e0e0e0;
      min-width: 100%;
    }

    .monthly-weekday-header {
      background-color: #f5f5f5;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      font-size: 0.9em;
    }

    .monthly-weekday-header.saturday {
      background-color: #e3f2fd;
      color: #1976d2;
    }

    .monthly-weekday-header.sunday {
      background-color: #fff3e0;
      color: #e65100;
    }

    .monthly-day-cell {
      background-color: white;
      min-height: 80px;
      /* max-heightã¯ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã§åˆ¶å¾¡ */
      overflow-y: auto;
      overflow-x: hidden;
      padding: 5px;
      vertical-align: top;
      cursor: pointer;
      position: relative;
      /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’ç´°ã */
      scrollbar-width: thin;
      scrollbar-color: rgba(0,0,0,0.08) transparent;
    }

    .monthly-day-cell::-webkit-scrollbar {
      width: 3px;
    }
    .monthly-day-cell::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.1);
      border-radius: 3px;
    }

    /* æœˆé–“ãƒ“ãƒ¥ãƒ¼ã®ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ« */
    .monthly-resize-handle {
      grid-column: 1 / -1;
      height: 4px;
      background: transparent;
      cursor: ns-resize;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
      z-index: 2;
      margin: -2px 0;
    }

    .monthly-resize-handle:hover {
      background: rgba(79, 172, 254, 0.08);
    }

    .monthly-resize-handle:active {
      background: rgba(79, 172, 254, 0.12);
    }

    /* ãƒãƒ³ãƒ‰ãƒ«ã®ã‚°ãƒªãƒƒãƒ—ï¼ˆã¤ã¾ã¿ï¼‰- hoveræ™‚ã ã‘è¡¨ç¤º */
    .monthly-resize-handle::after {
      content: '';
      width: 24px;
      height: 2px;
      background: rgba(0,0,0,0);
      border-radius: 1px;
      transition: background 0.2s ease, width 0.2s ease;
    }

    .monthly-resize-handle:hover::after {
      background: rgba(0,0,0,0.15);
      width: 32px;
    }

    .monthly-resize-handle:active::after {
      background: #4facfe;
      width: 40px;
    }

    .monthly-day-cell:hover {
      background-color: #fafafa;
    }

    .monthly-day-cell.other-month {
      background-color: #f9f9f9;
      color: #bbb;
    }

    .monthly-day-cell.saturday {
      background-color: #e3f2fd;
    }

    .monthly-day-cell.sunday {
      background-color: #fff3e0;
    }

    .monthly-day-cell.today {
      background-color: #fff9c4;
      box-shadow: inset 0 0 0 2px #fbc02d;
    }

    .monthly-day-number {
      font-weight: bold;
      font-size: 0.85em;
      margin-bottom: 5px;
    }

    .monthly-task-item {
      font-size: 0.75em;
      padding: 2px 4px;
      margin-bottom: 2px;
      border-radius: 2px;
      cursor: grab;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .monthly-task-item:hover {
      opacity: 0.8;
    }

    .monthly-task-item.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .monthly-day-cell.drag-over {
      background-color: #e8f5e9 !important;
      border: 2px dashed #4CAF50;
    }

    .monthly-day-cell.holiday {
      background-color: #fff3e0;
    }

    .monthly-day-cell.holiday.saturday {
      background-color: #fff3e0;
    }

    .monthly-holiday-name {
      font-size: 0.65em;
      color: #e65100;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ===== å¹´é–“ãƒ“ãƒ¥ãƒ¼ï¼ˆYEARLY PLANNERå‹ï¼‰===== */
    .yearly-view {
      display: none;
      width: 100%;
      height: calc(100vh - 50px);
      overflow: auto;
      padding: 10px;
      box-sizing: border-box;
      background-color: #f5f5f5;
    }

    .yearly-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 10px;
    }

    .yearly-header h2 {
      margin: 0;
      font-size: 1.3em;
      min-width: 100px;
      text-align: center;
    }

    .yearly-calendar {
      display: grid;
      grid-template-columns: 30px repeat(12, 1fr);
      gap: 1px;
      background-color: #bbb;
      border: 1px solid #bbb;
      font-size: 0.65em;
    }

    .yearly-header-cell {
      background-color: #e0e0e0;
      padding: 6px 2px;
      text-align: center;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .yearly-day-label {
      background-color: #f0f0f0;
      padding: 4px 2px;
      text-align: center;
      font-weight: bold;
      position: sticky;
      left: 0;
      z-index: 5;
    }

    .yearly-cell {
      background-color: #fff;
      padding: 3px 2px;
      min-height: 22px;
      cursor: pointer;
      position: relative;
      text-align: center;
      transition: background-color 0.15s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1px;
    }

    .yearly-cell:hover {
      background-color: #e3f2fd;
    }

    .yearly-cell.empty {
      background-color: #f0f0f0;
      color: #ccc;
      cursor: default;
    }

    .yearly-cell.empty:hover {
      background-color: #f0f0f0;
    }

    .yearly-cell.today {
      background-color: #fff59d;
      font-weight: bold;
      box-shadow: inset 0 0 0 2px #ffc107;
    }

    .yearly-cell.saturday {
      background-color: #e3f2fd;
    }

    .yearly-cell.sunday {
      background-color: #fff3e0;
    }

    .yearly-cell.holiday {
      background-color: #fff3e0;
    }

    .yearly-cell.has-task {
      background-color: #c8e6c9;
    }

    .yearly-cell.has-task.saturday {
      background-color: #b2dfdb;
    }

    .yearly-cell.has-task.sunday,
    .yearly-cell.has-task.holiday {
      background-color: #ffccbc;
    }

    .yearly-cell.has-task.today {
      background-color: #aed581;
      box-shadow: inset 0 0 0 2px #8bc34a;
    }

    .yearly-weekday {
      font-size: 0.9em;
      color: #666;
    }

    .yearly-cell.saturday .yearly-weekday {
      color: #1976d2;
      font-weight: bold;
    }

    .yearly-cell.sunday .yearly-weekday,
    .yearly-cell.holiday .yearly-weekday {
      color: #e65100;
      font-weight: bold;
    }

    .yearly-task-count {
      font-size: 0.85em;
      color: #2e7d32;
      font-weight: bold;
      background-color: rgba(255,255,255,0.7);
      border-radius: 50%;
      width: 14px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .weekly-container table {
      font-size: 0.9em;
    }

    .weekly-container table th,
    .weekly-container table td {
      min-width: 120px;
    }

    /* ã‚¹ãƒãƒ›ç‰ˆï¼šé€±é–“ãƒ“ãƒ¥ãƒ¼ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    @media screen and (max-width: 768px) {
      .weekly-view {
        padding: 10px;
      }

      .weekly-header {
        gap: 10px;
        padding: 8px 0;
        height: 40px;
        font-size: 0.9em;
      }

      .weekly-header h2 {
        font-size: 1em;
        min-width: 120px;
      }

      /* ã‚¹ãƒãƒ›ã§stickyãƒ˜ãƒƒãƒ€ãƒ¼ã®topä½ç½®ã‚’å†èª¿æ•´ */
      .weekly-container thead th {
        top: 40px;
        font-size: 0.7em;
        padding: 6px 2px !important;
      }
      
      .weekly-container table {
        font-size: 0.75em;
      }
      
      .weekly-container table th {
        min-width: 60px;
        padding: 8px 4px !important;
      }
      
      .weekly-container table td {
        min-width: 60px;
        padding: 6px 4px !important;
        height: 60px !important;
      }

      /* æœˆé–“ãƒ“ãƒ¥ãƒ¼ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
      .monthly-view {
        padding: 10px;
      }

      .monthly-header {
        gap: 10px;
        flex-wrap: wrap;
      }

      .monthly-header h2 {
        font-size: 1.1em;
        min-width: 120px;
      }

      .monthly-nav-btn {
        padding: 6px 12px;
        font-size: 0.85em;
      }

      .monthly-day-cell {
        min-height: 70px;
        padding: 3px;
      }

      .monthly-day-number {
        font-size: 0.75em;
      }

      .monthly-holiday-name {
        font-size: 0.55em;
      }

      .monthly-task-item {
        font-size: 0.65em;
        padding: 2px 3px;
      }

      .monthly-weekday-header {
        padding: 6px 2px;
        font-size: 0.8em;
      }

      /* ç§»å‹•ãƒ¢ãƒ¼ãƒ‰ä¸­ã®ã‚¿ã‚¹ã‚¯ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
      .monthly-task-item.moving {
        outline: 2px solid #4CAF50;
        outline-offset: 1px;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }

      /* ç§»å‹•å…ˆé¸æŠä¸­ã®ã‚»ãƒ« */
      .monthly-day-cell.move-target {
        background-color: #e8f5e9 !important;
        cursor: pointer;
      }

      /* ãƒŠãƒ“ã‚¿ãƒ–ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
      .nav-tabs {
        padding: 0 8px;
      }

      .nav-tab {
        padding: 12px 14px;
        font-size: 0.85em;
      }
    }

    @media print {
      body, html {
        width: 297mm;
        margin: 0;
        padding: 0;
      }
      /* ãƒŠãƒ“ã‚¿ãƒ–ã‚’å°åˆ·æ™‚ã«éè¡¨ç¤º */
      .nav-tabs {
        display: none !important;
      }
      .container {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        height: 100vh !important; /* A4ã«åã¾ã‚‹ã‚ˆã†ã« */
        min-height: 210mm;
      }
      .section {
        min-height: 100mm; /* æœ€ä½é™ã®é«˜ã•ã‚’ç¢ºä¿ */
        page-break-inside: avoid;
      }
      .task-input {
        border: none !important;
      }
      .purpose-group {
        display: none !important;  /* å°åˆ·æ™‚ã¯å…¥åŠ›æ¬„ã‚’éè¡¨ç¤º */
      }
      .purpose-group label {
        display: none !important;
      }
      .purpose-group input {
        display: none !important;
      }
      .purpose-group button {
        display: none !important;
      }
      /* å°åˆ·æ™‚ã«ç›®çš„è¡¨ç¤ºã‚’è¡¨ç¤ºï¼ˆãŸã ã—å†…å®¹ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰ */
      #purposeDisplay:not([style*="display: none"]):not([style*="display:none"]) {
        display: flex !important;
        font-size: 0.75em;
        margin-left: 10px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 400px;
      }
      .purpose-display #purposeText,
      #purposeDisplay #purposeText {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      /* å°åˆ·æ™‚ã«ç·¨é›†ãƒœã‚¿ãƒ³ã¯éè¡¨ç¤º */
      .purpose-display .edit-btn,
      #purposeDisplay .edit-btn {
        display: none !important;
      }
      /* å°åˆ·æ™‚ã«ã‚¿ã‚¤ãƒãƒ¼ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º */
      .timer-btn {
        display: none !important;
      }
      #timerBtn {
        display: none !important;
      }
      /* ç·¨é›†ãƒœã‚¿ãƒ³ã‚’å°åˆ·æ™‚ã«éè¡¨ç¤º */
      .edit-btn {
        display: none !important;
      }
      /* ç‚¹æ¤œãƒœã‚¿ãƒ³ã‚’å°åˆ·æ™‚ã«éè¡¨ç¤º */
      .deep-dive-btn {
        display: none !important;
      }
      /* æ­¢ã‚ã‚‹ä»•çµ„ã¿ï¼šå…¥åŠ›æ¬„ã‚’éè¡¨ç¤º */
      #stopConditionGroup {
        display: none !important;
      }
      /* æ­¢ã‚ã‚‹ä»•çµ„ã¿ï¼šä¿å­˜æ¸ˆã¿è¡¨ç¤ºã¯è¡¨ç¤ºï¼ˆãŸã ã—å†…å®¹ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰ */
      #stopConditionDisplay:not([style*="display: none"]):not([style*="display:none"]) {
        display: flex !important;
        font-size: 0.75em;
        white-space: normal;
        word-wrap: break-word;
        flex-wrap: wrap;
      }
      #stopConditionDisplay .edit-btn {
        display: none !important;
      }
      /* è‰²åˆ‡æ›¿ãƒœã‚¿ãƒ³ã‚’å°åˆ·æ™‚ã«éè¡¨ç¤º */
      .color-toggle-btn {
        display: none !important;
      }
      /* å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’å°åˆ·æ™‚ã«éè¡¨ç¤º */
      .clear-all-btn {
        display: none !important;
      }
      /* ã‚¿ã‚¹ã‚¯ã®ãƒœã‚¿ãƒ³ã‚’å°åˆ·æ™‚ã«éè¡¨ç¤º */
      .edit-task-btn {
        display: none !important;
      }
      .escape-btn {
        display: none !important;
      }
      .schedule-btn {
        display: none !important;
      }
      .delete-btn {
        display: none !important;
      }
      /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’å°åˆ·æ™‚ã«éè¡¨ç¤º */
      .section::-webkit-scrollbar {
        display: none;
      }
    }

    /* è¨­å®šãƒ“ãƒ¥ãƒ¼ */
    .settings-view {
      padding: 30px;
      max-width: 600px;
      margin: 0 auto;
    }

    .settings-container {
      background: white;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 1px 8px rgba(0,0,0,0.06);
      border: 1px solid #efefef;
    }

    .settings-section {
      margin-bottom: 30px;
    }

    .settings-item {
      margin-bottom: 20px;
    }

    .settings-radio-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .settings-radio {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border: 2px solid #e8e8e8;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .settings-radio:hover {
      border-color: #ccc;
      background: #fafafa;
    }

    .settings-radio input[type="radio"] {
      width: 20px;
      height: 20px;
      accent-color: #0095f6;
      cursor: pointer;
    }

    .settings-radio input[type="radio"]:checked + .radio-label {
      color: #0095f6;
      font-weight: bold;
    }

    .settings-radio:has(input:checked) {
      border-color: #0095f6;
      background: rgba(0, 149, 246, 0.03);
    }

    .radio-label {
      font-weight: 600;
      color: #333;
      min-width: 80px;
    }

    .radio-desc {
      font-size: 0.85em;
      color: #888;
    }

    /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ã‚¨ãƒªã‚¢ */
    .profile-edit-area {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .profile-avatar-edit {
      position: relative;
      width: 88px;
      height: 88px;
      border-radius: 50%;
      overflow: visible;
      cursor: pointer;
      background: conic-gradient(from 180deg, #feda75, #fa7e1e, #d62976, #962fbf, #4f5bd5, #feda75);
      padding: 3px;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      flex-shrink: 0;
    }

    .profile-avatar-edit:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 20px rgba(214, 41, 118, 0.35);
    }

    .profile-avatar-edit img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
      border: 3px solid white;
    }

    .avatar-placeholder {
      width: calc(100% - 6px);
      height: calc(100% - 6px);
      margin: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #dbdbdb;
      color: #8e8e8e;
      font-size: 2em;
      border-radius: 50%;
    }

    .avatar-edit-overlay {
      position: absolute;
      bottom: 3px;
      left: 3px;
      right: 3px;
      background: rgba(0,0,0,0.6);
      color: white;
      text-align: center;
      font-size: 0.7em;
      padding: 4px 0;
      opacity: 0;
      transition: opacity 0.2s;
      border-radius: 0 0 50% 50%;
    }

    .profile-avatar-edit:hover .avatar-edit-overlay {
      opacity: 1;
    }

    .profile-name-edit {
      flex: 1;
    }

    .avatar-remove-btn {
      margin-top: 10px;
      background: none;
      border: none;
      color: #ed4956;
      font-size: 0.85em;
      cursor: pointer;
      padding: 5px 10px;
      font-weight: 600;
    }

    .avatar-remove-btn:hover {
      opacity: 0.7;
    }

    /* ãƒŠãƒ“ãƒãƒ¼ã®ã‚¢ãƒã‚¿ãƒ¼ï¼ˆInstagramé¢¨è™¹è‰²æ  - conic-gradientï¼‰ */
    .nav-avatar-wrapper {
      position: relative;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: conic-gradient(from 180deg, #feda75, #fa7e1e, #d62976, #962fbf, #4f5bd5, #feda75);
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .nav-avatar-wrapper:hover {
      transform: scale(1.08);
      box-shadow: 0 2px 12px rgba(214, 41, 118, 0.25);
    }

    /* è¨­å®šã‚¿ãƒ–activeæ™‚ï¼šã‚¢ãƒã‚¿ãƒ¼ã«ã‚°ãƒ­ã‚¦ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
    .nav-tab-settings.active .nav-avatar-wrapper {
      box-shadow: 0 0 0 2px #fff, 0 2px 12px rgba(214, 41, 118, 0.35);
    }

    .nav-avatar {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid white;
      background: white;
    }

    .nav-tab-settings {
      padding: 6px 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 2px solid transparent !important;
    }

    /* è¨­å®šã‚¢ã‚¤ã‚³ãƒ³ï¼ˆâš™ï¸ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #navAvatarPlaceholder {
      font-size: 1.2em;
      transition: transform 0.3s ease;
    }

    .nav-tab-settings:hover #navAvatarPlaceholder {
      transform: rotate(60deg);
    }

    .nav-tab-settings.active #navAvatarPlaceholder {
      transform: rotate(90deg);
    }

    @media (max-width: 600px) {
      .settings-view {
        padding: 15px;
      }
      .settings-container {
        padding: 20px;
      }
      .settings-radio {
        flex-wrap: wrap;
      }
      .radio-desc {
        width: 100%;
        margin-left: 32px;
        margin-top: 4px;
      }
      .profile-edit-area {
        flex-direction: column;
        text-align: center;
      }
      .profile-name-edit {
        width: 100%;
      }
    }
  </style>
  
  <script>
    // è‰²ã®åˆ‡ã‚Šæ›¿ãˆã‚’CSSã«åæ˜ 
    if (typeof USE_COLORS !== 'undefined' && USE_COLORS) {
      document.write('<style>.section:nth-child(1){background-color:#ffe6e6 !important;}.section:nth-child(2){background-color:#e8f5e9 !important;}.section:nth-child(3){background-color:#fffef5 !important;}.section:nth-child(4){background-color:#f0f0f0 !important;}</style>');
    }
  </script>
</head>
<body>
  <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ– -->
  <div class="nav-tabs">
    <button class="nav-tab" id="navDaily" onclick="switchView('daily')">æ—¥æ¬¡</button>
    <button class="nav-tab" id="navWeekly" onclick="switchView('weekly')">é€±é–“</button>
    <button class="nav-tab active" id="navMonthly" onclick="switchView('monthly')">æœˆé–“</button>
    <button class="nav-tab" id="navYearly" onclick="switchView('yearly')">å¹´é–“</button>
    <button class="nav-tab nav-tab-settings" id="navSettings" onclick="switchView('settings')">
      <div class="nav-avatar-wrapper" id="navAvatarWrapper" style="display: none;">
        <img id="navAvatar" src="" alt="" class="nav-avatar">
      </div>
      <span id="navAvatarPlaceholder">âš™ï¸</span>
    </button>
  </div>

  <div class="container">
    <!-- å·¦ä¸Š: ç·Šæ€¥ã‹ã¤é‡è¦ -->
    <div class="section" id="section1">
      <div class="header-row">
        <h4>ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆã€ç·Šæ€¥ã‹ã¤é‡è¦ã€‘</h4>
        <!-- ã‚¹ãƒãƒ›ç¸¦ç”»é¢ç”¨ï¼šæ—¥ä»˜ã‚’ç¬¬1è±¡é™ã«è¡¨ç¤º -->
        <div class="date-display date-display-mobile" id="dateDisplayMobile"></div>
        <div class="purpose-group" id="purposeGroup" style="display: none;">
          <label>ç›®çš„:</label>
          <input type="text" id="purposeInput" placeholder="æœ¬è³ªçš„ãªç›®çš„ã‚’ä¸€è¡Œã§å…¥åŠ›...">
          <button class="edit-btn" onclick="confirmPurpose()">ä»®æ±ºã‚</button>
        </div>
        <div class="purpose-display" id="purposeDisplay" style="display: none;">
          <span id="purposeText"></span>
          <button class="edit-btn" onclick="editPurpose()">ç·¨é›†</button>
        </div>
        <button class="timer-btn" id="timerBtn" onclick="handleTimerClick()"></button>
      </div>
      <input type="text" class="task-input" id="input1" placeholder="æœ¬è³ªçš„ã§ä»Šã™ãå¿…è¦ãªè¡Œå‹•ã¯ï¼Ÿ...">
      <ul class="task-list" id="list1"></ul>
    </div>

    <!-- å³ä¸Š: ç·Šæ€¥ã§ãªã„ãŒé‡è¦ -->
    <div class="section" id="section2">
      <div class="simple-header">
        <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
          <h4>ã€ç·Šæ€¥ã§ãªã„ãŒé‡è¦ã€‘</h4>
          <button class="deep-dive-btn" onclick="toggleDeepDive()">ç‚¹æ¤œ</button>
          
          <!-- æ­¢ã¾ã‚‹ä»•çµ„ã¿å…¥åŠ› -->
          <div id="stopConditionGroup" style="display: none; align-items: center; gap: 4px;">
            <label style="font-size: 0.75em; white-space: nowrap;">æ­¢ã‚ã‚‹ä»•çµ„ã¿:</label>
            <input type="text" id="stopConditionInput" placeholder="ä¾‹: æœŸé™3æ—¥è¶…éã€2é€±é–“çµŒé" style="padding: 3px 6px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.8em; width: 150px; max-width: 150px;" onkeydown="if(event.key==='Enter') saveStopCondition();">
            <button class="edit-btn" onclick="saveStopCondition()">ä»®æ±ºã‚</button>
          </div>
          
          <!-- æ­¢ã‚ã‚‹ä»•çµ„ã¿è¡¨ç¤º -->
          <div id="stopConditionDisplay" style="display: none; font-size: 0.75em; flex-wrap: wrap; align-items: center; gap: 4px;">
            <span style="white-space: nowrap;">æ­¢ã‚ã‚‹ä»•çµ„ã¿:</span>
            <span id="stopConditionText" style="font-weight: normal; word-wrap: break-word; overflow-wrap: break-word; flex: 1; min-width: 0;"></span>
            <button class="edit-btn" onclick="editStopCondition()">ç·¨é›†</button>
          </div>
        </div>
        <div class="date-display" id="dateDisplay"></div>
      </div>
      <div id="deepDiveQuestions" style="display: none; margin-bottom: 10px; font-size: 0.85em; color: #333; line-height: 1.6;">
        <div style="margin-bottom: 8px; font-weight: bold; color: #d32f2f;">
          0. ã©ã†ã„ã†ã“ã¨ãŒèµ·ã“ã‚Œã°ã€ã„ã£ãŸã‚“æ­¢ã‚ã¦ç‚¹æ¤œã™ã‚‹ã‹ï¼Ÿ<br>
          ï¼ˆ2é€±é–“çµŒéã€èµ¤å­—æå¤±1ä¸‡å††ã€æœŸé™è¶…é3æ—¥ã€å®Œäº†ç‡30%æœªæº€ï¼‰<br>
          â€»æ•°å€¤åŒ–ã—ã¦å›³ã‚Œã€‚
        </div>
        <div>1. ã“ã‚Œã¯ã€èª°ã®äººç”Ÿã«ç´ã¥ãæœªå®Œäº†ã‹?(å¸°å±)</div>
        <div>2. ã“ã‚Œã®æ­£ä½“ã¯è¡Œå‹•ã‹?(çœŸè´‹)</div>
        <div>3. ã“ã‚Œã¨å…±ã«æ­©ã‚€è¦šæ‚Ÿã¯ã‚ã‚‹ã‹?(è¦šæ‚Ÿ)</div>
        <div>
          4. è¦šæ‚Ÿã‚’ã„ã¤ã¾ã§ã«ï¼ˆä½•ã‚’ã‚„ã‚‹ã‹ã€ä½•æ™‚ã‹ã‚‰ã‚„ã‚‹ã‹ã€ã„ã¤ã¾ã§ã«ã‚„ã‚‹ã‹ï¼‰ã¨è¡Œå‹•ã«è½ã¨ã—è¾¼ã‚“ã ã‹?<br>
          é–‹å§‹ç· ã‚åˆ‡ã‚Šã€çµ‚äº†ç· ã‚åˆ‡ã‚Šã€ç‚¹æ¤œã€‚<br>
          æ˜æ—¥ã‚‚åŒã˜å½¢ã§ç¶™ç¶šã§ãã‚‹å½¢ã«ãªã£ã¦ã„ã‚‹ã‹ï¼Ÿ
        </div>
        <div style="margin-top: 8px; font-weight: bold; color: #1976d2;">5. æœ€å¤§ã®æ•µã¯ã€ç­”ãˆã‚’å‡ºã—ãŸããªã„è‡ªåˆ†ã ã€‚</div>
        <div style="margin-top: 8px; font-weight: bold; color: #7b1fa2;">6. å•ã„ã®é¤¨ã¯å´©å£Šã—ã€ãŠå‰ã¯ä»Šã€ç”Ÿã¾ã‚Œå¤‰ã‚ã£ãŸã€‚</div>
        <div style="margin-top: 8px; font-weight: bold; color: #388e3c;">7. ã‚¨ãƒªã‚¯ã‚µãƒ¼ã¯å…·ä½“çš„ãªè¡Œå‹•ã ï¼</div>
      </div>
      <input type="text" class="task-input" id="input2" placeholder="æœ¬è³ªçš„ãªè¨ˆç”»è¡Œå‹•ã¯ï¼Ÿ...">
      <ul class="task-list" id="list2"></ul>
    </div>

    <!-- å·¦ä¸‹: ç·Šæ€¥ã ãŒé‡è¦ã§ã¯ãªã„ -->
    <div class="section" id="section3">
      <div class="simple-header">
        <h4>ã€ç·Šæ€¥ã ãŒé‡è¦ã§ã¯ãªã„ã€‘</h4>
        <button class="color-toggle-btn" onclick="toggleColors()">è‰²åˆ‡æ›¿</button>
      </div>
      <input type="text" class="task-input" id="input3" placeholder="äº›ç´°ã ãŒæ€¥ãã®è¡Œå‹•ã¯ï¼Ÿï¼ˆäººã«ä»»ã›ã‚‹ï¼‰...">
      <ul class="task-list" id="list3"></ul>
    </div>

    <!-- å³ä¸‹: ç·Šæ€¥ã§ã‚‚é‡è¦ã§ã‚‚ãªã„ -->
    <div class="section" id="section4">
      <div class="simple-header">
        <h4>ã€ç·Šæ€¥ã§ã‚‚é‡è¦ã§ã‚‚ãªã„ã€‘</h4>
        <div class="header-buttons">
          <button class="data-btn" onclick="exportData()">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button class="data-btn" onclick="document.getElementById('importFile').click()">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
          <button class="clear-all-btn" onclick="clearAllData()">ğŸ—‘ï¸ å…¨ã‚¯ãƒªã‚¢</button>
        </div>
      </div>
      <input type="text" class="task-input" id="input4" placeholder="äº›æœ«ãªäº‹ã¯ã‚„ã‚‰ãªã„ã¨æ±ºã‚ã‚‹...è¦–ç•Œã‹ã‚‰å¤–ã™ã€ã‚¹ãƒãƒ›é›»æºåˆ‡ã‚‹...">
      <ul class="task-list" id="list4"></ul>
    </div>
  </div>

  <!-- é€ƒã’å‡ºã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  <div id="escapeMessage" class="escape-message">
    é€ƒã’å‡ºã—ãŸï¼
  </div>

  <!-- é€±é–“ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="weeklyTaskModal" class="custom-modal">
    <div class="modal-content" style="max-width: 450px; max-height: 90vh; overflow-y: auto;">
      <h3>é€±é–“ã‚¿ã‚¹ã‚¯ã«è¿½åŠ </h3>
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 10px; font-weight: bold;">æ›œæ—¥</label>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
          <button class="day-select-btn" data-day="0">æœˆ</button>
          <button class="day-select-btn" data-day="1">ç«</button>
          <button class="day-select-btn" data-day="2">æ°´</button>
          <button class="day-select-btn" data-day="3">æœ¨</button>
          <button class="day-select-btn" data-day="4">é‡‘</button>
          <button class="day-select-btn" data-day="5">åœŸ</button>
          <button class="day-select-btn" data-day="6">æ—¥</button>
        </div>
        
        <label style="display: block; margin-bottom: 10px; font-weight: bold;">æ™‚é–“</label>
        <select id="weeklyTaskTime" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em; background-color: white; cursor: pointer;">
          <option value="00:00">00:00</option>
          <option value="00:15">00:15</option>
          <option value="00:30">00:30</option>
          <option value="00:45">00:45</option>
          <option value="01:00">01:00</option>
          <option value="01:15">01:15</option>
          <option value="01:30">01:30</option>
          <option value="01:45">01:45</option>
          <option value="02:00">02:00</option>
          <option value="02:15">02:15</option>
          <option value="02:30">02:30</option>
          <option value="02:45">02:45</option>
          <option value="03:00">03:00</option>
          <option value="03:15">03:15</option>
          <option value="03:30">03:30</option>
          <option value="03:45">03:45</option>
          <option value="04:00">04:00</option>
          <option value="04:15">04:15</option>
          <option value="04:30">04:30</option>
          <option value="04:45">04:45</option>
          <option value="05:00">05:00</option>
          <option value="05:15">05:15</option>
          <option value="05:30">05:30</option>
          <option value="05:45">05:45</option>
          <option value="06:00">06:00</option>
          <option value="06:15">06:15</option>
          <option value="06:30">06:30</option>
          <option value="06:45">06:45</option>
          <option value="07:00">07:00</option>
          <option value="07:15">07:15</option>
          <option value="07:30">07:30</option>
          <option value="07:45">07:45</option>
          <option value="08:00">08:00</option>
          <option value="08:15">08:15</option>
          <option value="08:30">08:30</option>
          <option value="08:45">08:45</option>
          <option value="09:00" selected>09:00</option>
          <option value="09:15">09:15</option>
          <option value="09:30">09:30</option>
          <option value="09:45">09:45</option>
          <option value="10:00">10:00</option>
          <option value="10:15">10:15</option>
          <option value="10:30">10:30</option>
          <option value="10:45">10:45</option>
          <option value="11:00">11:00</option>
          <option value="11:15">11:15</option>
          <option value="11:30">11:30</option>
          <option value="11:45">11:45</option>
          <option value="12:00">12:00</option>
          <option value="12:15">12:15</option>
          <option value="12:30">12:30</option>
          <option value="12:45">12:45</option>
          <option value="13:00">13:00</option>
          <option value="13:15">13:15</option>
          <option value="13:30">13:30</option>
          <option value="13:45">13:45</option>
          <option value="14:00">14:00</option>
          <option value="14:15">14:15</option>
          <option value="14:30">14:30</option>
          <option value="14:45">14:45</option>
          <option value="15:00">15:00</option>
          <option value="15:15">15:15</option>
          <option value="15:30">15:30</option>
          <option value="15:45">15:45</option>
          <option value="16:00">16:00</option>
          <option value="16:15">16:15</option>
          <option value="16:30">16:30</option>
          <option value="16:45">16:45</option>
          <option value="17:00">17:00</option>
          <option value="17:15">17:15</option>
          <option value="17:30">17:30</option>
          <option value="17:45">17:45</option>
          <option value="18:00">18:00</option>
          <option value="18:15">18:15</option>
          <option value="18:30">18:30</option>
          <option value="18:45">18:45</option>
          <option value="19:00">19:00</option>
          <option value="19:15">19:15</option>
          <option value="19:30">19:30</option>
          <option value="19:45">19:45</option>
          <option value="20:00">20:00</option>
          <option value="20:15">20:15</option>
          <option value="20:30">20:30</option>
          <option value="20:45">20:45</option>
          <option value="21:00">21:00</option>
          <option value="21:15">21:15</option>
          <option value="21:30">21:30</option>
          <option value="21:45">21:45</option>
          <option value="22:00">22:00</option>
          <option value="22:15">22:15</option>
          <option value="22:30">22:30</option>
          <option value="22:45">22:45</option>
          <option value="23:00">23:00</option>
          <option value="23:15">23:15</option>
          <option value="23:30">23:30</option>
          <option value="23:45">23:45</option>
        </select>
      </div>
      <div style="text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
        <button class="modal-btn modal-btn-cancel" onclick="closeWeeklyTaskModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-save" onclick="confirmAddToWeekly()">è¿½åŠ </button>
      </div>
    </div>
  </div>

  <!-- é€±é–“ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå†å®Ÿè£…ï¼‰ -->
  <div id="weeklyTaskEditModal" class="custom-modal" onclick="if(event.target.id==='weeklyTaskEditModal') closeWeeklyEditModal();">
    <div class="modal-content" style="max-width: 400px;">
      <h3>ã‚¿ã‚¹ã‚¯ç·¨é›†</h3>
      <input type="hidden" id="editTaskId">
      <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">ã‚¿ã‚¹ã‚¯å</label>
        <input type="text" id="editTaskText" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em; box-sizing: border-box;" onkeydown="if(event.key==='Enter') saveWeeklyEdit();">
      </div>
      <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <textarea id="editTaskMemo" rows="3" placeholder="è©³ç´°ã‚„æŒã¡ç‰©ãªã©..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em; box-sizing: border-box; resize: vertical; font-family: inherit;"></textarea>
      </div>
      <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">æ—¥ä»˜</label>
        <input type="date" id="editTaskDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em; box-sizing: border-box;">
      </div>
      <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">æ™‚é–“</label>
        <div class="custom-time-picker" id="weeklyEditTimePicker">
          <div class="time-select-wrapper">
            <select class="time-select" id="weeklyEditHourSelect">
              <option value="">--</option>
              <option value="0">00</option><option value="1">01</option><option value="2">02</option><option value="3">03</option>
              <option value="4">04</option><option value="5">05</option><option value="6">06</option><option value="7">07</option>
              <option value="8">08</option><option value="9">09</option><option value="10">10</option><option value="11">11</option>
              <option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option>
              <option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option>
              <option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option>
            </select>
            <div class="time-label">æ™‚</div>
          </div>
          <span class="time-separator">:</span>
          <div class="time-select-wrapper">
            <select class="time-select" id="weeklyEditMinuteSelect">
              <option value="">--</option>
              <option value="0">00</option><option value="5">05</option><option value="10">10</option><option value="15">15</option>
              <option value="20">20</option><option value="25">25</option><option value="30">30</option><option value="35">35</option>
              <option value="40">40</option><option value="45">45</option><option value="50">50</option><option value="55">55</option>
            </select>
            <div class="time-label">åˆ†</div>
          </div>
          <button type="button" class="time-clear-btn" onclick="clearTimeSelect('weeklyEdit')" title="æ™‚é–“ã‚’ã‚¯ãƒªã‚¢">âœ•</button>
        </div>
      </div>
      <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">è±¡é™</label>
        <select id="editTaskSection" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
          <option value="1">ç·Šæ€¥ã‹ã¤é‡è¦</option>
          <option value="2">ç·Šæ€¥ã§ãªã„ãŒé‡è¦</option>
          <option value="3">ç·Šæ€¥ã ãŒé‡è¦ã§ã¯ãªã„</option>
          <option value="4">ç·Šæ€¥ã§ã‚‚é‡è¦ã§ã‚‚ãªã„</option>
        </select>
      </div>
      <div class="modal-buttons" style="margin-top: 20px;">
        <button class="modal-btn modal-btn-cancel" onclick="closeWeeklyEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-delete" onclick="confirmDeleteFromEdit()">å‰Šé™¤</button>
        <button class="modal-btn modal-btn-save" onclick="saveWeeklyEdit()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- é€±é–“ã‚¿ã‚¹ã‚¯ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="weeklyTaskCreateModal" class="custom-modal" onclick="if(event.target.id==='weeklyTaskCreateModal') closeCreateModal();">
    <div class="modal-content" style="max-width: 400px;">
      <h3>ã‚¿ã‚¹ã‚¯ä½œæˆ</h3>
      <div id="weeklyModalDate" style="text-align: center; color: #666; margin-bottom: 15px; font-size: 0.9em;"></div>
      <div style="margin: 15px 0;">
        <input type="text" id="createTaskText" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em; box-sizing: border-box;" placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›..." onkeydown="if(event.key==='Enter') saveCreateTask();">
      </div>
      <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <textarea id="createTaskMemo" rows="2" placeholder="è©³ç´°ã‚„æŒã¡ç‰©ãªã©..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em; box-sizing: border-box; resize: vertical; font-family: inherit;"></textarea>
      </div>
      <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">æ™‚é–“</label>
        <select id="createTaskTime" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
          <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
        </select>
      </div>
      <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">è±¡é™</label>
        <select id="createTaskSection" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
          <option value="1">ç·Šæ€¥ã‹ã¤é‡è¦</option>
          <option value="2" selected>ç·Šæ€¥ã§ãªã„ãŒé‡è¦</option>
          <option value="3">ç·Šæ€¥ã ãŒé‡è¦ã§ã¯ãªã„</option>
          <option value="4">ç·Šæ€¥ã§ã‚‚é‡è¦ã§ã‚‚ãªã„</option>
        </select>
      </div>
      <div class="modal-buttons" style="margin-top: 20px;">
        <button class="modal-btn modal-btn-cancel" onclick="closeCreateModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-save" onclick="saveCreateTask()">ä½œæˆ</button>
      </div>
    </div>
  </div>

  <!-- é€±é–“ãƒ“ãƒ¥ãƒ¼ -->
  <div id="weeklyView" class="weekly-view">
    <div class="weekly-header">
      <button class="monthly-nav-btn" onclick="changeWeek(-1)">â—€ å…ˆé€±</button>
      <h2 id="weeklyTitle"></h2>
      <button class="monthly-nav-btn" onclick="changeWeek(1)">æ¥é€± â–¶</button>
    </div>
    <div class="weekly-container" id="weeklyContainer">
      <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
    </div>
  </div>

  <!-- æœˆé–“ãƒ“ãƒ¥ãƒ¼ -->
  <div id="monthlyView" class="monthly-view">
    <div class="monthly-header">
      <span id="seasonalArt" style="display: none; position: absolute; left: 4px; top: 50%; transform: translateY(-50%); font-size: 2em; line-height: 1; filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.1));"></span>
      <button class="monthly-nav-btn" onclick="changeMonth(-1)">â—€ å…ˆæœˆ</button>
      <h2 id="monthlyTitle"></h2>
      <button class="monthly-nav-btn" onclick="changeMonth(1)">æ¥æœˆ â–¶</button>
      <div id="widthSliderWrap" style="position: absolute; right: 4px; top: 50%; transform: translateY(-50%); display: flex; align-items: center; gap: 4px;">
        <span style="font-size: 0.65em; color: #bbb;">â†”</span>
        <input type="range" id="monthlyWidthSlider" min="100" max="300" value="100" 
          style="width: 70px; accent-color: #4facfe; cursor: pointer;"
          oninput="adjustMonthlyWidth(this.value)">
        <button onclick="resetMonthlyWidth()" style="font-size: 0.6em; color: #aaa; background: none; border: 1px solid #ddd; border-radius: 3px; padding: 1px 4px; cursor: pointer;">â†º</button>
      </div>
    </div>
    <div id="monthlyCalendar" class="monthly-calendar">
      <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
    </div>

    <!-- ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼šã‚¹ã‚¿ãƒ³ãƒ—ãƒãƒ¼ï¼ˆæŠ˜ã‚Šè¿”ã—å¯¾å¿œï¼‰ -->
    <div id="stampBar" style="display: none; position: sticky; bottom: 0; left: 0; right: 0; background: #fff; border-top: 2px solid #eee; padding: 6px 8px 4px; z-index: 30; box-shadow: 0 -2px 8px rgba(0,0,0,0.08);">
      <!-- ã‚¹ã‚¿ãƒ³ãƒ—ï¼‹ãƒ„ãƒ¼ãƒ«ï¼ˆflex-wrap ã§è‡ªå‹•æŠ˜ã‚Šè¿”ã—ï¼‰ -->
      <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 5px; justify-content: center; padding-bottom: 2px;">
        <div id="stampButtons" style="display: contents;"></div>
        <div style="display: flex; gap: 4px; margin-left: 2px;">
          <button onclick="selectEraserMode()" id="stampEraserBtn"
            style="padding: 4px 10px; border-radius: 14px; border: 1.5px solid #ef5350; background: #fff; font-size: 0.75em; cursor: pointer; white-space: nowrap; transition: all 0.2s; color: #ef5350;">ğŸ—‘</button>
          <button onclick="clearStampSelection()" id="stampClearBtn"
            style="padding: 4px 10px; border-radius: 14px; border: 1.5px solid #e0e0e0; background: #f5f5f5; font-size: 0.75em; cursor: pointer; white-space: nowrap;">âœ•</button>
        </div>
      </div>
      <div id="stampSelectionInfo" style="text-align: center; font-size: 0.7em; color: #999; margin-top: 2px;">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é¸ã‚“ã§ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—</div>
    </div>
  </div>

  <!-- å¹´é–“ãƒ“ãƒ¥ãƒ¼ï¼ˆYEARLY PLANNERå‹ï¼‰ -->
  <div id="yearlyView" class="yearly-view" style="display: none;">
    <div class="yearly-header">
      <button class="monthly-nav-btn" onclick="changeYear(-1)">â—€ å»å¹´</button>
      <h2 id="yearlyTitle"></h2>
      <button class="monthly-nav-btn" onclick="changeYear(1)">æ¥å¹´ â–¶</button>
    </div>
    <div id="yearlyCalendar" class="yearly-calendar">
      <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
    </div>
  </div>

  <!-- è¨­å®šãƒ“ãƒ¥ãƒ¼ -->
  <div id="settingsView" class="settings-view" style="display: none;">
    <div class="settings-container">
      <h2 style="margin: 0 0 30px 0; color: #262626; font-size: 1.4em; font-weight: 700; letter-spacing: -0.01em;">è¨­å®š</h2>
      
      <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="settings-section">
        <h3 style="margin: 0 0 20px 0; color: #262626; font-size: 1.05em; font-weight: 600; border-bottom: 1px solid #efefef; padding-bottom: 12px;">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
        <div class="settings-item">
          <div class="profile-edit-area">
            <div class="profile-avatar-edit" onclick="document.getElementById('avatarInput').click()">
              <img id="profileAvatarPreview" src="" alt="avatar" style="display: none;">
              <div id="profileAvatarPlaceholder" class="avatar-placeholder">ğŸ“·</div>
              <div class="avatar-edit-overlay">å¤‰æ›´</div>
            </div>
            <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="handleAvatarChange(event)">
            <div class="profile-name-edit">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #262626; font-size: 0.9em;">è¡¨ç¤ºå</label>
              <input type="text" id="profileNameInput" placeholder="ã‚ãªãŸã®åå‰..." maxlength="20" style="width: 100%; padding: 12px; border: 2px solid #e8e8e8; border-radius: 10px; font-size: 1em; box-sizing: border-box;">
            </div>
          </div>
          <button class="avatar-remove-btn" id="avatarRemoveBtn" onclick="removeAvatar()" style="display: none;">ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰Šé™¤</button>
        </div>
      </div>
      
      <div class="settings-section">
        <h3 style="margin: 0 0 15px 0; color: #262626; font-size: 1.05em; font-weight: 600; border-bottom: 1px solid #efefef; padding-bottom: 12px;">åˆæœŸè¡¨ç¤º</h3>
        <div class="settings-item">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #262626; font-size: 0.9em;">ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®ãƒ“ãƒ¥ãƒ¼</label>
          <p style="margin: 0 0 12px 0; font-size: 0.85em; color: #8e8e8e;">ã‚¢ãƒ—ãƒªã‚’é–‹ã„ãŸã¨ãã«æœ€åˆã«è¡¨ç¤ºã™ã‚‹ãƒ“ãƒ¥ãƒ¼ã‚’é¸æŠã—ã¾ã™</p>
          <div class="settings-radio-group" id="initialViewGroup">
            <label class="settings-radio">
              <input type="radio" name="initialView" value="daily">
              <span class="radio-label">ğŸ“… æ—¥æ¬¡</span>
              <span class="radio-desc">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã«é›†ä¸­</span>
            </label>
            <label class="settings-radio">
              <input type="radio" name="initialView" value="weekly">
              <span class="radio-label">ğŸ“Š é€±é–“</span>
              <span class="radio-desc">1é€±é–“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç¢ºèª</span>
            </label>
            <label class="settings-radio">
              <input type="radio" name="initialView" value="monthly" checked>
              <span class="radio-label">ğŸ—“ï¸ æœˆé–“</span>
              <span class="radio-desc">æœˆå…¨ä½“ã‚’ä¿¯ç°ã—ã¦æŠŠæ¡</span>
            </label>
            <label class="settings-radio">
              <input type="radio" name="initialView" value="yearly">
              <span class="radio-label">ğŸ“† å¹´é–“</span>
              <span class="radio-desc">å¹´é–“è¨ˆç”»ã‚’ç¢ºèª</span>
            </label>
          </div>
        </div>
      </div>

      <!-- æœˆé–“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
      <div style="margin-top: 24px; border-top: 1px solid #efefef; padding-top: 18px;">
        <h3 style="margin: 0 0 15px 0; color: #262626; font-size: 1.05em; font-weight: 600; border-bottom: 1px solid #efefef; padding-bottom: 12px;">æœˆé–“ãƒ“ãƒ¥ãƒ¼</h3>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #262626; font-size: 0.9em;">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</label>
          <p style="font-size: 0.8em; color: #8e8e8e; margin: 0 0 10px 0;">ã‚»ãƒ«ã®é«˜ã•ã®æŒ™å‹•ã‚’é¸æŠã—ã¾ã™</p>
          <div class="settings-radio-group" id="monthlyModeGroup">
            <label class="settings-radio-label">
              <input type="radio" name="monthlyMode" value="fixed" checked>
              <span>ğŸ“ å›ºå®šé«˜ã•</span>
              <span style="font-size: 0.75em; color: #8e8e8e; margin-left: 8px;">ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º</span>
            </label>
            <label class="settings-radio-label">
              <input type="radio" name="monthlyMode" value="expand">
              <span>ğŸ“– å…¨ã‚¿ã‚¹ã‚¯è¡¨ç¤º</span>
              <span style="font-size: 0.75em; color: #8e8e8e; margin-left: 8px;">å…¨æ–‡åˆ¤èª­å¯èƒ½</span>
            </label>
          </div>
        </div>
      </div>

      <!-- ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ -->
      <div style="margin-top: 24px; border-top: 1px solid #efefef; padding-top: 18px;">
        <h3 style="margin: 0 0 15px 0; color: #262626; font-size: 1.05em; font-weight: 600; border-bottom: 1px solid #efefef; padding-bottom: 12px;">ğŸ©º ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰</h3>
        <p style="font-size: 0.8em; color: #8e8e8e; margin: 0 0 12px 0;">ã‚·ãƒ•ãƒˆç®¡ç†ã«ç‰¹åŒ–ã—ãŸã‚·ãƒ³ãƒ—ãƒ«ç”»é¢ã€‚ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚¿ãƒƒãƒ—â†’æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã§å…¥åŠ›ã€‚</p>
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <label style="font-weight: 600; color: #262626; font-size: 0.9em;">ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰</label>
          <label style="position: relative; display: inline-block; width: 50px; height: 26px; cursor: pointer;">
            <input type="checkbox" id="simpleModeToggle" style="opacity: 0; width: 0; height: 0;"
              onchange="toggleSimpleModePreview(this.checked)">
            <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 26px; transition: 0.3s;"
              id="simpleToggleSlider"></span>
            <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: 0.3s; pointer-events: none;"
              id="simpleToggleKnob"></span>
          </label>
        </div>

        <!-- ã‚¹ã‚¿ãƒ³ãƒ—è¨­å®š -->
        <div id="stampSettingsArea" style="display: none;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #262626; font-size: 0.9em;">ã‚¹ã‚¿ãƒ³ãƒ—è¨­å®š</label>
          <p style="font-size: 0.8em; color: #8e8e8e; margin: 0 0 10px 0;">æœ€å¤§20å€‹ã€‚åå‰ãƒ»è‰²ãƒ»æ™‚é–“å¸¯ã‚’è¨­å®šã§ãã¾ã™ã€‚</p>
          <div id="stampList" style="margin-bottom: 12px;"></div>
          <button onclick="addStampSetting()" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 8px; padding: 8px 16px; font-size: 0.85em; cursor: pointer;">ï¼‹ ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ </button>
        </div>
      </div>
      
      <div class="settings-actions" style="margin-top: 30px; text-align: center;">
        <button class="modal-btn modal-btn-primary" style="padding: 14px 40px; font-size: 1em; border-radius: 12px;" onclick="saveSettings()">è¨­å®šã‚’ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- æœˆé–“ã‚¿ã‚¹ã‚¯è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="monthlyTaskModal" class="custom-modal" onclick="if(event.target.id==='monthlyTaskModal') closeMonthlyTaskModal();">
    <div class="modal-content" style="max-width: 400px;">
      <h3 id="monthlyModalTitle">ã‚¿ã‚¹ã‚¯è¿½åŠ </h3>
      <input type="hidden" id="monthlyTaskId">
      <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">ã‚¿ã‚¹ã‚¯å</label>
        <input type="text" id="monthlyTaskInput" placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em; box-sizing: border-box;" onkeydown="if(event.key==='Enter') saveMonthlyTask();">
      </div>
      <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <textarea id="monthlyTaskMemo" rows="3" placeholder="è©³ç´°ã‚„æŒã¡ç‰©ãªã©..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em; box-sizing: border-box; resize: vertical; font-family: inherit;"></textarea>
      </div>
      <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">æ—¥ä»˜</label>
        <input type="date" id="monthlyTaskDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em; box-sizing: border-box;">
      </div>
      <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">æ™‚é–“ï¼ˆä»»æ„ï¼‰</label>
        <div class="custom-time-picker" id="monthlyTimePicker">
          <div class="time-select-wrapper">
            <select class="time-select" id="monthlyHourSelect">
              <option value="">--</option>
              <option value="0">00</option><option value="1">01</option><option value="2">02</option><option value="3">03</option>
              <option value="4">04</option><option value="5">05</option><option value="6">06</option><option value="7">07</option>
              <option value="8">08</option><option value="9">09</option><option value="10">10</option><option value="11">11</option>
              <option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option>
              <option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option>
              <option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option>
            </select>
            <div class="time-label">æ™‚</div>
          </div>
          <span class="time-separator">:</span>
          <div class="time-select-wrapper">
            <select class="time-select" id="monthlyMinuteSelect">
              <option value="">--</option>
              <option value="0">00</option><option value="5">05</option><option value="10">10</option><option value="15">15</option>
              <option value="20">20</option><option value="25">25</option><option value="30">30</option><option value="35">35</option>
              <option value="40">40</option><option value="45">45</option><option value="50">50</option><option value="55">55</option>
            </select>
            <div class="time-label">åˆ†</div>
          </div>
          <button type="button" class="time-clear-btn" onclick="clearTimeSelect('monthly')" title="æ™‚é–“ã‚’ã‚¯ãƒªã‚¢">âœ•</button>
        </div>
        <div style="font-size: 0.75em; color: #888; margin-top: 4px;">â€»æ™‚é–“ã‚’è¨­å®šã™ã‚‹ã¨é€±é–“ãƒ“ãƒ¥ãƒ¼ã«ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã™</div>
      </div>
      <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">è±¡é™</label>
        <select id="monthlyTaskSection" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
          <option value="1">ç·Šæ€¥ã‹ã¤é‡è¦</option>
          <option value="2">ç·Šæ€¥ã§ãªã„ãŒé‡è¦</option>
          <option value="3">ç·Šæ€¥ã ãŒé‡è¦ã§ã¯ãªã„</option>
          <option value="4">ç·Šæ€¥ã§ã‚‚é‡è¦ã§ã‚‚ãªã„</option>
        </select>
      </div>
      <div class="modal-buttons" style="margin-top: 20px;">
        <button class="modal-btn modal-btn-cancel" onclick="closeMonthlyTaskModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="monthlyDeleteBtn" class="modal-btn modal-btn-delete" style="display: none;" onclick="deleteMonthlyTask()">å‰Šé™¤</button>
        <button class="modal-btn modal-btn-save" onclick="saveMonthlyTask()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    /**
     * ============================================================
     * ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ - GTDã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
     * ============================================================
     * 
     * ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦ï¼š
     * 
     * 1. ãƒ‡ãƒ¼ã‚¿å±¤ï¼ˆSingle Source of Truthï¼‰
     *    - allTasks[]: å…¨ã‚¿ã‚¹ã‚¯ã®å”¯ä¸€ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
     *    - å„ã‚¿ã‚¹ã‚¯ã¯è¡¨ç¤ºãƒ•ãƒ©ã‚°ã§ã€Œã©ã“ã«è¡¨ç¤ºã™ã‚‹ã‹ã€ã‚’åˆ¶å¾¡
     *    - ãƒ‡ãƒ¼ã‚¿é‡è¤‡ã‚’å®Œå…¨ã«æ’é™¤
     * 
     * 2. ãƒ“ãƒ¥ãƒ¼å±¤ï¼ˆè²¬å‹™ã®åˆ†é›¢ï¼‰
     *    - æ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼: getDailyTasks() ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
     *    - é€±é–“ãƒ“ãƒ¥ãƒ¼: getWeeklyTasks() ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
     *    - æœˆæ¬¡ãƒ“ãƒ¥ãƒ¼: getMonthlyTasks() ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå°†æ¥ï¼‰
     *    - å¹´æ¬¡ãƒ“ãƒ¥ãƒ¼: getYearlyTasks() ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå°†æ¥ï¼‰
     *    - 2å¹´/3å¹´/4å¹´/5å¹´ãƒ“ãƒ¥ãƒ¼: é•·æœŸç›®æ¨™ç®¡ç†ï¼ˆå°†æ¥ï¼‰
     * 
     * 3. CRUDæ“ä½œ
     *    - createTask(): ã‚¿ã‚¹ã‚¯ä½œæˆ
     *    - updateTask(): ã‚¿ã‚¹ã‚¯æ›´æ–°ï¼ˆå…¨ãƒ“ãƒ¥ãƒ¼ã«è‡ªå‹•åæ˜ ï¼‰
     *    - deleteTask(): ã‚¿ã‚¹ã‚¯å‰Šé™¤ï¼ˆå…¨ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰è‡ªå‹•å‰Šé™¤ï¼‰
     * 
     * 4. åŒæ–¹å‘åŒæœŸ
     *    - æ—¥æ¬¡ã§ç·¨é›† â†’ é€±é–“ã«è‡ªå‹•åæ˜ 
     *    - é€±é–“ã§ç·¨é›† â†’ æ—¥æ¬¡ã«è‡ªå‹•åæ˜ 
     *    - è±¡é™ç§»å‹• â†’ è‰²ã‚‚è‡ªå‹•å¤‰æ›´
     * 
     * 5. è±¡é™ã¨è‰²ã®å¯¾å¿œ
     *    - è±¡é™1ï¼ˆç·Šæ€¥ã‹ã¤é‡è¦ï¼‰: èµ¤ (#ffe6e6)
     *    - è±¡é™2ï¼ˆç·Šæ€¥ã ãŒé‡è¦ã§ãªã„ï¼‰: ç·‘ (#e8f5e9)
     *    - è±¡é™3ï¼ˆé‡è¦ã ãŒç·Šæ€¥ã§ãªã„ï¼‰: é»„ (#fffef5)
     *    - è±¡é™4ï¼ˆç·Šæ€¥ã§ã‚‚é‡è¦ã§ã‚‚ãªã„ï¼‰: ã‚°ãƒ¬ãƒ¼ (#f0f0f0)
     * 
     * 6. æ‹¡å¼µæ€§
     *    - æ–°ã—ã„ãƒ“ãƒ¥ãƒ¼è¿½åŠ : ãƒ•ãƒ©ã‚°è¿½åŠ  + ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é–¢æ•°è¿½åŠ 
     *    - ãƒ‡ãƒ¼ã‚¿æ§‹é€ å¤‰æ›´ä¸è¦
     *    - æ—¢å­˜æ©Ÿèƒ½ã«å½±éŸ¿ãªã—
     */
    
    // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨
    let purpose = '';

    // å­£ç¯€ã‚¢ãƒ¼ãƒˆï¼ˆæ—¥æœ¬ã®é¢¨ç‰©è©©ï¼‰
    const SEASONAL_ART = {
      1: 'ğŸ',  // æ­£æœˆãƒ»é–€æ¾
      2: 'ğŸ‘¹',  // ç¯€åˆ†ãƒ»é¬¼
      3: 'âœ¿',   // æ¢…ã®èŠ±
      4: 'ğŸŒ¸',  // æ¡œãƒ»ãŠèŠ±è¦‹
      5: 'ğŸ',  // ã“ã©ã‚‚ã®æ—¥ãƒ»é¯‰ã®ã¼ã‚Š
      6: 'â˜”',  // æ¢…é›¨
      7: 'ğŸ–ï¸',  // å¤ä¼‘ã¿ãƒ»ãƒ“ãƒ¼ãƒ
      8: 'ğŸŒ»',  // å‘æ—¥è‘µ
      9: 'ğŸŒ¾',  // ç¨²ç©‚ãƒ»å®Ÿã‚Šã®ç§‹
      10: 'ğŸƒ', // ãƒãƒ­ã‚¦ã‚£ãƒ³
      11: 'ğŸ', // ç´…è‘‰
      12: 'ğŸ„'  // ã‚¯ãƒªã‚¹ãƒã‚¹
    };
    let purposeConfirmed = false;
    let stopCondition = '';
    let stopConditionSaved = false;
    
    // ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã‚’YYYY-MM-DDå½¢å¼ã§å–å¾—ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å•é¡Œã‚’å›é¿ï¼‰
    function getLocalDateStr(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    let tasks = {
      1: [],
      2: [],
      3: [],
      4: []
    };

    // é€ƒã’ãƒ­ã‚°ç”¨
    let escapeLog = [];

    // é€±é–“ã‚¿ã‚¹ã‚¯ç”¨ï¼ˆæ—¥ä»˜ã”ã¨ã®æ™‚é–“ä»˜ãã‚¿ã‚¹ã‚¯ï¼‰
    let weeklyTasks = {};
    // æ§‹é€ : { '2026-02-03': [{ text: 'ã‚¿ã‚¹ã‚¯', time: '09:00', completed: false }, ...], ... }

    // 1åˆ†ã‚¿ã‚¤ãƒãƒ¼ç”¨
    let timerState = 'idle'; // idle, thinking, imagine, writing, selecting, executing, complete, pomodoro, pomodoroBreak, pomodoroComplete
    let timeLeft = 60;
    let timerInterval = null;
    let selectedTaskText = null; // é¸æŠã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã®ãƒ†ã‚­ã‚¹ãƒˆ
    let pomodoroCount = 0; // ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã®ã‚»ãƒƒãƒˆæ•°ï¼ˆæœ€å¤§12ï¼‰

    // é€±é–“ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨
    let pendingScheduleTask = null; // { sectionNum, taskText }
    let selectedWeekday = null; // 0-6 (æœˆ-æ—¥)
    
    // é€±é–“ã‚¿ã‚¹ã‚¯ç·¨é›†ç”¨
    let editingTask = null; // { dateStr, index }
    let creatingTask = null; // { dateStr, hour }

    // æœˆé–“ãƒ“ãƒ¥ãƒ¼ç”¨
    let currentMonthDate = new Date(); // è¡¨ç¤ºä¸­ã®æœˆ
    let movingTaskId = null; // ã‚¹ãƒãƒ›ç”¨ï¼šç§»å‹•ä¸­ã®ã‚¿ã‚¹ã‚¯ID

    // é€±é–“ãƒ“ãƒ¥ãƒ¼ç”¨
    let currentWeekDate = new Date(); // è¡¨ç¤ºä¸­ã®é€±ã®åŸºæº–æ—¥

    // å¹´é–“ãƒ“ãƒ¥ãƒ¼ç”¨
    let currentYearDate = new Date(); // è¡¨ç¤ºä¸­ã®å¹´
    
    // æ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼ç”¨
    let currentDailyDate = null; // è¡¨ç¤ºä¸­ã®æ—¥ï¼ˆnullãªã‚‰ä»Šæ—¥ï¼‰

    // æ—¥æœ¬ã®ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ï¼ˆ2024-2027å¹´ï¼‰
    const japaneseHolidays = {
      // 2024å¹´
      '2024-01-01': 'å…ƒæ—¥',
      '2024-01-08': 'æˆäººã®æ—¥',
      '2024-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
      '2024-02-12': 'æŒ¯æ›¿ä¼‘æ—¥',
      '2024-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
      '2024-03-20': 'æ˜¥åˆ†ã®æ—¥',
      '2024-04-29': 'æ˜­å’Œã®æ—¥',
      '2024-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
      '2024-05-04': 'ã¿ã©ã‚Šã®æ—¥',
      '2024-05-05': 'ã“ã©ã‚‚ã®æ—¥',
      '2024-05-06': 'æŒ¯æ›¿ä¼‘æ—¥',
      '2024-07-15': 'æµ·ã®æ—¥',
      '2024-08-11': 'å±±ã®æ—¥',
      '2024-08-12': 'æŒ¯æ›¿ä¼‘æ—¥',
      '2024-09-16': 'æ•¬è€ã®æ—¥',
      '2024-09-22': 'ç§‹åˆ†ã®æ—¥',
      '2024-09-23': 'æŒ¯æ›¿ä¼‘æ—¥',
      '2024-10-14': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
      '2024-11-03': 'æ–‡åŒ–ã®æ—¥',
      '2024-11-04': 'æŒ¯æ›¿ä¼‘æ—¥',
      '2024-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
      // 2025å¹´
      '2025-01-01': 'å…ƒæ—¥',
      '2025-01-13': 'æˆäººã®æ—¥',
      '2025-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
      '2025-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
      '2025-02-24': 'æŒ¯æ›¿ä¼‘æ—¥',
      '2025-03-20': 'æ˜¥åˆ†ã®æ—¥',
      '2025-04-29': 'æ˜­å’Œã®æ—¥',
      '2025-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
      '2025-05-04': 'ã¿ã©ã‚Šã®æ—¥',
      '2025-05-05': 'ã“ã©ã‚‚ã®æ—¥',
      '2025-05-06': 'æŒ¯æ›¿ä¼‘æ—¥',
      '2025-07-21': 'æµ·ã®æ—¥',
      '2025-08-11': 'å±±ã®æ—¥',
      '2025-09-15': 'æ•¬è€ã®æ—¥',
      '2025-09-23': 'ç§‹åˆ†ã®æ—¥',
      '2025-10-13': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
      '2025-11-03': 'æ–‡åŒ–ã®æ—¥',
      '2025-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
      '2025-11-24': 'æŒ¯æ›¿ä¼‘æ—¥',
      // 2026å¹´
      '2026-01-01': 'å…ƒæ—¥',
      '2026-01-12': 'æˆäººã®æ—¥',
      '2026-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
      '2026-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
      '2026-03-20': 'æ˜¥åˆ†ã®æ—¥',
      '2026-04-29': 'æ˜­å’Œã®æ—¥',
      '2026-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
      '2026-05-04': 'ã¿ã©ã‚Šã®æ—¥',
      '2026-05-05': 'ã“ã©ã‚‚ã®æ—¥',
      '2026-05-06': 'æŒ¯æ›¿ä¼‘æ—¥',
      '2026-07-20': 'æµ·ã®æ—¥',
      '2026-08-11': 'å±±ã®æ—¥',
      '2026-09-21': 'æ•¬è€ã®æ—¥',
      '2026-09-22': 'å›½æ°‘ã®ä¼‘æ—¥',
      '2026-09-23': 'ç§‹åˆ†ã®æ—¥',
      '2026-10-12': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
      '2026-11-03': 'æ–‡åŒ–ã®æ—¥',
      '2026-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
      // 2027å¹´
      '2027-01-01': 'å…ƒæ—¥',
      '2027-01-11': 'æˆäººã®æ—¥',
      '2027-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
      '2027-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
      '2027-03-21': 'æ˜¥åˆ†ã®æ—¥',
      '2027-03-22': 'æŒ¯æ›¿ä¼‘æ—¥',
      '2027-04-29': 'æ˜­å’Œã®æ—¥',
      '2027-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
      '2027-05-04': 'ã¿ã©ã‚Šã®æ—¥',
      '2027-05-05': 'ã“ã©ã‚‚ã®æ—¥',
      '2027-07-19': 'æµ·ã®æ—¥',
      '2027-08-11': 'å±±ã®æ—¥',
      '2027-09-20': 'æ•¬è€ã®æ—¥',
      '2027-09-23': 'ç§‹åˆ†ã®æ—¥',
      '2027-10-11': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
      '2027-11-03': 'æ–‡åŒ–ã®æ—¥',
      '2027-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥'
    };

    function getHoliday(dateStr) {
      return japaneseHolidays[dateStr] || null;
    }

    // ===== ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆSingle Source of Truthï¼‰ =====
    /**
     * allTasks: å…¨ã‚¿ã‚¹ã‚¯ã®å”¯ä¸€ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
     * 
     * è¨­è¨ˆæ€æƒ³ï¼š
     * - 1ã¤ã®ã‚¿ã‚¹ã‚¯ã¯1ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ç®¡ç†
     * - è¡¨ç¤ºãƒ•ãƒ©ã‚°ã§ã€Œã©ã®ãƒ“ãƒ¥ãƒ¼ã«è¡¨ç¤ºã™ã‚‹ã‹ã€ã‚’åˆ¶å¾¡
     * - ãƒ‡ãƒ¼ã‚¿é‡è¤‡ã‚’å®Œå…¨ã«æ’é™¤
     * - åŒæ–¹å‘åŒæœŸã‚’è‡ªå‹•çš„ã«å®Ÿç¾
     * 
     * ãƒ¡ãƒªãƒƒãƒˆï¼š
     * 1. ç·¨é›†ãƒ»å‰Šé™¤ãŒç¢ºå®Ÿã«å…¨ãƒ“ãƒ¥ãƒ¼ã«åæ˜ ã•ã‚Œã‚‹
     * 2. ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆãŒç™ºç”Ÿã—ãªã„
     * 3. æ–°ã—ã„ãƒ“ãƒ¥ãƒ¼è¿½åŠ ãŒå®¹æ˜“ï¼ˆãƒ•ãƒ©ã‚°è¿½åŠ ã ã‘ï¼‰
     * 4. ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒ1ç®‡æ‰€ï¼‰
     * 
     * IDç®¡ç†ï¼š
     * - UUID v4ã‚’ä½¿ç”¨ï¼ˆRFC 4122æº–æ‹ ï¼‰
     * - 128ãƒ“ãƒƒãƒˆã®ä¸€æ„è­˜åˆ¥å­
     * - è¡çªç¢ºç‡: å®Ÿè³ªã‚¼ãƒ­ï¼ˆ10^-15ï¼‰
     * - è¤‡æ•°ã‚¿ãƒ–ãƒ»è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹ã§ã‚‚å®‰å…¨
     * - å¯Œå£«é€šã‚¸ãƒ£ãƒ‘ãƒ³ã®ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰å•é¡Œã‚’å›é¿
     * 
     * ãƒ“ãƒ¥ãƒ¼åˆ¥ãƒ•ãƒ©ã‚°ã®ä½¿ã„æ–¹ï¼š
     * - showInDaily: æ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼ã«è¡¨ç¤º
     * - showInWeekly: é€±é–“ãƒãƒ¼ãƒã‚«ãƒ«ã«è¡¨ç¤º
     * 
     * æ³¨æ„ï¼š
     * - æœˆé–“/å¹´é–“ãƒ“ãƒ¥ãƒ¼ã¯dateãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ç›´æ¥ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆãƒ•ãƒ©ã‚°ä¸è¦ï¼‰
     */
    let allTasks = []; // å…¨ã‚¿ã‚¹ã‚¯ã®å”¯ä¸€ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
    let taskIdCounter = 1; // äº’æ›æ€§ã®ãŸã‚ä¿æŒï¼ˆå®Ÿéš›ã¯UUIDã‚’ä½¿ç”¨ï¼‰

    // åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿54ä»¶ - å¤§å­¦3å¹´ç”Ÿãƒ»ãƒãƒƒã‚¯ãƒã‚¤ãƒˆãƒ»å½¼æ°ã‚ã‚Šï¼‰
    const INITIAL_DATA = [{"id":"58c3b5d3-3dab-468e-b94d-644ad8ff2b67","text":"ç†±åŠ›å­¦ã®å®¿é¡Œ","date":"2026-02-09","time":"10:00","section":1,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"6db44052-8f93-481c-bd68-9d62ded414c0","text":"ãŠã°ã‚ã¡ã‚ƒã‚“å®¶ æ§˜å­è¦‹","date":"2026-02-09","time":"14:00","section":1,"order":1,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"965653ab-a245-461f-99a5-efe137002ab4","text":"ã‚ã—","date":"2026-02-09","time":"12:00","section":2,"order":0,"completed":true,"showInDaily":true,"showInWeekly":true},{"id":"01bf2de0-1d4f-493b-a62e-ce52f255ea16","text":"æ´—æ¿¯","date":"2026-02-09","time":"09:00","section":2,"order":1,"completed":true,"showInDaily":true,"showInWeekly":true},{"id":"3c916322-2347-43ff-ace2-f284d0b60c1f","text":"LINEè¿”ã™","date":"2026-02-09","time":"20:00","section":3,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"5b60a61c-803c-42d1-9208-15e500884b35","text":"Netflix","date":"2026-02-09","time":"22:00","section":4,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"54267021-2c61-43f1-b554-be7f01f41a30","text":"ææ–™åŠ›å­¦ 2é™","date":"2026-02-10","time":"10:30","section":2,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"6b698034-60d9-4825-a2e2-86a0681a676f","text":"ç†±åŠ›å­¦ãƒ¬ãƒãƒ¼ãƒˆæå‡º","date":"2026-02-10","time":"23:59","section":1,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"d2b7ce67-23e0-42f5-84b2-7f9126258398","text":"ãƒãƒƒã‚¯ 17:00-22:00","date":"2026-02-10","time":"17:00","section":2,"order":1,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"36612121-39ac-4d7c-b0cf-6c310a6e9045","text":"æ–°äººãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° ä½è—¤ã•ã‚“","date":"2026-02-10","time":"18:00","section":1,"order":1,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"68e1d1ea-89e1-4552-bde9-305d3544d0f1","text":"ã‚ã—","date":"2026-02-10","time":"12:00","section":2,"order":2,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"2a6a6f00-8bae-41c8-8421-499cdf0fcf7c","text":"ãŠã°ã‚ã¡ã‚ƒã‚“ç—…é™¢ä»˜ãæ·»ã„ æ¨ªæµœå¸‚å¤§","date":"2026-02-11","time":"10:00","section":1,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"2d5d4e32-05aa-4d42-bcc2-1111ecc31761","text":"ã‚±ã‚¢ãƒãƒã•ã‚“é›»è©±","date":"2026-02-11","time":"15:00","section":1,"order":1,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"8369e595-04d8-4ef5-849b-b3b8e1c28f7e","text":"è–¬å±€ å‡¦æ–¹ç®‹","date":"2026-02-11","time":"12:00","section":2,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"e24e5245-7517-46ca-81d8-b9d2e9ddf8ea","text":"éƒ¨å±‹æƒé™¤","date":"2026-02-11","time":"16:00","section":4,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"42e13b28-a103-4b20-a755-647a405a7f64","text":"ç ”ç©¶å®¤ã‚¼ãƒŸ ç™ºè¡¨","date":"2026-02-12","time":"14:00","section":1,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"35fbff5f-bd46-4579-81f7-f6a8405590ba","text":"ã‚¼ãƒŸç™ºè¡¨ã‚¹ãƒ©ã‚¤ãƒ‰æœ€çµ‚ç¢ºèª","date":"2026-02-12","time":"09:00","section":1,"order":1,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"28bc4e34-dd30-4486-95bd-7a4ffd509d1c","text":"ãƒãƒƒã‚¯ 17:00-21:00","date":"2026-02-12","time":"17:00","section":2,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"b6435ad1-fb20-4a17-9a50-295d6360eb63","text":"ã‚ã—","date":"2026-02-12","time":"12:00","section":2,"order":1,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"a2169fc7-43f3-4b7b-9f07-858263188232","text":"ãƒã‚¤ãƒˆã‚°ãƒ«ãƒ¼ãƒ—LINEç¢ºèª","date":"2026-02-12","time":"22:00","section":3,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"65106b5a-1a3a-4552-b4f4-e45f7928764e","text":"æµä½“åŠ›å­¦ 3é™","date":"2026-02-13","time":"13:00","section":2,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"3d883e67-e613-4da8-880e-9a2d7f2f4d23","text":"å‹é”ã¨ã‚«ãƒ©ã‚ªã‚± ã¾ã­ãã­ã“æ¨ªæµœè¥¿å£","date":"2026-02-13","time":"19:00","section":2,"order":1,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"9fce656c-2605-4787-9c72-95eb7a1b8180","text":"ã‚†ã†ã‹ã«èª•ãƒ—ãƒ¬æ¸¡ã™","date":"2026-02-13","time":"19:00","section":1,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"30cc43fb-6da3-4bdd-beec-d10ed873d179","text":"ã‚ã—","date":"2026-02-13","time":"12:00","section":2,"order":2,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"f9061ff5-b090-4a82-b5b0-508dafe7024f","text":"ç¿”å¤ªã¨æ¨ªæµœãƒ‡ãƒ¼ãƒˆ","date":"2026-02-14","time":"11:00","section":2,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"95040bd3-e274-4732-8f67-8aa6e5990e8f","text":"bills æ¨ªæµœèµ¤ãƒ¬ãƒ³ã‚¬ ãƒ©ãƒ³ãƒ","date":"2026-02-14","time":"12:00","section":2,"order":1,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"93f82bee-882b-4229-912d-3fec6f116767","text":"ãƒãƒ§ã‚³æ¸¡ã™","date":"2026-02-14","time":"15:00","section":1,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"6808e0e0-2c91-4fc7-a7a7-2489bc403817","text":"MARINE & WALK æ•£æ­©","date":"2026-02-14","time":"14:00","section":2,"order":2,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"6cdf43d6-c0e1-47ab-a959-9bed00d9c534","text":"ã‚¢ãƒ‹ãƒ´ã‚§ãƒ«ã‚»ãƒ« ã¿ãªã¨ã¿ã‚‰ã„ ãƒ‡ã‚£ãƒŠãƒ¼äºˆç´„æ¸ˆ","date":"2026-02-14","time":"18:00","section":2,"order":3,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"e0edd106-3c1a-4a2f-b5e4-64f909196648","text":"ã‚ã„ã¿ã‚‡ã‚“ ãƒ©ã‚¤ãƒ– æ¨ªæµœã‚¢ãƒªãƒ¼ãƒŠ","date":"2026-02-15","time":"17:00","section":2,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"ed802d46-1e6f-4e8e-85ab-42448c30ec94","text":"AFLOAT æ¨ªæµœ ã‚«ãƒƒãƒˆäºˆç´„","date":"2026-02-15","time":"11:00","section":2,"order":1,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"0b620f74-5f5d-43c1-a8fb-19e74ee67f63","text":"ãƒ©ã‚¤ãƒ–å‰ã«ã¿ã•ãã¨åˆæµ","date":"2026-02-15","time":"15:00","section":2,"order":2,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"63fd2b42-077b-4de0-baaf-39ac7548ca32","text":"ã‚ã—","date":"2026-02-15","time":"13:00","section":2,"order":3,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"69dd6d27-c23a-4bf3-92d3-cf0afa32d108","text":"ãŠæ¯ã•ã‚“èª•ç”Ÿæ—¥","date":"2026-02-16","time":"12:00","section":1,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"43704123-24b9-4914-94c2-4a0c9e270749","text":"å®Ÿå®¶å¸°ã‚‹","date":"2026-02-16","time":"11:00","section":2,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"b73e666c-e5f0-476e-b8dc-d53294d18467","text":"ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ ãƒ«ãƒŸãƒã§è²·ã†","date":"2026-02-16","time":"10:00","section":1,"order":1,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"fd196cc7-7214-4d1a-b97c-44a3aadd48c8","text":"å¦¹ã®å¡¾é€ã‚Š","date":"2026-02-16","time":"17:00","section":3,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"21f7fa53-d2d2-46a5-ad8b-ad1c86ac61b1","text":"ãƒãƒƒã‚¯ 10:00-15:00","date":"2026-02-17","time":"10:00","section":2,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"2a5f452a-811a-4cca-bccd-f6c8edf600fa","text":"åˆ¶å¾¡å·¥å­¦ 4é™","date":"2026-02-17","time":"14:30","section":2,"order":1,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"ef02a42d-fbe5-4cdc-abbc-5bea28d64499","text":"å±¥ä¿®ç™»éŒ²ç¢ºèª","date":"2026-02-17","time":"20:00","section":3,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"9d8453d3-7a58-4868-b83a-b5e0a935907f","text":"åº—é•·MTG ã‚·ãƒ•ãƒˆèª¿æ•´","date":"2026-02-19","time":"16:00","section":1,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"2f071eb8-fe0e-4757-8eb3-3fd3bed88271","text":"ãƒãƒƒã‚¯ 17:00-22:00","date":"2026-02-19","time":"17:00","section":2,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"fcc7da9e-dfa7-4c61-92ff-9f866ac3b198","text":"EXILE ãƒ©ã‚¤ãƒ– æ±äº¬ãƒ‰ãƒ¼ãƒ ","date":"2026-02-22","time":"16:00","section":2,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"7fe096fd-18e3-4b76-97fb-d45e1b47f8ee","text":"å‹é”ã¨ç¾åœ°é›†åˆ 14:30","date":"2026-02-22","time":"14:30","section":2,"order":1,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"24a1969e-302d-4631-9557-5ea289c957a1","text":"å®¶è³ƒæ”¯æ‰•æ—¥","date":"2026-02-27","time":"09:00","section":1,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"cefc7416-bd08-42cd-bb43-a9a93b7775b4","text":"ãŠã°ã‚ã¡ã‚ƒã‚“ æœˆ1é€šé™¢","date":"2026-02-27","time":"10:00","section":1,"order":1,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"4726c52b-6145-40de-a6ce-7c81a4e1159a","text":"ã‚¼ãƒŸä¸­é–“ç™ºè¡¨","date":"2026-03-12","time":"14:00","section":1,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"487ab703-72be-4fd7-ace4-cdf3251f08d7","text":"ç¿”å¤ª èª•ç”Ÿæ—¥","date":"2026-03-21","time":"18:00","section":1,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"975c669a-5d59-4ab6-b6ae-8353bd427791","text":"æ˜¥ä¼‘ã¿æ—…è¡Œ äº¬éƒ½ è¨ˆç”»","date":"2026-03-25","time":"10:00","section":2,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"1d5e68b8-87d9-40a1-8eeb-2542ff87d270","text":"æ–°å­¦æœŸã‚¬ã‚¤ãƒ€ãƒ³ã‚¹","date":"2026-04-01","time":"10:00","section":1,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"43a651ce-eb2a-4390-b6a1-5bebf9dd7451","text":"è–¬é£²ã‚€","date":"2026-02-09","time":null,"section":2,"order":99,"completed":false,"showInDaily":true,"showInWeekly":false},{"id":"fe60d6cb-131f-421b-8372-304505a9eb98","text":"æ—¥è¨˜æ›¸ã","date":"2026-02-09","time":null,"section":4,"order":99,"completed":false,"showInDaily":true,"showInWeekly":false},{"id":"ddfec598-b81c-4999-9aef-aab86bda0eba","text":"æ•™ç§‘æ›¸ ç”Ÿå”ã§è²·ã†","date":"2026-02-10","time":null,"section":3,"order":0,"completed":false,"showInDaily":true,"showInWeekly":true},{"id":"740c0b4a-fe72-4369-b494-a3746de1f102","text":"ãƒ¡ãƒ«ã‚«ãƒªå‡ºå“ å†¬æœ","date":"2026-02-11","time":null,"section":4,"order":1,"completed":false,"showInDaily":true,"showInWeekly":true}];
    const INITIAL_PURPOSE = "ç†±åŠ›å­¦ãƒ¬ãƒãƒ¼ãƒˆæå‡ºã™ã‚‹";
    const INITIAL_STOP_CONDITION = "çµ‚ã‚ã‚‹ã¾ã§å¯ãªã„ã€‚ãŸã ã—2æ™‚ã§å¼·åˆ¶çµ‚äº†ã€‚";

    /**
     * IDç”Ÿæˆé–¢æ•°ï¼ˆUUID v4ï¼‰
     * 
     * RFC 4122æº–æ‹ ã®UUID v4ã‚’ç”Ÿæˆ
     * - 128ãƒ“ãƒƒãƒˆã®ä¸€æ„è­˜åˆ¥å­
     * - è¡çªç¢ºç‡: 10^-15ï¼ˆå®Ÿè³ªã‚¼ãƒ­ï¼‰
     * - è¤‡æ•°ã‚¿ãƒ–ãƒ»è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹ã§ã‚‚å®‰å…¨
     * 
     * å½¢å¼: xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx
     * - x: 0-9, a-f ã®ãƒ©ãƒ³ãƒ€ãƒ å€¤
     * - 4: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ï¼ˆv4ï¼‰
     * - y: 8, 9, a, b ã®ã„ãšã‚Œã‹ï¼ˆvariant bitsï¼‰
     * 
     * ä¾‹: "a3bb189e-8bf9-4d32-9c51-2d3e6f8b4a7c"
     * 
     * å‚è€ƒï¼šå¯Œå£«é€šã‚¸ãƒ£ãƒ‘ãƒ³ã®ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰å•é¡Œï¼ˆ2023å¹´ï¼‰
     * - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ™ãƒ¼ã‚¹ã®IDã§è¡çªãŒç™ºç”Ÿ
     * - UUIDãªã‚‰å®Œå…¨ã«é˜²æ­¢å¯èƒ½
     */
    function generateTaskId() {
      // UUID v4ç”Ÿæˆï¼ˆcrypto.randomUUID()ãŒä½¿ãˆãªã„ç’°å¢ƒç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å«ã‚€ï¼‰
      if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        // ãƒ¢ãƒ€ãƒ³ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆChrome 92+, Firefox 95+, Safari 15.4+ï¼‰
        return crypto.randomUUID();
      } else {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…ï¼ˆå¤ã„ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œï¼‰
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          const r = Math.random() * 16 | 0;
          const v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }
    }

    // ã‚¿ã‚¹ã‚¯ä½œæˆ
    /**
     * ã‚¿ã‚¹ã‚¯ä½œæˆ
     * 
     * @param {string} text - ã‚¿ã‚¹ã‚¯ã®ãƒ†ã‚­ã‚¹ãƒˆ
     * @param {string} date - åŸºæº–æ—¥ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
     *                        é€±é–“/æœˆæ¬¡/å¹´æ¬¡ã‚¿ã‚¹ã‚¯ï¼šãã®æ—¥ä»˜ã«è¡¨ç¤º
     *                        æ—¥æ¬¡ã‚¿ã‚¹ã‚¯ï¼šä½œæˆæ—¥ï¼ˆå‚ç…§ç”¨ã€æ—¥æ¬¡è¡¨ç¤ºã«ã¯ä½¿ã‚ãªã„ï¼‰
     * @param {string|null} time - æ™‚åˆ»ï¼ˆHH:MMå½¢å¼ï¼‰ã€‚nullã®å ´åˆã¯çµ‚æ—¥ã‚¿ã‚¹ã‚¯
     * @param {number} section - è±¡é™ï¼ˆ1-4ï¼‰
     *                           1: ç·Šæ€¥ã‹ã¤é‡è¦ï¼ˆèµ¤ï¼‰
     *                           2: ç·Šæ€¥ã ãŒé‡è¦ã§ãªã„ï¼ˆç·‘ï¼‰
     *                           3: é‡è¦ã ãŒç·Šæ€¥ã§ãªã„ï¼ˆé»„ï¼‰
     *                           4: ç·Šæ€¥ã§ã‚‚é‡è¦ã§ã‚‚ãªã„ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰
     * @param {boolean} showInDaily - æ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼ã«è¡¨ç¤ºã™ã‚‹ã‹
     * @param {boolean} showInWeekly - é€±é–“ãƒ“ãƒ¥ãƒ¼ã«è¡¨ç¤ºã™ã‚‹ã‹
     * @returns {object} ä½œæˆã•ã‚ŒãŸã‚¿ã‚¹ã‚¯
     * 
     * ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼š
     * {
     *   id: string,           // UUID v4ï¼ˆä¾‹: "a3bb189e-8bf9-4d32-9c51-2d3e6f8b4a7c"ï¼‰
     *   text: string,         // ã‚¿ã‚¹ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ
     *   date: string,         // åŸºæº–æ—¥ï¼ˆYYYY-MM-DDï¼‰
     *   time: string|null,    // æ™‚åˆ»ï¼ˆHH:MMï¼‰ã¾ãŸã¯ null
     *   section: number,      // è±¡é™ï¼ˆ1-4ï¼‰
     *   completed: boolean,   // å®Œäº†ãƒ•ãƒ©ã‚°
     *   showInDaily: boolean,   // æ—¥æ¬¡è¡¨ç¤ºãƒ•ãƒ©ã‚°
     *   showInWeekly: boolean,  // é€±é–“è¡¨ç¤ºãƒ•ãƒ©ã‚°
     *   createdAt: string,    // ä½œæˆæ—¥æ™‚ï¼ˆISO 8601å½¢å¼ï¼‰
     *   updatedAt: string     // æ›´æ–°æ—¥æ™‚ï¼ˆISO 8601å½¢å¼ï¼‰
     * }
     * 
     * ä½¿ç”¨ä¾‹ï¼š
     * - æ—¥æ¬¡ã‚¿ã‚¹ã‚¯ä½œæˆ: createTask("ä¼šè­°", today, null, 1, true, false)
     * - é€±é–“ã‚¿ã‚¹ã‚¯ä½œæˆ: createTask("ä¼šè­°", "2026-02-05", "09:00", 1, false, true)
     * - æ—¥æ¬¡ï¼‹é€±é–“: createTask("ä¼šè­°", "2026-02-05", "09:00", 1, true, true)
     */
    function createTask(text, date, time, section, showInDaily = true, showInWeekly = false) {
      // åŒã˜æ—¥ãƒ»åŒã˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æœ€å¤§orderã‚’å–å¾—
      const sameGroupTasks = allTasks.filter(t => t.date === date && t.section === section);
      const maxOrder = sameGroupTasks.length > 0 
        ? Math.max(...sameGroupTasks.map(t => t.order || 0)) + 1 
        : 0;
      
      const task = {
        id: generateTaskId(),
        kind: 'task',
        text: text,
        memo: null,
        date: date,
        time: time || null,
        section: section,
        order: maxOrder,
        completed: false,
        showInDaily: showInDaily,
        showInWeekly: showInWeekly,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      allTasks.push(task);
      saveAllTasks();
      return task;
    }

    // ã‚¿ã‚¹ã‚¯æ›´æ–°
    function updateTask(id, updates) {
      const task = allTasks.find(t => t.id === id);
      if (task) {
        Object.assign(task, updates, {
          updatedAt: new Date().toISOString()
        });
        saveAllTasks();
        return task;
      }
      return null;
    }

    // ã‚¿ã‚¹ã‚¯å‰Šé™¤
    // ã‚¿ã‚¹ã‚¯å‰Šé™¤ï¼ˆãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ï¼‰
    function removeTaskFromMaster(id) {
      const index = allTasks.findIndex(t => t.id === id);
      if (index !== -1) {
        allTasks.splice(index, 1);
        saveAllTasks();
        return true;
      }
      return false;
    }

    /**
     * æ—¥æ¬¡ã‚¿ã‚¹ã‚¯å–å¾—
     * 
     * @param {string} date - å¯¾è±¡æ—¥ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
     * @returns {object} è±¡é™åˆ¥ã‚¿ã‚¹ã‚¯é…åˆ— { 1: [...], 2: [...], 3: [...], 4: [...] }
     * 
     * ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ï¼š
     * - showInDaily === trueï¼ˆæ—¥æ¬¡è¡¨ç¤ºãƒ•ãƒ©ã‚°ãŒONï¼‰
     * - ã‹ã¤ä»¥ä¸‹ã®ã„ãšã‚Œã‹ï¼š
     *   1. showInWeekly === falseï¼ˆæ—¥æ¬¡å°‚ç”¨ã‚¿ã‚¹ã‚¯ï¼‰â†’ å¸¸ã«è¡¨ç¤º
     *   2. showInWeekly === trueï¼ˆä¸¡æ–¹å¯¾å¿œã‚¿ã‚¹ã‚¯ï¼‰â†’ ãã®æ—¥ã ã‘è¡¨ç¤ºï¼ˆdateä¸€è‡´ï¼‰
     * 
     * ãƒ­ã‚¸ãƒƒã‚¯èª¬æ˜ï¼š
     * - æ—¥æ¬¡å°‚ç”¨ã‚¿ã‚¹ã‚¯ï¼ˆshowInWeekly: falseï¼‰: æ—¥ä»˜ã«é–¢ä¿‚ãªãå¸¸ã«æ—¥æ¬¡ã«è¡¨ç¤º
     *   ä¾‹ï¼šã€Œãƒ¡ãƒ¼ãƒ«ç¢ºèªã€ã€Œæ—¥å ±æ›¸ãã€ãªã©æ—¥ã€…ã®ãƒ«ãƒ¼ãƒãƒ³
     * - é€±é–“ã‚‚å¯¾å¿œï¼ˆshowInWeekly: trueï¼‰: ãã®æ—¥ä»˜ã ã‘æ—¥æ¬¡ã«è¡¨ç¤º
     *   ä¾‹ï¼šã€Œ2/5 ä¼šè­°ã€ã¯2/5ã®æ—¥æ¬¡ã«ã®ã¿è¡¨ç¤º
     * 
     * ä½¿ã„åˆ†ã‘ï¼š
     * - æ—¥æ¬¡ã§ã‚¿ã‚¹ã‚¯ä½œæˆ â†’ showInWeekly: false â†’ æ¯æ—¥è¡¨ç¤º
     * - é€±é–“ã§ã‚¿ã‚¹ã‚¯ä½œæˆ â†’ showInWeekly: true â†’ ãã®æ—¥ã ã‘è¡¨ç¤º
     * - ğŸ“…ãƒœã‚¿ãƒ³ã§é€±é–“è¿½åŠ  â†’ showInWeekly: true â†’ ãã®æ—¥ã ã‘è¡¨ç¤º
     */
    function getDailyTasks(date) {
      const result = { 1: [], 2: [], 3: [], 4: [] };
      
      
      allTasks
        .filter(t => {
          // showInDailyãŒfalseãªã‚‰é™¤å¤–
          if (!t.showInDaily) return false;
          
          // æ—¥æ¬¡å°‚ç”¨ã‚¿ã‚¹ã‚¯ï¼ˆé€±é–“éå¯¾å¿œï¼‰â†’ å¸¸ã«è¡¨ç¤º
          if (!t.showInWeekly) {
            return true;
          }
          
          // é€±é–“ã‚‚å¯¾å¿œ â†’ ãã®æ—¥ã ã‘è¡¨ç¤º
          const match = (t.date === date);
          return match;
        })
        .forEach(t => {
          if (result[t.section]) {
            result[t.section].push(t);
          }
        });
      
      // å„è±¡é™ã‚’orderé †ã«ã‚½ãƒ¼ãƒˆï¼ˆorderãŒãªã‘ã‚Œã°0æ‰±ã„ï¼‰
      for (let sec = 1; sec <= 4; sec++) {
        result[sec].sort((a, b) => (a.order || 0) - (b.order || 0));
      }
      
      
      return result;
    }

    /**
     * é€±é–“ã‚¿ã‚¹ã‚¯å–å¾—
     * 
     * @param {string} startDate - é€±ã®é–‹å§‹æ—¥ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
     * @param {string} endDate - é€±ã®çµ‚äº†æ—¥ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
     * @returns {array} ã‚¿ã‚¹ã‚¯é…åˆ—
     * 
     * ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ï¼š
     * - showInWeekly === trueï¼ˆé€±é–“è¡¨ç¤ºãƒ•ãƒ©ã‚°ãŒONï¼‰
     * - time !== nullï¼ˆæ™‚åˆ»ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ï¼‰
     * - date ãŒ startDateã€œendDate ã®ç¯„å›²å†…
     * 
     * æ³¨æ„ï¼š
     * - é€±é–“ãƒ“ãƒ¥ãƒ¼ã¯æ™‚åˆ»ä»˜ãã‚¿ã‚¹ã‚¯ã®ã¿è¡¨ç¤ºï¼ˆãƒãƒ¼ãƒã‚«ãƒ«å½¢å¼ã®ãŸã‚ï¼‰
     * - çµ‚æ—¥ã‚¿ã‚¹ã‚¯ï¼ˆtime: nullï¼‰ã¯è¡¨ç¤ºã•ã‚Œãªã„
     */
    function getWeeklyTasks(startDate, endDate) {
      return allTasks
        .filter(t => t.showInWeekly && t.time && t.date >= startDate && t.date <= endDate)
        .sort((a, b) => {
          // ã¾ãšæ—¥ä»˜é †
          if (a.date !== b.date) return a.date.localeCompare(b.date);
          // åŒã˜æ—¥ãªã‚‰æ™‚é–“é †
          if (a.time !== b.time) return a.time.localeCompare(b.time);
          // åŒã˜æ™‚é–“ãªã‚‰orderé †
          return (a.order || 0) - (b.order || 0);
        });
    }

    // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    function saveAllTasks() {
      localStorage.setItem('allTasks', JSON.stringify(allTasks));
      localStorage.setItem('taskIdCounter', taskIdCounter.toString());
    }

    // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadAllTasks() {
      const saved = localStorage.getItem('allTasks');
      if (saved) {
        try {
          allTasks = JSON.parse(saved);
          const savedCounter = localStorage.getItem('taskIdCounter');
          if (savedCounter) {
            taskIdCounter = parseInt(savedCounter);
          }
          
          // ãƒ‡ãƒ¼ã‚¿ãŒç©ºé…åˆ—ã®å ´åˆã‚‚åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
          if (allTasks.length === 0 && INITIAL_DATA && INITIAL_DATA.length > 0) {
            allTasks = INITIAL_DATA;
            saveAllTasks();
            if (INITIAL_PURPOSE) {
              localStorage.setItem('purpose', INITIAL_PURPOSE);
            }
            if (INITIAL_STOP_CONDITION) {
              localStorage.setItem('stopCondition', INITIAL_STOP_CONDITION);
            }
            return;
          }
          
          // orderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„ã‚¿ã‚¹ã‚¯ã«åˆæœŸå€¤ã‚’ä»˜ä¸ï¼ˆv9.6ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
          const orderMigrationDone = localStorage.getItem('orderMigrationDone_v96');
          if (!orderMigrationDone) {
            // æ—¥ä»˜+ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦orderã‚’ä»˜ä¸
            const groups = {};
            allTasks.forEach(task => {
              const key = `${task.date}_${task.section}`;
              if (!groups[key]) groups[key] = [];
              groups[key].push(task);
            });
            
            let fixedCount = 0;
            Object.values(groups).forEach(tasks => {
              // æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆ
              tasks.sort((a, b) => (a.time || '99:99').localeCompare(b.time || '99:99'));
              tasks.forEach((task, idx) => {
                if (task.order === undefined) {
                  task.order = idx;
                  fixedCount++;
                }
              });
            });
            
            if (fixedCount > 0) {
              saveAllTasks();
            }
            localStorage.setItem('orderMigrationDone_v96', 'true');
          }
          
          // ãƒ‡ãƒ¼ã‚¿ä¿®æ­£ï¼šé€±é–“ã‚¿ã‚¹ã‚¯ï¼ˆshowInWeekly: trueï¼‰ã§showInDailyãŒfalseãªã‚‰ä¿®æ­£
          const migrationDone = localStorage.getItem('showInDailyMigrationDone_v1');
          if (!migrationDone) {
            let fixedCount = 0;
            allTasks.forEach(task => {
              if (task.time && task.showInWeekly && !task.showInDaily) {
                task.showInDaily = true;
                fixedCount++;
              }
            });
            
            if (fixedCount > 0) {
              saveAllTasks();
            }
            
            localStorage.setItem('showInDailyMigrationDone_v1', 'true');
          }
          
          // memoãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„ã‚¿ã‚¹ã‚¯ã«åˆæœŸå€¤ã‚’ä»˜ä¸ï¼ˆv9.7ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
          const memoMigrationDone = localStorage.getItem('memoMigrationDone_v97');
          if (!memoMigrationDone) {
            let fixedCount = 0;
            allTasks.forEach(task => {
              if (task.memo === undefined) {
                task.memo = null;
                fixedCount++;
              }
            });
            
            if (fixedCount > 0) {
              saveAllTasks();
            }
            localStorage.setItem('memoMigrationDone_v97', 'true');
          }
        } catch (e) {
          console.error('Failed to load allTasks:', e);
          allTasks = [];
        }
      }
      
      // LocalStorageã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã€ã¾ãŸã¯ç©ºã®å ´åˆã¯åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
      if (allTasks.length === 0 && INITIAL_DATA && INITIAL_DATA.length > 0) {
        allTasks = INITIAL_DATA;
        saveAllTasks();
        
        if (INITIAL_PURPOSE) {
          localStorage.setItem('purpose', INITIAL_PURPOSE);
        }
        if (INITIAL_STOP_CONDITION) {
          localStorage.setItem('stopCondition', INITIAL_STOP_CONDITION);
        }
      }
    }

    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œ
    function migrateToMasterData() {
      // æ—¢ã«ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ç§»è¡Œã—ãªã„
      if (allTasks.length > 0) return;
      
      const today = getLocalDateStr(new Date());
      const migrated = [];
      
      // æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œ
      for (let sec = 1; sec <= 4; sec++) {
        if (tasks[sec]) {
          tasks[sec].forEach(oldTask => {
            // "11:30 ã‚¿ã‚¹ã‚¯" å½¢å¼ã‚’åˆ†è§£
            const match = oldTask.text.match(/^(\d{2}:\d{2})\s+(.+)$/);
            const time = match ? match[1] : null;
            const text = match ? match[2] : oldTask.text;
            
            migrated.push({
              id: generateTaskId(),
              text: text,
              date: today,
              time: time,
              section: sec,
              completed: oldTask.completed || false,
              showInDaily: true,
              showInWeekly: false,
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString()
            });
          });
        }
      }
      
      // é€±é–“ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œ
      if (weeklyTasks) {
        Object.keys(weeklyTasks).forEach(dateStr => {
          weeklyTasks[dateStr].forEach(oldTask => {
            // æ—¢ã«æ—¥æ¬¡ã§ç§»è¡Œæ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
            const exists = migrated.some(t => 
              t.date === dateStr && 
              t.text === oldTask.text && 
              t.time === oldTask.time
            );
            
            if (!exists) {
              migrated.push({
                id: generateTaskId(),
                text: oldTask.text,
                date: dateStr,
                time: oldTask.time,
                section: 1, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è±¡é™1
                completed: oldTask.completed || false,
                showInDaily: false,
                showInWeekly: true,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
              });
            }
          });
        });
      }
      
      allTasks = migrated;
      saveAllTasks();
    }

    // æ—¥ä»˜è¡¨ç¤º
    function updateDate() {
      const now = new Date();
      const weekday = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const dateStr = now.toLocaleDateString('ja-JP') + 'ï¼ˆ' + weekday[now.getDay()] + 'ï¼‰';
      document.getElementById('dateDisplay').textContent = dateStr;
      // ã‚¹ãƒãƒ›ç”¨ã®ç¬¬1è±¡é™æ—¥ä»˜ã‚‚åŒæœŸ
      const mobileDate = document.getElementById('dateDisplayMobile');
      if (mobileDate) mobileDate.textContent = dateStr;
    }

    // ç›®çš„ã®ç¢ºå®š
    function confirmPurpose() {
      const input = document.getElementById('purposeInput');
      if (input.value.trim()) {
        purpose = input.value.trim();
        purposeConfirmed = true;
        document.getElementById('purposeGroup').style.display = 'none';
        document.getElementById('purposeDisplay').style.display = 'flex';
        document.getElementById('purposeText').textContent = 'ç›®çš„: ' + purpose;
        
        // ç›®çš„ã‚’localStorageã«ä¿å­˜
        localStorage.setItem('purpose', purpose);
        localStorage.setItem('purposeConfirmed', 'true');
        
        // ç¢ºå®šå¾Œã€5ç§’ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ â†’ ã‚¤ãƒ¡ãƒ¼ã‚¸é–‹å§‹
        const timerBtn = document.getElementById('timerBtn');
        if (timerBtn) {
          timerState = 'countdown'; // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³çŠ¶æ…‹ã«å¤‰æ›´
          
          // å…ˆã«ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®åˆæœŸå€¤ã‚’è¨­å®šã—ã¦ã‹ã‚‰è¡¨ç¤º
          let countdown = 5;
          timerBtn.textContent = countdown;
          timerBtn.style.backgroundColor = '#3b82f6';
          timerBtn.style.fontSize = '1.5em';
          timerBtn.style.display = 'inline-flex'; // ã“ã‚Œã§ã€Œ5ã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹
          
          countdown--;
          
          const countdownInterval = setInterval(() => {
            if (countdown > 0) {
              timerBtn.textContent = countdown;
              timerBtn.style.backgroundColor = '#3b82f6';
              countdown--;
            } else {
              timerBtn.textContent = 'é–‹å§‹ï¼';
              timerBtn.style.backgroundColor = '#22c55e';
              timerBtn.style.fontSize = '1em';
              clearInterval(countdownInterval);
              
              // 1ç§’å¾Œã«ã‚¤ãƒ¡ãƒ¼ã‚¸é–‹å§‹
              setTimeout(() => {
                timerBtn.style.fontSize = '0.8em';
                timerState = 'imagine';
                timeLeft = 60;
                startTimer();
              }, 1000);
            }
          }, 1000);
        }
      }
    }

    // ç›®çš„ã®ç·¨é›†
    function editPurpose() {
      purposeConfirmed = false;
      document.getElementById('purposeGroup').style.display = 'flex';
      document.getElementById('purposeDisplay').style.display = 'none';
      document.getElementById('purposeInput').value = purpose;
    }

    // æ­¢ã¾ã‚‹ä»•çµ„ã¿ã®ä¿å­˜
    function saveStopCondition() {
      const input = document.getElementById('stopConditionInput');
      stopCondition = input.value.trim();
      
      if (stopCondition) {
        stopConditionSaved = true;
        document.getElementById('stopConditionGroup').style.display = 'none';
        document.getElementById('stopConditionDisplay').style.display = 'flex';
        document.getElementById('stopConditionText').textContent = stopCondition;
        
        // æ­¢ã‚ã‚‹ä»•çµ„ã¿ã‚’localStorageã«ä¿å­˜
        localStorage.setItem('stopCondition', stopCondition);
        localStorage.setItem('stopConditionSaved', 'true');
      }
    }

    // æ­¢ã¾ã‚‹ä»•çµ„ã¿ã®ç·¨é›†
    function editStopCondition() {
      stopConditionSaved = false;
      document.getElementById('stopConditionGroup').style.display = 'flex';
      document.getElementById('stopConditionDisplay').style.display = 'none';
      document.getElementById('stopConditionInput').value = stopCondition;
    }

    // é€±é–“ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openDaySelectModal(sectionNum, taskText) {
      const today = getLocalDateStr(new Date());
      const dailyTasks = getDailyTasks(today);
      const task = dailyTasks[sectionNum].find(t => t.text === taskText);
      if (task) {
        openDaySelectModalById(task.id);
      }
    }

    // IDç‰ˆï¼šé€±é–“è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openDaySelectModalById(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (!task) return;
      
      pendingScheduleTask = { taskId: taskId, taskText: task.text };
      selectedWeekday = null;
      
      // æ›œæ—¥ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll('.day-select-btn').forEach(btn => {
        btn.style.backgroundColor = '#fff';
        btn.style.color = '#000';
        btn.style.borderColor = '#ddd';
      });
      
      document.getElementById('weeklyTaskModal').classList.add('show');
    }

    // é€±é–“ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeWeeklyTaskModal() {
      document.getElementById('weeklyTaskModal').classList.remove('show');
      pendingScheduleTask = null;
      selectedWeekday = null;
    }

    // é€±é–“ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰æ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼ã«æˆ»ã‚‹
    function backToDailyView() {
      switchView('daily');
    }

    // æ›œæ—¥ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«è¨­å®šï¼‰
    function setupDayButtons() {
      document.querySelectorAll('.day-select-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          // å…¨ãƒœã‚¿ãƒ³ã®é¸æŠè§£é™¤
          document.querySelectorAll('.day-select-btn').forEach(b => {
            b.style.backgroundColor = '#fff';
            b.style.color = '#000';
            b.style.borderColor = '#ddd';
          });
          
          // ã“ã®ãƒœã‚¿ãƒ³ã‚’é¸æŠ
          this.style.backgroundColor = '#2196F3';
          this.style.color = 'white';
          this.style.borderColor = '#2196F3';
          
          selectedWeekday = parseInt(this.dataset.day);
        });
      });
    }

    // é€±é–“ã‚¿ã‚¹ã‚¯ã«è¿½åŠ ç¢ºå®š
    function confirmAddToWeekly() {
      if (!pendingScheduleTask || selectedWeekday === null) {
        alert('æ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      const time = document.getElementById('weeklyTaskTime').value;
      
      // ä»Šé€±ã®æœˆæ›œæ—¥ã‚’åŸºæº–ã«æ—¥ä»˜ã‚’è¨ˆç®—
      const now = new Date();
      const dayOfWeek = now.getDay();
      const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      const monday = new Date(now);
      monday.setDate(now.getDate() + mondayOffset);
      
      // é¸æŠã•ã‚ŒãŸæ›œæ—¥ã®æ—¥ä»˜
      const targetDate = new Date(monday);
      targetDate.setDate(monday.getDate() + selectedWeekday);
      const dateStr = getLocalDateStr(targetDate);
      
      // æ—¢å­˜ã‚¿ã‚¹ã‚¯ã«ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
      if (pendingScheduleTask.taskId) {
        updateTask(pendingScheduleTask.taskId, {
          date: dateStr,
          time: time,
          showInWeekly: true
        });
      } else {
        // æ–°è¦ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆï¼ˆæ—¥æ¬¡ï¼‹é€±é–“ã®ä¸¡æ–¹ã«è¡¨ç¤ºï¼‰
        createTask(pendingScheduleTask.taskText, dateStr, time, 1, true, true);
      }
      
      closeWeeklyTaskModal();
      
      // é€±é–“ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãŸã‚‰æ›´æ–°
      if (document.getElementById('weeklyView').style.display === 'block') {
        renderWeeklyView();
      }
      
      // æ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼ã‚‚å†æç”»ï¼ˆä»Šæ—¥ã¾ãŸã¯å…ƒã®æ—¥ä»˜ã®ã‚¿ã‚¹ã‚¯ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆï¼‰
      const today = getLocalDateStr(new Date());
      for (let sec = 1; sec <= 4; sec++) {
        renderTasks(sec);
      }
    }

    // è‰²ã‚’ãƒ–ãƒ¬ãƒ³ãƒ‰ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function blendColors(color1, color2, ratio) {
      // ç°¡æ˜“å®Ÿè£…ï¼šcolor2ã‚’å„ªå…ˆçš„ã«è¿”ã™
      return color2;
    }

    // é€±é–“ãƒ“ãƒ¥ãƒ¼ã‚’æç”»ï¼ˆãƒãƒ¼ãƒã‚«ãƒ«ï¼‰
    function renderWeeklyView() {
      const container = document.getElementById('weeklyContainer');
      container.innerHTML = '';
      
      // è¡¨ç¤ºä¸­ã®é€±ã®æœˆæ›œæ—¥ã‹ã‚‰æ—¥æ›œæ—¥ã¾ã§
      const baseDate = new Date(currentWeekDate);
      const dayOfWeek = baseDate.getDay();
      const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      const monday = new Date(baseDate);
      monday.setDate(baseDate.getDate() + mondayOffset);
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
      const titleEl = document.getElementById('weeklyTitle');
      const sundayDate = new Date(monday);
      sundayDate.setDate(monday.getDate() + 6);
      titleEl.textContent = `${monday.getMonth() + 1}/${monday.getDate()} ã€œ ${sundayDate.getMonth() + 1}/${sundayDate.getDate()}`;
      
      const weekdays = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
      const table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'separate';
      table.style.borderSpacing = '0';
      table.style.backgroundColor = '#fff';
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      
      const timeHeader = document.createElement('th');
      timeHeader.textContent = 'æ™‚é–“';
      timeHeader.style.padding = '12px 10px';
      timeHeader.style.border = '1px solid #ddd';
      timeHeader.style.backgroundColor = '#f5f5f5';
      timeHeader.style.width = '70px';
      timeHeader.style.minWidth = '70px';
      timeHeader.style.fontWeight = 'bold';
      timeHeader.style.position = 'sticky';
      timeHeader.style.left = '0';
      timeHeader.style.zIndex = '25';
      headerRow.appendChild(timeHeader);
      
      // ä»Šæ—¥ã®æ—¥ä»˜
      const todayDateStr = getLocalDateStr(new Date());
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        const displayDate = `${date.getMonth() + 1}/${date.getDate()}`;
        const dateStr = getLocalDateStr(date);
        const isToday = (dateStr === todayDateStr);
        
        const th = document.createElement('th');
        th.textContent = `${displayDate}ï¼ˆ${weekdays[i]}ï¼‰`;
        th.style.padding = '12px 10px';
        th.style.border = '1px solid #ddd';
        th.style.backgroundColor = '#f5f5f5';
        th.style.fontWeight = 'bold';
        th.dataset.date = dateStr;  // æ—¥ä»˜ã‚’ä¿å­˜
        
        // åœŸæ›œãƒ»æ—¥æ›œã®è‰²åˆ†ã‘
        if (i === 5) {
          th.style.backgroundColor = '#e3f2fd';
          th.style.color = '#1976d2';
        }
        if (i === 6) {
          th.style.backgroundColor = '#fff3e0';
          th.style.color = '#e65100';
        }
        
        // ä»Šæ—¥ã®ãƒ˜ãƒƒãƒ€ãƒ¼å¼·èª¿ï¼ˆé»„è‰²ç³»ï¼‰
        if (isToday) {
          th.style.backgroundColor = '#fff9c4';
          th.style.color = '#f57c00';
          th.style.fontWeight = 'bold';
          th.style.borderBottom = '3px solid #fbc02d';
        }
        
        headerRow.appendChild(th);
      }
      
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—
      const currentHour = new Date().getHours();
      
      // æ™‚é–“è¡Œï¼ˆ0:00-23:00ï¼‰
      const tbody = document.createElement('tbody');
      
      for (let hour = 0; hour <= 23; hour++) {
        const tr = document.createElement('tr');
        
        // æ™‚é–“å¸¯ã«ã‚ˆã‚‹ã‚¾ãƒ¼ãƒ‹ãƒ³ã‚°è‰²
        let zoneColor = '#fafafa'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        let zoneBorder = '1px solid #ddd';
        
        // 6æ™‚é–“ã”ã¨ã®ã‚¾ãƒ¼ãƒ³
        if (hour >= 0 && hour < 6) {
          // æ·±å¤œï¼ˆ0-5æ™‚ï¼‰ï¼šæš—ã‚
          zoneColor = '#f5f5f5';
        } else if (hour >= 6 && hour < 12) {
          // æœï¼ˆ6-11æ™‚ï¼‰ï¼šæ˜ã‚‹ã„
          zoneColor = '#fafafa';
        } else if (hour >= 12 && hour < 18) {
          // æ˜¼ï¼ˆ12-17æ™‚ï¼‰ï¼šæ˜ã‚‹ã„
          zoneColor = '#fafafa';
        } else {
          // å¤œï¼ˆ18-23æ™‚ï¼‰ï¼šã‚„ã‚„æš—ã‚
          zoneColor = '#f5f5f5';
        }
        
        // 12æ™‚ï¼ˆæ­£åˆï¼‰ã®ä¸Šã«å¤ªã„åŒºåˆ‡ã‚Šç·š
        if (hour === 12) {
          tr.style.borderTop = '3px solid #ff5722';
        }
        
        // 6æ™‚ã€18æ™‚ã«ã‚‚è–„ã„åŒºåˆ‡ã‚Šç·š
        if (hour === 6 || hour === 18) {
          tr.style.borderTop = '2px solid #bdbdbd';
        }
        
        // ç¾åœ¨æ™‚åˆ»ã®è¡Œã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        const isCurrentHour = (hour === currentHour);
        
        // æ™‚é–“ã‚»ãƒ«
        const timeCell = document.createElement('td');
        timeCell.textContent = `${String(hour).padStart(2, '0')}:00`;
        timeCell.id = `weekly-time-${hour}`;
        timeCell.style.padding = '15px 10px';
        timeCell.style.border = '1px solid #ddd';
        timeCell.style.textAlign = 'center';
        timeCell.style.backgroundColor = isCurrentHour ? '#fff9c4' : zoneColor;
        timeCell.style.fontWeight = 'bold';
        timeCell.style.height = '80px';
        timeCell.style.verticalAlign = 'middle';
        timeCell.style.position = 'sticky';
        timeCell.style.left = '0';
        timeCell.style.zIndex = '5';
        timeCell.style.minWidth = '70px';
        
        // ç¾åœ¨æ™‚åˆ»ã¯å¼·èª¿
        if (isCurrentHour) {
          timeCell.style.color = '#e65100';
          timeCell.style.fontSize = '1.1em';
          timeCell.style.background = 'linear-gradient(135deg, #fff9c4 0%, #fff176 100%)';
          timeCell.style.borderRight = '3px solid #fbc02d';
        }
        
        tr.appendChild(timeCell);
        
        // å„æ›œæ—¥ã®ã‚»ãƒ«
        for (let i = 0; i < 7; i++) {
          const date = new Date(monday);
          date.setDate(monday.getDate() + i);
          const dateStr = getLocalDateStr(date);
          
          const td = document.createElement('td');
          td.style.padding = '8px';
          td.style.border = '1px solid #ddd';
          td.style.verticalAlign = 'top';
          td.style.height = '80px';
          td.style.position = 'relative';
          td.style.cursor = 'pointer';
          td.dataset.date = dateStr;
          td.dataset.hour = hour;
          
          // æ›œæ—¥ã”ã¨ã®èƒŒæ™¯è‰²ï¼ˆãƒ™ãƒ¼ã‚¹ï¼‰
          let cellBgColor = '#ffffff'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç™½
          if (i === 1 || i === 3) {
            // ç«ãƒ»æœ¨ã¯æ¥µè–„ã‚°ãƒ¬ãƒ¼
            cellBgColor = '#fafafa';
          } else if (i === 5) {
            // åœŸæ›œæ—¥ã¯è–„é’
            cellBgColor = '#e3f2fd';
          } else if (i === 6) {
            // æ—¥æ›œæ—¥ã¯è–„ã‚ªãƒ¬ãƒ³ã‚¸
            cellBgColor = '#fff3e0';
          }
          
          // ç¥æ—¥ãƒã‚§ãƒƒã‚¯
          const holiday = getHoliday(dateStr);
          if (holiday) {
            cellBgColor = '#fff3e0'; // ç¥æ—¥ã¯è–„ã‚ªãƒ¬ãƒ³ã‚¸
          }
          
          // ç¾åœ¨æ™‚åˆ»ã®è¡Œã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          if (isCurrentHour && dateStr === todayDateStr) {
            cellBgColor = '#fff176'; // ä»Šã“ã®ç¬é–“ï¼ˆæ¿ƒã„é»„è‰²ï¼‰
            td.style.boxShadow = 'inset 0 0 0 2px #fbc02d';
            td.style.borderRadius = '4px';
          } else if (isCurrentHour) {
            // ç¾åœ¨æ™‚åˆ»ã®è¡Œã¯å…¨ä½“çš„ã«è–„é»„è‰²
            cellBgColor = blendColors(cellBgColor, '#fffde7', 0.5);
          }
          
          td.style.backgroundColor = cellBgColor;
          td.dataset.bgColor = cellBgColor; // å…ƒã®è‰²ã‚’ä¿å­˜
          
          // ã‚¯ãƒªãƒƒã‚¯ã§ã‚¿ã‚¹ã‚¯ä½œæˆ
          td.addEventListener('click', (e) => {
            // ã‚¿ã‚¹ã‚¯Divè‡ªä½“ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (e.target !== td) return;
            
            openWeeklyTaskCreateModal(dateStr, hour);
          });
          
          // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
          td.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            td.style.backgroundColor = '#e8f5e9';
          });
          
          // ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–
          td.addEventListener('dragleave', (e) => {
            td.style.backgroundColor = td.dataset.bgColor; // å…ƒã®è‰²ã«æˆ»ã™
          });
          
          // ãƒ‰ãƒ­ãƒƒãƒ—
          td.addEventListener('drop', (e) => {
            e.preventDefault();
            td.style.backgroundColor = td.dataset.bgColor; // å…ƒã®è‰²ã«æˆ»ã™
            
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const taskId = data.taskId;
            const newHour = hour;
            const newTime = `${String(newHour).padStart(2, '0')}:00`;
            
            // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            updateTask(taskId, {
              date: dateStr,
              time: newTime,
              showInWeekly: true,  // é€±é–“ã«ç§»å‹•ã—ãŸã®ã§trueã«
              showInDaily: true    // æ—¥æ¬¡ã«ã‚‚è¡¨ç¤º
            });
            
            renderWeeklyView();
            
            // æ—¥æ¬¡ã‚‚å†æç”»
            for (let sec = 1; sec <= 4; sec++) {
              renderTasks(sec);
            }
          });
          
          // ã“ã®æ™‚é–“å¸¯ã®ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤ºï¼ˆãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼‰
          const weekStart = getLocalDateStr(monday);
          const weekEnd = new Date(monday);
          weekEnd.setDate(monday.getDate() + 6);
          const weekEndStr = getLocalDateStr(weekEnd);
          
          const weeklyTasksForDate = allTasks.filter(t => 
            t.date === dateStr && t.time
          );
          
          weeklyTasksForDate.forEach((task) => {
            const taskHour = parseInt(task.time.split(':')[0]);
            
            if (taskHour === hour) {
              // sectionåˆ¥ã®è‰²è¨­å®š
              const sectionColors = {
                1: { bg: '#ffe6e6', border: '#ff4444' }, // ç·Šæ€¥ã‹ã¤é‡è¦ï¼ˆèµ¤ï¼‰
                2: { bg: '#e8f5e9', border: '#4caf50' }, // ç·Šæ€¥ã ãŒé‡è¦ã§ãªã„ï¼ˆç·‘ï¼‰
                3: { bg: '#fffef5', border: '#ffc107' }, // é‡è¦ã ãŒç·Šæ€¥ã§ãªã„ï¼ˆé»„ï¼‰
                4: { bg: '#f0f0f0', border: '#999999' }  // ç·Šæ€¥ã§ã‚‚é‡è¦ã§ã‚‚ãªã„ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰
              };
              
              const colors = sectionColors[task.section] || sectionColors[1];
              
              const taskDiv = document.createElement('div');
              taskDiv.style.padding = '4px 8px';
              taskDiv.style.marginBottom = '2px';
              taskDiv.style.backgroundColor = task.completed ? '#e0e0e0' : colors.bg;
              taskDiv.style.borderLeft = `3px solid ${colors.border}`;
              taskDiv.style.borderRadius = '3px';
              taskDiv.style.fontSize = '0.85em';
              taskDiv.style.cursor = 'grab';
              taskDiv.style.display = 'flex';
              taskDiv.style.alignItems = 'center';
              taskDiv.style.gap = '4px';
              taskDiv.draggable = true;
              taskDiv.dataset.taskId = task.id;
              
              // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
              taskDiv.addEventListener('dragstart', (e) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', JSON.stringify({
                  taskId: task.id,
                  dateStr: dateStr,
                  taskText: task.text,
                  taskTime: task.time
                }));
                taskDiv.style.opacity = '0.5';
              });
              
                // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
                taskDiv.addEventListener('dragend', (e) => {
                  taskDiv.style.opacity = '1';
                });
                
                const timeSpan = document.createElement('span');
                timeSpan.textContent = task.time;
                timeSpan.style.fontWeight = 'bold';
                timeSpan.style.marginRight = '4px';
                
                const textSpan = document.createElement('span');
                textSpan.textContent = task.text;
                textSpan.style.flex = '1';
                if (task.completed) {
                  textSpan.style.textDecoration = 'line-through';
                  textSpan.style.opacity = '0.6';
                }
                
                const editBtn = document.createElement('span');
                editBtn.textContent = 'âœï¸';
                editBtn.title = 'ç·¨é›†';
                editBtn.style.cursor = 'pointer';
                editBtn.style.opacity = '0.5';
                editBtn.style.pointerEvents = 'auto';
                editBtn.addEventListener('click', (e) => {
                  e.stopPropagation();
                  e.preventDefault();
                  
                  
                  // promptã‚’setTimeoutã§é…å»¶å®Ÿè¡Œï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ–ãƒ­ãƒƒã‚¯å›é¿ï¼‰
                  setTimeout(() => {
                    editWeeklyTaskById(task.id);
                  }, 10);
                });
                
                taskDiv.onclick = (e) => {
                  // ãƒœã‚¿ãƒ³ä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã ã‘å®Œäº†ãƒˆã‚°ãƒ«
                  if (e.target === taskDiv || e.target === timeSpan || e.target === textSpan) {
                    updateTask(task.id, { completed: !task.completed });
                    renderWeeklyView();
                    
                    // ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ãªã‚‰æ—¥æ¬¡ã‚‚å†æç”»
                    const today = getLocalDateStr(new Date());
                    if (task.date === today) {
                      for (let sec = 1; sec <= 4; sec++) {
                        renderTasks(sec);
                      }
                    }
                  }
                };
                
                taskDiv.appendChild(timeSpan);
                taskDiv.appendChild(textSpan);
                taskDiv.appendChild(editBtn);
                td.appendChild(taskDiv);
              }
            });
          
          tr.appendChild(td);
        }
        
        tbody.appendChild(tr);
      }
      
      table.appendChild(tbody);
      container.appendChild(table);
    }

    // é€±é–“ã‚¿ã‚¹ã‚¯ã®ç·¨é›†ï¼ˆIDç‰ˆï¼‰
    let editingWeeklyTaskId = null; // ç·¨é›†ä¸­ã®ã‚¿ã‚¹ã‚¯ID
    
    function editWeeklyTaskById(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      
      if (!task) {
        console.error('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', taskId);
        return;
      }
      
      // ç·¨é›†ä¸­ã®ã‚¿ã‚¹ã‚¯IDã‚’ä¿å­˜
      editingWeeklyTaskId = taskId;
      
      // ã‚¿ã‚¹ã‚¯åã‚’è¨­å®š
      document.getElementById('editTaskText').value = task.text;
      document.getElementById('editTaskId').value = task.id;
      
      // ãƒ¡ãƒ¢ã‚’è¨­å®š
      document.getElementById('editTaskMemo').value = task.memo || '';
      
      // æ—¥ä»˜ã‚’è¨­å®š
      document.getElementById('editTaskDate').value = task.date || '';
      
      // æ™‚é–“ã‚’è¨­å®šï¼ˆæ–°ã—ã„ã‚»ãƒ¬ã‚¯ãƒˆå¼ï¼‰
      setTimeSelect('weeklyEdit', task.time);
      
      // è±¡é™ã‚’è¨­å®š
      document.getElementById('editTaskSection').value = task.section || 2;
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      document.getElementById('weeklyTaskEditModal').classList.add('show');
      
      // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      setTimeout(() => {
        document.getElementById('editTaskText').focus();
        document.getElementById('editTaskText').select();
      }, 100);
    }
    
    function closeWeeklyEditModal() {
      document.getElementById('weeklyTaskEditModal').classList.remove('show');
      editingWeeklyTaskId = null;
    }
    
    function saveWeeklyEdit() {
      if (!editingWeeklyTaskId) return;
      
      const newText = document.getElementById('editTaskText').value.trim();
      const newMemo = document.getElementById('editTaskMemo').value.trim();
      const newDate = document.getElementById('editTaskDate').value;
      const newTime = getTimeFromSelect('weeklyEdit');
      const newSection = parseInt(document.getElementById('editTaskSection').value);
      
      if (!newText) {
        alert('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!newDate) {
        alert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // æ™‚é–“ãŒã‚ã‚Œã°é€±é–“ã«è¡¨ç¤º
      const showInWeekly = newTime ? true : false;
      
      updateTask(editingWeeklyTaskId, { 
        text: newText,
        memo: newMemo || null,
        date: newDate,
        time: newTime, 
        section: newSection,
        showInWeekly: showInWeekly
      });
      
      closeWeeklyEditModal();
      renderWeeklyView();
      renderMonthlyView();
      
      // æ—¥æ¬¡ã‚‚å†æç”»
      for (let sec = 1; sec <= 4; sec++) {
        renderTasks(sec);
      }
    }
    
    let deleteConfirmationShown = false;
    
    function confirmDeleteFromEdit() {
      
      if (!editingWeeklyTaskId) {
        console.error('editingWeeklyTaskIdãŒæœªè¨­å®š');
        return;
      }
      
      const task = allTasks.find(t => t.id === editingWeeklyTaskId);
      
      if (!task) {
        console.error('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´ã—ã¦ç¢ºèª
      if (!deleteConfirmationShown) {
        // 1å›ç›®ï¼šç¢ºèªã‚’è¡¨ç¤º
        const btn = event.target;
        btn.textContent = 'æœ¬å½“ã«å‰Šé™¤ï¼Ÿ';
        btn.style.backgroundColor = '#d32f2f';
        deleteConfirmationShown = true;
        
        
        // 3ç§’å¾Œã«å…ƒã«æˆ»ã™
        setTimeout(() => {
          btn.textContent = 'å‰Šé™¤';
          btn.style.backgroundColor = '#f44336';
          deleteConfirmationShown = false;
        }, 3000);
        
        return;
      }
      
      // 2å›ç›®ï¼šå®Ÿéš›ã«å‰Šé™¤
      
      deleteTaskById(editingWeeklyTaskId);
      
      closeWeeklyEditModal();
      
      deleteConfirmationShown = false;
      
    }
    
    // ç·¨é›†ã‚’ä¿å­˜ï¼ˆæ—§ã‚·ã‚¹ãƒ†ãƒ ãƒ»ãƒ‡ãƒƒãƒ‰ã‚³ãƒ¼ãƒ‰å‰Šé™¤æ¸ˆã¿ï¼‰
    // â†’ editWeeklyTaskByIdã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
    
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰å‰Šé™¤ï¼ˆæ—§ã‚·ã‚¹ãƒ†ãƒ ãƒ»ãƒ‡ãƒƒãƒ‰ã‚³ãƒ¼ãƒ‰å‰Šé™¤æ¸ˆã¿ï¼‰
    // â†’ editWeeklyTaskByIdã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„

    // ===== æœˆé–“ãƒ“ãƒ¥ãƒ¼é–¢æ•° =====
    
    function renderMonthlyView() {
      const calendar = document.getElementById('monthlyCalendar');
      calendar.innerHTML = '';
      
      // æœˆé–“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰å–å¾—
      const monthlyMode = localStorage.getItem('monthlyMode') || 'fixed';
      
      // expandãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æœ€å°å¹…ã‚’æ‹¡å¼µ
      if (monthlyMode === 'expand') {
        calendar.style.minWidth = '100%';
        calendar.style.width = '100%';
      } else {
        calendar.style.minWidth = '100%';
        calendar.style.width = '100%';
      }
      
      const year = currentMonthDate.getFullYear();
      const month = currentMonthDate.getMonth();
      
      // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
      document.getElementById('monthlyTitle').textContent = `${year}å¹´${month + 1}æœˆ`;
      
      // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
      const weekdays = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
      weekdays.forEach((day, index) => {
        const header = document.createElement('div');
        header.className = 'monthly-weekday-header';
        if (index === 5) header.classList.add('saturday');
        if (index === 6) header.classList.add('sunday');
        header.textContent = day;
        calendar.appendChild(header);
      });
      
      // æœˆã®æœ€åˆã®æ—¥
      const firstDay = new Date(year, month, 1);
      // æœˆæ›œå§‹ã¾ã‚Šã«èª¿æ•´ï¼ˆ0=æ—¥æ›œ â†’ 6, 1=æœˆæ›œ â†’ 0, ...ï¼‰
      let startDayOfWeek = firstDay.getDay();
      startDayOfWeek = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1;
      
      // æœˆã®æœ€å¾Œã®æ—¥
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      
      // å‰æœˆã®æ—¥æ•°
      const prevMonthLastDay = new Date(year, month, 0);
      const daysInPrevMonth = prevMonthLastDay.getDate();
      
      // ä»Šæ—¥ã®æ—¥ä»˜
      const today = new Date();
      const todayStr = getLocalDateStr(today);
      
      // 6é€±åˆ†ï¼ˆ42æ—¥ï¼‰è¡¨ç¤º
      let currentDate = 1;
      let nextMonthDate = 1;
      
      for (let i = 0; i < 42; i++) {
        // å„é€±ã®é–“ã«ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã‚’æŒ¿å…¥
        if (i > 0 && i % 7 === 0) {
          const handle = document.createElement('div');
          handle.className = 'monthly-resize-handle';
          handle.dataset.weekRow = Math.floor(i / 7);
          handle.addEventListener('mousedown', function(e) { startMonthlyResize(e); });
          handle.addEventListener('touchstart', function(e) { startMonthlyResizeTouchWrapper(e); }, { passive: false });
          calendar.appendChild(handle);
        }
        
        const cell = document.createElement('div');
        cell.className = 'monthly-day-cell';
        
        let dateStr;
        let dayNumber;
        let isOtherMonth = false;
        
        if (i < startDayOfWeek) {
          // å‰æœˆã®æ—¥
          dayNumber = daysInPrevMonth - startDayOfWeek + i + 1;
          const prevMonth = month === 0 ? 11 : month - 1;
          const prevYear = month === 0 ? year - 1 : year;
          dateStr = `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
          isOtherMonth = true;
        } else if (currentDate <= daysInMonth) {
          // å½“æœˆã®æ—¥
          dayNumber = currentDate;
          dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
          currentDate++;
        } else {
          // æ¬¡æœˆã®æ—¥
          dayNumber = nextMonthDate;
          const nextMonth = month === 11 ? 0 : month + 1;
          const nextYear = month === 11 ? year + 1 : year;
          dateStr = `${nextYear}-${String(nextMonth + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
          nextMonthDate++;
          isOtherMonth = true;
        }
        
        if (isOtherMonth) {
          cell.classList.add('other-month');
        }
        
        // æ›œæ—¥ã«ã‚ˆã‚‹è‰²åˆ†ã‘ï¼ˆåœŸæ›œãƒ»æ—¥æ›œï¼‰
        const dayOfWeek = i % 7;
        if (dayOfWeek === 5 && !isOtherMonth) cell.classList.add('saturday');
        if (dayOfWeek === 6 && !isOtherMonth) cell.classList.add('sunday');
        
        // ç¥æ—¥ãƒã‚§ãƒƒã‚¯
        const holiday = getHoliday(dateStr);
        if (holiday && !isOtherMonth) {
          cell.classList.add('holiday');
        }
        
        // ä»Šæ—¥ã®å¼·èª¿
        if (dateStr === todayStr) {
          cell.classList.add('today');
        }
        
        cell.dataset.date = dateStr;
        
        // æ—¥ä»˜ç•ªå·
        const dayNum = document.createElement('div');
        dayNum.className = 'monthly-day-number';
        dayNum.textContent = dayNumber;
        cell.appendChild(dayNum);
        
        // ç¥æ—¥åã‚’è¡¨ç¤º
        if (holiday && !isOtherMonth) {
          const holidayDiv = document.createElement('div');
          holidayDiv.className = 'monthly-holiday-name';
          holidayDiv.textContent = holiday;
          holidayDiv.title = holiday; // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
          cell.appendChild(holidayDiv);
        }
        
        // ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼šã‚¹ã‚¿ãƒ³ãƒ—è¡¨ç¤º
        const isSimple = localStorage.getItem('simpleMode') === 'on';
        if (isSimple) {
          const dayInfo = getDayInfo(dateStr);
          
          if (dayInfo && dayInfo.stampId) {
            const def = getStampDef(dayInfo.stampId);
            if (def) {
              const stampLabel = document.createElement('div');
              stampLabel.className = 'stamp-label';
              stampLabel.textContent = def.name;
              stampLabel.style.cssText = `
                background: ${def.color}; color: ${def.textColor || '#333'}; 
                padding: 2px 8px; border-radius: 10px; font-size: 0.75em; font-weight: 600;
                text-align: center; margin-bottom: 2px; cursor: pointer;
              `;
              // ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒ™ãƒ«ã‚¿ãƒƒãƒ—ï¼šæ¶ˆã—ã‚´ãƒ ä¸­ã¯å‰Šé™¤ã€é€šå¸¸ã¯è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
              stampLabel.addEventListener('click', (e) => {
                if (eraserMode) {
                  e.stopPropagation();
                  removeDayInfo(dateStr);
                  renderMonthlyView();
                  if (navigator.vibrate) navigator.vibrate(30);
                } else if (!selectedStamp) {
                  e.stopPropagation();
                  openDayInfoModal(dateStr);
                }
                // selectedStampæ™‚ã¯stopPropagationã—ãªã„ â†’ ã‚»ãƒ«ã®clickã«å§”è­²ï¼ˆä¸Šæ›¸ãå‡¦ç†ï¼‰
              });
              cell.appendChild(stampLabel);
            }
          }
          
          // ãƒ¡ãƒ¢ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º
          if (dayInfo && (dayInfo.workMemo || dayInfo.privateMemo)) {
            const memoIcons = document.createElement('div');
            memoIcons.style.cssText = 'display: flex; gap: 2px; justify-content: center; font-size: 0.7em;';
            if (dayInfo.workMemo) {
              const icon = document.createElement('span');
              icon.className = 'memo-icon';
              icon.textContent = 'â– ';
              icon.style.color = '#78909c';
              icon.title = dayInfo.workMemo;
              memoIcons.appendChild(icon);
            }
            if (dayInfo.privateMemo) {
              const icon = document.createElement('span');
              icon.className = 'memo-icon';
              icon.textContent = 'â˜…';
              icon.style.color = '#ffa726';
              icon.title = dayInfo.privateMemo;
              memoIcons.appendChild(icon);
            }
            cell.appendChild(memoIcons);
          }
        }
        
        // ã“ã®æ—¥ã®ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤ºï¼ˆdailyStatusã¯é™¤å¤–ï¼‰
        const dayTasks = allTasks.filter(t => t.date === dateStr && (t.kind || 'task') === 'task');
        dayTasks.forEach(task => {
          const taskDiv = document.createElement('div');
          taskDiv.className = 'monthly-task-item';
          taskDiv.dataset.taskId = task.id;
          taskDiv.draggable = true;
          taskDiv.style.display = 'flex';
          taskDiv.style.alignItems = 'center';
          
          // è±¡é™ã«ã‚ˆã‚‹è‰²
          const colors = {
            1: { bg: '#ffe6e6', border: '#ff4444' },
            2: { bg: '#e8f5e9', border: '#4caf50' },
            3: { bg: '#fffef5', border: '#ffc107' },
            4: { bg: '#f0f0f0', border: '#999999' }
          };
          const color = colors[task.section] || colors[4];
          taskDiv.style.backgroundColor = color.bg;
          taskDiv.style.borderLeft = `3px solid ${color.border}`;
          
          // å®Œäº†çŠ¶æ…‹
          if (task.completed) {
            taskDiv.style.textDecoration = 'line-through';
            taskDiv.style.opacity = '0.6';
          }
          
          // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ï¼ˆPCç”¨ï¼‰
          taskDiv.addEventListener('dragstart', (e) => {
            e.stopPropagation();
            taskDiv.classList.add('dragging');
            e.dataTransfer.setData('text/plain', JSON.stringify({
              taskId: task.id,
              source: 'monthly'
            }));
            e.dataTransfer.effectAllowed = 'move';
          });
          
          // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†ï¼ˆPCç”¨ï¼‰
          taskDiv.addEventListener('dragend', () => {
            taskDiv.classList.remove('dragging');
          });
          
          // é•·æŠ¼ã—æ¤œå‡ºï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰
          let longPressTimer = null;
          
          taskDiv.addEventListener('touchstart', (e) => {
            longPressTimer = setTimeout(() => {
              e.preventDefault();
              // ç§»å‹•ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
              startMoveMode(task.id);
            }, 500); // 500msé•·æŠ¼ã—
          }, { passive: false });
          
          taskDiv.addEventListener('touchend', () => {
            if (longPressTimer) {
              clearTimeout(longPressTimer);
              longPressTimer = null;
            }
          });
          
          taskDiv.addEventListener('touchmove', () => {
            if (longPressTimer) {
              clearTimeout(longPressTimer);
              longPressTimer = null;
            }
          });
          
          // ã‚¿ã‚¹ã‚¯æœ¬ä½“ã‚¯ãƒªãƒƒã‚¯ â†’ å®Œäº†ãƒˆã‚°ãƒ«ï¼ˆç·šã§æ¶ˆã™ï¼‰
          taskDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            if (movingTaskId) {
              cancelMoveMode();
            } else if (e.target === taskDiv || e.target.classList.contains('monthly-task-text')) {
              // å®Œäº†ãƒˆã‚°ãƒ«
              toggleTaskById(task.id);
              renderMonthlyView();
            }
          });
          
          // ã‚¿ã‚¹ã‚¯ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†
          const taskText = document.createElement('span');
          taskText.className = 'monthly-task-text';
          taskText.textContent = task.time ? `${task.time} ${task.text}` : task.text;
          taskText.style.flex = '1';
          taskText.style.overflow = 'hidden';
          taskText.style.textOverflow = 'ellipsis';
          taskText.style.whiteSpace = 'nowrap';
          taskText.style.minWidth = '0';  // flexã‚¢ã‚¤ãƒ†ãƒ ã®çœç•¥ã«å¿…è¦
          taskDiv.appendChild(taskText);
          
          // ã‚¢ã‚¤ã‚³ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ
          const iconContainer = document.createElement('span');
          iconContainer.style.display = 'flex';
          iconContainer.style.gap = '2px';
          iconContainer.style.marginLeft = '4px';
          iconContainer.style.flexShrink = '0';
          
          // ğŸ“ç·¨é›†ãƒœã‚¿ãƒ³
          const editBtn = document.createElement('span');
          editBtn.textContent = 'ğŸ“';
          editBtn.style.cursor = 'pointer';
          editBtn.style.fontSize = '0.7em';
          editBtn.style.opacity = task.memo ? '1' : '0.5';
          editBtn.title = task.memo ? 'ãƒ¡ãƒ¢ã‚ã‚Š - ç·¨é›†' : 'ç·¨é›†';
          editBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openMonthlyTaskEditModal(task.id);
          });
          iconContainer.appendChild(editBtn);
          
          // ğŸ“†æ—¥æ¬¡ã¸é£›ã¶ãƒœã‚¿ãƒ³
          const goBtn = document.createElement('span');
          goBtn.textContent = 'ğŸ“†';
          goBtn.style.cursor = 'pointer';
          goBtn.style.fontSize = '0.7em';
          goBtn.title = 'ã“ã®æ—¥ã®æ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼ã¸';
          goBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            goToDailyView(task.date);
          });
          iconContainer.appendChild(goBtn);
          
          taskDiv.appendChild(iconContainer);
          
          cell.appendChild(taskDiv);
        });
        
        // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼ï¼ˆPCç”¨ - ã‚¿ã‚¹ã‚¯ç§»å‹•ã®ã¿ï¼‰
        cell.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          cell.classList.add('drag-over');
        });
        
        // ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–ï¼ˆPCç”¨ï¼‰
        cell.addEventListener('dragleave', () => {
          cell.classList.remove('drag-over');
        });
        
        // ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆPCç”¨ - ã‚¿ã‚¹ã‚¯ç§»å‹•ã®ã¿ï¼‰
        cell.addEventListener('drop', (e) => {
          e.preventDefault();
          cell.classList.remove('drag-over');
          
          try {
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const taskId = data.taskId;
            const newDate = cell.dataset.date;
            
            // ã‚¿ã‚¹ã‚¯ã®æ—¥ä»˜ã‚’æ›´æ–°
            updateTask(taskId, { date: newDate });
            
            // å†æç”»
            renderMonthlyView();
            
            // æ—¥æ¬¡ã‚‚å†æç”»
            for (let sec = 1; sec <= 4; sec++) {
              renderTasks(sec);
            }
          } catch (err) {}
        });
        
        // ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯ï¼ˆæ–°è¦ã‚¿ã‚¹ã‚¯è¿½åŠ  or ç§»å‹•å…ˆç¢ºå®š or ã‚¹ã‚¿ãƒ³ãƒ—è²¼ä»˜ï¼‰
        cell.addEventListener('click', (e) => {
          const isSimple = localStorage.getItem('simpleMode') === 'on';
          if (movingTaskId && (e.target === cell || e.target === dayNum || e.target.classList.contains('monthly-holiday-name'))) {
            // ç§»å‹•ãƒ¢ãƒ¼ãƒ‰ä¸­ï¼šã“ã®ã‚»ãƒ«ã«ç§»å‹•
            completeMoveMode(dateStr);
          } else if (isSimple && (selectedStamp || eraserMode) && (e.target === cell || e.target === dayNum || e.target.classList.contains('monthly-holiday-name') || e.target.classList.contains('stamp-label') || e.target.classList.contains('memo-icon'))) {
            // ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼šã‚¹ã‚¿ãƒ³ãƒ—/ãƒ¡ãƒ¢è²¼ä»˜
            applyStampToDate(dateStr);
          } else if (e.target === cell || e.target === dayNum || e.target.classList.contains('monthly-holiday-name')) {
            // é€šå¸¸ï¼šæ–°è¦ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            openMonthlyTaskAddModal(dateStr);
          }
        });
        
        // æœˆé–“ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸã‚»ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«
        if (monthlyMode === 'fixed') {
          cell.style.maxHeight = '120px';
        } else {
          // expandãƒ¢ãƒ¼ãƒ‰ï¼šåˆ¶é™ãªã—ã€å…¨ã‚¿ã‚¹ã‚¯è¡¨ç¤º
          cell.style.maxHeight = 'none';
          cell.style.overflow = 'visible';
        }
        
        calendar.appendChild(cell);
      }
    }
    
    // ===== æœˆé–“ãƒ“ãƒ¥ãƒ¼ï¼šè¡Œãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ =====
    let resizingRow = null;
    let resizeStartY = 0;
    let resizeStartHeights = [];

    function startMonthlyResize(e) {
      e.preventDefault();
      const weekRow = parseInt(e.target.dataset.weekRow);
      resizingRow = weekRow;
      resizeStartY = e.clientY;
      
      const calendar = document.getElementById('monthlyCalendar');
      const cells = calendar.querySelectorAll('.monthly-day-cell');
      const startIndex = (weekRow - 1) * 7;
      resizeStartHeights = [];
      for (let j = 0; j < 7; j++) {
        const actualIndex = startIndex + j;
        if (cells[actualIndex]) {
          resizeStartHeights.push(cells[actualIndex].offsetHeight);
        }
      }
      
      document.addEventListener('mousemove', onMonthlyResize);
      document.addEventListener('mouseup', stopMonthlyResize);
      document.body.style.cursor = 'ns-resize';
      document.body.style.userSelect = 'none';
    }

    function startMonthlyResizeTouchWrapper(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const weekRow = parseInt(e.target.dataset.weekRow);
      resizingRow = weekRow;
      resizeStartY = touch.clientY;
      
      const calendar = document.getElementById('monthlyCalendar');
      const cells = calendar.querySelectorAll('.monthly-day-cell');
      const startIndex = (weekRow - 1) * 7;
      resizeStartHeights = [];
      for (let j = 0; j < 7; j++) {
        const actualIndex = startIndex + j;
        if (cells[actualIndex]) {
          resizeStartHeights.push(cells[actualIndex].offsetHeight);
        }
      }
      
      document.addEventListener('touchmove', onMonthlyResizeTouch, { passive: false });
      document.addEventListener('touchend', stopMonthlyResizeTouch);
    }

    function onMonthlyResize(e) {
      if (resizingRow === null) return;
      const delta = e.clientY - resizeStartY;
      applyRowResize(delta);
    }

    function onMonthlyResizeTouch(e) {
      e.preventDefault();
      if (resizingRow === null) return;
      const delta = e.touches[0].clientY - resizeStartY;
      applyRowResize(delta);
    }

    function applyRowResize(delta) {
      const calendar = document.getElementById('monthlyCalendar');
      const cells = calendar.querySelectorAll('.monthly-day-cell');
      const startIndex = (resizingRow - 1) * 7;
      
      for (let j = 0; j < 7; j++) {
        const actualIndex = startIndex + j;
        if (cells[actualIndex] && resizeStartHeights[j] !== undefined) {
          const newHeight = Math.max(50, resizeStartHeights[j] + delta);
          cells[actualIndex].style.height = newHeight + 'px';
          cells[actualIndex].style.maxHeight = newHeight + 'px';
          cells[actualIndex].style.minHeight = newHeight + 'px';
        }
      }
    }

    function stopMonthlyResize() {
      resizingRow = null;
      document.removeEventListener('mousemove', onMonthlyResize);
      document.removeEventListener('mouseup', stopMonthlyResize);
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    }

    function stopMonthlyResizeTouch() {
      resizingRow = null;
      document.removeEventListener('touchmove', onMonthlyResizeTouch);
      document.removeEventListener('touchend', stopMonthlyResizeTouch);
    }

    // æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å¹…èª¿æ•´
    function adjustMonthlyWidth(percent) {
      const calendar = document.getElementById('monthlyCalendar');
      calendar.style.width = percent + '%';
      calendar.style.minWidth = percent + '%';
    }

    function resetMonthlyWidth() {
      const slider = document.getElementById('monthlyWidthSlider');
      slider.value = 100;
      adjustMonthlyWidth(100);
    }

    function changeMonth(delta) {
      cancelMoveMode();
      currentMonthDate.setMonth(currentMonthDate.getMonth() + delta);
      renderMonthlyView();
      updateSeasonalArt();
    }

    // é€±ã‚’å¤‰æ›´
    function changeWeek(delta) {
      currentWeekDate.setDate(currentWeekDate.getDate() + (delta * 7));
      renderWeeklyView();
    }

    // ===== å¹´é–“ãƒ“ãƒ¥ãƒ¼é–¢æ•° =====
    
    // å¹´é–“ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderYearlyView() {
      const year = currentYearDate.getFullYear();
      const calendar = document.getElementById('yearlyCalendar');
      const title = document.getElementById('yearlyTitle');
      
      title.textContent = `${year}å¹´`;
      
      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
      
      const weekdayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      
      // ã‚°ãƒªãƒƒãƒ‰æ§‹ç¯‰
      let html = '';
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆç©ºç™½ + 1æœˆã€œ12æœˆï¼‰
      html += '<div class="yearly-header-cell"></div>';
      for (let m = 1; m <= 12; m++) {
        html += `<div class="yearly-header-cell">${m}æœˆ</div>`;
      }
      
      // 31æ—¥åˆ†ã®è¡Œ
      for (let day = 1; day <= 31; day++) {
        // æ—¥ãƒ©ãƒ™ãƒ«
        html += `<div class="yearly-day-label">${day}</div>`;
        
        // å„æœˆã®ã‚»ãƒ«
        for (let month = 1; month <= 12; month++) {
          const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const date = new Date(year, month - 1, day);
          
          // ãã®æœˆã«å­˜åœ¨ã—ãªã„æ—¥ï¼ˆä¾‹ï¼š2æœˆ30æ—¥ï¼‰
          if (date.getMonth() !== month - 1) {
            html += '<div class="yearly-cell empty">-</div>';
            continue;
          }
          
          const dayOfWeek = date.getDay();
          const weekdayName = weekdayNames[dayOfWeek];
          const isToday = dateStr === todayStr;
          const isHoliday = japaneseHolidays[dateStr];
          
          // ãã®æ—¥ã®ã‚¿ã‚¹ã‚¯æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          const dayTasks = allTasks.filter(t => t.date === dateStr);
          const taskCount = dayTasks.length;
          
          let cellClass = 'yearly-cell';
          if (isToday) cellClass += ' today';
          if (dayOfWeek === 0) cellClass += ' sunday';
          if (dayOfWeek === 6) cellClass += ' saturday';
          if (isHoliday) cellClass += ' holiday';
          if (taskCount > 0) cellClass += ' has-task';
          
          // ã‚»ãƒ«å†…å®¹ï¼šæ›œæ—¥ + ã‚¿ã‚¹ã‚¯æ•°
          let cellContent = `<span class="yearly-weekday">${weekdayName}</span>`;
          if (taskCount > 0) {
            cellContent += `<span class="yearly-task-count">${taskCount}</span>`;
          }
          
          html += `<div class="${cellClass}" data-date="${dateStr}" onclick="onYearlyCellClick('${dateStr}')">${cellContent}</div>`;
        }
      }
      
      calendar.innerHTML = html;
    }
    
    // å¹´é–“ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
    function onYearlyCellClick(dateStr) {
      // æœˆé–“ãƒ“ãƒ¥ãƒ¼ã«é·ç§»ã—ã¦ãã®æ—¥ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      const [year, month, day] = dateStr.split('-').map(Number);
      currentMonthDate = new Date(year, month - 1, 1);
      
      // ç›´æ¥æœˆé–“ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºï¼ˆswitchViewã‚’ä½¿ã‚ãšï¼‰
      currentView = 'monthly';
      const dailyView = document.querySelector('.container');
      const weeklyView = document.getElementById('weeklyView');
      const monthlyView = document.getElementById('monthlyView');
      const yearlyView = document.getElementById('yearlyView');
      
      dailyView.style.display = 'none';
      weeklyView.style.display = 'none';
      monthlyView.style.display = 'block';
      yearlyView.style.display = 'none';
      
      document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById('navMonthly').classList.add('active');
      
      renderMonthlyView();
      localStorage.setItem('currentView', 'monthly');
      
      // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰è©²å½“æ—¥ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      setTimeout(() => {
        const targetCell = document.querySelector(`.monthly-day-cell[data-date="${dateStr}"]`);
        if (targetCell) {
          targetCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
          // ãƒã‚¤ãƒ©ã‚¤ãƒˆåŠ¹æœ
          targetCell.style.boxShadow = '0 0 10px #4caf50';
          setTimeout(() => {
            targetCell.style.boxShadow = '';
          }, 2000);
        }
      }, 100);
    }
    
    // å¹´ã‚’å¤‰æ›´
    function changeYear(delta) {
      currentYearDate.setFullYear(currentYearDate.getFullYear() + delta);
      renderYearlyView();
    }
    
    // ã‚¹ãƒãƒ›ç”¨ï¼šç§»å‹•ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
    function startMoveMode(taskId) {
      movingTaskId = taskId;
      
      // ç§»å‹•ä¸­ã®ã‚¿ã‚¹ã‚¯ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      const taskElements = document.querySelectorAll('.monthly-task-item');
      taskElements.forEach(el => {
        if (el.dataset.taskId === taskId) {
          el.classList.add('moving');
        }
      });
      
      // å…¨ã‚»ãƒ«ã‚’ç§»å‹•å…ˆå€™è£œã¨ã—ã¦ãƒãƒ¼ã‚¯
      const cells = document.querySelectorAll('.monthly-day-cell');
      cells.forEach(cell => {
        cell.classList.add('move-target');
      });
      
      // æŒ¯å‹•ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆå¯¾å¿œãƒ‡ãƒã‚¤ã‚¹ã®ã¿ï¼‰
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    }
    
    // ã‚¹ãƒãƒ›ç”¨ï¼šç§»å‹•ãƒ¢ãƒ¼ãƒ‰å®Œäº†
    function completeMoveMode(newDate) {
      if (!movingTaskId) return;
      
      // ã‚¿ã‚¹ã‚¯ã®æ—¥ä»˜ã‚’æ›´æ–°
      updateTask(movingTaskId, { date: newDate });
      
      // ç§»å‹•ãƒ¢ãƒ¼ãƒ‰çµ‚äº†
      movingTaskId = null;
      
      // å†æç”»
      renderMonthlyView();
      renderWeeklyView();
      
      // æ—¥æ¬¡ã‚‚å†æç”»
      for (let sec = 1; sec <= 4; sec++) {
        renderTasks(sec);
      }
      
      // æŒ¯å‹•ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
      if (navigator.vibrate) {
        navigator.vibrate([30, 30, 30]);
      }
    }
    
    // ã‚¹ãƒãƒ›ç”¨ï¼šç§»å‹•ãƒ¢ãƒ¼ãƒ‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    function cancelMoveMode() {
      if (!movingTaskId) return;
      
      movingTaskId = null;
      
      // ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤
      document.querySelectorAll('.monthly-task-item.moving').forEach(el => {
        el.classList.remove('moving');
      });
      document.querySelectorAll('.monthly-day-cell.move-target').forEach(el => {
        el.classList.remove('move-target');
      });
    }
    
    function formatDateForDisplay(dateStr) {
      const date = new Date(dateStr);
      const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const weekday = weekdays[date.getDay()];
      return `${date.getFullYear()}/${month}/${day}ï¼ˆ${weekday}ï¼‰`;
    }
    
    function openMonthlyTaskAddModal(dateStr) {
      document.getElementById('monthlyModalTitle').textContent = 'ã‚¿ã‚¹ã‚¯è¿½åŠ ';
      document.getElementById('monthlyTaskInput').value = '';
      document.getElementById('monthlyTaskMemo').value = '';
      document.getElementById('monthlyTaskDate').value = dateStr;
      document.getElementById('monthlyTaskId').value = '';
      clearTimeSelect('monthly'); // æ™‚é–“ãªã—
      document.getElementById('monthlyTaskSection').value = '2'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç¬¬2è±¡é™
      document.getElementById('monthlyDeleteBtn').style.display = 'none';
      document.getElementById('monthlyTaskModal').classList.add('show');
      document.getElementById('monthlyTaskInput').focus();
    }
    
    function openMonthlyTaskEditModal(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (!task) return;
      
      document.getElementById('monthlyModalTitle').textContent = 'ã‚¿ã‚¹ã‚¯ç·¨é›†';
      document.getElementById('monthlyTaskInput').value = task.text;
      document.getElementById('monthlyTaskMemo').value = task.memo || '';
      document.getElementById('monthlyTaskDate').value = task.date;
      document.getElementById('monthlyTaskId').value = task.id;
      setTimeSelect('monthly', task.time); // æ™‚é–“ãŒã‚ã‚Œã°è¨­å®š
      document.getElementById('monthlyTaskSection').value = task.section;
      document.getElementById('monthlyDeleteBtn').style.display = 'inline-block';
      document.getElementById('monthlyTaskModal').classList.add('show');
      document.getElementById('monthlyTaskInput').focus();
    }
    
    function closeMonthlyTaskModal() {
      document.getElementById('monthlyTaskModal').classList.remove('show');
    }
    
    function saveMonthlyTask() {
      const text = document.getElementById('monthlyTaskInput').value.trim();
      const memo = document.getElementById('monthlyTaskMemo').value.trim();
      const dateStr = document.getElementById('monthlyTaskDate').value;
      const taskId = document.getElementById('monthlyTaskId').value;
      const time = getTimeFromSelect('monthly');
      const section = parseInt(document.getElementById('monthlyTaskSection').value);
      
      if (!text) {
        alert('ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!dateStr) {
        alert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // æ™‚é–“ãŒã‚ã‚Œã°é€±é–“ã«ã‚‚è¡¨ç¤º
      const showInWeekly = time ? true : false;
      
      if (taskId) {
        // ç·¨é›†ï¼ˆæ—¥ä»˜ã‚‚æ›´æ–°ï¼‰
        updateTask(taskId, { text, memo: memo || null, date: dateStr, time, section, showInWeekly });
      } else {
        // æ–°è¦ä½œæˆ
        const newTask = createTask(text, dateStr, time, section, true, showInWeekly);
        if (memo) {
          updateTask(newTask.id, { memo });
        }
      }
      
      closeMonthlyTaskModal();
      renderMonthlyView();
      
      // é€±é–“ã‚‚å†æç”»
      renderWeeklyView();
      
      // æ—¥æ¬¡ã‚‚å†æç”»
      for (let i = 1; i <= 4; i++) {
        renderTasks(i);
      }
    }
    
    function deleteMonthlyTask() {
      const taskId = document.getElementById('monthlyTaskId').value;
      if (!taskId) return;
      
      if (confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        deleteTaskById(taskId);
        closeMonthlyTaskModal();
        renderMonthlyView();
        
        // æ—¥æ¬¡ã‚‚å†æç”»
        for (let i = 1; i <= 4; i++) {
          renderTasks(i);
        }
      }
    }

    // é€±é–“ã‚¿ã‚¹ã‚¯ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openWeeklyTaskCreateModal(dateStr, hour) {
      creatingTask = { dateStr, hour };
      
      // æ—¥ä»˜è¡¨ç¤ºã‚’è¨­å®š
      document.getElementById('weeklyModalDate').textContent = formatDateForDisplay(dateStr);
      
      // ã‚¿ã‚¹ã‚¯åã‚’ã‚¯ãƒªã‚¢
      document.getElementById('createTaskText').value = '';
      
      // è±¡é™ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
      document.getElementById('createTaskSection').value = '2';
      
      // æ™‚é–“ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆï¼ˆ15åˆ†åˆ»ã¿ï¼‰
      const timeSelect = document.getElementById('createTaskTime');
      timeSelect.innerHTML = '';
      for (let h = 0; h <= 23; h++) {
        for (let min = 0; min < 60; min += 15) {
          const timeStr = `${String(h).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
          const option = document.createElement('option');
          option.value = timeStr;
          option.textContent = timeStr;
          if (h === hour && min === 0) {
            option.selected = true;
          }
          timeSelect.appendChild(option);
        }
      }
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      document.getElementById('weeklyTaskCreateModal').classList.add('show');
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      setTimeout(() => {
        document.getElementById('createTaskText').focus();
      }, 100);
    }
    
    // ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeCreateModal() {
      document.getElementById('weeklyTaskCreateModal').classList.remove('show');
      document.getElementById('createTaskMemo').value = '';
      creatingTask = null;
    }
    
    // ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
    function saveCreateTask() {
      if (!creatingTask) return;
      
      const taskText = document.getElementById('createTaskText').value.trim();
      const taskMemo = document.getElementById('createTaskMemo').value.trim();
      const taskTime = document.getElementById('createTaskTime').value;
      const taskSection = parseInt(document.getElementById('createTaskSection').value);
      
      if (!taskText) {
        alert('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // é€±é–“ã‚¿ã‚¹ã‚¯ä½œæˆæ™‚ã¯æ—¥æ¬¡ã«ã‚‚é€±é–“ã«ã‚‚è¡¨ç¤º
      const showInDaily = true;
      const showInWeekly = true;
      
      // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ 
      const newTask = createTask(taskText, creatingTask.dateStr, taskTime, taskSection, showInDaily, showInWeekly);
      
      // ãƒ¡ãƒ¢ãŒã‚ã‚Œã°è¨­å®š
      if (taskMemo) {
        updateTask(newTask.id, { memo: taskMemo });
      }
      
      closeCreateModal();
      renderWeeklyView();
      renderMonthlyView();
      
      // æ—¥æ¬¡ã‚‚å†æç”»
      for (let sec = 1; sec <= 4; sec++) {
        renderTasks(sec);
      }
    }

    // é€±é–“ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤
    // é€±é–“ã‚¿ã‚¹ã‚¯å‰Šé™¤ï¼ˆæ—§ã‚·ã‚¹ãƒ†ãƒ ãƒ»ãƒ‡ãƒƒãƒ‰ã‚³ãƒ¼ãƒ‰å‰Šé™¤æ¸ˆã¿ï¼‰
    // â†’ editWeeklyTaskByIdã¾ãŸã¯deleteTaskByIdã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„

    // é€±é–“ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ï¼ˆæ—§ã‚·ã‚¹ãƒ†ãƒ ãƒ»ãƒ‡ãƒƒãƒ‰ã‚³ãƒ¼ãƒ‰å‰Šé™¤æ¸ˆã¿ï¼‰
    // â†’ saveAllTasks()ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„

    // é€±é–“ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆæ—§ã‚·ã‚¹ãƒ†ãƒ ãƒ»ç§»è¡Œå‡¦ç†ç”¨ã«ä¿æŒï¼‰
    function loadWeeklyData() {
      const saved = localStorage.getItem('weeklyTasks');
      if (saved) {
        try {
          weeklyTasks = JSON.parse(saved);
        } catch (e) {
          console.error('é€±é–“ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', e);
        }
      }
    }

    // ã‚¿ã‚¤ãƒãƒ¼é–¢é€£é–¢æ•°
    function handleTimerClick() {
      stopTimer(); // ç¾åœ¨ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
      
      if (timerState === 'idle') {
        // ã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ã§ã¯ä½•ã‚‚ã—ãªã„ï¼ˆç¢ºå®šãƒœã‚¿ãƒ³ã‹ã‚‰é–‹å§‹ï¼‰
        return;
      } else if (timerState === 'thinking') {
        // ç›®çš„å‡ºã— â†’ ã‚¤ãƒ¡ãƒ¼ã‚¸
        timerState = 'imagine';
        timeLeft = 60;
        startTimer();
      } else if (timerState === 'imagine') {
        // ã‚¤ãƒ¡ãƒ¼ã‚¸ â†’ æ›¸ãå‡ºã—
        timerState = 'writing';
        timeLeft = 60;
        startTimer();
      } else if (timerState === 'writing') {
        // æ›¸ãå‡ºã— â†’ é¸æŠ
        timerState = 'selecting';
        timeLeft = 5;
        startTimer();
      } else if (timerState === 'selecting') {
        // é¸æŠ â†’ å®Ÿè¡Œï¼ˆä¸€ç•ªä¸Šã‚’è‡ªå‹•é¸æŠï¼‰
        autoSelectTopTask();
        timerState = 'executing';
        timeLeft = 60;
        startTimer();
      } else if (timerState === 'executing') {
        // å®Ÿè¡Œ â†’ å®Œäº†ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸è§£é™¤ï¼‰
        selectedTaskText = null;
        for (let i = 1; i <= 4; i++) {
          renderTasks(i);
        }
        timerState = 'complete';
        updateTimerDisplay();
      } else if (timerState === 'complete') {
        // å®Œäº† â†’ ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­é–‹å§‹
        pomodoroCount = 0;
        timerState = 'pomodoro';
        timeLeft = 25 * 60; // 25åˆ†
        startTimer();
      } else if (timerState === 'pomodoro') {
        // ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­å®Ÿè¡Œä¸­ â†’ ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ä¼‘æ†©ã¸
        timerState = 'pomodoroBreak';
        timeLeft = 5 * 60; // 5åˆ†
        startTimer();
      } else if (timerState === 'pomodoroBreak') {
        // ä¼‘æ†©ä¸­ â†’ ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å®Ÿè¡Œã¸
        pomodoroCount++;
        if (pomodoroCount >= 2) {
          timerState = 'pomodoroComplete';
          updateTimerDisplay();
        } else {
          timerState = 'pomodoro';
          timeLeft = 25 * 60;
          startTimer();
        }
      } else if (timerState === 'pomodoroComplete') {
        // ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­å®Œäº† â†’ å®Œå…¨ãƒªã‚»ãƒƒãƒˆï¼ˆç›®çš„å…¥åŠ›ã«æˆ»ã‚‹ï¼‰
        timerState = 'idle';
        timeLeft = 60;
        selectedTaskText = null;
        pomodoroCount = 0;
        purpose = '';
        purposeConfirmed = false;
        
        // ç›®çš„å…¥åŠ›ç”»é¢ã«æˆ»ã™
        document.getElementById('purposeGroup').style.display = 'flex';
        document.getElementById('purposeDisplay').style.display = 'none';
        document.getElementById('purposeInput').value = '';
        
        // ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤
        for (let i = 1; i <= 4; i++) {
          renderTasks(i);
        }
        
        updateTimerDisplay();
      }
    }

    function startTimer() {
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        if (timeLeft <= 0) {
          stopTimer();
          if (timerState === 'thinking') {
            timerState = 'imagine';
            timeLeft = 60;
            updateTimerDisplay();
            setTimeout(() => startTimer(), 100);
          } else if (timerState === 'imagine') {
            timerState = 'writing';
            timeLeft = 60;
            updateTimerDisplay();
            setTimeout(() => startTimer(), 100);
          } else if (timerState === 'writing') {
            timerState = 'selecting';
            timeLeft = 5; // 5ç§’ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
            updateTimerDisplay();
            setTimeout(() => startTimer(), 100);
          } else if (timerState === 'selecting') {
            // 5ç§’çµŒéï¼šä¸€ç•ªä¸Šã®ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•é¸æŠ
            autoSelectTopTask();
            timerState = 'executing';
            timeLeft = 60;
            updateTimerDisplay();
            setTimeout(() => startTimer(), 100);
          } else if (timerState === 'executing') {
            // å®Ÿè¡Œçµ‚äº†ï¼šã‚ªãƒ¬ãƒ³ã‚¸è§£é™¤
            selectedTaskText = null;
            // å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            for (let i = 1; i <= 4; i++) {
              renderTasks(i);
            }
            timerState = 'complete';
            updateTimerDisplay();
          } else if (timerState === 'pomodoro') {
            // ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­25åˆ†çµ‚äº† â†’ ä¼‘æ†©ã¸
            timerState = 'pomodoroBreak';
            timeLeft = 5 * 60; // 5åˆ†
            updateTimerDisplay();
            setTimeout(() => startTimer(), 100);
          } else if (timerState === 'pomodoroBreak') {
            // ä¼‘æ†©5åˆ†çµ‚äº† â†’ æ¬¡ã®ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã¸
            pomodoroCount++;
            if (pomodoroCount >= 2) {
              timerState = 'pomodoroComplete';
              updateTimerDisplay();
            } else {
              timerState = 'pomodoro';
              timeLeft = 25 * 60; // 25åˆ†
              updateTimerDisplay();
              setTimeout(() => startTimer(), 100);
            }
          }
        }
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function updateTimerDisplay() {
      const btn = document.getElementById('timerBtn');
      if (!btn) return;

      let text = '';
      let color = '#3b82f6'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šé®®ã‚„ã‹ãªé’

      if (timerState === 'idle') {
        text = '';
        color = '#3b82f6'; // é®®ã‚„ã‹ãªé’ - ã‚¹ã‚¿ãƒ¼ãƒˆ
      } else if (timerState === 'countdown') {
        // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ä¸­ã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„ï¼ˆconfirmPurposeå†…ã§ç›´æ¥è¨­å®šï¼‰
        return;
      } else if (timerState === 'thinking') {
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        text = `ç›®ã®å‰ã®1åˆ†ã‚’æœ€é«˜å¯†åº¦ã«ï¼ ${mins}:${secs.toString().padStart(2, '0')}`;
        if (timeLeft > 30) color = '#22c55e'; // ãƒ©ã‚¤ãƒ ã‚°ãƒªãƒ¼ãƒ³ - GO!
        else if (timeLeft > 10) color = '#f59e0b'; // ã‚´ãƒ¼ãƒ«ãƒ‰ - é›†ä¸­
        else color = '#dc2626'; // èµ¤ - ãƒ©ã‚¹ãƒˆ!
      } else if (timerState === 'imagine') {
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        text = `ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ ï¼æœ€é«˜ã®ç†æƒ³ã‚’æ€ã„æãï¼ ${mins}:${secs.toString().padStart(2, '0')}`;
        if (timeLeft > 40) color = '#22c55e'; // é®®ã‚„ã‹ãªç·‘
        else if (timeLeft > 20) color = '#4ade80'; // å„ªã—ã„ç·‘
        else color = '#86efac'; // ã•ã‚‰ã«å„ªã—ã„ç·‘
      } else if (timerState === 'writing') {
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        text = `æ€ã„ã¤ãã“ã¨å…¨éƒ¨æ›¸ãå‡ºã›ï¼åãå‡ºã›ï¼ ${mins}:${secs.toString().padStart(2, '0')}`;
        if (timeLeft > 30) color = '#22c55e';
        else if (timeLeft > 10) color = '#f59e0b';
        else color = '#dc2626';
      } else if (timerState === 'selecting') {
        text = `5ç§’ã§é¸ã¹ã€ã‚»ãƒ³ã‚¿ãƒ¼ãƒ”ãƒ³ï¼ ${timeLeft}`;
        color = '#dc2626'; // èµ¤ - ç·Šæ€¥
      } else if (timerState === 'executing') {
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        text = `ã“ã‚Œã‹ã‚‰1åˆ†ã ã‘ã€ä½œæ¥­ã«æ²¡é ­ã—ã¦ã¿ã‚ˆã†ï¼ ${mins}:${secs.toString().padStart(2, '0')}`;
        if (timeLeft > 30) color = '#22c55e'; // ãƒ©ã‚¤ãƒ ã‚°ãƒªãƒ¼ãƒ³ - GO!
        else if (timeLeft > 10) color = '#f59e0b'; // ã‚´ãƒ¼ãƒ«ãƒ‰ - é›†ä¸­
        else color = '#dc2626'; // èµ¤ - ãƒ©ã‚¹ãƒˆ!
      } else if (timerState === 'complete') {
        text = 'Keep Going!';
        color = '#e0e0e0'; // ã‚°ãƒ¬ãƒ¼ï¼ˆç¢ºå®šãƒœã‚¿ãƒ³ã¨åŒã˜ï¼‰
      } else if (timerState === 'pomodoro') {
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        text = `ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼å®Ÿè¡Œä¸­ ${mins}:${secs.toString().padStart(2, '0')} [${pomodoroCount + 1}/2]`;
        if (timeLeft > 15 * 60) color = '#22c55e'; // ç·‘
        else if (timeLeft > 5 * 60) color = '#f59e0b'; // ã‚´ãƒ¼ãƒ«ãƒ‰
        else color = '#dc2626'; // èµ¤
      } else if (timerState === 'pomodoroBreak') {
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        text = `ä¼‘æ†©ä¸­ ${mins}:${secs.toString().padStart(2, '0')} [${pomodoroCount}/2]`;
        color = '#4ade80'; // å„ªã—ã„ç·‘
      } else if (timerState === 'pomodoroComplete') {
        text = 'è‡ªåˆ†ã¨ã®ç´„æŸã‚’æœãŸãã†';
        color = '#e0e0e0'; // ã‚°ãƒ¬ãƒ¼
      }

      btn.textContent = text;
      btn.style.backgroundColor = color;
      
      // idleçŠ¶æ…‹ã®æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
      if (timerState === 'idle') {
        btn.style.display = 'none';
      } else {
        btn.style.display = 'block';
      }
      
      // Keep Going!ã¨ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­å®Œäº†ã®æ™‚ã¯æ–‡å­—è‰²ã‚‚ã‚°ãƒ¬ãƒ¼ã«
      if (timerState === 'complete' || timerState === 'pomodoroComplete') {
        btn.style.color = '#666';
      } else {
        btn.style.color = 'white';
      }
    }

    // ã‚¿ã‚¹ã‚¯é¸æŠ
    function selectTask(sectionNum, index) {
      const today = getLocalDateStr(new Date());
      const dailyTasks = getDailyTasks(today);
      if (dailyTasks[sectionNum] && dailyTasks[sectionNum][index]) {
        selectTaskById(dailyTasks[sectionNum][index].id);
      }
    }

    // IDç‰ˆï¼šã‚¿ã‚¹ã‚¯é¸æŠ
    function selectTaskById(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (task) {
        selectedTaskText = task.text;
        // å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        for (let i = 1; i <= 4; i++) {
          renderTasks(i);
        }
      }
    }

    // ä¸€ç•ªä¸Šã®ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•é¸æŠ
    function autoSelectTopTask() {
      const today = getLocalDateStr(new Date());
      const dailyTasks = getDailyTasks(today);
      if (dailyTasks[1].length > 0) {
        selectTaskById(dailyTasks[1][0].id);
      }
    }

    // ã‚¿ã‚¹ã‚¯è¿½åŠ 
    function addTask(sectionNum) {
      const input = document.getElementById('input' + sectionNum);
      const text = input.value.trim();
      
      if (text) {
        const today = getLocalDateStr(new Date());
        
        
        // æ—¥æ¬¡ã‚¿ã‚¹ã‚¯ã¯æ—¥æ¬¡ã®ã¿ã«è¡¨ç¤º
        const newTask = createTask(text, today, null, sectionNum, true, false);
        
        
        input.value = '';
        renderTasks(sectionNum);
      }
    }

    // ã‚¿ã‚¹ã‚¯å®Œäº†ãƒˆã‚°ãƒ«ï¼ˆIDç‰ˆï¼‰
    function toggleTaskById(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (task) {
        task.completed = !task.completed;
        task.updatedAt = new Date().toISOString();
        saveAllTasks();
        
        // æ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼ï¼šå…¨è±¡é™ã‚’å†æç”»
        for (let sec = 1; sec <= 4; sec++) {
          renderTasks(sec);
        }
        
        // é€±é–“ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãŸã‚‰æ›´æ–°
        if (document.getElementById('weeklyView').style.display === 'block') {
          renderWeeklyView();
        }
      }
    }

    // ã‚¿ã‚¹ã‚¯å®Œäº†ãƒˆã‚°ãƒ«ï¼ˆæ—§ç‰ˆãƒ»äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
    function toggleTask(sectionNum, index) {
      const today = getLocalDateStr(new Date());
      const dailyTasks = getDailyTasks(today);
      const task = dailyTasks[sectionNum][index];
      if (task) {
        toggleTaskById(task.id);
      }
    }

    // ã‚¿ã‚¹ã‚¯ç·¨é›†ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ï¼‰
    function editTask(sectionNum, index, textSpan) {
      const today = getLocalDateStr(new Date());
      const dailyTasks = getDailyTasks(today);
      if (dailyTasks[sectionNum] && dailyTasks[sectionNum][index]) {
        editTaskById(dailyTasks[sectionNum][index].id, textSpan);
      }
    }

    // IDç‰ˆï¼šã‚¿ã‚¹ã‚¯ç·¨é›†
    function editTaskById(taskId, textSpan) {
      openTaskEditModal(taskId);
    }
    
    // ===== ã‚«ã‚¹ã‚¿ãƒ æ™‚é–“ãƒ”ãƒƒã‚«ãƒ¼ï¼ˆã‚»ãƒ¬ã‚¯ãƒˆå¼ï¼‰ =====
    
    // ã‚»ãƒ¬ã‚¯ãƒˆã‹ã‚‰æ™‚é–“ã‚’å–å¾—
    function getTimeFromSelect(prefix) {
      const hourSelect = document.getElementById(prefix + 'HourSelect');
      const minuteSelect = document.getElementById(prefix + 'MinuteSelect');
      
      if (!hourSelect || !minuteSelect) return null;
      
      const hour = hourSelect.value;
      const minute = minuteSelect.value;
      
      if (hour === '' || minute === '') return null;
      
      return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
    }
    
    // ã‚»ãƒ¬ã‚¯ãƒˆã«æ™‚é–“ã‚’è¨­å®š
    function setTimeSelect(prefix, timeStr) {
      const hourSelect = document.getElementById(prefix + 'HourSelect');
      const minuteSelect = document.getElementById(prefix + 'MinuteSelect');
      
      if (!hourSelect || !minuteSelect) return;
      
      if (timeStr && timeStr.includes(':')) {
        const [h, m] = timeStr.split(':').map(Number);
        hourSelect.value = h;
        // åˆ†ã¯5åˆ†åˆ»ã¿ãªã®ã§ã€æœ€ã‚‚è¿‘ã„å€¤ã«ä¸¸ã‚ã‚‹
        const roundedMinute = Math.round(m / 5) * 5;
        minuteSelect.value = roundedMinute >= 60 ? 55 : roundedMinute;
      } else {
        hourSelect.value = '';
        minuteSelect.value = '';
      }
    }
    
    // æ™‚é–“ã‚’ã‚¯ãƒªã‚¢
    function clearTimeSelect(prefix) {
      const hourSelect = document.getElementById(prefix + 'HourSelect');
      const minuteSelect = document.getElementById(prefix + 'MinuteSelect');
      
      if (hourSelect) hourSelect.value = '';
      if (minuteSelect) minuteSelect.value = '';
    }
    
    // ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openTaskEditModal(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (!task) return;
      
      document.getElementById('taskEditId').value = taskId;
      document.getElementById('taskEditText').value = task.text;
      document.getElementById('taskEditMemo').value = task.memo || '';
      document.getElementById('taskEditDate').value = task.date || '';
      
      // ã‚»ãƒ¬ã‚¯ãƒˆã«æ™‚é–“ã‚’è¨­å®š
      setTimeSelect('taskEdit', task.time);
      
      document.getElementById('taskEditModal').classList.add('show');
      
      // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      setTimeout(() => {
        document.getElementById('taskEditText').focus();
      }, 100);
    }
    
    // ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeTaskEditModal() {
      document.getElementById('taskEditModal').classList.remove('show');
    }
    
    // ã‚¿ã‚¹ã‚¯ç·¨é›†ã‚’ä¿å­˜
    function saveTaskEdit() {
      const taskId = document.getElementById('taskEditId').value;
      const text = document.getElementById('taskEditText').value.trim();
      const memo = document.getElementById('taskEditMemo').value.trim();
      const date = document.getElementById('taskEditDate').value;
      const time = getTimeFromSelect('taskEdit');
      
      if (!text) {
        alert('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!date) {
        alert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      updateTask(taskId, { 
        text: text, 
        memo: memo || null,
        date: date,
        time: time
      });
      
      closeTaskEditModal();
      
      // å…¨ç”»é¢ã‚’å†æç”»
      const dateStr = currentDailyDate || getLocalDateStr(new Date());
      for (let sec = 1; sec <= 4; sec++) {
        renderTasks(sec, dateStr);
      }
      renderWeeklyView();
      if (document.getElementById('monthlyView').style.display === 'block') {
        renderMonthlyView();
      }
    }
    
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰å‰Šé™¤
    function deleteTaskFromEditModal() {
      const taskId = document.getElementById('taskEditId').value;
      const task = allTasks.find(t => t.id === taskId);
      
      if (!task) return;
      
      if (confirm(`ã€Œ${task.text}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        removeTaskFromMaster(taskId);
        closeTaskEditModal();
        
        // å…¨ç”»é¢ã‚’å†æç”»
        const dateStr = currentDailyDate || getLocalDateStr(new Date());
        for (let sec = 1; sec <= 4; sec++) {
          renderTasks(sec, dateStr);
        }
        renderWeeklyView();
        if (document.getElementById('monthlyView').style.display === 'block') {
          renderMonthlyView();
        }
      }
    }

    // ã‚¿ã‚¹ã‚¯å‰Šé™¤ï¼ˆæ—§ç‰ˆï¼‰
    function deleteTask(sectionNum, index) {
      const today = getLocalDateStr(new Date());
      const dailyTasks = getDailyTasks(today);
      if (dailyTasks[sectionNum] && dailyTasks[sectionNum][index]) {
        deleteTaskById(dailyTasks[sectionNum][index].id);
      }
    }

    // IDç‰ˆï¼šã‚¿ã‚¹ã‚¯å‰Šé™¤
    function deleteTaskById(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (!task) {
        console.error('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', taskId);
        return;
      }
      
      
      const index = allTasks.findIndex(t => t.id === taskId);
      if (index !== -1) {
        allTasks.splice(index, 1);
        saveAllTasks();
      }
      
      // æ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼ï¼šå…¨è±¡é™ã‚’å†æç”»
      for (let sec = 1; sec <= 4; sec++) {
        renderTasks(sec);
      }
      
      // é€±é–“ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãŸã‚‰æ›´æ–°
      if (document.getElementById('weeklyView').style.display === 'block') {
        renderWeeklyView();
      }
    }

    // æ—§deleteTaské–¢æ•°ã¯å‰Šé™¤æ¸ˆã¿

    // ã‚¿ã‚¹ã‚¯ã‹ã‚‰é€ƒã’ã‚‹
    // ãƒ­ã‚°è¨˜éŒ²é–¢æ•°
    function logAction(type, taskText = '') {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1; // 0-indexed
      const day = now.getDate();
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      
      const dateStr = `${year}/${month}/${day}`;
      const timeStr = `${hours}:${minutes}`;
      
      const logEntry = {
        date: `${dateStr} ${timeStr}`,
        type: type, // 'open', 'inspect', 'escape'
      };
      
      if (type === 'escape') {
        logEntry.task = taskText;
      }
      
      escapeLog.push(logEntry);
      
      // LocalStorageã«ä¿å­˜
      localStorage.setItem('escapeLog', JSON.stringify(escapeLog));
    }

    function escapeTask(sectionNum, index) {
      const today = getLocalDateStr(new Date());
      const dailyTasks = getDailyTasks(today);
      if (dailyTasks[sectionNum] && dailyTasks[sectionNum][index]) {
        escapeTaskById(dailyTasks[sectionNum][index].id);
      }
    }

    // IDç‰ˆï¼šã‚¿ã‚¹ã‚¯ã‹ã‚‰é€ƒã’ã‚‹
    function escapeTaskById(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (!task) return;
      
      // é€ƒã’ãƒ­ã‚°ã«è¨˜éŒ²
      logAction('escape', task.text);
      
      // ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤
      const section = task.section;
      const index = allTasks.findIndex(t => t.id === taskId);
      if (index !== -1) {
        allTasks.splice(index, 1);
        saveAllTasks();
      }
      renderTasks(section);
      
      // ã€Œé€ƒã’å‡ºã—ãŸï¼ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
      showEscapeMessage();
    }

    // é€ƒã’å‡ºã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    function showEscapeMessage() {
      const msg = document.getElementById('escapeMessage');
      msg.classList.add('show');
      setTimeout(() => {
        msg.classList.remove('show');
      }, 1000);
    }

    // ã‚¿ã‚¹ã‚¯è¡¨ç¤ºï¼ˆdateStrãŒnullãªã‚‰ä»Šæ—¥ï¼‰
    function renderTasks(sectionNum, dateStr = null) {
      const list = document.getElementById('list' + sectionNum);
      list.innerHTML = '';
      
      // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
      const targetDate = dateStr || getLocalDateStr(new Date());
      const dailyTasks = getDailyTasks(targetDate);
      const sectionTasks = dailyTasks[sectionNum];
      
      sectionTasks.forEach((task, index) => {
        const li = document.createElement('li');
        li.className = 'task-item' + (task.completed ? ' completed' : '');
        li.dataset.taskId = task.id;  // IDã‚’ä¿å­˜
        
        // é¸æŠã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆIDã§ç…§åˆï¼‰
        if (selectedTaskText && task.text === selectedTaskText) {
          li.classList.add('selected-task');
        }
        
        li.draggable = true;
        li.dataset.index = index;
        li.dataset.section = sectionNum;
        
        // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
        li.addEventListener('dragstart', (e) => {
          li.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', JSON.stringify({
            taskId: task.id,  // IDã‚’ä½¿ç”¨
            section: sectionNum,
            index: index,
            task: task
          }));
        });
        
        // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
        li.addEventListener('dragend', (e) => {
          li.classList.remove('dragging');
          document.querySelectorAll('.task-item').forEach(item => {
            item.classList.remove('drag-over-top', 'drag-over-bottom');
          });
          document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('drag-over-section');
          });
        });
        
        // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
        li.addEventListener('dragover', (e) => {
          e.preventDefault();
          const dragging = document.querySelector('.dragging');
          if (dragging && dragging !== li) {
            // å…¨ã¦ã®ã‚¿ã‚¹ã‚¯ã§ä¸ŠåŠåˆ†/ä¸‹åŠåˆ†ã‚’åˆ¤å®š
            const rect = li.getBoundingClientRect();
            const midpoint = rect.top + rect.height / 2;
            
            li.classList.remove('drag-over-top', 'drag-over-bottom');
            if (e.clientY < midpoint) {
              li.classList.add('drag-over-top');
            } else {
              li.classList.add('drag-over-bottom');
            }
          }
        });
        
        // ãƒ‰ãƒ©ãƒƒã‚°é›¢è„±
        li.addEventListener('dragleave', (e) => {
          li.classList.remove('drag-over-top', 'drag-over-bottom');
        });
        
        // ãƒ‰ãƒ­ãƒƒãƒ—
        li.addEventListener('drop', (e) => {
          e.preventDefault();
          e.stopPropagation();
          li.classList.remove('drag-over-top', 'drag-over-bottom');
          
          const dragging = document.querySelector('.dragging');
          if (!dragging || dragging === li) return;
          
          try {
            const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
            const taskId = dragData.taskId;
            const fromSection = dragData.section;
            const toSection = parseInt(li.dataset.section);
            const dropIndex = parseInt(li.dataset.index);
            
            // ä¸ŠåŠåˆ†ã‹ä¸‹åŠåˆ†ã‹ã‚’åˆ¤å®š
            const rect = li.getBoundingClientRect();
            const midpoint = rect.top + rect.height / 2;
            const insertBefore = e.clientY < midpoint;
            
            // å¯¾è±¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¹ã‚¯ã‚’å–å¾—ï¼ˆorderé †ï¼‰
            const dailyTasks = getDailyTasks(targetDate);
            const targetTasks = dailyTasks[toSection];
            
            // æ–°ã—ã„orderã‚’è¨ˆç®—
            let newOrder;
            if (targetTasks.length === 0) {
              newOrder = 0;
            } else if (insertBefore) {
              // ä¸Šã«æŒ¿å…¥ï¼šã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®orderã‚ˆã‚Šå°ã•ã„å€¤
              const targetOrder = targetTasks[dropIndex]?.order || 0;
              const prevOrder = dropIndex > 0 ? (targetTasks[dropIndex - 1]?.order || 0) : targetOrder - 1;
              newOrder = (prevOrder + targetOrder) / 2;
            } else {
              // ä¸‹ã«æŒ¿å…¥ï¼šã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®orderã‚ˆã‚Šå¤§ãã„å€¤
              const targetOrder = targetTasks[dropIndex]?.order || 0;
              const nextOrder = dropIndex < targetTasks.length - 1 ? (targetTasks[dropIndex + 1]?.order || targetOrder + 1) : targetOrder + 1;
              newOrder = (targetOrder + nextOrder) / 2;
            }
            
            // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆsection ã¨ orderï¼‰
            updateTask(taskId, { section: toSection, order: newOrder });
            
            // ç”»é¢æ›´æ–°ï¼ˆåŒã˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚‚å†æç”»ï¼‰
            renderTasks(fromSection, targetDate);
            if (toSection !== fromSection) {
              renderTasks(toSection, targetDate);
            }
          } catch (err) {
            console.error('ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', err);
          }
        });
        
        const textSpan = document.createElement('span');
        textSpan.className = 'task-text';
        // æ™‚é–“ãŒã‚ã‚Œã°è¡¨ç¤º
        const displayText = task.time ? `${task.time} ${task.text}` : task.text;
        textSpan.textContent = displayText;
        textSpan.onclick = () => {
          if (timerState === 'selecting') {
            // é¸æŠãƒ¢ãƒ¼ãƒ‰ï¼šã‚¿ã‚¹ã‚¯ã‚’é¸æŠ
            selectTaskById(task.id);
          } else {
            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šå®Œäº†ãƒˆã‚°ãƒ«
            toggleTaskById(task.id);
          }
        };
        
        const editBtn = document.createElement('span');
        editBtn.className = 'edit-task-btn';
        editBtn.textContent = 'ğŸ“';
        editBtn.title = task.memo ? 'ãƒ¡ãƒ¢ã‚ã‚Š - ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†' : 'ç·¨é›†ãƒ»ãƒ¡ãƒ¢è¿½åŠ ';
        editBtn.style.opacity = task.memo ? '1' : '0.4';
        editBtn.onclick = (e) => {
          e.stopPropagation();
          editTaskById(task.id, textSpan);
        };
        
        const escapeBtn = document.createElement('span');
        escapeBtn.className = 'escape-btn';
        escapeBtn.textContent = 'ğŸƒ';
        escapeBtn.title = 'é€ƒã’ã‚‹';
        escapeBtn.onclick = (e) => {
          e.stopPropagation();
          escapeTaskById(task.id);
        };
        
        const scheduleBtn = document.createElement('span');
        scheduleBtn.className = 'schedule-btn';
        scheduleBtn.textContent = 'ğŸ“…';
        scheduleBtn.title = 'é€±é–“ã«è¿½åŠ ';
        scheduleBtn.onclick = (e) => {
          e.stopPropagation();
          openDaySelectModalById(task.id);
        };
        
        const deleteBtn = document.createElement('span');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'Ã—';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteTaskById(task.id);
        };
        
        li.appendChild(textSpan);
        li.appendChild(editBtn);
        li.appendChild(escapeBtn);
        li.appendChild(scheduleBtn);
        li.appendChild(deleteBtn);
        list.appendChild(li);
      });
    }
    
    // è±¡é™ã¸ã®ãƒ‰ãƒ­ãƒƒãƒ—ã‚’è¨­å®šï¼ˆåˆæœŸåŒ–æ™‚ã«ä¸€åº¦ã ã‘å‘¼ã¶ï¼‰
    function setupAllSectionDrops() {
      for (let i = 1; i <= 4; i++) {
        const section = document.getElementById('section' + i);
        const list = document.getElementById('list' + i);
        
        section.addEventListener('dragover', (e) => {
          e.preventDefault();
          const dragging = document.querySelector('.dragging');
          if (dragging && dragging.dataset.section != i) {
            section.classList.add('drag-over-section');
          }
        });
        
        section.addEventListener('dragleave', (e) => {
          if (!section.contains(e.relatedTarget)) {
            section.classList.remove('drag-over-section');
          }
        });
        
        section.addEventListener('drop', (e) => {
          e.preventDefault();
          section.classList.remove('drag-over-section');
          
          const dragging = document.querySelector('.dragging');
          if (dragging) {
            try {
              const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
              const taskId = dragData.taskId;
              const fromSection = dragData.section;
              const toSection = i;
              
              if (fromSection !== toSection) {
                // ç§»å‹•å…ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æœ€å¾Œã«orderã‚’è¨­å®š
                const today = getLocalDateStr(new Date());
                const dailyTasks = getDailyTasks(today);
                const targetTasks = dailyTasks[toSection];
                const maxOrder = targetTasks.length > 0 
                  ? Math.max(...targetTasks.map(t => t.order || 0)) + 1 
                  : 0;
                
                // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®sectionã¨orderã‚’æ›´æ–°
                updateTask(taskId, { section: toSection, order: maxOrder });
                
                // ä¸¡æ–¹ã®è±¡é™ã‚’å†æç”»
                renderTasks(fromSection);
                renderTasks(toSection);
              }
            } catch (err) {
              console.error('è±¡é™ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', err);
            }
          }
        });
      }
    }

    // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆæ—§ã‚·ã‚¹ãƒ†ãƒ ãƒ»ãƒ‡ãƒƒãƒ‰ã‚³ãƒ¼ãƒ‰å‰Šé™¤æ¸ˆã¿ï¼‰
    // â†’ saveAllTasks()ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆæ—§ã‚·ã‚¹ãƒ†ãƒ ãƒ»ç§»è¡Œå‡¦ç†ç”¨ã«ä¿æŒï¼‰
    function loadData() {
      const saved = localStorage.getItem('todoData');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          purpose = data.purpose || '';
          purposeConfirmed = data.purposeConfirmed || false;
          stopCondition = data.stopCondition || '';
          stopConditionSaved = data.stopConditionSaved || false;
          tasks = data.tasks || { 1: [], 2: [], 3: [], 4: [] };
          
          if (purposeConfirmed && purpose) {
            document.getElementById('purposeGroup').style.display = 'none';
            document.getElementById('purposeDisplay').style.display = 'flex';
            document.getElementById('purposeText').textContent = 'ç›®çš„: ' + purpose;
            
            // ç›®çš„ãŒç¢ºå®šæ¸ˆã¿ã®å ´åˆã€ã‚¿ã‚¤ãƒãƒ¼ã¯idleçŠ¶æ…‹ã®ã¾ã¾
            // ï¼ˆé’ã„ãƒœã‚¿ãƒ³ã€Œç›®ã®å‰ã®1åˆ†ã‚’ã€œã€ã‚’è¡¨ç¤ºï¼‰
            updateTimerDisplay();
          }
          
          // æ­¢ã‚ã‚‹ä»•çµ„ã¿ã¯ä¿å­˜ã•ã‚Œã¦ã„ã¦ã‚‚ã€ç‚¹æ¤œãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¾ã§è¡¨ç¤ºã—ãªã„
          // if (stopConditionSaved && stopCondition) {
          //   document.getElementById('stopConditionGroup').style.display = 'none';
          //   document.getElementById('stopConditionDisplay').style.display = 'flex';
          //   document.getElementById('stopConditionText').textContent = stopCondition;
          // }
          
          for (let i = 1; i <= 4; i++) {
            renderTasks(i);
          }
        } catch (e) {
          console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', e);
        }
      }
      
      // é€ƒã’ãƒ­ã‚°ã®èª­ã¿è¾¼ã¿
      const savedEscapeLog = localStorage.getItem('escapeLog');
      if (savedEscapeLog) {
        try {
          escapeLog = JSON.parse(savedEscapeLog);
        } catch (e) {
          console.error('é€ƒã’ãƒ­ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', e);
        }
      }
    }

    // å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ - ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function clearAllData() {
      document.getElementById('customModal').classList.add('show');
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeModal() {
      document.getElementById('customModal').classList.remove('show');
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚’å®Ÿéš›ã«å‰Šé™¤
    function executeDelete() {
      closeModal();
      
      // æ—§ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆäº’æ›æ€§ã®ãŸã‚ä¿æŒï¼‰
      localStorage.removeItem('todoData');
      localStorage.removeItem('deepDiveState');
      localStorage.removeItem('useColors');
      localStorage.removeItem('escapeLog');
      
      // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
      localStorage.removeItem('allTasks');
      localStorage.removeItem('taskIdCounter');
      localStorage.removeItem('showInDailyMigrationDone_v1');
      
      // ç›®çš„ãƒ»æ­¢ã‚ã‚‹ä»•çµ„ã¿
      localStorage.removeItem('purpose');
      localStorage.removeItem('purposeConfirmed');
      localStorage.removeItem('stopCondition');
      localStorage.removeItem('stopConditionSaved');
      
      // å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
      allTasks = [];
      taskIdCounter = 1;
      purpose = '';
      purposeConfirmed = false;
      stopCondition = '';
      stopConditionSaved = false;
      tasks = { 1: [], 2: [], 3: [], 4: [] };
      escapeLog = [];
      
      // ã‚¿ã‚¤ãƒãƒ¼çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      timerState = 'idle';
      timeLeft = 60;
      selectedTaskText = null;
      pomodoroCount = 0;
      stopTimer();
      
      document.getElementById('purposeGroup').style.display = 'flex';
      document.getElementById('purposeDisplay').style.display = 'none';
      document.getElementById('purposeInput').value = '';
      document.getElementById('purposeText').textContent = '';
      
      document.getElementById('stopConditionGroup').style.display = 'flex';
      document.getElementById('stopConditionDisplay').style.display = 'none';
      document.getElementById('stopConditionInput').value = '';
      document.getElementById('stopConditionText').textContent = '';
      
      // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
      updateTimerDisplay();
      
      // æ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼ã‚’å†æç”»
      for (let i = 1; i <= 4; i++) {
        renderTasks(i);
      }
      
      // é€±é–“ãƒ“ãƒ¥ãƒ¼ã‚‚å†æç”»
      renderWeeklyView();
    }

    // ===== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ =====
    
    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼šJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function exportData() {
      const exportObj = {
        version: '0.10.2',
        exportedAt: new Date().toISOString(),
        tasks: allTasks
      };
      
      const jsonStr = JSON.stringify(exportObj, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const today = new Date();
      const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
      const filename = `yarukotolist_${dateStr}.json`;
      
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†ï¼\n${allTasks.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚\n\nãƒ•ã‚¡ã‚¤ãƒ«: ${filename}`);
    }
    
    // ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼šJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆtasksã¾ãŸã¯allTasksã‚­ãƒ¼ã«å¯¾å¿œï¼‰
          const tasksData = data.tasks || data.allTasks;
          if (!tasksData || !Array.isArray(tasksData)) {
            throw new Error('ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }
          
          // å„ã‚¿ã‚¹ã‚¯ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
          const validTasks = tasksData.filter(task => {
            if (!task.id || typeof task.id !== 'string') return false;
            if (!task.text || typeof task.text !== 'string') return false;
            if (!task.section || ![1, 2, 3, 4].includes(task.section)) return false;
            if (!task.date || !/^\d{4}-\d{2}-\d{2}$/.test(task.date)) return false;
            return true;
          });
          
          if (validTasks.length === 0) {
            throw new Error('æœ‰åŠ¹ãªã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“');
          }
          
          // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
          const currentCount = allTasks.length;
          const importCount = validTasks.length;
          const skippedCount = tasksData.length - validTasks.length;
          
          let message = `ã‚¤ãƒ³ãƒãƒ¼ãƒˆç¢ºèª\n\n`;
          message += `ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯: ${currentCount}ä»¶\n`;
          message += `ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã‚¿ã‚¹ã‚¯: ${importCount}ä»¶\n`;
          if (skippedCount > 0) {
            message += `ã‚¹ã‚­ãƒƒãƒ—ï¼ˆä¸æ­£ãƒ‡ãƒ¼ã‚¿ï¼‰: ${skippedCount}ä»¶\n`;
          }
          message += `\nã€è¿½åŠ ã€‘ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ \n`;
          message += `ã€ç½®æ›ã€‘ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç½®ãæ›ãˆ\n`;
          message += `ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‘ä½•ã‚‚ã—ãªã„\n\n`;
          message += `ã©ã†ã—ã¾ã™ã‹ï¼Ÿï¼ˆè¿½åŠ =OK / ç½®æ›=ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾Œã«å†åº¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰`;
          
          if (confirm(message)) {
            // è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ï¼šé‡è¤‡ãƒã‚§ãƒƒã‚¯ã—ã¦è¿½åŠ 
            const existingIds = new Set(allTasks.map(t => t.id));
            const newTasks = validTasks.filter(t => !existingIds.has(t.id));
            allTasks = [...allTasks, ...newTasks];
            saveAllTasks();
            
            // purpose, stopConditionã‚‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆã‚ã‚Œã°ï¼‰
            if (data.purpose) {
              localStorage.setItem('purpose', data.purpose);
            }
            if (data.stopCondition) {
              localStorage.setItem('stopCondition', data.stopCondition);
            }
            
            alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼\n${newTasks.length}ä»¶ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`);
            location.reload();
          } else {
            // ç½®æ›ãƒ¢ãƒ¼ãƒ‰ç¢ºèª
            if (confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«ç½®ãæ›ãˆã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼‰')) {
              allTasks = validTasks;
              saveAllTasks();
              
              // purpose, stopConditionã‚‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆã‚ã‚Œã°ï¼‰
              if (data.purpose) {
                localStorage.setItem('purpose', data.purpose);
              }
              if (data.stopCondition) {
                localStorage.setItem('stopCondition', data.stopCondition);
              }
              
              alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼\n${validTasks.length}ä»¶ã«ç½®ãæ›ãˆã¾ã—ãŸã€‚`);
              location.reload();
            } else {
              alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚');
            }
          }
          
        } catch (err) {
          alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${err.message}\n\nãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ã„JSONå½¢å¼ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
        event.target.value = '';
      };
      
      reader.readAsText(file);
    }

    // è‰²åˆ‡ã‚Šæ›¿ãˆ
    function toggleColors() {
      USE_COLORS = !USE_COLORS;
      applyColors();
      // çŠ¶æ…‹ã‚’ä¿å­˜
      localStorage.setItem('useColors', USE_COLORS);
    }

    // é€ƒã’ãƒ­ã‚°ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    function applyColors() {
      const section1 = document.getElementById('section1');
      const section2 = document.getElementById('section2');
      const section3 = document.getElementById('section3');
      const section4 = document.getElementById('section4');
      
      if (USE_COLORS) {
        section1.style.backgroundColor = '#ffe6e6';
        section2.style.backgroundColor = '#e8f5e9';
        section3.style.backgroundColor = '#fffef5';
        section4.style.backgroundColor = '#f5f5f5';
      } else {
        section1.style.backgroundColor = 'white';
        section2.style.backgroundColor = 'white';
        section3.style.backgroundColor = 'white';
        section4.style.backgroundColor = 'white';
      }
    }

    // å…¥åŠ›æ¬„ã§Enterã‚­ãƒ¼æŠ¼ä¸‹æ™‚ã®å‡¦ç†
    for (let i = 1; i <= 4; i++) {
      const input = document.getElementById('input' + i);
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addTask(i);
        }
      });
    }

    // ç›®çš„å…¥åŠ›ã§Enterã‚­ãƒ¼
    document.getElementById('purposeInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        confirmPurpose();
      }
    });

    // åˆæœŸåŒ–
    updateDate();
    
    // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
    loadAllTasks();
    
    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆç§»è¡Œã®ãŸã‚ï¼‰
    loadData();
    loadWeeklyData();
    
    // ç§»è¡Œå®Ÿè¡Œ
    migrateToMasterData();
    
    // æ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼ã‚’åˆæœŸæç”»
    for (let i = 1; i <= 4; i++) {
      renderTasks(i);
    }
    
    setupAllSectionDrops();
    setupDayButtons();
    
    // é€±é–“å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šï¼ˆæ—§ã‚·ã‚¹ãƒ†ãƒ ãƒ»ãƒ‡ãƒƒãƒ‰ã‚³ãƒ¼ãƒ‰å‰Šé™¤æ¸ˆã¿ï¼‰
    // editWeeklyTaskByIdãŒpromptã§ç›´æ¥ç·¨é›†ã™ã‚‹ãŸã‚ä¸è¦
    
    // ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸãƒ­ã‚°ã‚’è¨˜éŒ²
    logAction('open');
    
    // è‰²è¨­å®šã‚’èª­ã¿è¾¼ã¿
    const savedColorSetting = localStorage.getItem('useColors');
    if (savedColorSetting !== null) {
      USE_COLORS = savedColorSetting === 'true';
      applyColors();
    }

    // ã‚¿ã‚¤ãƒãƒ¼ãƒœã‚¿ãƒ³ã®åˆæœŸè¡¨ç¤º
    updateTimerDisplay();

    // æ·±å €å±•é–‹ã®çŠ¶æ…‹ç®¡ç†
    // ãƒ“ãƒ¥ãƒ¼ç®¡ç†ï¼ˆã©ã®ç”»é¢ã‚’è¦‹ã¦ã„ã‚‹ã‹ï¼‰
    let currentView = 'daily'; // 'daily' | 'weekly' | 'monthly' | 'yearly' | 'settings'
    
    // ç‚¹æ¤œçŠ¶æ…‹ï¼ˆæ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼å†…ã§ã®è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‰
    let inspectionMode = 0; // 0: é€šå¸¸, 1: 8ã¤ã®å•ã„è¡¨ç¤º, 2: å±¥æ­´è¡¨ç¤º, 3: ãƒ—ãƒ¬ãƒ¼ãƒ³è¡¨ç¤º

    // èµ·å‹•æ™‚ã®åˆæœŸãƒ“ãƒ¥ãƒ¼ã‚’é©ç”¨
    (function() {
      const initialView = localStorage.getItem('initialView') || 'monthly';
      setTimeout(() => {
        switchView(initialView);
      }, 100);
    })();

    // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
    function switchView(view) {
      currentView = view;
      
      const dailyView = document.querySelector('.container');
      const weeklyView = document.getElementById('weeklyView');
      const monthlyView = document.getElementById('monthlyView');
      const yearlyView = document.getElementById('yearlyView');
      const settingsView = document.getElementById('settingsView');
      
      // å…¨ãƒ“ãƒ¥ãƒ¼ã‚’éè¡¨ç¤º
      dailyView.style.display = 'none';
      weeklyView.style.display = 'none';
      monthlyView.style.display = 'none';
      yearlyView.style.display = 'none';
      settingsView.style.display = 'none';
      
      // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
      
      if (view === 'daily') {
        dailyView.style.display = 'grid';
        document.getElementById('navDaily').classList.add('active');
        // ä»Šæ—¥ã«ãƒªã‚»ãƒƒãƒˆ
        currentDailyDate = null;
        updateDate();  // æ—¥ä»˜è¡¨ç¤ºã‚’ä»Šæ—¥ã«æ›´æ–°
        for (let i = 1; i <= 4; i++) {
          renderTasks(i);
        }
      } else if (view === 'weekly') {
        weeklyView.style.display = 'block';
        document.getElementById('navWeekly').classList.add('active');
        currentWeekDate = new Date(); // ä»Šé€±ã«ãƒªã‚»ãƒƒãƒˆ
        renderWeeklyView();
        // ç¾åœ¨æ™‚åˆ»ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆå°‘ã—ä¸Šã«ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰
        setTimeout(() => {
          const now = new Date();
          const currentHourEl = document.getElementById(`weekly-time-${now.getHours()}`);
          if (currentHourEl) {
            const weeklyViewEl = document.getElementById('weeklyView');
            const elTop = currentHourEl.offsetTop;
            weeklyViewEl.scrollTop = Math.max(0, elTop - 120);
          }
        }, 50);
      } else if (view === 'monthly') {
        monthlyView.style.display = 'block';
        document.getElementById('navMonthly').classList.add('active');
        currentMonthDate = new Date();
        renderMonthlyView();
        applySimpleMode();
      } else if (view === 'yearly') {
        yearlyView.style.display = 'block';
        document.getElementById('navYearly').classList.add('active');
        renderYearlyView();
      } else if (view === 'settings') {
        settingsView.style.display = 'block';
        document.getElementById('navSettings').classList.add('active');
        loadSettingsUI();
      }
      
      // çŠ¶æ…‹ã‚’ä¿å­˜ï¼ˆè¨­å®šç”»é¢ä»¥å¤–ï¼‰
      if (view !== 'settings') {
        localStorage.setItem('currentView', view);
      }
    }

    // ===== è¨­å®šé–¢é€£ =====
    
    // è¨­å®šã‚’UIã«åæ˜ 
    function loadSettingsUI() {
      // åˆæœŸãƒ“ãƒ¥ãƒ¼
      const initialView = localStorage.getItem('initialView') || 'monthly';
      const radios = document.querySelectorAll('input[name="initialView"]');
      radios.forEach(radio => {
        radio.checked = (radio.value === initialView);
      });
      
      // æœˆé–“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
      const monthlyMode = localStorage.getItem('monthlyMode') || 'fixed';
      const monthlyRadios = document.querySelectorAll('input[name="monthlyMode"]');
      monthlyRadios.forEach(radio => {
        radio.checked = (radio.value === monthlyMode);
      });

      // ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰
      const simpleMode = localStorage.getItem('simpleMode') === 'on';
      const simpleToggle = document.getElementById('simpleModeToggle');
      simpleToggle.checked = simpleMode;
      updateSimpleToggleUI(simpleMode);
      document.getElementById('stampSettingsArea').style.display = simpleMode ? 'block' : 'none';
      if (simpleMode) loadStampSettingsUI();
      
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
      const savedName = localStorage.getItem('profileName') || '';
      const savedAvatar = localStorage.getItem('profileAvatar') || '';
      
      document.getElementById('profileNameInput').value = savedName;
      
      if (savedAvatar) {
        document.getElementById('profileAvatarPreview').src = savedAvatar;
        document.getElementById('profileAvatarPreview').style.display = 'block';
        document.getElementById('profileAvatarPlaceholder').style.display = 'none';
        document.getElementById('avatarRemoveBtn').style.display = 'block';
      } else {
        document.getElementById('profileAvatarPreview').style.display = 'none';
        document.getElementById('profileAvatarPlaceholder').style.display = 'flex';
        document.getElementById('avatarRemoveBtn').style.display = 'none';
      }
    }
    
    // ã‚¢ãƒã‚¿ãƒ¼ç”»åƒå¤‰æ›´
    function handleAvatarChange(event) {
      const file = event.target.files[0];
      
      if (!file) {
        return;
      }
      
      
      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ5MBä»¥ä¸‹ã«ç·©å’Œï¼‰
      if (file.size > 5 * 1024 * 1024) {
        alert('ç”»åƒã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
        return;
      }
      
      // ã‚¿ã‚¤ãƒ—ãƒã‚§ãƒƒã‚¯ã‚’ç·©å’Œï¼ˆiOSã§ç©ºã«ãªã‚‹å ´åˆãŒã‚ã‚‹ï¼‰
      const validExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.heic', '.heif'];
      const fileName = file.name.toLowerCase();
      const hasValidExt = validExtensions.some(ext => fileName.endsWith(ext));
      
      if (file.type && !file.type.startsWith('image/') && !hasValidExt) {
        alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      const reader = new FileReader();
      
      reader.onerror = function(err) {
        alert('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      };
      
      reader.onload = function(e) {
        
        const img = new Image();
        
        img.onerror = function(err) {
          alert('ã“ã®ç”»åƒå½¢å¼ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\nJPGã¾ãŸã¯PNGå½¢å¼ã§ãŠè©¦ã—ãã ã•ã„ã€‚');
        };
        
        img.onload = function() {
          try {
            const canvas = document.createElement('canvas');
            const size = 200;
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            
            const minDim = Math.min(img.width, img.height);
            const sx = (img.width - minDim) / 2;
            const sy = (img.height - minDim) / 2;
            
            ctx.drawImage(img, sx, sy, minDim, minDim, 0, 0, size, size);
            
            const resizedBase64 = canvas.toDataURL('image/jpeg', 0.8);
            
            const preview = document.getElementById('profileAvatarPreview');
            preview.src = resizedBase64;
            preview.style.display = 'block';
            document.getElementById('profileAvatarPlaceholder').style.display = 'none';
            document.getElementById('avatarRemoveBtn').style.display = 'block';
            
            localStorage.setItem('profileAvatar', resizedBase64);
            updateNavAvatar();
            
            
          } catch (err) {
            alert('ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    
    // ã‚¢ãƒã‚¿ãƒ¼å‰Šé™¤
    function removeAvatar() {
      document.getElementById('profileAvatarPreview').src = '';
      document.getElementById('profileAvatarPreview').style.display = 'none';
      document.getElementById('profileAvatarPlaceholder').style.display = 'flex';
      document.getElementById('avatarRemoveBtn').style.display = 'none';
      document.getElementById('avatarInput').value = '';
      
      // å³åº§ã«localStorageã‹ã‚‰å‰Šé™¤ï¼†ãƒŠãƒ“æ›´æ–°
      localStorage.removeItem('profileAvatar');
      updateNavAvatar();
    }
    
    // ãƒŠãƒ“ãƒãƒ¼ã®ã‚¢ãƒã‚¿ãƒ¼ã‚’æ›´æ–°
    function updateNavAvatar() {
      const savedAvatar = localStorage.getItem('profileAvatar');
      const navAvatar = document.getElementById('navAvatar');
      const navAvatarWrapper = document.getElementById('navAvatarWrapper');
      const navPlaceholder = document.getElementById('navAvatarPlaceholder');
      
      if (savedAvatar) {
        navAvatar.src = savedAvatar;
        navAvatarWrapper.style.display = 'flex';
        navPlaceholder.style.display = 'none';
      } else {
        navAvatarWrapper.style.display = 'none';
        navPlaceholder.style.display = 'inline';
      }
    }
    
    // è¨­å®šã‚’ä¿å­˜
    function saveSettings() {
      // åˆæœŸãƒ“ãƒ¥ãƒ¼
      const selectedView = document.querySelector('input[name="initialView"]:checked');
      if (selectedView) {
        localStorage.setItem('initialView', selectedView.value);
      }
      
      // æœˆé–“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
      const selectedMonthlyMode = document.querySelector('input[name="monthlyMode"]:checked');
      if (selectedMonthlyMode) {
        localStorage.setItem('monthlyMode', selectedMonthlyMode.value);
      }
      
      // ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰
      const simpleToggle = document.getElementById('simpleModeToggle');
      localStorage.setItem('simpleMode', simpleToggle.checked ? 'on' : 'off');
      
      // ã‚¹ã‚¿ãƒ³ãƒ—è¨­å®šä¿å­˜
      saveStampSettings();
      
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å
      const profileName = document.getElementById('profileNameInput').value.trim();
      localStorage.setItem('profileName', profileName);
      
      // ã‚¢ãƒã‚¿ãƒ¼
      const avatarPreview = document.getElementById('profileAvatarPreview');
      if (avatarPreview.style.display !== 'none' && avatarPreview.src) {
        localStorage.setItem('profileAvatar', avatarPreview.src);
      } else {
        localStorage.removeItem('profileAvatar');
      }
      
      // ãƒŠãƒ“ãƒãƒ¼æ›´æ–°
      updateNavAvatar();
      
      // ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰é©ç”¨
      applySimpleMode();
      
      // ä¿å­˜å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
      
      // ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯æœˆé–“ã«å¼·åˆ¶ç§»å‹•
      if (simpleToggle.checked) {
        switchView('monthly');
      } else {
        switchView(selectedView.value);
      }
    }
    
    // åˆæœŸãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—
    function getInitialView() {
      return localStorage.getItem('initialView') || 'monthly';
    }
    
    // èµ·å‹•æ™‚ã«ãƒŠãƒ“ã‚¢ãƒã‚¿ãƒ¼ã‚’æ›´æ–°
    (function() {
      setTimeout(updateNavAvatar, 50);
    })();

    // ç‰¹å®šã®æ—¥ä»˜ã®æ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼ã¸é·ç§»
    function goToDailyView(dateStr, openTaskId = null) {
      // æ—¥ä»˜ã‚’ä¸€æ™‚ä¿å­˜ï¼ˆæ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼ã§ä½¿ç”¨ï¼‰
      localStorage.setItem('selectedDailyDate', dateStr);
      currentDailyDate = dateStr;  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
      
      // æ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
      switchView('daily');
      
      // æ—¥ä»˜è¡¨ç¤ºã‚’æ›´æ–°
      const dateObj = new Date(dateStr + 'T00:00:00');
      const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const dateText = `${dateObj.getFullYear()}/${dateObj.getMonth() + 1}/${dateObj.getDate()}ï¼ˆ${weekdays[dateObj.getDay()]}ï¼‰`;
      document.getElementById('dateDisplay').textContent = dateText;
      // ã‚¹ãƒãƒ›ç”¨ã®ç¬¬1è±¡é™æ—¥ä»˜ã‚‚åŒæœŸ
      const mobileDate = document.getElementById('dateDisplayMobile');
      if (mobileDate) mobileDate.textContent = dateText;
      
      // ã‚¿ã‚¹ã‚¯ã‚’å†æç”»ï¼ˆé¸æŠã—ãŸæ—¥ä»˜ã§ï¼‰
      for (let i = 1; i <= 4; i++) {
        renderTasks(i, dateStr);
      }
      
      // ã‚¿ã‚¹ã‚¯IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      if (openTaskId) {
        setTimeout(() => {
          openTaskEditModal(openTaskId);
        }, 100);
      }
    }

    // ç‚¹æ¤œãƒœã‚¿ãƒ³ï¼ˆæ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼å†…ã®è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆï¼‰
    function toggleDeepDive() {
      const questionsDiv = document.getElementById('deepDiveQuestions');
      const input1 = document.getElementById('input1');
      const input2 = document.getElementById('input2');
      const input3 = document.getElementById('input3');
      const input4 = document.getElementById('input4');
      const purposeInput = document.getElementById('purposeInput');
      const purposeGroup = document.getElementById('purposeGroup');
      const stopConditionGroup = document.getElementById('stopConditionGroup');
      
      inspectionMode = (inspectionMode + 1) % 4;
      
      if (inspectionMode === 0) {
        // é€šå¸¸
        questionsDiv.style.display = 'none';
        input1.placeholder = 'æœ¬è³ªçš„ã§ä»Šã™ãå¿…è¦ãªè¡Œå‹•ã¯ï¼Ÿ...';
        input2.placeholder = 'æœ¬è³ªçš„ãªè¨ˆç”»è¡Œå‹•ã¯ï¼Ÿ...';
        input3.placeholder = 'äº›ç´°ã ãŒæ€¥ãã®è¡Œå‹•ã¯ï¼Ÿï¼ˆäººã«ä»»ã›ã‚‹ï¼‰...';
        input4.placeholder = 'äº›æœ«ãªäº‹ã¯ã‚„ã‚‰ãªã„ã¨æ±ºã‚ã‚‹...è¦–ç•Œã‹ã‚‰å¤–ã™ã€ã‚¹ãƒãƒ›é›»æºåˆ‡ã‚‹...';
        purposeInput.placeholder = 'æœ¬è³ªçš„ãªç›®çš„ã‚’ä¸€è¡Œã§å…¥åŠ›...';
        document.getElementById('stopConditionInput').placeholder = 'ä¾‹: æœŸé™3æ—¥è¶…éã€2é€±é–“çµŒé';
      } else if (inspectionMode === 1) {
        // 8ã¤ã®å•ã„è¡¨ç¤º
        questionsDiv.innerHTML = `
          <div style="margin-bottom: 8px; font-weight: bold; color: #d32f2f;">
            0. ã©ã†ã„ã†ã“ã¨ãŒèµ·ã“ã‚Œã°ã€ã„ã£ãŸã‚“æ­¢ã‚ã¦ç‚¹æ¤œã™ã‚‹ã‹ï¼Ÿ<br>
            ï¼ˆ2é€±é–“çµŒéã€èµ¤å­—æå¤±1ä¸‡å††ã€æœŸé™è¶…é3æ—¥ã€å®Œäº†ç‡30%æœªæº€ï¼‰<br>
            â€»æ•°å€¤åŒ–ã—ã¦å›³ã‚Œã€‚
          </div>
          <div>1. ã“ã‚Œã¯ã€èª°ã®äººç”Ÿã«ç´ã¥ãæœªå®Œäº†ã‹?(å¸°å±)</div>
          <div>2. ã“ã‚Œã®æ­£ä½“ã¯è¡Œå‹•ã‹?(çœŸè´‹)</div>
          <div>3. ã“ã‚Œã¨å…±ã«æ­©ã‚€è¦šæ‚Ÿã¯ã‚ã‚‹ã‹?(è¦šæ‚Ÿ)</div>
          <div>
            4. è¦šæ‚Ÿã‚’ã„ã¤ã¾ã§ã«ï¼ˆä½•ã‚’ã‚„ã‚‹ã‹ã€ä½•æ™‚ã‹ã‚‰ã‚„ã‚‹ã‹ã€ã„ã¤ã¾ã§ã«ã‚„ã‚‹ã‹ï¼‰ã¨è¡Œå‹•ã«è½ã¨ã—è¾¼ã‚“ã ã‹?<br>
            é–‹å§‹ç· ã‚åˆ‡ã‚Šã€çµ‚äº†ç· ã‚åˆ‡ã‚Šã€ç‚¹æ¤œã€‚<br>
            æ˜æ—¥ã‚‚åŒã˜å½¢ã§ç¶™ç¶šã§ãã‚‹å½¢ã«ãªã£ã¦ã„ã‚‹ã‹ï¼Ÿ
          </div>
          <div style="margin-top: 8px; font-weight: bold; color: #1976d2;">5. æœ€å¤§ã®æ•µã¯ã€ç­”ãˆã‚’å‡ºã—ãŸããªã„è‡ªåˆ†ã ã€‚</div>
          <div style="margin-top: 8px; font-weight: bold; color: #7b1fa2;">6. å•ã„ã®é¤¨ã¯å´©å£Šã—ã€ãŠå‰ã¯ä»Šã€ç”Ÿã¾ã‚Œå¤‰ã‚ã£ãŸã€‚</div>
          <div style="margin-top: 8px; font-weight: bold; color: #388e3c;">7. ã‚¨ãƒªã‚¯ã‚µãƒ¼ã¯å…·ä½“çš„ãªè¡Œå‹•ã ï¼</div>
        `;
        questionsDiv.style.display = 'block';
        
        // ç›®çš„ã¨æ­¢ã‚ã‚‹ä»•çµ„ã¿ã‚’è¡¨ç¤º
        if (!purposeConfirmed) {
          purposeGroup.style.display = 'flex';
        }
        if (!stopConditionSaved) {
          stopConditionGroup.style.display = 'flex';
        } else if (stopConditionSaved && stopCondition) {
          document.getElementById('stopConditionDisplay').style.display = 'flex';
          document.getElementById('stopConditionText').textContent = stopCondition;
        }
        
        // ç‚¹æ¤œãƒ­ã‚°ã«è¨˜éŒ²
        logAction('inspect');
      } else if (inspectionMode === 2) {
        // å±¥æ­´è¡¨ç¤º
        const logs = escapeLog.slice().reverse().slice(0, 20);
        if (logs.length === 0) {
          questionsDiv.innerHTML = '<div style="color: #999; padding: 20px;">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        } else {
          let html = '';
          logs.forEach(log => {
            const time = log.date.split(' ')[1] || '';
            const dateStr = log.date.split(' ')[0];
            if (log.type === 'open') {
              html += `<div style="padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em;">${dateStr} ${time} é–‹ã</div>`;
            } else if (log.type === 'inspect') {
              html += `<div style="padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em;">${dateStr} ${time} ç‚¹æ¤œ</div>`;
            } else if (log.type === 'escape') {
              html += `<div style="padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em;">${dateStr} ${time} ğŸƒ é€ƒã’ãŸï¼š${log.task}</div>`;
            }
          });
          questionsDiv.innerHTML = html;
        }
        questionsDiv.style.display = 'block';
      } else if (inspectionMode === 3) {
        // ãƒ—ãƒ¬ãƒ¼ãƒ³è¡¨ç¤ºï¼ˆå°åˆ·ç”¨ï¼‰
        questionsDiv.style.display = 'none';
        input1.placeholder = '';
        input2.placeholder = '';
        input3.placeholder = '';
        input4.placeholder = '';
        purposeInput.placeholder = '';
        document.getElementById('stopConditionInput').placeholder = '';
      }
      
      // çŠ¶æ…‹ã‚’ä¿å­˜
      localStorage.setItem('inspectionMode', inspectionMode);
    }

    // çŠ¶æ…‹ã®å¾©å…ƒï¼ˆãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ï¼‰
    const savedView = localStorage.getItem('currentView');
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æœˆé–“ãƒ“ãƒ¥ãƒ¼ï¼ˆå…¨ä½“ã‚’ä¿¯ç°ã§ãã‚‹ï¼‰
    switchView(savedView || 'monthly');
    
    const savedInspectionMode = localStorage.getItem('inspectionMode');
    if (savedInspectionMode !== null) {
      const targetMode = parseInt(savedInspectionMode);
      inspectionMode = (targetMode - 1 + 4) % 4;
      toggleDeepDive();
    }

    // ===== ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ =====
    let selectedStamp = null;
    let eraserMode = false;

    // å­£ç¯€ã‚¢ãƒ¼ãƒˆï¼ˆæœˆã”ã¨ã®emojiï¼‰
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ãƒ³ãƒ—
    const DEFAULT_STAMPS = [
      { id: 's1', name: 'æ—¥å‹¤', color: '#ffcdd2', textColor: '#c62828', startTime: '08:30', endTime: '17:00' },
      { id: 's2', name: 'é•·æ—¥å‹¤', color: '#f8bbd0', textColor: '#ad1457', startTime: '08:30', endTime: '20:00' },
      { id: 's3', name: 'å…¥ã‚Š', color: '#e1bee7', textColor: '#6a1b9a', startTime: '16:30', endTime: '01:00' },
      { id: 's4', name: 'æ˜ã‘', color: '#c5cae9', textColor: '#283593', startTime: '00:00', endTime: '09:00' },
      { id: 's5', name: 'ä¼‘ã¿', color: '#b2dfdb', textColor: '#00695c', startTime: '', endTime: '' },
      { id: 's6', name: 'æœ‰çµ¦', color: '#fff9c4', textColor: '#f57f17', startTime: '', endTime: '' }
    ];

    function getStamps() {
      const saved = localStorage.getItem('simpleStamps');
      return saved ? JSON.parse(saved) : DEFAULT_STAMPS;
    }

    // ===== dailyStatus CRUDï¼ˆallTasksã«çµ±åˆï¼‰ =====
    function getDayInfo(date) {
      return allTasks.find(t => t.kind === 'dailyStatus' && t.date === date) || null;
    }

    function setDayInfo(date, stampId, workMemo, privateMemo) {
      const existing = getDayInfo(date);
      if (existing) {
        existing.stampId = stampId;
        if (workMemo !== undefined) existing.workMemo = workMemo;
        if (privateMemo !== undefined) existing.privateMemo = privateMemo;
        existing.updatedAt = new Date().toISOString();
      } else {
        allTasks.push({
          id: generateTaskId(),
          kind: 'dailyStatus',
          date: date,
          stampId: stampId,
          workMemo: workMemo || '',
          privateMemo: privateMemo || '',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
      }
      saveAllTasks();
    }

    function removeDayInfo(date) {
      const idx = allTasks.findIndex(t => t.kind === 'dailyStatus' && t.date === date);
      if (idx !== -1) {
        allTasks.splice(idx, 1);
        saveAllTasks();
        return true;
      }
      return false;
    }

    // ã‚¹ã‚¿ãƒ³ãƒ—å®šç¾©ã‹ã‚‰IDâ†’è¡¨ç¤ºæƒ…å ±ã‚’å–å¾—
    function getStampDef(stampId) {
      const stamps = getStamps();
      return stamps.find(s => s.id === stampId) || null;
    }


    // ã‚¹ã‚¿ãƒ³ãƒ—é¸æŠ
    function selectStamp(stamp) {
      selectedStamp = stamp;
      eraserMode = false;
      updateStampBarUI();
    }

    function selectEraserMode() {
      eraserMode = !eraserMode;
      selectedStamp = null;
      updateStampBarUI();
    }

    function clearStampSelection() {
      selectedStamp = null;
      eraserMode = false;
      updateStampBarUI();
    }

    function updateStampBarUI() {
      const info = document.getElementById('stampSelectionInfo');
      const btns = document.querySelectorAll('#stampButtons div[data-stamp-id]');
      btns.forEach(btn => {
        btn.style.transform = btn.dataset.stampId === (selectedStamp ? selectedStamp.id : '') ? 'scale(1.1)' : 'scale(1)';
        btn.style.boxShadow = btn.dataset.stampId === (selectedStamp ? selectedStamp.id : '') ? '0 2px 8px rgba(0,0,0,0.2)' : 'none';
      });
      // æ¶ˆã—ã‚´ãƒ ãƒœã‚¿ãƒ³
      const eraserBtn = document.getElementById('stampEraserBtn');
      if (eraserBtn) {
        eraserBtn.style.background = eraserMode ? '#ef5350' : '#fff';
        eraserBtn.style.color = eraserMode ? '#fff' : '#ef5350';
      }

      if (eraserMode) {
        info.textContent = 'ğŸ—‘ æ¶ˆã—ã‚´ãƒ ãƒ¢ãƒ¼ãƒ‰ â†’ æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã§å‰Šé™¤';
        info.style.color = '#ef5350';
      } else if (selectedStamp) {
        info.textContent = `ã€Œ${selectedStamp.name}ã€ã‚’é¸æŠä¸­ â†’ æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—`;
        info.style.color = selectedStamp.textColor || '#333';
      } else {
        info.textContent = 'ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é¸ã‚“ã§ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—';
        info.style.color = '#999';
      }
    }

    // æ—¥ä»˜ã‚»ãƒ«ã«ã‚¹ã‚¿ãƒ³ãƒ—è²¼ä»˜ or æ¶ˆã—ã‚´ãƒ å‰Šé™¤
    function applyStampToDate(dateStr) {
      // æ¶ˆã—ã‚´ãƒ ãƒ¢ãƒ¼ãƒ‰ â†’ dailyStatusã®ã¿å‰Šé™¤
      if (eraserMode) {
        if (removeDayInfo(dateStr)) {
          renderMonthlyView();
          if (navigator.vibrate) navigator.vibrate(30);
        }
        return;
      }
      // ã‚¹ã‚¿ãƒ³ãƒ—è²¼ä»˜
      if (selectedStamp) {
        const existing = getDayInfo(dateStr);
        if (existing && existing.stampId === selectedStamp.id) {
          // åŒã˜ã‚¹ã‚¿ãƒ³ãƒ—å†ã‚¿ãƒƒãƒ— â†’ è§£é™¤
          removeDayInfo(dateStr);
        } else {
          // æ–°è¦ or ä¸Šæ›¸ãï¼ˆãƒ¡ãƒ¢ã¯ä¿æŒï¼‰
          setDayInfo(dateStr, selectedStamp.id,
            existing ? existing.workMemo : '',
            existing ? existing.privateMemo : '');
        }
        renderMonthlyView();
      }
    }

    // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒ™ãƒ«ã‚¿ãƒƒãƒ—ã§é–‹ãï¼‰
    function openDayInfoModal(dateStr) {
      const dayInfo = getDayInfo(dateStr);
      if (!dayInfo) return;
      const def = getStampDef(dayInfo.stampId);
      const dateParts = dateStr.split('-');
      const dateLabel = `${parseInt(dateParts[1])}/${parseInt(dateParts[2])}`;
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«HTML
      const modal = document.createElement('div');
      modal.id = 'dayInfoModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999;
        background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center;
      `;
      modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
      
      const box = document.createElement('div');
      box.style.cssText = `
        background: #fff; border-radius: 16px; padding: 24px; width: 90%; max-width: 360px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      `;
      
      box.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
          <span style="font-size: 1.2em; font-weight: 700;">${dateLabel}</span>
          ${def ? `<span style="background: ${def.color}; color: ${def.textColor || '#333'}; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">${def.name}</span>` : ''}
        </div>
        <div style="margin-bottom: 14px;">
          <label style="font-size: 0.8em; font-weight: 600; color: #78909c;">â–  ä»•äº‹ãƒ¡ãƒ¢</label>
          <textarea id="dayInfoWorkMemo" rows="2" style="width: 100%; border: 1.5px solid #e0e0e0; border-radius: 8px; padding: 8px; font-size: 0.9em; resize: vertical; box-sizing: border-box; margin-top: 4px;">${dayInfo.workMemo || ''}</textarea>
        </div>
        <div style="margin-bottom: 18px;">
          <label style="font-size: 0.8em; font-weight: 600; color: #ffa726;">â˜… ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¡ãƒ¢</label>
          <textarea id="dayInfoPrivateMemo" rows="2" style="width: 100%; border: 1.5px solid #e0e0e0; border-radius: 8px; padding: 8px; font-size: 0.9em; resize: vertical; box-sizing: border-box; margin-top: 4px;">${dayInfo.privateMemo || ''}</textarea>
        </div>
        <div style="display: flex; gap: 8px; justify-content: flex-end;">
          <button onclick="document.getElementById('dayInfoModal').remove()" style="padding: 8px 16px; border-radius: 10px; border: 1.5px solid #e0e0e0; background: #f5f5f5; cursor: pointer; font-size: 0.85em;">é–‰ã˜ã‚‹</button>
          <button id="dayInfoSaveBtn" style="padding: 8px 16px; border-radius: 10px; border: none; background: #4facfe; color: #fff; cursor: pointer; font-size: 0.85em; font-weight: 600;">ä¿å­˜</button>
        </div>
      `;
      
      modal.appendChild(box);
      document.body.appendChild(modal);
      
      // ä¿å­˜ãƒœã‚¿ãƒ³
      document.getElementById('dayInfoSaveBtn').onclick = function() {
        const wm = document.getElementById('dayInfoWorkMemo').value.trim();
        const pm = document.getElementById('dayInfoPrivateMemo').value.trim();
        setDayInfo(dateStr, dayInfo.stampId, wm, pm);
        modal.remove();
        renderMonthlyView();
      };
    }

    // ã‚¹ã‚¿ãƒ³ãƒ—ãƒãƒ¼ã®ãƒœã‚¿ãƒ³ç”Ÿæˆ
    // ===== ã‚«ã‚¹ã‚¿ãƒ D&D =====
    window._stampDrag = { active: false, stamp: null, ghost: null, srcBtn: null };

    function _stampDragMove(cx, cy) {
      const d = window._stampDrag;
      if (!d.active || !d.ghost) return;
      d.ghost.style.left = (cx - 30) + 'px';
      d.ghost.style.top = (cy - 25) + 'px';
      // ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      const cells = document.querySelectorAll('.monthly-day-cell');
      cells.forEach(c => { c.style.outline = ''; c.style.outlineOffset = ''; });
      // ã‚´ãƒ¼ã‚¹ãƒˆã‚’ä¸€æ™‚çš„ã«éè¡¨ç¤ºã«ã—ã¦elementFromPoint
      d.ghost.style.pointerEvents = 'none';
      const el = document.elementFromPoint(cx, cy);
      if (el) {
        const cell = el.closest('.monthly-day-cell');
        if (cell) {
          cell.style.outline = '3px solid #4facfe';
          cell.style.outlineOffset = '-3px';
        }
      }
    }

    function _stampDragEnd(cx, cy) {
      const d = window._stampDrag;
      if (!d.active) return;
      // ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤
      document.querySelectorAll('.monthly-day-cell').forEach(c => {
        c.style.outline = ''; c.style.outlineOffset = '';
      });
      if (d.ghost) {
        d.ghost.style.display = 'none';
        const el = document.elementFromPoint(cx, cy);
        if (el) {
          const cell = el.closest('.monthly-day-cell');
          if (cell && cell.dataset.date && d.stamp) {
            const key = cell.dataset.date;
            const existing = getDayInfo(key);
            if (existing && existing.stampId === d.stamp.id) {
              removeDayInfo(key);
            } else {
              setDayInfo(key, d.stamp.id,
                existing ? existing.workMemo : '',
                existing ? existing.privateMemo : '');
            }
            if (navigator.vibrate) navigator.vibrate(30);
          }
        }
        d.ghost.remove();
      }
      if (d.srcBtn) d.srcBtn.style.opacity = '1';
      d.active = false; d.stamp = null; d.ghost = null; d.srcBtn = null;
      document.body.style.userSelect = '';
      document.body.style.webkitUserSelect = '';
      // çŠ¶æ…‹ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
      const info = document.getElementById('stampSelectionInfo');
      if (info) info.textContent = 'ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é¸ã‚“ã§ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—';
      renderMonthlyView();
    }

    function _initStampDrag(stamp, cx, cy, srcBtn) {
      const d = window._stampDrag;
      d.active = true;
      d.stamp = stamp;
      d.srcBtn = srcBtn;
      document.body.style.userSelect = 'none';
      document.body.style.webkitUserSelect = 'none';
      if (srcBtn) srcBtn.style.opacity = '0.4';
      // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿
      const info = document.getElementById('stampSelectionInfo');
      if (info) { info.textContent = `ğŸ¯ã€Œ${stamp.name}ã€ã‚’ãƒ‰ãƒ©ãƒƒã‚°ä¸­...ã‚»ãƒ«ã«é‡ã­ã¦é›¢ã™`; info.style.color = stamp.textColor || '#4facfe'; }
      // ã‚´ãƒ¼ã‚¹ãƒˆ
      const g = document.createElement('div');
      g.textContent = stamp.name;
      g.style.cssText = `
        position: fixed; z-index: 99999; padding: 8px 18px; border-radius: 18px;
        background: ${stamp.color}; color: ${stamp.textColor || '#333'}; font-size: 1em;
        font-weight: 700; pointer-events: none; box-shadow: 0 8px 24px rgba(0,0,0,0.35);
        transform: scale(1.2); border: 2px solid ${stamp.textColor || '#333'};
        left: ${cx - 30}px; top: ${cy - 25}px; transition: none;
      `;
      document.body.appendChild(g);
      d.ghost = g;
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«mouse/touchã‚¤ãƒ™ãƒ³ãƒˆ
    document.addEventListener('mousemove', function(e) {
      if (window._stampDrag.active) { e.preventDefault(); _stampDragMove(e.clientX, e.clientY); }
    }, { capture: true });
    document.addEventListener('mouseup', function(e) {
      if (window._stampDrag.active) { _stampDragEnd(e.clientX, e.clientY); }
    }, { capture: true });
    document.addEventListener('touchmove', function(e) {
      if (window._stampDrag.active) { e.preventDefault(); _stampDragMove(e.touches[0].clientX, e.touches[0].clientY); }
    }, { passive: false, capture: true });
    document.addEventListener('touchend', function(e) {
      if (window._stampDrag.active) { _stampDragEnd(e.changedTouches[0].clientX, e.changedTouches[0].clientY); }
    }, { capture: true });
    document.addEventListener('touchcancel', function() {
      if (window._stampDrag.active) { _stampDragEnd(-1, -1); }
    }, { capture: true });

    function renderStampBar() {
      const container = document.getElementById('stampButtons');
      if (!container) return;
      container.innerHTML = '';
      const stamps = getStamps();
      stamps.forEach(stamp => {
        const btn = document.createElement('div');
        btn.dataset.stampId = stamp.id;
        btn.textContent = stamp.name;
        btn.setAttribute('role', 'button');
        btn.style.cssText = `
          padding: 5px 12px; border-radius: 14px; border: 2px solid ${stamp.textColor || '#333'};
          background: ${stamp.color}; color: ${stamp.textColor || '#333'}; font-size: 0.78em;
          font-weight: 600; cursor: grab; white-space: nowrap;
          user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;
          touch-action: none;
        `;
        
        // === ãƒã‚¦ã‚¹ ===
        let msx = 0, msy = 0, mdrag = false;
        btn.addEventListener('mousedown', function(e) {
          if (e.button !== 0) return; // å·¦ã‚¯ãƒªãƒƒã‚¯ã®ã¿
          e.preventDefault();
          e.stopPropagation();
          msx = e.clientX; msy = e.clientY; mdrag = false;
          
          function mm(ev) {
            if (!mdrag && (Math.abs(ev.clientX - msx) > 4 || Math.abs(ev.clientY - msy) > 4)) {
              mdrag = true;
              _initStampDrag(stamp, ev.clientX, ev.clientY, btn);
            }
          }
          function mu(ev) {
            document.removeEventListener('mousemove', mm, true);
            document.removeEventListener('mouseup', mu, true);
            if (!mdrag) selectStamp(stamp);
          }
          document.addEventListener('mousemove', mm, true);
          document.addEventListener('mouseup', mu, true);
        });
        
        // === ã‚¿ãƒƒãƒ ===
        let tsx = 0, tsy = 0, tdrag = false;
        btn.addEventListener('touchstart', function(e) {
          e.preventDefault(); // ã“ã‚ŒãŒé‡è¦ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ­¢ã‚ã‚‹
          const t = e.touches[0];
          tsx = t.clientX; tsy = t.clientY; tdrag = false;
        }, { passive: false });
        
        btn.addEventListener('touchmove', function(e) {
          e.preventDefault();
          const t = e.touches[0];
          if (!tdrag && (Math.abs(t.clientX - tsx) > 6 || Math.abs(t.clientY - tsy) > 6)) {
            tdrag = true;
            _initStampDrag(stamp, t.clientX, t.clientY, btn);
          }
        }, { passive: false });
        
        btn.addEventListener('touchend', function(e) {
          if (!tdrag) selectStamp(stamp);
        });
        
        container.appendChild(btn);
      });
    }

    // ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ON/OFF
    function applySimpleMode() {
      const isSimple = localStorage.getItem('simpleMode') === 'on';
      const navDaily = document.getElementById('navDaily');
      const navWeekly = document.getElementById('navWeekly');
      const navYearly = document.getElementById('navYearly');
      const stampBar = document.getElementById('stampBar');
      const seasonalArt = document.getElementById('seasonalArt');

      if (isSimple) {
        if (navDaily) navDaily.style.display = '';
        if (navWeekly) navWeekly.style.display = '';
        if (navYearly) navYearly.style.display = '';
        if (stampBar) { stampBar.style.display = 'block'; renderStampBar(); }
        if (seasonalArt) { seasonalArt.style.display = 'block'; updateSeasonalArt(); }
      } else {
        if (navDaily) navDaily.style.display = '';
        if (navWeekly) navWeekly.style.display = '';
        if (navYearly) navYearly.style.display = '';
        if (stampBar) stampBar.style.display = 'none';
        if (seasonalArt) { seasonalArt.style.display = 'block'; updateSeasonalArt(); }
      }
    }

    function updateSeasonalArt() {
      const el = document.getElementById('seasonalArt');
      if (!el) return;
      const month = currentMonthDate ? (currentMonthDate.getMonth() + 1) : (new Date().getMonth() + 1);
      if (month === 3) {
        // ç™½æ¢…ã®èŠ±ã‚’SVGã§æç”»
        el.innerHTML = '<svg width="36" height="36" viewBox="0 0 40 40" style="filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.15));">' +
          '<circle cx="20" cy="12" r="5.5" fill="#fff" stroke="#e8b4c8" stroke-width="1"/>' +
          '<circle cx="12" cy="18" r="5.5" fill="#fff" stroke="#e8b4c8" stroke-width="1"/>' +
          '<circle cx="28" cy="18" r="5.5" fill="#fff" stroke="#e8b4c8" stroke-width="1"/>' +
          '<circle cx="14" cy="27" r="5.5" fill="#fff" stroke="#e8b4c8" stroke-width="1"/>' +
          '<circle cx="26" cy="27" r="5.5" fill="#fff" stroke="#e8b4c8" stroke-width="1"/>' +
          '<circle cx="20" cy="20" r="4" fill="#ffd54f"/>' +
          '<circle cx="18.5" cy="18.5" r="1" fill="#e8a000"/>' +
          '<circle cx="21.5" cy="18.5" r="1" fill="#e8a000"/>' +
          '<circle cx="20" cy="21.5" r="1" fill="#e8a000"/>' +
          '</svg>';
      } else {
        el.innerHTML = '';
        el.textContent = SEASONAL_ART[month] || 'ğŸ—“ï¸';
      }
    }

    // è¨­å®šç”»é¢ã®ãƒˆã‚°ãƒ«UI
    function toggleSimpleModePreview(checked) {
      updateSimpleToggleUI(checked);
      document.getElementById('stampSettingsArea').style.display = checked ? 'block' : 'none';
      if (checked) loadStampSettingsUI();
    }

    function updateSimpleToggleUI(checked) {
      const slider = document.getElementById('simpleToggleSlider');
      const knob = document.getElementById('simpleToggleKnob');
      if (checked) {
        slider.style.backgroundColor = '#4facfe';
        knob.style.left = '27px';
      } else {
        slider.style.backgroundColor = '#ccc';
        knob.style.left = '3px';
      }
    }

    // ã‚¹ã‚¿ãƒ³ãƒ—è¨­å®šUI
    function loadStampSettingsUI() {
      const stamps = getStamps();
      const list = document.getElementById('stampList');
      list.innerHTML = '';
      stamps.forEach((stamp, idx) => {
        const row = document.createElement('div');
        row.style.cssText = 'display: flex; align-items: center; gap: 6px; margin-bottom: 6px; flex-wrap: wrap;';
        row.innerHTML = `
          <input type="text" value="${stamp.name}" data-idx="${idx}" data-field="name"
            style="width: 60px; padding: 4px 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85em;"
            onchange="updateStampField(${idx}, 'name', this.value)">
          <input type="color" value="${stamp.color}" data-idx="${idx}"
            style="width: 30px; height: 28px; border: none; cursor: pointer; border-radius: 4px;"
            onchange="updateStampField(${idx}, 'color', this.value)">
          <input type="time" value="${stamp.startTime || ''}" placeholder="é–‹å§‹"
            style="width: 75px; padding: 3px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8em;"
            onchange="updateStampField(${idx}, 'startTime', this.value)">
          <span style="font-size: 0.8em; color: #999;">ã€œ</span>
          <input type="time" value="${stamp.endTime || ''}" placeholder="çµ‚äº†"
            style="width: 75px; padding: 3px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8em;"
            onchange="updateStampField(${idx}, 'endTime', this.value)">
          <button onclick="removeStamp(${idx})" style="background: none; border: none; color: #e53935; cursor: pointer; font-size: 1.1em; padding: 2px 6px;">âœ•</button>
        `;
        list.appendChild(row);
      });
    }

    function updateStampField(idx, field, value) {
      const stamps = getStamps();
      if (stamps[idx]) {
        stamps[idx][field] = value;
        localStorage.setItem('simpleStamps', JSON.stringify(stamps));
      }
    }

    function addStampSetting() {
      const stamps = getStamps();
      if (stamps.length >= 20) { alert('ã‚¹ã‚¿ãƒ³ãƒ—ã¯æœ€å¤§20å€‹ã§ã™'); return; }
      stamps.push({
        id: 's' + Date.now(),
        name: 'æ–°è¦',
        color: '#e0e0e0',
        textColor: '#333',
        startTime: '',
        endTime: ''
      });
      localStorage.setItem('simpleStamps', JSON.stringify(stamps));
      loadStampSettingsUI();
    }

    function removeStamp(idx) {
      const stamps = getStamps();
      stamps.splice(idx, 1);
      localStorage.setItem('simpleStamps', JSON.stringify(stamps));
      loadStampSettingsUI();
    }

    function saveStampSettings() {
      // è¨­å®šUIã‹ã‚‰æœ€æ–°ã®å€¤ã‚’åé›†
      const stamps = getStamps();
      const nameInputs = document.querySelectorAll('#stampList input[data-field="name"]');
      nameInputs.forEach(input => {
        const idx = parseInt(input.dataset.idx);
        if (stamps[idx]) stamps[idx].name = input.value;
      });
      localStorage.setItem('simpleStamps', JSON.stringify(stamps));
    }

    // v0.10.0: æ—§localStorageã‚­ãƒ¼æƒé™¤ï¼ˆstampData/simpleMemos â†’ allTasksã«çµ±åˆæ¸ˆã¿ï¼‰
    localStorage.removeItem('stampData');
    localStorage.removeItem('simpleMemos');

    // èµ·å‹•æ™‚ã«ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰é©ç”¨
    applySimpleMode();
  </script>

  <!-- ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="taskEditModal" class="custom-modal" onclick="if(event.target.id==='taskEditModal') closeTaskEditModal();">
    <div class="modal-content" style="max-width: 420px; text-align: left;">
      <h3 style="margin: 0 0 24px 0; text-align: center; font-size: 1.15em; color: #333; font-weight: 600;">ã‚¿ã‚¹ã‚¯ç·¨é›†</h3>
      <input type="hidden" id="taskEditId">
      <div style="margin-bottom: 18px;">
        <label>ã‚¿ã‚¹ã‚¯å</label>
        <input type="text" id="taskEditText">
      </div>
      <div style="margin-bottom: 18px;">
        <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <textarea id="taskEditMemo" rows="3" placeholder="è©³ç´°ã‚„æŒã¡ç‰©ãªã©..."></textarea>
      </div>
      <div class="task-edit-datetime" style="display: flex; gap: 12px; margin-bottom: 18px;">
        <div style="flex: 1; min-width: 0;">
          <label>æ—¥ä»˜</label>
          <input type="date" id="taskEditDate">
        </div>
        <div style="flex: 1; min-width: 0;">
          <label>æ™‚é–“ï¼ˆä»»æ„ï¼‰</label>
          <input type="hidden" id="taskEditTime">
          <div class="custom-time-picker" id="taskEditTimePicker">
            <div class="time-select-wrapper">
              <select class="time-select" id="taskEditHourSelect">
                <option value="">--</option>
                <option value="0">00</option><option value="1">01</option><option value="2">02</option><option value="3">03</option>
                <option value="4">04</option><option value="5">05</option><option value="6">06</option><option value="7">07</option>
                <option value="8">08</option><option value="9">09</option><option value="10">10</option><option value="11">11</option>
                <option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option>
                <option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option>
                <option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option>
              </select>
              <div class="time-label">æ™‚</div>
            </div>
            <span class="time-separator">:</span>
            <div class="time-select-wrapper">
              <select class="time-select" id="taskEditMinuteSelect">
                <option value="">--</option>
                <option value="0">00</option><option value="5">05</option><option value="10">10</option><option value="15">15</option>
                <option value="20">20</option><option value="25">25</option><option value="30">30</option><option value="35">35</option>
                <option value="40">40</option><option value="45">45</option><option value="50">50</option><option value="55">55</option>
              </select>
              <div class="time-label">åˆ†</div>
            </div>
            <button type="button" class="time-clear-btn" onclick="clearTimeSelect('taskEdit')" title="æ™‚é–“ã‚’ã‚¯ãƒªã‚¢">âœ•</button>
          </div>
        </div>
      </div>
      <div class="modal-buttons" style="margin-top: 24px;">
        <button class="modal-btn modal-btn-cancel" onclick="closeTaskEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-delete" onclick="deleteTaskFromEditModal()">å‰Šé™¤</button>
        <button class="modal-btn modal-btn-save" onclick="saveTaskEdit()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="customModal" class="custom-modal" onclick="if(event.target.id==='customModal') closeModal();">
    <div class="modal-content">
      <div class="modal-title">ç¢ºèª</div>
      <div class="modal-message">æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-confirm" onclick="executeDelete()">å‰Šé™¤</button>
      </div>
    </div>
  </div>

</body>
</html>
